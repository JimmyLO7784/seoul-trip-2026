<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¦–çˆ¾ 2026</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#F2F1F6',
                        primary: '#C8A47E',
                        'primary-dark': '#A68665',
                        'accent-green': '#34C759',
                    },
                    boxShadow: { 'ios': '0 2px 8px rgba(0,0,0,0.04)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #E5E5E5; -webkit-tap-highlight-color: transparent; font-family: "M PLUS Rounded 1c", sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Transitions */
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        a { -webkit-touch-callout: none; }
    </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden select-none">

<div id="app" class="relative w-full h-full max-w-[480px] mx-auto bg-[#F2F1F6] shadow-2xl overflow-hidden flex flex-col">

    <!-- Header (V21 Style + File Button) -->
    <header class="flex-none px-5 py-3 pt-[calc(12px+env(safe-area-inset-top))] bg-bg/90 backdrop-blur-md border-b border-black/5 z-50 flex justify-between items-center sticky top-0">
        <!-- Title & Status -->
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight text-gray-900 flex items-center gap-2">
                é¦–çˆ¾ 2026
                <span v-if="connectionState === 'online'" class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse ml-0.5"></span>
                <span v-else class="w-1.5 h-1.5 rounded-full bg-orange-400 ml-0.5"></span>
            </h1>
        </div>
        
        <!-- Right: Weather + File Manager -->
        <div class="flex items-center gap-3">
            <div @click="fetchWeather" class="bg-white/60 px-3 py-1.5 rounded-full flex items-center gap-2 shadow-sm cursor-pointer active:scale-95 transition-transform">
                <i :class="['fa-solid text-primary', weather.icon]"></i>
                <span class="text-xs font-bold text-gray-700">{{ weather.temp }}Â°</span>
            </div>
            <button @click="showFileMenu = true" class="w-8 h-8 rounded-full bg-white text-gray-600 shadow-sm flex items-center justify-center active:scale-95 transition-transform hover:text-primary">
                <i class="fa-regular fa-folder-open text-sm"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden pb-[100px] hide-scroll relative">
        
        <!-- View: PLAN -->
        <div v-show="currentView === 'plan'">
            
            <!-- Date Slider -->
            <div class="sticky top-0 z-40 px-4 py-2 bg-[#F2F1F6]/95 backdrop-blur-sm pt-4 border-b border-gray-200/50">
                <div class="flex gap-2 overflow-x-auto hide-scroll pb-2">
                    <div v-for="(day, index) in itinerary" :key="index" 
                            @click="selectDay(index)"
                            :class="['flex-none w-[70px] p-2.5 rounded-2xl text-center transition-all duration-200 cursor-pointer border border-transparent shadow-sm', 
                                    selectedDayIndex === index ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-white text-gray-400']">
                        <div class="text-[10px] font-bold opacity-80">Day {{ day.d }}</div>
                        <div class="text-lg font-extrabold leading-tight">{{ day.date ? day.date.split(' ')[0] : `D${day.d}` }}</div>
                    </div>
                    <!-- Add Day Button -->
                    <div @click="addNewDay" class="flex-none w-[50px] p-2.5 rounded-2xl text-center border-2 border-dashed border-gray-300 text-gray-400 flex items-center justify-center cursor-pointer hover:border-primary hover:text-primary transition-colors">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                </div>
            </div>

            <!-- Itinerary Items -->
            <div v-if="itinerary.length > 0" :key="selectedDayIndex" class="space-y-4 px-4 pt-4">
                <div class="bg-white rounded-2xl p-5 text-center shadow-ios border border-gray-100/50">
                    <h2 class="text-xl font-extrabold text-gray-800">{{ currentDay?.title || 'è¦åŠƒä¸­...' }}</h2>
                    <div class="text-xs text-gray-400 mt-1">{{ currentDay?.date }}</div>
                </div>

                <div v-if="!currentDay?.items || currentDay.items.length === 0" class="text-center py-8 text-gray-300 border-2 border-dashed border-gray-200 rounded-2xl">
                    <p class="text-xs font-bold mb-2">æœ¬æ—¥ç„¡è¡Œç¨‹</p>
                    <button @click="openModal('add', selectedDayIndex)" class="text-primary text-xs font-bold">ï¼‹ é»æ“Šæ–°å¢</button>
                </div>

                <div v-for="(item, idx) in currentDay?.items" :key="idx" class="relative group">
                    <!-- Edit Button -->
                    <button @click="openModal('edit', selectedDayIndex, idx, item)" class="absolute -right-2 -top-2 z-10 w-8 h-8 bg-gray-900 rounded-full text-white text-xs flex items-center justify-center shadow-lg opacity-80 hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-pen"></i>
                    </button>

                    <!-- Type: Simple Item -->
                    <div v-if="!item.type || item.type === 'normal'" class="bg-white rounded-[20px] p-4 shadow-ios border border-gray-50 flex justify-between items-start">
                        <div class="flex-1 min-w-0 pr-3">
                            <a :href="getSearchLink(item.title)" target="_blank" class="font-bold text-base text-gray-800 block flex items-center gap-1">
                                {{ item.title }} <i class="fa-solid fa-magnifying-glass text-[10px] text-blue-300 opacity-50"></i>
                            </a>
                            <div class="text-xs text-gray-500 mt-1 whitespace-pre-line">{{ item.desc }}</div>
                            <div v-if="item.brands" class="flex flex-wrap gap-1.5 mt-2">
                                <a v-for="brand in item.brands" :href="getSearchLink(brand + ' ' + item.title)" target="_blank" class="px-2 py-0.5 rounded text-[10px] bg-gray-50 border border-gray-100 text-gray-600 hover:bg-gray-100">{{ brand }}</a>
                            </div>
                            <div v-if="item.note" class="mt-2 bg-yellow-50 text-yellow-800 text-xs p-2 rounded-lg border border-yellow-100 flex gap-2 items-start">
                                <i class="fa-solid fa-sticky-note mt-0.5 opacity-50"></i><span>{{ item.note }}</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2 shrink-0">
                            <span v-if="item.time" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md">{{ item.time }}</span>
                            <a v-if="item.map" :href="getNaverLink(item.map)" target="_blank" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-accent-green hover:bg-green-100">
                                <i class="fa-solid fa-location-arrow text-sm"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Type: Meal -->
                    <div v-else-if="item.type === 'meal'" class="bg-white rounded-[20px] shadow-ios overflow-hidden border border-gray-50">
                        <div class="bg-gray-50/80 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                            <div class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-utensils text-primary"></i> {{ item.title }}</div>
                            <span v-if="item.time" class="text-xs font-bold text-gray-400 bg-gray-200/50 px-2 py-1 rounded-md">{{ item.time }}</span>
                        </div>
                        <div class="p-4 space-y-3">
                            <div v-for="opt in item.opts" class="flex justify-between items-center text-sm">
                                <a :href="getSearchLink(opt.n)" target="_blank" class="flex-1 group">
                                    <div class="font-bold text-gray-700 flex items-center gap-1">{{ opt.n }} <i class="fa-solid fa-magnifying-glass text-[10px] text-gray-300 opacity-0 group-hover:opacity-100"></i></div>
                                    <div v-if="opt.tip" class="text-[10px] text-gray-400">{{ opt.tip }}</div>
                                </a>
                                <div class="flex gap-2 items-center">
                                    <span :class="['text-[10px] px-2 py-1 rounded font-bold', opt.t==='res'?'bg-green-100 text-green-700':'bg-red-100 text-red-600']">{{ opt.t==='res'?'é ç´„':'æ’éšŠ' }}</span>
                                    <a v-if="opt.k" :href="getNaverLink(opt.k)" target="_blank" class="w-6 h-6 bg-gray-50 rounded-full flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50"><i class="fa-solid fa-location-arrow text-[10px]"></i></a>
                                </div>
                            </div>
                            <div v-if="item.note" class="pt-2 mt-2 border-t border-dashed border-gray-200 text-xs text-yellow-700">ğŸ“ {{ item.note }}</div>
                        </div>
                    </div>

                    <!-- Type: Choice -->
                    <div v-else-if="item.type === 'choice'" class="bg-[#FAFAFA] rounded-[20px] p-4 border-2 border-dashed border-gray-200">
                        <div class="flex justify-between items-center mb-1">
                            <div class="text-xs font-bold text-gray-400">{{ item.time || 'æ™‚æ®µ' }}</div>
                            <div class="text-center font-bold text-primary-dark">{{ item.title }}</div>
                            <div class="w-4"></div>
                        </div>
                        <div class="text-center text-xs text-gray-400 mb-3">{{ item.desc }}</div>
                        <div class="flex flex-wrap gap-2">
                            <a v-for="c in item.choices" :href="getSearchLink(c.n + ' ' + c.desc)" target="_blank" class="flex-1 min-w-[45%] bg-white p-3 rounded-xl border border-gray-100 text-center shadow-sm flex items-center justify-between group hover:border-primary/30 transition-colors">
                                <div class="text-left">
                                    <div class="text-[10px] font-bold bg-gray-800 text-white inline-block px-1.5 rounded mb-1">{{ c.n.split(' ')[0] }}</div>
                                    <div class="text-xs font-bold text-gray-700 flex items-center gap-1">{{ c.desc }} <i class="fa-solid fa-magnifying-glass text-[8px] text-gray-300"></i></div>
                                </div>
                                <div v-if="c.target" @click.prevent="window.open(getNaverLink(c.target))" class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50">
                                    <i class="fa-solid fa-location-arrow text-[10px]"></i>
                                </div>
                            </a>
                        </div>
                        <div v-if="item.note" class="mt-3 bg-white p-2 rounded border text-xs text-gray-600 text-center shadow-sm">
                            <span class="text-primary font-bold">ç­†è¨˜ï¼š</span> {{ item.note }}
                        </div>
                    </div>
                </div>

                <!-- ADD BUTTON -->
                <button @click="openModal('add', selectedDayIndex)" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white hover:text-primary hover:border-primary transition-colors flex items-center justify-center gap-2 mb-10">
                    <i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹
                </button>
            </div>
            
             <!-- Empty State / Init -->
            <div v-if="itinerary.length === 0 && !loading" class="flex flex-col items-center justify-center h-[50vh] text-gray-400">
                 <i class="fa-regular fa-calendar-xmark text-4xl mb-3 opacity-30"></i>
                 <p class="text-sm font-bold">ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„</p>
                 <button @click="uploadDefaultData" class="mt-4 text-xs bg-gray-900 px-6 py-2.5 rounded-full shadow-sm font-bold text-white">
                    <i class="fa-solid fa-cloud-arrow-up mr-2"></i>è¼‰å…¥é¦–çˆ¾2026è¡Œç¨‹
                 </button>
            </div>
        </div>

        <!-- View: CALC -->
        <div v-show="currentView === 'calc'" class="p-5">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4 ml-1">åŒ¯ç‡è¨ˆç®—</h2>
            <div class="bg-white rounded-[24px] p-6 shadow-ios border border-gray-50 text-right mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-400">è¼¸å…¥éŸ“å¹£ (KRW)</span>
                    <button @click="resetCalc" class="text-xs font-bold text-primary hover:text-primary-dark">æ¸…é™¤</button>
                </div>
                <input type="text" inputmode="decimal" v-model="calcInput" 
                       class="w-full text-right text-5xl font-light text-gray-900 placeholder-gray-200 outline-none bg-transparent font-mono mb-4 tracking-tighter" 
                       placeholder="0">
                <div class="border-t border-gray-100 py-3 flex justify-between items-center">
                    <span class="text-sm text-gray-400">ç´„åˆå°å¹£</span>
                    <span class="text-xl font-bold font-mono text-gray-800">{{ calcTwd }}</span>
                </div>
                <div class="pt-2 flex justify-between items-center">
                    <span class="text-sm text-gray-400">é è¨ˆé€€ç¨…</span>
                    <span class="text-xl font-bold font-mono text-accent-green">{{ calcTax }}</span>
                </div>
            </div>
            <div class="text-center text-xs text-gray-400">ç•¶å‰åŒ¯ç‡: {{ rate }} | æ»¿ 30,000 å¯é€€ç¨…</div>
        </div>

        <!-- View: GUIDE -->
        <div v-show="currentView === 'guide'" class="p-4 space-y-5">
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-3">1æœˆå¿«é–ƒ & å¸‚é›†</h3>
                <div class="space-y-2">
                    <div v-for="p in popupList" :key="p.title" class="flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" @click="openInfoModal(p.modalTitle || p.title, p.modalDesc || p.desc)">
                        <span :class="['px-2 py-1 rounded text-xs font-bold h-fit shrink-0', p.tagClass || 'bg-purple-100 text-purple-600']">{{ p.tag }}</span>
                        <div>
                            <div class="font-bold text-sm">{{ p.title }}</div>
                            <div class="text-xs text-gray-500 line-clamp-1">{{ p.desc }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-3">æ½®ç‰Œ & è³¼ç‰©å¿«è¨Š</h3>
                <div class="space-y-2">
                    <div v-for="b in brandList" :key="b.title" class="flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" @click="openInfoModal(b.modalTitle || b.title, b.modalDesc || b.desc)">
                        <span :class="['px-2 py-1 rounded text-xs font-bold h-fit shrink-0', b.tagClass || 'bg-blue-100 text-blue-600']">{{ b.tag }}</span>
                        <div>
                            <div class="font-bold text-sm">{{ b.title }}</div>
                            <div class="text-xs text-gray-500 line-clamp-1">{{ b.desc }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-2">ç”Ÿå­˜éŸ“èª</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div v-for="c in survivalCards" class="border p-2 rounded-xl text-center hover:bg-gray-50 active:scale-95 transition-all cursor-pointer" @click="openInfoModal(c.title + ' ' + c.k, c.desc)">
                        <div class="text-xl mb-1">{{ c.icon }}</div>
                        <div class="font-bold text-sm text-gray-700">{{ c.title }}</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-1 shadow-sm border border-gray-100">
                <a href="https://m.map.naver.com/" target="_blank" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl transition-colors">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-map text-green-500 text-xl"></i>
                        <div>
                            <div class="font-bold text-sm">Naver Map</div>
                            <div class="text-xs text-gray-400">éŸ“åœ‹å¿…å‚™å°èˆª</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </a>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="flex-none h-[calc(60px+env(safe-area-inset-bottom))] bg-white/95 backdrop-blur-xl border-t border-gray-200 pb-safe-bottom flex justify-around items-center z-50">
        <button v-for="tab in ['plan', 'calc', 'guide']" :key="tab" @click="currentView = tab" :class="['flex-1 h-full flex flex-col items-center justify-center gap-1 transition-colors', currentView === tab ? 'text-primary-dark' : 'text-gray-400']">
            <i :class="['fa-solid text-xl transition-transform duration-200', tab === 'plan' ? 'fa-calendar-days' : (tab === 'calc' ? 'fa-calculator' : 'fa-book-open'), currentView === tab ? '-translate-y-0.5' : '']"></i>
            <span class="text-[10px] font-bold tracking-wide">{{ tab === 'plan' ? 'è¡Œç¨‹' : (tab === 'calc' ? 'è¨ˆç®—' : 'æ”»ç•¥') }}</span>
        </button>
    </nav>

    <!-- Modal: File Management (Menu) -->
    <transition name="fade">
        <div v-if="showFileMenu" class="absolute inset-0 z-[120] bg-black/60 flex items-center justify-center p-6" @click="showFileMenu = false">
            <div class="bg-white w-full max-w-xs rounded-[24px] p-6 shadow-2xl space-y-4" @click.stop>
                <h3 class="text-lg font-extrabold text-gray-900 text-center mb-2">æª”æ¡ˆèˆ‡è¨­å®š</h3>
                
                <button @click="downloadItinerary" class="w-full bg-blue-50 text-blue-600 p-4 rounded-xl font-bold flex items-center gap-3 hover:bg-blue-100 transition-colors">
                    <i class="fa-solid fa-download"></i> åŒ¯å‡ºå‚™ä»½ (Save)
                </button>
                
                <label class="w-full bg-green-50 text-green-600 p-4 rounded-xl font-bold flex items-center gap-3 hover:bg-green-100 transition-colors cursor-pointer">
                    <i class="fa-solid fa-upload"></i> åŒ¯å…¥è¡Œç¨‹ (Load)
                    <input type="file" class="hidden" accept=".json" @change="uploadItinerary">
                </label>
                
                <hr class="border-gray-100 my-2">
                
                <button @click="clearItinerary" class="w-full bg-red-50 text-red-500 p-4 rounded-xl font-bold flex items-center gap-3 hover:bg-red-100 transition-colors">
                    <i class="fa-solid fa-trash-can"></i> æ¸…é™¤é‡ç½® (Clear)
                </button>
            </div>
        </div>
    </transition>

    <!-- Modal: Edit Itinerary -->
    <transition name="slide-up">
        <div v-if="showEditModal" class="absolute inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end justify-center" @click="closeEditModal">
            <div class="bg-white w-full h-[85vh] rounded-t-[24px] p-6 shadow-2xl flex flex-col" @click.stop>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-extrabold text-gray-900">{{ editForm.mode === 'add' ? 'æ–°å¢è¡Œç¨‹' : 'ç·¨è¼¯è¡Œç¨‹' }}</h3>
                    <button @click="closeEditModal" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto hide-scroll space-y-5 pb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-2">é¡å‹</label>
                        <div class="flex bg-gray-100 p-1 rounded-xl">
                            <button v-for="t in ['normal', 'meal', 'choice']" @click="editForm.type = t" :class="['flex-1 py-2 text-xs font-bold rounded-lg transition-all', editForm.type === t ? 'bg-white shadow-sm text-gray-900' : 'text-gray-400']">{{ t === 'normal' ? 'ä¸€èˆ¬' : (t === 'meal' ? 'é¤å»³' : 'å¤šé¸') }}</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3">
                        <div class="col-span-1"><label class="text-xs font-bold text-gray-400 block mb-1">æ™‚é–“</label><input v-model="editForm.time" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-sm text-center" placeholder="12:00"></div>
                        <div class="col-span-3"><label class="text-xs font-bold text-gray-400 block mb-1">æ¨™é¡Œ</label><input v-model="editForm.title" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-base" placeholder="åœ°é»åç¨±"></div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">æè¿°</label><textarea v-model="editForm.desc" rows="2" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="ç°¡çŸ­èªªæ˜"></textarea></div>
                    
                    <div v-if="editForm.type === 'normal'" class="space-y-4">
                        <div><label class="text-xs font-bold text-gray-400 block mb-1">åœ°åœ–é—œéµå­—</label><input v-model="editForm.map" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="ç”¨æ–¼å°èˆªæœå°‹"></div>
                        <div><label class="text-xs font-bold text-gray-400 block mb-1">å“ç‰Œ/æ¨™ç±¤</label><input v-model="editForm.brandsStr" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="Nike, Adidas..."></div>
                    </div>
                    <div v-if="editForm.type === 'meal'" class="space-y-3">
                        <label class="text-xs font-bold text-gray-400 flex justify-between items-center">é¤å»³é¸é … <button @click="addSubItem('meal')" class="text-primary text-[10px]"><i class="fa-solid fa-plus"></i> å¢åŠ </button></label>
                        <div v-for="(opt, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative">
                            <button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                            <input v-model="opt.n" class="w-full bg-white p-2 rounded border border-gray-100 text-sm font-bold" placeholder="é¤å»³åç¨±">
                            <div class="flex gap-2"><select v-model="opt.t" class="bg-white p-2 rounded border border-gray-100 text-xs flex-1"><option value="walk">ç¾å ´</option><option value="res">é ç´„</option><option value="wait">å€™ä½</option></select><input v-model="opt.k" class="flex-[2] bg-white p-2 rounded border border-gray-100 text-xs" placeholder="åœ°åœ–é—œéµå­—"></div>
                        </div>
                    </div>
                    <div v-if="editForm.type === 'choice'" class="space-y-3">
                        <label class="text-xs font-bold text-gray-400 flex justify-between items-center">å¤šé¸æ–¹æ¡ˆ <button @click="addSubItem('choice')" class="text-primary text-[10px]"><i class="fa-solid fa-plus"></i> å¢åŠ </button></label>
                        <div v-for="(c, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative">
                            <button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                            <div class="flex gap-2"><input v-model="c.n" class="w-1/3 bg-white p-2 rounded border border-gray-100 text-sm font-bold text-center" placeholder="Plan A"><input v-model="c.desc" class="w-2/3 bg-white p-2 rounded border border-gray-100 text-sm" placeholder="æè¿°"></div>
                            <input v-model="c.target" class="w-full bg-white p-2 rounded border border-gray-100 text-xs" placeholder="æœå°‹é—œéµå­—">
                        </div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">ç­†è¨˜</label><textarea v-model="editForm.note" rows="2" class="w-full bg-yellow-50 border border-yellow-100 p-3 rounded-xl text-sm text-gray-700" placeholder="ç§äººç­†è¨˜..."></textarea></div>
                </div>
                <div class="pt-4 border-t border-gray-100 flex gap-3">
                    <button v-if="editForm.mode === 'edit'" @click="deleteItem" class="flex-1 bg-red-50 text-red-500 font-bold py-3.5 rounded-xl active:scale-95 transition-transform">åˆªé™¤</button>
                    <button @click="saveEdit" class="flex-[3] bg-gray-900 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-transform flex justify-center items-center gap-2"><span>{{ isSaving ? 'è™•ç†ä¸­...' : 'å„²å­˜è®Šæ›´' }}</span></button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Info Modal -->
    <transition name="fade">
        <div v-if="infoModal.show" class="absolute inset-0 z-[110] bg-black/60 flex items-center justify-center p-6" @click="infoModal.show = false">
            <div class="bg-white w-full max-w-sm rounded-[30px] p-6 shadow-2xl text-center" @click.stop>
                <h3 class="text-xl font-extrabold text-gray-900 mb-3 whitespace-pre-line">{{ infoModal.title }}</h3>
                <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap mb-6">{{ infoModal.desc }}</p>
                <button @click="infoModal.show = false" class="w-full bg-gray-100 text-gray-900 font-bold py-3 rounded-xl">é—œé–‰</button>
            </div>
        </div>
    </transition>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBFDAs4hj4eJ2hCxsWWlRRCsJC_qEekBCc",
        authDomain: "trip-plan-app-c38a3.firebaseapp.com",
        projectId: "trip-plan-app-c38a3",
        storageBucket: "trip-plan-app-c38a3.firebasestorage.app",
        messagingSenderId: "79177072268",
        appId: "1:79177072268:web:e8efe92b05a528046d45a9"
    };

    let app, db;
    try { app = initializeApp(firebaseConfig); db = getFirestore(app); } catch(e) {}

    const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

    // --- SEOUL DEFAULT DATA (Preserved from V21) ---
    const DEFAULT_ITINERARY = [
        { 
            d: 1, date: "1/25 (æ—¥)", title: "æŠµé” & æ˜æ´",
            items: [
                { time:"13:00", title:"L7 é£¯åº— Check-in", desc:"å¯„æ”¾è¡Œæ / å¤§å»³æ©Ÿå™¨æ›éŒ¢", map:"L7 ëª…ë™", type:"normal", note: "" },
                { title:"Money Planet æ›éŒ¢", desc:"å°±åœ¨æ˜æ´ï¼ŒåŒ¯ç‡å„ªï¼", map:"ë¨¸ë‹ˆí”Œë ˆë‹›", type:"normal", brands: ["æ›éŒ¢æ‰€", "è‡ªåŠ©æ›éŒ¢æ©Ÿ"], note: "" },
                { title:"é¦–çˆ¾è³¼ç‰©å­£ (Shopping Festa)", desc:"å»ã€Œæ˜æ´æ­¡è¿ä¸­å¿ƒã€é ˜å„ªæƒ åˆ¸ & æ­¡è¿ç¦®åŒ…ï¼\n*è¨˜å¾—å¸¶è­·ç…§/æ©Ÿç¥¨", map:"ëª…ë™ì˜ˆìˆ ê·¹ì¥", type:"normal", brands: ["Welcome Center", "å„ªæƒ åˆ¸"], note: "" },
                { type:"meal", title:"æ˜æ´åˆé¤", opts:[{n:"æ˜æ´é¤ƒå­", t:"wait", tip:"å¿…æ¯”ç™»æ¨è–¦"}, {n:"ç¥ä»™é›ªæ¿ƒæ¹¯", t:"wait", tip:"æ¹¯é ­æ¿ƒéƒ"}, {n:"è’è¬¬çš„ç”Ÿè‚‰", t:"walk", tip:"é«˜CPå€¼çƒ¤è‚‰"}], note: "" },
                { time:"16:00", type:"choice", title:"ä¸‹åˆè‡ªç”±é¸", desc:"ç´¯äº†å—ï¼Ÿé¸ä¸€å€‹å–œæ­¡çš„", choices: [{n:"A é€›è¡—", desc:"Olive Young æ——è‰¦åº— / 8ç§’", target:"ì˜¬ë¦¬ë¸Œì˜ ëª…ë™"}, {n:"B è–å ‚", desc:"æ˜æ´è–å ‚ æ‹ç¾ç…§", target:"ëª…ë™ì„±ë‹¹"}, {n:"C å’–å•¡", desc:"Pink Pool Cafe", target:"ìŠ¤íƒ€ì¼ë‚œë‹¤ í•‘í¬í’€ì¹´í˜"}, {n:"D äº‚æ‰“ç§€", desc:"17:00 å ´æ¬¡ (é€±æ—¥æœ‰ä¸‹åˆå ´)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" },
                { title:"æ¨‚å¤©ç™¾è²¨ & å…ç¨…åº—", desc:"B1 é£Ÿå“è¡— / 9-12F å…ç¨…åº— (è­·ç…§)", map:"ë¡¯ë°ë°±í™”ì  ë³¸ì ", type:"normal", brands: ["Gentle Monster", "Tamburins", "Matin Kim", "Blue Elephant"], note: "" },
                { time:"19:00", type:"meal", title:"æ™šé¤ï¼šéŸ“å¼çƒ¤è‚‰", opts:[{n:"ç‹å¦ƒå®¶", t:"res"}, {n:"é»ƒé‡‘ç‰§å ´", t:"res"}, {n:"è‚‰çµ±ç¸½", t:"wait"}], note: "" }
            ]
        },
        { 
            d: 2, date: "1/26 (ä¸€)", title: "å—å¤§é–€ & æ±å¤§é–€",
            items: [
                { time:"09:30", title:"æ™¯ç¦å®®", desc:"ç©¿éŸ“æœé€²å ´å…è²» (æ¨è–¦In KoreaéŸ“æœ)", map:"ê²½ë³µê¶", type:"normal", note: "" },
                { time:"12:00", type:"meal", title:"è¥¿æ‘åˆé¤", opts:[{n:"åœŸä¿—æ‘è”˜é›æ¹¯", t:"walk"}, {n:"é€šä»å¸‚å ´", t:"walk", tip:"éŠ…éŒ¢ä¾¿ç•¶"}, {n:"å¤§å¾æ›¸åº—", t:"walk", tip:"IUæ‹æ”åœ°"}], note: "" },
                { time:"14:00", title:"å—å¤§é–€å¸‚å ´ (ç«¥è£/æ£‰è¢«)", desc:"Dæ£Ÿæ£‰è¢«(äº¬ä¸€å±‹)ã€Eæ£Ÿ3FèŠ±å¸‚(æ°›åœç‡ˆ)", map:"ë‚¨ëŒ€ë¬¸ì‹œì¥", type:"normal", brands: ["Burdeng", "Mama", "äº¬ä¸€å±‹", "Eæ£Ÿ3Fç‡ˆå…·"], note: "" },
                { time:"15:30", title:"ILKW Showroom (ç‡ˆå…·)", desc:"èµ°è·¯å»å°é¢(æœƒè³¢ç«™)çœ‹Snowmanç‡ˆ", map:"ì¼ê´‘ì „êµ¬ ë¼ì´íŒ…ë£¸ ì„œìš¸", type:"normal", note: "" },
                { time:"16:30", type:"choice", title:"ä¸‹åˆä¸‰é¸ä¸€", desc:"è²·å®Œæ±è¥¿å»å“ªï¼Ÿ", choices: [{n:"A ä¼‘æ¯", desc:"å›é£¯åº—æ”¾æˆ°åˆ©å“", target:"L7 ëª…ë™"}, {n:"B å’–å•¡", desc:"Molto Espresso Bar", target:"ëª°ë˜ ì´íƒˆë¦¬ì•ˆ ì—ìŠ¤í”„ë ˆì†Œë°”"}, {n:"C äº‚æ‰“ç§€", desc:"17:00 å ´æ¬¡ (è¿‘é£¯åº—)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" },
                { time:"19:30", type:"choice", title:"æ™šä¸Šä¸‰é¸ä¸€", desc:"é€›è¡— vs ä¼‘æ¯", choices: [{n:"A é€›è¡—", desc:"æ±å¤§é–€ DDP ç«ç‘°èŠ±æµ·/æ‰¹ç™¼", target:"DDP"}, {n:"B æ±—è’¸", desc:"Sparex æ±—è’¸å¹• æ“æ¾¡ä¼‘æ¯", target:"ìŠ¤íŒŒë ‰ìŠ¤ ë™ëŒ€ë¬¸"}, {n:"C äº‚æ‰“ç§€", desc:"20:00 å ´æ¬¡ (æ˜æ´)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" }
            ]
        },
        { 
            d: 3, date: "1/27 (äºŒ)", title: "å°å­©çš„é¸æ“‡æ—¥",
            items: [
                { type:"choice", title:"è¶…å¤šæ–¹æ¡ˆ (è¦–å¤©æ°£é«”åŠ›)", desc:"Plan A-H ä»»å›æŒ‘é¸", choices: [{n:"A æˆ¶å¤–", desc:"å—æ€¡å³¶/æ»‘é›ª (å¥½å¤©æ°£)", target:"ë‚¨ì´ì„¬"}, {n:"B å®¤å…§", desc:"æ¨‚å¤©ä¸–ç•Œ+æ°´æ—é¤¨ (è ¶å®¤)", target:"ë¡¯ë°ì›”ë“œ"}, {n:"C æ°´æ—", desc:"COEX æ°´æ—é¤¨+æ˜Ÿç©ºåœ–æ›¸é¤¨", target:"ì½”ì—‘ìŠ¤ ì•„ì¿ ì•„ë¦¬ì›€"}, {n:"D å‹•ç•«", desc:"é¦–çˆ¾å‹•ç•«ä¸­å¿ƒ (Pororo/Tayoæœ¬ç‡Ÿ)", target:"ì„œìš¸ì• ë‹ˆë©”ì´ì…˜ì„¼í„°"}, {n:"E HiKR", desc:"å¥½å®¢ç©ºé–“ (å…è²»åª’é«”è—è¡“)", target:"í•˜ì´ì»¤ê·¸ë¼ìš´ë“œ"}, {n:"F æ¨‚åœ’", desc:"Pororo Park (è ¶å®¤) å°å­©æœ€æ„›", target:"ë½€ë¡œë¡œíŒŒí¬ ë¡¯ë°ì›”ë“œì "}, {n:"G å‚³çµ±", desc:"å»£è—å¸‚å ´+DDP", target:"DDP"}, {n:"H å‹•ç‰©", desc:"å…’ç«¥å¤§å…¬åœ’", target:"ì„œìš¸ì–´ë¦°ì´ëŒ€ê³µì›"}] },
                { title:"ç‰¹è‰²ç¾é£Ÿæ¨è–¦", desc:"æƒ³åƒæµ·é®®æ‹‰éºµï¼Ÿæ¨è–¦å»å¼˜å¤§/æ±Ÿå—", map:"", type:"normal", brands: ["æ¿Ÿå·é‡‘è¬ç¦", "æ–‡ä¾†æ´ Chae Yoon Hee"], note: "" },
                { time:"19:00", type:"choice", title:"å¤œæ™šå››é¸ä¸€", desc:"çœ‹é«”åŠ›æ±ºå®š", choices: [{n:"A æ™¯é»", desc:"å—å±±å¡”å¤œæ™¯ (æ­çºœè»Š)", target:"ë‚¨ì‚°ì¼€ì´ë¸”ì¹´"}, {n:"B æŒ‰æ‘©", desc:"æ˜æ´æŒ‰æ‘© + åƒç‚¸é›", target:"BHCì¹˜í‚¨ ëª…ë™ë³¸ì "}, {n:"C æ•£æ­¥", desc:"æ¸…æºªå· æ•£æ­¥çœ‹ç‡ˆå…‰", target:"ì²­ê³„ì²œ"}, {n:"D äº‚æ‰“ç§€", desc:"20:00 å ´æ¬¡ (èˆ’å£“)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] }
            ]
        },
        { 
            d: 4, date: "1/28 (ä¸‰)", title: "ç‹é·—äº­ & è–æ°´æ´",
            items: [
                { time:"11:00", title:"ç‹é·—äº­ æ½®ç‰Œå·¡ç¦®", desc:"å³¶å±±å…¬åœ’å‘¨é‚Šï¼Œé«˜ç´šæ„Ÿæ»¿æ»¿", map:"í•˜ìš°ìŠ¤ ë„ì‚°", type:"normal", brands: ["Haus Dosan", "StÃ¼ssy", "Supreme", "London Bagel (å¤–å¸¶)"], note: "" },
                { time:"14:30", type:"choice", title:"è–æ°´æ´ä¸‰é¸ä¸€", desc:"é€›è¡— vs æºœå°å­©", choices: [{n:"A é€›è¡—", desc:"Dior/ADER/LCDC æ½®ç‰Œå·¡ç¦®", target:"ì„±ìˆ˜ë™ ì¹´í˜ê±°ë¦¬"}, {n:"B å…¬åœ’", desc:"é¦–çˆ¾æ—å…¬åœ’ æ•£æ­¥çœ‹é¹¿", target:"ì„œìš¸ìˆ²"}, {n:"C äº‚æ‰“ç§€", desc:"å›æ˜æ´çœ‹ 17:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] },
                { time:"17:00", type:"meal", title:"è–æ°´æ´æ™šé¤", opts:[{n:"ç¥–å‚³é¦¬éˆ´è–¯æ¹¯", t:"wait"}, {n:"Daelim Guksu", t:"walk", tip:"æº«éºµ"}, {n:"Onion Cafe", t:"walk"}], note: "" },
                { time:"20:00", type:"choice", title:"æ™šä¸ŠçºŒæ”¤", desc:"åƒé£½å¾Œæ´»å‹•", choices: [{n:"A äº‚æ‰“ç§€", desc:"20:00 å ´æ¬¡ (ç¶“å…¸å¿…çœ‹)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}, {n:"B é€›è¡—", desc:"Olive Young æ˜æ´æ——è‰¦åº—", target:"ì˜¬ë¦¬ë¸Œì˜ ëª…ë™"}] }
            ]
        },
        { 
            d: 5, date: "1/29 (å››)", title: "æ±çŸ£å³¶ ç¾ä»£ç™¾è²¨",
            items: [
                { time:"10:30", title:"Zoolung Zoolung", desc:"æ°¸ç™»æµ¦å®¤å…§å‹•ç‰©åœ’ (è¦ªå­)", map:"ì£¼ë ì£¼ë  ì˜ë“±í¬", type:"normal", note: "" },
                { time:"13:30", title:"The Hyundai Seoul", desc:"ç¾ä»£ç™¾è²¨ï¼Œç›®å‰é¦–çˆ¾æœ€å¤§æœ€æ½®", map:"ë”í˜„ëŒ€ ì„œìš¸", type:"normal", brands: ["Matin Kim", "Marithe", "Arket", "Blue Bottle"], note: "" },
                { type:"choice", title:"å‚æ™šä¸‰é¸ä¸€", desc:"å®¤å…§ vs æˆ¶å¤–", choices: [{n:"A é€›è¡—", desc:"ç™¾è²¨B1/B2 ç¹¼çºŒé€›/åƒæ™šé¤", target:"ë”í˜„ëŒ€ ì„œìš¸"}, {n:"B æ°´æ—", desc:"63å¤§æ¨“ Aqua Planet æ°´æ—é¤¨", target:"ì•„ì¿ ì•„í”Œë¼ë„· 63"}, {n:"C äº‚æ‰“ç§€", desc:"å›æ˜æ´çœ‹ 17:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] },
                { time:"19:00", type:"choice", title:"æ™šé¤ä¸‰é¸ä¸€", desc:"åœ¨åœ°é«”é©—", choices: [{n:"A æµ·é®®", desc:"é·ºæ¢æ´¥æ°´ç”¢å¸‚å ´ åƒå¸ç‹èŸ¹", target:"ë…¸ëŸ‰ì§„ìˆ˜ì‚°ì‹œì¥"}, {n:"B æ¼¢æ±Ÿ", desc:"æ¼¢æ±Ÿå…¬åœ’ åƒç…®æ³¡éºµ", target:"ì—¬ì˜ë„í•œê°•ê³µì›"}, {n:"C äº‚æ‰“ç§€", desc:"è¶•å›æ˜æ´çœ‹ 20:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] }
            ]
        },
        { 
            d: 6, date: "1/30 (äº”)", title: "å¼˜å¤§ & æœ›é ",
            items: [
                { time:"11:00", title:"å¼˜å¤§å•†åœˆ å¿…é€›", desc:"AK Plaza, Object, Shoopen", map:"í™ëŒ€ì…êµ¬ì—­", type:"normal", brands: ["Object", "Musinsa", "Shoopen", "Butter"], note: "" },
                { time:"12:30", type:"meal", title:"å¼˜å¤§åˆé¤", opts:[{n:"ç”³ç¾äº¬è¾£ç‚’é›æ’", t:"walk"}, {n:"è±¬è…³å°å§", t:"walk"}], note: "" },
                { type:"choice", title:"ä¸‹åˆå››é¸ä¸€", desc:"æ–‡é’ vs å‚³çµ±", choices: [{n:"A å»¶å—", desc:"å»¶å—æ´ æ–‡é’å’–å•¡/å°åº—", target:"ì—°ë‚¨ë™"}, {n:"B ç›Šå–„", desc:"ç›Šå–„æ´ éŸ“å±‹å’–å•¡/é£¾å“", target:"ìµì„ ë™"}, {n:"C å¸‚å ´", desc:"æœ›é å¸‚å ´ åƒç‚¸é›/å¯æ¨‚é¤…", target:"ë§ì›ì‹œì¥"}, {n:"D äº‚æ‰“ç§€", desc:"17:00 å ´æ¬¡ (éœ€å›æ˜æ´)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] },
                { time:"18:30", title:"æ¨‚å¤©è¶…å¸‚", desc:"é¦–çˆ¾ç«™åšæœ€å¾Œé›¶é£Ÿæ¡è³¼", map:"ë¡¯ë°ë§ˆíŠ¸ ì„œìš¸ì—­ì ", type:"normal", note: "" }
            ]
        },
        { 
            d: 7, date: "1/31 (å…­)", title: "å›å®¶",
            items: [
                { time:"08:30", title:"Check-out", desc:"æ­æ©Ÿå ´å·´å£« 6001/6015 å‰å¾€ä»å·", type:"normal", note: "" },
                { time:"11:00", title:"æ©Ÿå ´é ˜å–å…ç¨…å“", desc:"éæµ·é—œå¾Œå»é ˜è²¨æ«ƒæª¯", type:"normal", note: "" },
                { time:"12:00", title:"èµ·é£›", desc:"å¹³å®‰å›å®¶", type:"normal", note: "" }
            ]
        }
    ];

    const DOC_ID = "seoul_trip_data_v28"; // Updated ID

    const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

    // --- Guide Data ---
    const popupList = ref([
        { title: "é¦–çˆ¾ç‡ˆç¯€ & å…‰åŒ–é–€å¸‚é›†", desc: "å†¬å­£å¿…å»ï¼å°±åœ¨æ™¯ç¦å®®å‰", tag: "é™å®š", tagClass: "bg-orange-100 text-orange-600", modalTitle: "é¦–çˆ¾ç‡ˆç¯€ & å…‰åŒ–é–€å¸‚é›†", modalDesc: "æ™‚é–“ï¼šé è¨ˆè‡³ 1æœˆåº•\nåœ°é»ï¼šå…‰åŒ–é–€å»£å ´~æ¸…æºªå·\n\nå…§å®¹ï¼šè¶…å¤§å‹èŠ±ç‡ˆå±•ç¤ºã€å†¬å­£ç¾é£Ÿå¸‚é›† (é¯›é­šç‡’/ç†±ç´…é…’)ã€æ–‡å‰µå°ç‰©ã€‚\n\næ¨è–¦ï¼šDay 2 é€›å®Œæ™¯ç¦å®®å¾Œé †è·¯å»ã€‚" },
        { title: "é¦–çˆ¾å»£å ´æºœå†°å ´", desc: "å¸‚ä¸­å¿ƒæˆ¶å¤–æºœå†°ï¼Œè¶…ä¾¿å®œ", tag: "é«”é©—", tagClass: "bg-blue-100 text-blue-600", modalTitle: "é¦–çˆ¾å»£å ´æºœå†°å ´", modalDesc: "åœ°é»ï¼šå¸‚å»³ç«™ (æ˜æ´èµ°è·¯å¯åˆ°)\nè²»ç”¨ï¼šç´„ 1000 éŸ“å…ƒ\n\nå…§å®¹ï¼šæˆ¶å¤–æºœå†°ï¼Œå°±åœ¨é¦–çˆ¾åœ–æ›¸é¤¨å‰ã€‚" },
        { title: "ç¾ä»£ç™¾è²¨ å¿«é–ƒåº—", desc: "B2 / 5F å¸¸æœ‰å¤§å‹IPæ´»å‹•", tag: "ç†±é–€", tagClass: "bg-purple-100 text-purple-600", modalTitle: "The Hyundai Seoul å¿«é–ƒ", modalDesc: "åœ°é»ï¼šæ±çŸ£å³¶ (Day 5)\nä½ç½®ï¼šB2 ICONIC SQUARE / 5F Sounds Forest\n\næ”»ç•¥ï¼š1æœˆåº•é€šå¸¸æœ‰å¤§å‹ IP (å¦‚ Kakao/Line/éŸ“æ¼«) å¿«é–ƒã€‚å»ºè­°ä¸€åˆ°ç™¾è²¨å…ˆå» B2 æ©Ÿå™¨å€™ä½ã€‚" }
    ]);
    const brandList = ref([
        { title: "Olive Young å¤§ä¿ƒ", desc: "æ˜æ´æ——è‰¦åº— | æ»¿é¡é€€ç¨…", tag: "SALE", tagClass: "bg-red-100 text-red-600", modalTitle: "Olive Young 1æœˆå„ªæƒ ", modalDesc: "æ´»å‹•ï¼šå†¬å­£ä¿é¤Šå“ä¿ƒéŠ·\næ¨è–¦ï¼šTorriden é¢è†œã€Round Lab é˜²æ›¬ã€‚\n\nTip: æ˜æ´æ——è‰¦åº—è²¨æœ€å…¨ã€‚" },
        { title: "Gentle Monster", desc: "Haus Dosan | æ–°æ¬¾è©¦æˆ´", tag: "æ–°å“", tagClass: "bg-gray-100 text-gray-800", modalTitle: "Gentle Monster", modalDesc: "åœ°é»ï¼šç‹é·—äº­ Haus Dosan\nå…§å®¹ï¼šå…¨æ–°æœå‡ç³»åˆ—å¤ªé™½çœ¼é¡ä¸Šæ¶ã€‚" }
    ]);
    const survivalCards = [
        { title: "ä½ å¥½", k: "ì•ˆë…•í•˜ì„¸ìš”", icon: "ğŸ‘‹", desc: "å®‰å¦å“ˆã„™ã„Ÿå‘¦" }, { title: "è¬è¬", k: "ê°ì‚¬í•©ë‹ˆë‹¤", icon: "ğŸ™", desc: "åº·æ’’å“ˆå’ªæ­" },
        { title: "æˆ‘è¦é€™å€‹", k: "ì´ê±° ì£¼ì„¸ìš”", icon: "ğŸ‘‰", desc: "ä¼Šå‹¾ æœ±ã„™ã„Ÿå‘¦" }, { title: "æ´—æ‰‹é–“", k: "í™”ì¥ì‹¤", icon: "ğŸš»", desc: "èŠ±æ±Ÿæ´—" },
        { title: "ä¾¿å®œé»", k: "ê¹ì•„ì£¼ì„¸ìš”", icon: "ğŸ’¸", desc: "å˜å˜æœ±ã„™ã„Ÿå‘¦" }, { title: "è¢‹å­", k: "ë´‰íˆ¬ ì£¼ì„¸ìš”", icon: "ğŸ›ï¸", desc: "å´©åœŸ æœ±ã„™ã„Ÿå‘¦" }
    ];

    createApp({
        setup() {
            const currentView = ref('plan');
            const itinerary = ref([]);
            const selectedDayIndex = ref(0);
            const dbStatus = ref('connecting');
            const loading = ref(true);
            const showFileMenu = ref(false);
            
            // Edit Modal State
            const showEditModal = ref(false);
            const editingItem = ref(null);
            const isSaving = ref(false);
            const editForm = reactive({ mode: 'add', dIdx: 0, iIdx: 0, type: 'normal', time: '', title: '', desc: '', map: '', brandsStr: '', note: '', subItems: [] });

            // Calc & Weather
            const calcInput = ref('');
            const rate = ref(0.024);
            const weather = reactive({ temp: '--', desc: 'è¼‰å…¥ä¸­', icon: 'fa-cloud' });
            
            // Info Modal
            const infoModal = reactive({ show: false, title: '', desc: '' });
            
            const currentDay = computed(() => itinerary.value[selectedDayIndex.value]);
            const statusText = computed(() => {
                if (dbStatus.value === 'connected') return 'å·²é€£ç·š';
                if (dbStatus.value === 'empty') return 'æ–°è¡Œç¨‹';
                return 'é›¢ç·šæ¨¡å¼';
            });
            const calcTwd = computed(() => Math.round((parseFloat(calcInput.value)||0) * rate.value).toLocaleString());
            const calcTax = computed(() => { 
                const v = parseFloat(calcInput.value)||0; 
                if(v < 30000) return 0;
                return 'â‚© ' + (v>=75000?5000:1500).toLocaleString(); 
            });

            // --- Database Sync Logic ---
            onMounted(async () => {
                fetchWeather();
                if (!db) {
                    dbStatus.value = 'error';
                    loading.value = false;
                    itinerary.value = DEFAULT_ITINERARY;
                    return;
                }

                try {
                    const docRef = doc(db, "trips", DOC_ID);
                    
                    onSnapshot(docRef, (docSnap) => {
                        loading.value = false;
                        if (docSnap.exists()) {
                            itinerary.value = docSnap.data().itinerary;
                            dbStatus.value = 'connected';
                        } else {
                            // Empty DB -> Initialize with Default Data
                            setDoc(doc(db, "trips", DOC_ID), {
                                itinerary: DEFAULT_ITINERARY,
                                lastUpdated: new Date()
                            });
                            itinerary.value = DEFAULT_ITINERARY;
                            dbStatus.value = 'connected';
                        }
                    }, (error) => {
                        console.error("ç›£è½å¤±æ•—:", error);
                        dbStatus.value = 'error';
                        itinerary.value = DEFAULT_ITINERARY;
                        loading.value = false;
                    });

                } catch (e) {
                    console.error("Firebase é€£ç·šéŒ¯èª¤", e);
                    dbStatus.value = 'error';
                    itinerary.value = DEFAULT_ITINERARY;
                    loading.value = false;
                }
            });

            const addNewDay = async () => {
                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                newItinerary.push({ d: newItinerary.length + 1, date: `Day ${newItinerary.length + 1}`, title: "æ–°çš„ä¸€å¤©", items: [] });
                itinerary.value = newItinerary;
                if(db) await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary });
            };
            
            const uploadDefaultData = async () => {
                if(!db) return;
                try {
                    loading.value = true;
                    await setDoc(doc(db, "trips", DOC_ID), {
                        itinerary: DEFAULT_ITINERARY,
                        lastUpdated: new Date()
                    });
                } catch(e) {
                    alert("åˆå§‹åŒ–å¤±æ•—: " + e.message);
                    loading.value = false;
                }
            };

            const openEditModal = (dIdx, iIdx, item) => {
                editingItem.value = { dIdx, iIdx };
                editForm.title = item.title;
                editForm.note = item.note || '';
                
                // Advanced Edit Logic
                editForm.mode = 'edit';
                editForm.type = item.type || 'normal';
                editForm.time = item.time || '';
                editForm.desc = item.desc || '';
                editForm.map = item.map || '';
                editForm.brandsStr = item.brands ? item.brands.join(',') : '';
                editForm.subItems = [];
                if(item.opts) editForm.subItems = JSON.parse(JSON.stringify(item.opts));
                if(item.choices) editForm.subItems = JSON.parse(JSON.stringify(item.choices));
                
                showEditModal.value = true;
            };

            const openModal = (mode, dIdx) => {
                 editForm.mode = 'add';
                 editForm.dIdx = dIdx;
                 editForm.type = 'normal';
                 editForm.time = '';
                 editForm.title = '';
                 editForm.desc = '';
                 editForm.map = '';
                 editForm.brandsStr = '';
                 editForm.note = '';
                 editForm.subItems = [];
                 showEditModal.value = true;
            };

            const closeEditModal = () => { showEditModal.value = false; };
            const addSubItem = (type) => { editForm.subItems.push(type === 'meal' ? {n:'', t:'walk', k:'', tip:''} : {n:'Plan', desc:'', target:''}); };
            const removeSubItem = (idx) => { editForm.subItems.splice(idx, 1); };

            const saveEdit = async () => {
                if (!db) return;
                isSaving.value = true;
                const newItem = { title: editForm.title, desc: editForm.desc, time: editForm.time, note: editForm.note, type: editForm.type };
                if (editForm.type === 'normal') { newItem.map = editForm.map; if(editForm.brandsStr) newItem.brands = editForm.brandsStr.split(/,|ï¼Œ/).map(s=>s.trim()).filter(s=>s); }
                else if (editForm.type === 'meal') newItem.opts = editForm.subItems;
                else if (editForm.type === 'choice') newItem.choices = editForm.subItems;

                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                if (editForm.mode === 'add') newItinerary[editForm.dIdx].items.push(newItem);
                else newItinerary[editForm.dIdx].items[editingItem.value.iIdx] = newItem;

                itinerary.value = newItinerary;
                try { await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary }); showEditModal.value = false; } catch (e) { alert("å„²å­˜å¤±æ•—"); } finally { isSaving.value = false; }
            };
            
            const deleteItem = async () => {
                if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                newItinerary[editForm.dIdx].items.splice(editingItem.value.iIdx, 1);
                try { await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary }); showEditModal.value = false; } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
            };

            // --- File Management ---
            const downloadItinerary = () => {
                const dataStr = JSON.stringify(itinerary.value, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `seoul_trip_backup_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
                showFileMenu.value = false;
            };

            const uploadItinerary = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            itinerary.value = importedData;
                            if(db) await setDoc(doc(db, "trips", DOC_ID), { itinerary: importedData });
                            alert("åŒ¯å…¥æˆåŠŸï¼");
                            showFileMenu.value = false;
                        } else { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
                    } catch (err) { alert("è®€å–å¤±æ•—"); }
                };
                reader.readAsText(file);
            };

            const clearItinerary = async () => {
                if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿå»ºè­°å…ˆå‚™ä»½ï¼")) return;
                itinerary.value = [];
                if(db) await setDoc(doc(db, "trips", DOC_ID), { itinerary: [] });
                showFileMenu.value = false;
            };

            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current=temperature_2m,weather_code&timezone=Asia%2FSeoul');
                    const d = await res.json();
                    weather.temp = Math.round(d.current.temperature_2m);
                    weather.desc = d.current.weather_code > 2 ? 'å¤šé›²' : 'æ™´æœ—';
                    weather.icon = d.current.weather_code > 2 ? 'fa-cloud' : 'fa-sun';
                } catch(e) {}
            };
            const selectDay = (idx) => selectedDayIndex.value = idx;
            const resetCalc = () => calcInput.value = '';
            
            const getSearchLink = (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`;
            const getNaverLink = (k) => `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(k)}`;
            const openInfoModal = (title, desc) => { infoModal.title = title; infoModal.desc = desc; infoModal.show = true; };
            const checkUpdates = (t) => { if(t==='popup') popupList.value.unshift({title:"NewJeanså¿«é–ƒ", desc:"å¼˜å¤§AK Plaza", tag:"NEW", tagClass:"bg-teal-100 text-teal-600"}); else brandList.value.unshift({title:"Stussyè£œè²¨", desc:"ç‹é·—äº­", tag:"HOT", tagClass:"bg-red-100 text-red-600"}); alert('å·²æ›´æ–°'); };

            return {
                itinerary, selectedDayIndex, currentDay: computed(() => itinerary.value[selectedDayIndex.value]),
                dbStatus, loading, statusText: computed(() => connectionState.value === 'online' ? 'å·²é€£ç·šé›²ç«¯' : 'é›¢ç·šæ¨¡å¼'), connectionState,
                showEditModal, editForm, openModal, closeEditModal, saveEdit, deleteItem, isSaving, addSubItem, removeSubItem, addNewDay, uploadDefaultData,
                showFileMenu, downloadItinerary, uploadItinerary, clearItinerary,
                currentView, weather, fetchWeather, selectDay,
                calcInput, calcTwd, calcTax, resetCalc, rate,
                survivalCards, infoModal, openInfoModal, popupList, brandList, checkUpdates,
                getSearchLink, getNaverLink
            };
        }
    }).mount('#app');
</script>
</body>
</html>

