<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¦–çˆ¾ 2026 (v39 AIç„¡é™æ“´å……ç‰ˆ)</title>
    
    <!-- PWA Manifest -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F1F6">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi5a6W54i+MjAyNiIsImRpc3BsYXkiOiJzdGFuZGFxvbmUiLCJzdGFydF91cmwiOiIvIiwiaWNvbnMiOltdfQ==" />

    <!-- Resource Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CUTE ROUND FONT -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { bg: '#F2F1F6', primary: '#C8A47E', 'primary-dark': '#A68665', 'accent-green': '#34C759', 'flight-blue': '#003087', 'ai-purple': '#8B5CF6' }, boxShadow: { 'ios': '0 2px 8px rgba(0,0,0,0.04)' } } } }
    </script>
    <style>
        /* Apply Rounded Font Everywhere */
        body, input, textarea, button, select { font-family: "M PLUS Rounded 1c", sans-serif; }
        
        /* Mobile Viewport Fixes */
        body { background-color: #333; overflow: hidden; position: fixed; inset: 0; width: 100%; height: 100dvh; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; } .hide-scroll::-webkit-scrollbar { display: none; }
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); } .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; } .fade-enter-from, .fade-leave-to { opacity: 0; }
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; } .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(-20px); }
        a { -webkit-touch-callout: none; }
        
        .ai-content p { margin-bottom: 0.5rem; }
        .ai-content ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }
        .ai-content strong { color: #8B5CF6; font-weight: 800; }
        .draggable-btn { touch-action: none; user-select: none; transition: transform 0.1s; }
        .draggable-btn:active { transform: scale(0.95); }
        .skeleton { background: #e0e0e0; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; border-radius: 12px; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .new-item-highlight { animation: highlight-pulse 2s ease-out; }
        @keyframes highlight-pulse { 0% { background-color: #FEF9C3; transform: scale(1.02); } 100% { background-color: white; transform: scale(1); } }
        
        .global-spinner { position: fixed; top: 15px; right: 15px; z-index: 9999; pointer-events: none; }
    </style>
</head>
<body class="text-gray-900 select-none flex justify-center items-center bg-gray-800/50 backdrop-blur-sm">

<!-- Success Toast -->
<div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 z-[200] bg-gray-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl transition-all duration-300 opacity-0 pointer-events-none flex items-center gap-3 border border-white/10">
    <i id="toast-icon" class="fa-solid fa-check-circle text-green-400"></i> 
    <span id="toast-msg" class="font-bold text-sm">æ“ä½œæˆåŠŸ</span>
</div>

<!-- Global Background Spinner -->
<div v-if="globalLoading" class="global-spinner">
    <div class="bg-white/90 backdrop-blur text-primary-dark px-3 py-1.5 rounded-full shadow-lg text-xs font-bold flex items-center gap-2 border border-gray-100">
        <i class="fa-solid fa-circle-notch animate-spin text-ai-purple"></i> AI æ¢ç´¢æ–°åœ°é»...
    </div>
</div>

<div id="app" class="relative w-full h-full max-w-[480px] bg-[#F2F1F6] shadow-2xl flex flex-col md:h-[95dvh] md:rounded-[40px] md:overflow-hidden md:border-[8px] md:border-gray-900">
    <!-- Header -->
    <header class="flex-none px-5 py-3 pt-[calc(12px+env(safe-area-inset-top))] bg-bg/90 backdrop-blur-md border-b border-black/5 z-50 flex justify-between items-center sticky top-0">
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight text-gray-900 flex items-center gap-2">
                SEOUL 2026 <span :class="['w-2 h-2 rounded-full', dbStatus === 'connected' ? 'bg-green-500 animate-pulse' : (dbStatus === 'cached' ? 'bg-yellow-400' : 'bg-red-400')]"></span>
            </h1>
            <p class="text-xs font-semibold text-gray-400 -mt-1">{{ statusText }}</p>
        </div>
        <button v-if="dbStatus === 'empty'" @click="uploadDefaultData" class="text-xs bg-primary text-white px-3 py-1 rounded-full font-bold shadow-sm animate-bounce">åˆå§‹åŒ– v39</button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden hide-scroll relative w-full">
        <div class="pb-[20px]"> 
            <!-- PLAN VIEW -->
            <div v-show="currentView === 'plan'">
                <div v-if="loading" class="p-4 space-y-5">
                    <div class="skeleton h-32 w-full rounded-[24px]"></div>
                    <div class="flex gap-2 overflow-hidden"><div class="skeleton h-16 w-16 flex-none rounded-2xl"></div><div class="skeleton h-16 w-16 flex-none rounded-2xl"></div><div class="skeleton h-16 w-16 flex-none rounded-2xl"></div></div>
                    <div class="space-y-4"><div class="skeleton h-20 w-full rounded-[20px]"></div><div class="skeleton h-32 w-full rounded-[20px]"></div></div>
                </div>

                <div v-else class="p-4 space-y-5">
                    <!-- Weather Card -->
                    <div @click="openWeatherModal" class="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-[#6DD5FA] to-[#2980B9] p-5 text-white shadow-lg active:scale-95 transition-transform cursor-pointer group">
                        <div class="absolute right-0 top-0 p-2 opacity-90 text-[10px] font-bold bg-white/20 rounded-bl-xl backdrop-blur-sm flex items-center gap-1"><i class="fa-solid fa-hand-pointer animate-pulse"></i> é»æ“Šçœ‹ 7 å¤©é å ±</div>
                        <div class="relative z-10 flex justify-between items-center">
                            <div><div class="text-4xl font-extrabold tracking-tighter">{{ weather.temp }}<span v-if="weather.temp !== '--'">Â°</span></div><div class="text-sm font-bold opacity-90 mt-1">{{ weather.desc }}</div></div><i :class="['fa-solid text-4xl opacity-90', weather.icon]"></i>
                        </div>
                    </div>

                    <!-- Date Slider -->
                    <div class="sticky top-0 z-40 -mx-4 px-4 py-2 bg-[#F2F1F6]/95 backdrop-blur-sm">
                        <div class="flex gap-2 overflow-x-auto hide-scroll pb-2">
                            <div v-for="(day, index) in itinerary" :key="index" @click="selectedDayIndex = index" :class="['flex-none w-[70px] p-2.5 rounded-2xl text-center transition-all cursor-pointer border border-transparent shadow-sm', selectedDayIndex === index ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-white text-gray-400']">
                                <div class="text-[10px] font-bold opacity-80">Day {{ day.d }}</div><div class="text-lg font-extrabold leading-tight">{{ day.date.split(' ')[0] }}</div>
                            </div>
                        </div>
                    </div>
                    <!-- Items -->
                    <div :key="selectedDayIndex" class="space-y-4">
                        <div class="bg-white rounded-2xl p-5 text-center shadow-ios border border-gray-100/50">
                            <h2 class="text-xl font-extrabold text-gray-800">{{ currentDay?.title }}</h2><div class="text-xs text-gray-400 mt-1">{{ currentDay?.date }}</div>
                        </div>
                        
                        <transition-group name="list" tag="div" class="space-y-4">
                        <div v-for="(item, idx) in currentDay?.items" :key="item.title + idx" class="relative group">
                            <button @click="openModal('edit', selectedDayIndex, idx, item)" class="absolute -right-2 -top-2 z-10 w-8 h-8 bg-gray-900 rounded-full text-white text-xs flex items-center justify-center shadow-lg opacity-80 hover:opacity-100 transition-opacity"><i class="fa-solid fa-pen"></i></button>
                            
                            <div v-if="item.type === 'flight'" class="bg-gradient-to-r from-flight-blue to-blue-600 rounded-[20px] text-white shadow-lg overflow-hidden relative">
                                <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
                                <div class="p-5 relative z-10">
                                    <div class="flex justify-between items-start mb-4"><div class="text-xs font-bold bg-white/20 px-2 py-1 rounded backdrop-blur-sm border border-white/10"><i class="fa-solid fa-plane-up mr-1"></i> {{ item.flightNo || 'FLIGHT' }}</div><div class="text-right"><div class="text-xs opacity-70">BOARDING</div><div class="font-mono font-bold text-lg leading-none">{{ item.time }}</div></div></div>
                                    <div class="flex justify-between items-center px-2"><div class="text-center"><div class="text-3xl font-black tracking-tighter">{{ item.dep }}</div><div class="text-[10px] opacity-70 font-bold mt-1">é«˜é›„ KHH</div></div><div class="flex-1 flex flex-col items-center px-4"><i class="fa-solid fa-plane text-white/50 rotate-90 text-xl"></i><div class="h-0.5 w-full bg-white/20 mt-[-10px]"></div><div class="text-[10px] mt-2 opacity-60">{{ item.duration }}</div></div><div class="text-center"><div class="text-3xl font-black tracking-tighter">{{ item.arr }}</div><div class="text-[10px] opacity-70 font-bold mt-1">é¦–çˆ¾ ICN</div></div></div>
                                </div>
                                <div class="bg-white/10 p-3 flex justify-between items-center text-[10px] font-bold tracking-wide relative"><div class="absolute top-0 left-0 w-full border-t border-dashed border-white/30"></div><span>{{ item.desc }}</span><i class="fa-solid fa-chevron-right opacity-50"></i></div>
                            </div>

                            <div v-else-if="!item.type || item.type === 'normal'" class="bg-white rounded-[20px] p-4 shadow-ios border border-gray-50 flex justify-between items-start">
                                <div class="flex-1 min-w-0 pr-3">
                                    <button v-if="item.detail" @click="openInfoModal(item.title, item.detail, null, item.map || item.title)" class="font-bold text-base text-gray-800 block flex items-center gap-1 text-left w-full hover:opacity-70 transition-opacity">{{ item.title }} <i class="fa-solid fa-circle-info text-[12px] text-blue-400 animate-pulse"></i></button>
                                    <a v-else :href="getSearchLink(item.title)" target="_blank" class="font-bold text-base text-gray-800 block flex items-center gap-1">{{ item.title }} <i v-if="item.map" class="fa-solid fa-location-dot text-[10px] text-primary opacity-50"></i><i v-else class="fa-solid fa-magnifying-glass text-[10px] text-blue-300 opacity-50"></i></a>
                                    <div class="text-xs text-gray-500 mt-1 whitespace-pre-line">{{ item.desc }}</div>
                                    <div v-if="item.brands" class="flex flex-wrap gap-1.5 mt-2"><a v-for="b in item.brands" :href="getSearchLink(b + ' ' + item.title)" target="_blank" class="px-2 py-0.5 rounded text-[10px] bg-gray-50 border border-gray-100 text-gray-600 hover:bg-gray-100">{{ b }}</a></div>
                                    <div v-if="item.note" class="mt-2 bg-yellow-50 text-yellow-800 text-xs p-2 rounded-lg border border-yellow-100 flex gap-2 items-start"><i class="fa-solid fa-sticky-note mt-0.5 opacity-50"></i><span>{{ item.note }}</span></div>
                                </div>
                                <div class="flex flex-col items-end gap-2 shrink-0">
                                    <span v-if="item.time" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md">{{ item.time }}</span>
                                    <a v-if="item.map" :href="getNaverLink(item.map)" target="_blank" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-accent-green hover:bg-green-100"><i class="fa-solid fa-location-arrow text-sm"></i></a>
                                </div>
                            </div>

                            <div v-else-if="item.type === 'meal'" class="bg-white rounded-[20px] shadow-ios overflow-hidden border border-gray-50">
                                <div class="bg-gray-50/80 px-4 py-3 border-b border-gray-100 flex justify-between items-center"><div class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-utensils text-primary"></i> {{ item.title }} <span class="text-[10px] text-gray-400 font-normal ml-1">(é»é¤å»³çœ‹è©•åƒ¹)</span></div><span v-if="item.time" class="text-xs font-bold text-gray-400 bg-gray-200/50 px-2 py-1 rounded-md">{{ item.time }}</span></div>
                                <div class="p-4 space-y-3">
                                    <div v-for="opt in item.opts" :key="opt.n" @click="openInfoModal(opt.n, opt.detail || 'æš«ç„¡è©•åƒ¹', null, opt.k || opt.n)" class="flex justify-between items-center text-sm cursor-pointer active:scale-[0.98] transition-transform hover:bg-gray-50 p-2 rounded-lg -mx-2">
                                        <div class="flex-1 group"><div class="font-bold text-gray-700 flex items-center gap-1">{{ opt.n }} <i class="fa-solid fa-circle-info text-[10px] text-gray-300 opacity-0 group-hover:opacity-100"></i></div><div v-if="opt.tip" class="text-[10px] text-gray-400">{{ opt.tip }}</div></div>
                                        <div class="flex gap-2 items-center"><span :class="['text-[10px] px-2 py-1 rounded font-bold', opt.t==='res'?'bg-green-100 text-green-700':'bg-red-100 text-red-600']">{{ opt.t==='res'?'é ç´„':'æ’éšŠ' }}</span><a v-if="opt.k" @click.stop :href="getNaverLink(opt.k)" target="_blank" class="w-6 h-6 bg-gray-50 rounded-full flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50"><i class="fa-solid fa-location-arrow text-[10px]"></i></a></div>
                                    </div>
                                    <div v-if="item.note" class="pt-2 mt-2 border-t border-dashed border-gray-200 text-xs text-yellow-700">ğŸ“ {{ item.note }}</div>
                                </div>
                            </div>

                            <div v-else-if="item.type === 'choice'" class="bg-[#FAFAFA] rounded-[20px] p-4 border-2 border-dashed border-gray-200">
                                <div class="flex justify-between items-center mb-1"><div class="text-xs font-bold text-gray-400">{{ item.time || 'æ™‚æ®µ' }}</div><div class="text-center font-bold text-primary-dark">{{ item.title }}</div><div class="w-4"></div></div>
                                <div class="text-center text-xs text-gray-400 mb-3">{{ item.desc }} <span class="text-[9px] opacity-70">(é»é¸é …çœ‹æ”»ç•¥)</span></div>
                                <div class="flex flex-wrap gap-2">
                                    <div v-for="c in item.choices" :key="c.n" @click="openInfoModal(c.n, c.detail || 'æš«ç„¡è©³ç´°è³‡è¨Š', null, c.target)" class="flex-1 min-w-[45%] bg-white p-3 rounded-xl border border-gray-100 text-center shadow-sm flex items-center justify-between group hover:border-primary/30 transition-colors cursor-pointer active:scale-95">
                                        <div class="text-left"><div class="text-[10px] font-bold bg-gray-800 text-white inline-block px-1.5 rounded mb-1">{{ c.n.split(' ')[0] }}</div><div class="text-xs font-bold text-gray-700 flex items-center gap-1">{{ c.desc }} <i class="fa-solid fa-circle-info text-[8px] text-blue-300"></i></div></div>
                                        <div v-if="c.target" @click.stop="window.open(getNaverLink(c.target))" class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50"><i class="fa-solid fa-location-arrow text-[10px]"></i></div>
                                    </div>
                                </div>
                                <div v-if="item.note" class="mt-3 bg-white p-2 rounded border text-xs text-gray-600 text-center shadow-sm"><span class="text-primary font-bold">ç­†è¨˜ï¼š</span> {{ item.note }}</div>
                            </div>
                        </div>
                        </transition-group>
                        
                        <button @click="openModal('add', selectedDayIndex)" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white hover:text-primary hover:border-primary transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹</button>
                        <div class="h-10"></div>
                    </div>
                </div>
            </div>

            <!-- CALC VIEW -->
            <div v-show="currentView === 'calc'" class="p-5">
                <h2 class="text-xl font-extrabold text-gray-900 mb-4 ml-1">åŒ¯ç‡è¨ˆç®—</h2>
                <div class="bg-white rounded-[24px] p-6 shadow-ios border border-gray-50 text-right mb-4">
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-400">è¼¸å…¥éŸ“å¹£ (KRW)</span><button @click="calcInput=''" class="text-xs font-bold text-primary">æ¸…é™¤</button></div>
                    <input type="text" inputmode="decimal" v-model="calcInput" class="w-full text-right text-5xl font-light text-gray-900 placeholder-gray-200 outline-none bg-transparent font-mono mb-4 tracking-tighter" placeholder="0">
                    <div class="border-t border-gray-100 py-3 flex justify-between items-center"><span class="text-sm text-gray-400">ç´„åˆå°å¹£</span><span class="text-xl font-bold font-mono text-gray-800">{{ calcTwd }}</span></div>
                    <div class="pt-2 flex justify-between items-center"><span class="text-sm text-gray-400">é è¨ˆé€€ç¨…</span><span class="text-xl font-bold font-mono text-accent-green">{{ calcTax }}</span></div>
                </div>
                <div class="text-center text-xs text-gray-400">åŒ¯ç‡: {{ rate }} | æ»¿ 30,000 å¯é€€ç¨…</div>
            </div>

            <!-- NEW VIEW: KOREAN -->
            <div v-show="currentView === 'korean'" class="p-4 space-y-5">
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 h-full">
                    <h3 class="font-bold text-lg mb-3 flex justify-between items-center">
                        ç”Ÿå­˜éŸ“èª <span class="text-[10px] font-bold text-white bg-red-400 px-2 py-0.5 rounded-full">é»æ“Šç™¼éŸ³</span>
                    </h3>
                    
                    <div class="flex gap-2 mb-4 overflow-x-auto hide-scroll pb-1">
                        <button v-for="t in koreanTabs" :key="t.id" @click="koreanTab = t.id" :class="['px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors', koreanTab === t.id ? 'bg-gray-800 text-white shadow-md' : 'bg-gray-100 text-gray-400']">{{ t.name }}</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <transition-group name="list">
                            <div v-for="c in filteredKorean" :key="c.title" class="ripple relative border p-3 rounded-2xl hover:bg-gray-50 active:scale-95 transition-all cursor-pointer bg-white shadow-sm flex flex-col items-center justify-center min-h-[100px]" @click="playAudio(c.k)">
                                <div class="text-3xl mb-2">{{ c.icon }}</div>
                                <div class="font-bold text-sm text-gray-800 text-center">{{ c.title }}</div>
                                <div class="text-[10px] text-gray-400 mt-0.5 text-center font-mono">{{ c.desc }}</div>
                                <div class="mt-2 text-xs text-primary/80 font-bold bg-primary/10 px-2 py-0.5 rounded-full"><i class="fa-solid fa-volume-high"></i> ç™¼éŸ³</div>
                            </div>
                        </transition-group>
                    </div>
                </div>
            </div>

            <!-- VIEW: GUIDE -->
            <div v-show="currentView === 'guide'" class="p-4 space-y-5">
                <!-- GUIDE SECTIONS -->
                <div v-for="sec in guideSections" :key="sec.id" class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">{{ sec.title }}</h3>
                        <button @click="fetchAIUpdates(sec.id)" class="text-xs text-primary font-bold flex items-center gap-1 active:opacity-50" :disabled="sec.updating.value">
                            <i class="fa-solid fa-rotate-right transition-transform duration-700" :class="{'animate-spin': sec.updating.value}"></i> æ›´æ–°æƒ…å ±
                        </button>
                    </div>
                    <div class="space-y-2">
                        <transition-group name="list">
                            <div v-for="item in sec.list.value" :key="item.title" :class="['flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors', item.isNew ? 'new-item-highlight' : '']" @click="openInfoModal(item.modalTitle || item.title, item.modalDesc || item.desc, null, item.mapKeyword || item.title)">
                                <span :class="['px-2 py-1 rounded text-xs font-bold h-fit shrink-0', item.tagClass]">{{ item.tag }}</span>
                                <div>
                                    <div class="font-bold text-sm flex items-center gap-2">
                                        {{ item.title }} 
                                        <span v-if="item.isNew" class="text-[9px] bg-red-500 text-white px-1 rounded animate-pulse">NEW</span>
                                        <span v-if="item.isNew" class="text-[9px] bg-blue-100 text-blue-500 px-1 rounded">ğŸ“ å«åœ°åœ–</span>
                                    </div>
                                    <div class="text-xs text-gray-500 line-clamp-1">{{ item.desc }}</div>
                                </div>
                            </div>
                        </transition-group>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Nav (Updated with 4 items) -->
    <nav class="flex-none h-[calc(60px+env(safe-area-inset-bottom))] bg-white/95 backdrop-blur-xl border-t border-gray-200 pb-safe-bottom flex justify-around items-center z-50 w-full">
        <button v-for="tab in ['plan', 'guide', 'korean', 'calc']" :key="tab" @click="currentView = tab" :class="['flex-1 h-full flex flex-col items-center justify-center gap-1 transition-colors', currentView === tab ? 'text-primary-dark' : 'text-gray-400']">
            <i :class="['fa-solid text-xl transition-transform duration-200', tab === 'plan' ? 'fa-calendar-days' : (tab === 'calc' ? 'fa-calculator' : (tab === 'guide' ? 'fa-book-open' : 'fa-language')), currentView === tab ? '-translate-y-0.5' : '']"></i>
            <span class="text-[10px] font-bold tracking-wide">{{ tab === 'plan' ? 'è¡Œç¨‹' : (tab === 'calc' ? 'è¨ˆç®—' : (tab === 'guide' ? 'æ”»ç•¥' : 'éŸ“èª')) }}</span>
        </button>
    </nav>

    <!-- AI CHAT BUTTON & MODAL -->
    <div ref="aiButton" class="fixed z-50 draggable-btn" :style="{ top: aiBtnPos.y + 'px', left: aiBtnPos.x + 'px' }" @touchstart.passive="onAiBtnTouchStart" @touchmove.prevent="onAiBtnTouchMove" @touchend="onAiBtnTouchEnd" @mousedown="onAiBtnMouseDown" @click="onAiBtnClick">
        <button class="w-14 h-14 bg-gradient-to-r from-ai-purple to-pink-500 rounded-full shadow-lg flex items-center justify-center text-white text-2xl animate-bounce cursor-pointer active:scale-95 transition-transform border-4 border-white/30 backdrop-blur-sm pointer-events-none">âœ¨</button>
    </div>

    <transition name="slide-up">
        <div v-if="showAIChat" class="absolute inset-0 z-[150] bg-white flex flex-col h-full safe-area-padding">
            <div class="flex-none px-5 py-4 border-b border-gray-100 flex justify-between items-center bg-white/95 backdrop-blur pt-[calc(12px+env(safe-area-inset-top))]">
                <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-gradient-to-tr from-ai-purple to-pink-400 flex items-center justify-center text-white text-lg">ğŸ¤–</div><div><h3 class="font-extrabold text-gray-900">AI å°éŠ</h3><p class="text-[10px] text-green-500 font-bold flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Online</p></div></div>
                <div class="flex gap-2"><button @click="showApiKeyInput = !showApiKeyInput" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 active:bg-gray-200"><i class="fa-solid fa-gear"></i></button><button @click="showAIChat = false" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 active:bg-gray-200"><i class="fa-solid fa-chevron-down"></i></button></div>
            </div>
            <div v-if="showApiKeyInput" class="p-4 bg-gray-100 border-b border-gray-200 animate-fade-in"><label class="block text-xs font-bold text-gray-500 mb-1">API Key (å·²å…§å»º)</label><div class="flex gap-2"><input v-model="userApiKey" type="password" placeholder="å·²è‡ªå‹•å¡«å…¥" class="flex-1 p-2 rounded text-sm border border-gray-300 opacity-50" readonly></div><p class="text-[10px] text-green-600 mt-1"><i class="fa-solid fa-check"></i> ç³»çµ±é‡‘é‘°å·²å•Ÿç”¨</p></div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" ref="chatContainer"><div v-for="(msg, i) in chatMessages" :key="i" :class="['flex w-full', msg.role === 'user' ? 'justify-end' : 'justify-start']"><div :class="['max-w-[85%] p-3.5 rounded-2xl text-sm leading-relaxed shadow-sm ai-content', msg.role === 'user' ? 'bg-ai-purple text-white rounded-br-none' : 'bg-white text-gray-700 rounded-bl-none border border-gray-100']" v-html="msg.text"></div></div><div v-if="isChatLoading" class="flex justify-start"><div class="bg-white p-3 rounded-2xl rounded-bl-none shadow-sm border border-gray-100 flex gap-1 items-center"><span class="w-2 h-2 bg-gray-300 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-gray-300 rounded-full animate-bounce delay-75"></span><span class="w-2 h-2 bg-gray-300 rounded-full animate-bounce delay-150"></span></div></div></div>
            <div class="flex-none p-2 bg-white border-t border-gray-100 flex gap-2 overflow-x-auto hide-scroll"><button @click="sendMessage('ğŸ˜‹ æ¨è–¦é™„è¿‘ç¾é£Ÿ')" class="flex-none px-4 py-2 bg-orange-50 text-orange-600 rounded-full text-xs font-bold border border-orange-100 whitespace-nowrap active:bg-orange-100">ğŸ˜‹ æ¨è–¦ç¾é£Ÿ</button><button @click="sendMessage('ğŸ‡°ğŸ‡· é€™å¥éŸ“æ–‡æ€éº¼èªªï¼šä½ å¥½')" class="flex-none px-4 py-2 bg-blue-50 text-blue-600 rounded-full text-xs font-bold border border-blue-100 whitespace-nowrap active:bg-blue-100">ğŸ‡°ğŸ‡· éŸ“æ–‡ç¿»è­¯</button><button @click="sendMessage('â˜ï¸ æ˜å¤©é¦–çˆ¾å¤©æ°£å¦‚ä½•ï¼Ÿç©¿ä»€éº¼ï¼Ÿ')" class="flex-none px-4 py-2 bg-cyan-50 text-cyan-600 rounded-full text-xs font-bold border border-cyan-100 whitespace-nowrap active:bg-cyan-100">â˜ï¸ ç©¿æ­å»ºè­°</button><button @click="sendMessage('è«‹å¹«æˆ‘æ–°å¢ä¸€å€‹è¡Œç¨‹åœ¨æ˜å¤©æ—©ä¸Š')" class="flex-none px-4 py-2 bg-purple-50 text-purple-600 rounded-full text-xs font-bold border border-purple-100 whitespace-nowrap active:bg-purple-100">â• æ–°å¢</button><button @click="sendMessage('åˆªé™¤ Day2 çš„å»£è—å¸‚å ´')" class="flex-none px-4 py-2 bg-red-50 text-red-600 rounded-full text-xs font-bold border border-red-100 whitespace-nowrap active:bg-red-100">ğŸ—‘ï¸ åˆªé™¤</button></div>
            <div class="flex-none p-3 bg-white border-t border-gray-100 pb-[calc(10px+env(safe-area-inset-bottom))] flex gap-2 items-center"><input v-model="chatInput" @keyup.enter="sendMessage(chatInput)" type="text" enterkeyhint="send" placeholder="å•å• AI å°éŠ..." class="flex-1 bg-gray-100 border-0 rounded-full px-5 py-3 text-base focus:ring-2 focus:ring-ai-purple/50 outline-none appearance-none"><button @click="sendMessage(chatInput)" :disabled="!chatInput.trim() || isChatLoading" class="w-12 h-12 bg-ai-purple text-white rounded-full flex items-center justify-center disabled:opacity-50 active:scale-90 transition-transform shadow-md"><i class="fa-solid fa-paper-plane"></i></button></div>
        </div>
    </transition>

    <!-- Info Modal -->
    <transition name="fade">
        <div v-if="infoModal.show" class="absolute inset-0 z-[110] bg-black/60 flex items-center justify-center p-6 rounded-[40px] overflow-hidden" @click="infoModal.show = false">
            <div class="bg-white w-full max-w-sm rounded-[30px] p-6 shadow-2xl text-center flex flex-col" @click.stop>
                <div class="flex-1 overflow-y-auto hide-scroll mb-4">
                    <h3 class="text-2xl font-extrabold text-gray-900 mb-1 whitespace-pre-line">{{ infoModal.title.split(' ')[0] }}</h3>
                    <p class="text-lg text-primary font-bold mb-4 font-mono">{{ infoModal.title.split(' ').slice(1).join(' ') }}</p>
                    
                    <button v-if="infoModal.audio" @click="playAudio(infoModal.audio)" class="mb-5 bg-primary text-white w-14 h-14 rounded-full flex items-center justify-center text-xl shadow-lg shadow-primary/30 mx-auto active:scale-90 transition-transform"><i class="fa-solid fa-volume-high"></i></button>
                    
                    <p class="text-base text-gray-600 leading-relaxed whitespace-pre-wrap font-medium text-left">{{ infoModal.desc }}</p>
                </div>

                <div class="flex-none pt-2 border-t border-gray-100 w-full space-y-2">
                    <a v-if="infoModal.mapUrl" :href="infoModal.mapUrl" target="_blank" class="block w-full bg-blue-500 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-transform shadow-md hover:bg-blue-600">
                        <i class="fa-solid fa-map-location-dot mr-2"></i> æŸ¥çœ‹åœ°åœ–ä½ç½®
                    </a>
                    <button @click="infoModal.show = false" class="block w-full bg-gray-100 text-gray-900 font-bold py-3.5 rounded-xl active:scale-95 transition-transform hover:bg-gray-200">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- WEATHER MODAL -->
    <transition name="slide-up">
        <div v-if="weatherModal.show" class="absolute inset-0 z-[120] bg-black/60 backdrop-blur-sm flex items-end justify-center rounded-[40px] overflow-hidden" @click="weatherModal.show = false">
            <div class="bg-white w-full max-h-[85%] rounded-t-[30px] p-6 shadow-2xl flex flex-col" @click.stop>
                <div class="flex justify-between items-center mb-6"><div><h3 class="text-2xl font-extrabold text-gray-900">é¦–çˆ¾å¤©æ°£é å ±</h3><p class="text-xs text-gray-400 font-bold">æœªä¾† 7 å¤©</p></div><button @click="weatherModal.show = false" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
                <div class="flex-1 overflow-y-auto hide-scroll space-y-3">
                    <div v-if="weatherModal.loading" class="text-center py-10 text-gray-400"><i class="fa-solid fa-circle-notch animate-spin text-2xl mb-2"></i><p class="text-xs">è¼‰å…¥æ°£è±¡è³‡æ–™ä¸­...</p></div>
                    <div v-else-if="weatherModal.error" class="text-center py-10 text-red-400"><p>æš«æ™‚ç„¡æ³•å–å¾—å¤©æ°£è³‡è¨Š</p></div>
                    <div v-else v-for="(day, idx) in weatherModal.list" :key="idx" class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                        <div class="flex items-center gap-4"><div class="w-12 text-center"><div class="text-xs font-bold text-gray-400">{{ day.week }}</div><div class="text-lg font-black text-gray-800">{{ day.date }}</div></div><div class="text-2xl text-gray-600 w-8 text-center"><i :class="['fa-solid', day.icon]"></i></div></div>
                        <div class="flex gap-4 text-right"><div><span class="text-xs text-blue-400 font-bold block">ä½</span><span class="text-lg font-bold text-gray-800">{{ day.min }}Â°</span></div><div><span class="text-xs text-red-400 font-bold block">é«˜</span><span class="text-lg font-bold text-gray-800">{{ day.max }}Â°</span></div></div>
                    </div>
                </div>
            </div>
        </div>
    </transition>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    const firebaseConfig = { apiKey: "AIzaSyBFDAs4hj4eJ2hCxsWWlRRCsJC_qEekBCc", authDomain: "trip-plan-app-c38a3.firebaseapp.com", projectId: "trip-plan-app-c38a3", storageBucket: "trip-plan-app-c38a3.firebasestorage.app", messagingSenderId: "79177072268", appId: "1:79177072268:web:e8efe92b05a528046d45a9", measurementId: "G-T39PWKG8GL" };
    
    // --- 1. GEMINI API CONFIG ---
    const apiKey = "AIzaSyBuQy4qcF3DUQasJ6Ltg5boXjsPUEyqYII";

    let db; try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e) { console.error(e); }
    const DOC_ID = "seoul_trip_data_v39"; // ID v39 for Infinite AI
    const { createApp, ref, computed, onMounted, reactive, nextTick, watch } = Vue;

    // --- DATA MOCK (Same as v33) ---
    const DEFAULT_ITINERARY = [ /* ... Same as v33 ... */ 
        { d: 1, date: "1/25 (æ—¥)", title: "å‡ºç™¼ & æ˜æ´", items: [{ type:"choice", title:"å°å— -> å°æ¸¯æ©Ÿå ´", choices:[{n:"é ç´„æ¥é€", desc:"é¦–é¸"}, {n:"è¨ˆç¨‹è»Š", desc:"å‚™æ¡ˆ"}]}, { time:"05:00", title:"ğŸ›« æŠµé”æ©Ÿå ´", type:"normal"}, { type: "flight", time: "07:00", flightNo: "CI 164", dep: "KHH", arr: "ICN", duration: "2h 35m"}, { type:"choice", title:"æ©Ÿå ´ -> æ˜æ´", choices:[{n:"æ©Ÿå ´å·´å£« 6015", desc:"é¦–é¸"}, {n:"AREX", desc:"å‚™é¸"}]}, { time:"13:00", title:"L7 é£¯åº—", type:"normal"}, { type:"meal", title:"æ˜æ´åˆé¤", opts:[{n:"æ±Ÿå—é¢å±‹"}, {n:"æ˜æ´é¤ƒå­"}, {n:"ç¥ä»™é›ªæ¿ƒæ¹¯"}]}, { time:"16:00", type:"choice", title:"ä¸‹åˆè‡ªç”±é¸", choices:[{n:"Olive Young"}, {n:"å··å­é˜¿å§¨"}, {n:"ä¹±æ‰“ç§€"}]}, { title:"æ¨‚å¤©ç™¾è²¨", type:"normal"}, { type:"meal", title:"æ™šé¤", opts:[{n:"Myth è±¬è¹„"}, {n:"ç‹å¦ƒå®¶"}, {n:"BHC ç‚¸é›"}]} ] },
        { d: 2, date: "1/26 (ä¸€)", title: "å—å¤§é–€ & æ±å¤§é–€", items: [{ type:"meal", title:"æ—©é¤", opts:[{n:"Isaac Toast"}]}, { time:"09:30", title:"æ™¯ç¦å®®", type:"normal"}, { type:"meal", title:"åˆé¤", opts:[{n:"åœŸä¿—æ‘è”˜é›æ¹¯"}, {n:"é€šä»å¸‚å ´"}, {n:"é»ƒç”Ÿå®¶"}]}, { time:"14:00", title:"å—å¤§é–€å¸‚å ´", type:"normal"}, { type:"meal", title:"æ™šé¤", opts:[{n:"JoJo Kalguksu"}, {n:"æ™‰å·æœƒé¤¨"}, {n:"æ»¿è¶³äº”é¦™"}]}, { type:"choice", title:"æ™šä¸Š", choices:[{n:"DDP"}, {n:"Sparex"}]} ] },
        { d: 3, date: "1/27 (äºŒ)", title: "COEX & æ±Ÿå—", items: [{ type:"meal", title:"æ—©é¤", opts:[{n:"Eggslut"}]}, { time:"10:00", title:"COEX æ°´æ—é¤¨", type:"normal"}, { type:"meal", title:"åˆé¤", opts:[{n:"æ²³æ±é¤¨"}, {n:"Dim Dim Sum"}]}, { time:"14:00", title:"æ˜Ÿç©ºåœ–æ›¸é¤¨", type:"normal"}, { type:"choice", title:"ä¸‹åˆå‚™æ¡ˆ", choices:[{n:"æ¨‚å¤©ä¸–ç•Œ"}, {n:"Seoul Sky"}, {n:"å…’ç«¥å¤§å…¬åœ’"}]}, { type:"meal", title:"æ™šé¤", opts:[{n:"Kkanbu Chicken"}, {n:"é»‘è±šå®¶"}]} ] },
        { d: 4, date: "1/28 (ä¸‰)", title: "è–æ°´æ´", items: [{ type:"meal", title:"æ—©é¤", opts:[{n:"London Bagel"}, {n:"Milestone"}]}, { time:"11:00", title:"ç‹é·—äº­", type:"normal"}, { time:"13:30", title:"Miffy's Celebration", type:"normal"}, { type:"choice", title:"è–æ°´æ´æ½®ç‰Œ", choices:[{n:"The North Face"}, {n:"Human Made"}, {n:"ADER Error"}, {n:"Matin Kim"}]}, { type:"meal", title:"æ™šé¤", opts:[{n:"ç¥–å‚³é¦¬éˆ´è–¯æ¹¯"}, {n:"Grandma's Recipe"}]}, { type:"choice", title:"æ™šä¸Š", choices:[{n:"äº‚æ‰“ç§€"}, {n:"Olive Young"}]} ] },
        { d: 5, date: "1/29 (å››)", title: "æ±çŸ£å³¶", items: [{ type:"meal", title:"æ—©é¤", opts:[{n:"é£¯åº—"}]}, { time:"10:30", title:"Zoolung Zoolung", type:"normal"}, { time:"13:30", title:"The Hyundai", type:"normal"}, { type:"meal", title:"åˆé¤", opts:[{n:"Eataly"}, {n:"Five Guys"}]}, { type:"choice", title:"æ™šé¤", choices:[{n:"é·ºæ¢æ´¥"}, {n:"æ¼¢æ±Ÿæ³¡éºµ"}]} ] },
        { d: 6, date: "1/30 (äº”)", title: "å¼˜å¤§", items: [{ type:"meal", title:"æ—©é¤", opts:[{n:"Oats Office"}]}, { time:"11:00", title:"å¼˜å¤§å•†åœˆ", type:"normal"}, { type:"choice", title:"ä¸‹åˆèŒ¶", choices:[{n:"Parole & Langue"}, {n:"Mintchoco"}, {n:"Ugly Bakery"}]}, { time:"16:00", title:"FOLNUA", type:"normal"}, { type:"meal", title:"æ™šé¤", opts:[{n:"Hongs ç« é­š"}, {n:"å…ƒå ‚è„Šéª¨"}, {n:"BHC"}]} ] },
        { d: 7, date: "1/31 (å…­)", title: "å›å®¶", items: [{ time:"08:30", title:"Check-out", type:"normal"}, { type:"choice", title:"å›ç¨‹äº¤é€š", choices:[{n:"å·´å£« 6015"}, {n:"AREX"}]}, { type:"flight", time:"12:00", flightNo:"CI 165"}, { type:"choice", title:"å›ç¨‹æ¥é€", choices:[{n:"é ç´„æ¥é€"}]} ] }
    ];
    
    // --- STATIC DATA ---
    const koreanTabs = [{ id: 'all', name: 'å…¨éƒ¨' }, { id: 'basic', name: 'åŸºç¤' }, { id: 'food', name: 'åƒå–' }, { id: 'shop', name: 'è³¼ç‰©' }, { id: 'traffic', name: 'äº¤é€š' }];
    const survivalCards = [ 
        { cat: 'basic', title: "ä½ å¥½", k: "ì•ˆë…•í•˜ì„¸ìš”", icon: "ğŸ‘‹", desc: "å®‰å¦å“ˆã„™ã„Ÿå‘¦" }, { cat: 'basic', title: "è¬è¬", k: "ê°ì‚¬í•©ë‹ˆë‹¤", icon: "ğŸ™", desc: "åº·æ’’å“ˆå’ªæ­" }, { cat: 'basic', title: "å°ä¸èµ·", k: "ì£„ì†¡í•©ë‹ˆë‹¤", icon: "ğŸ™‡", desc: "å´”é€å“ˆå’ªæ­" }, { cat: 'basic', title: "ä¸å¥½æ„æ€", k: "ì €ê¸°ìš”", icon: "ğŸ™‹", desc: "ä¸˜giå‘¦ (å«åº—å“¡ç”¨)" }, { cat: 'basic', title: "æ´—æ‰‹é–“", k: "í™”ì¥ì‹¤", icon: "ğŸš»", desc: "èŠ±æ±Ÿæ´—" }, { cat: 'basic', title: "æ˜¯/å¥½çš„", k: "ë„¤", icon: "â­•", desc: "å…§" }, { cat: 'basic', title: "ä¸æ˜¯", k: "ì•„ë‹ˆìš”", icon: "âŒ", desc: "é˜¿å°¼å‘¦" }, { cat: 'basic', title: "æ²’é—œä¿‚", k: "ê´œì°®ì•„ìš”", icon: "ğŸ‘Œ", desc: "å¤æ°é‚£å‘¦" },
        { cat: 'food', title: "è«‹çµ¦æ°´", k: "ë¬¼ ì£¼ì„¸ìš”", icon: "ğŸ’§", desc: "ç©† æœ±ã„™ã„Ÿå‘¦" }, { cat: 'food', title: "å¥½åƒ", k: "ë§›ìˆì–´ìš”", icon: "ğŸ˜‹", desc: "ç‘ªå¸Œæœå‘¦" }, { cat: 'food', title: "çµå¸³", k: "ê³„ì‚°í•´ì£¼ì„¸ìš”", icon: "ğŸ’³", desc: "åˆ‡æ¡‘é»‘æœ±ã„™ã„Ÿå‘¦" }, { cat: 'food', title: "èœå–®", k: "ë©”ë‰´íŒ ì£¼ì„¸ìš”", icon: "ğŸ“–", desc: "Me-New-Pan æœ±ã„™ã„Ÿå‘¦" }, { cat: 'food', title: "ä¸è¦è¾£", k: "ì•ˆ ë§µê²Œ", icon: "ğŸŒ¶ï¸", desc: "å®‰å¦¹çµ¦ (ä¸è¾£)" }, { cat: 'food', title: "å¾®è¾£", k: "ëœ ë§µê²Œ", icon: "ğŸ¤", desc: "å¤šå¦¹çµ¦ (å°‘è¾£)" }, { cat: 'food', title: "å¹¾ä½?", k: "ëª‡ ë¶„ì´ì„¸ìš”?", icon: "âœŒï¸", desc: "è‹—å¸ƒä½ ã„™ã„Ÿå‘¦" }, { cat: 'food', title: "çºŒå°èœ", k: "ë°˜ì°¬ ë¦¬í•„", icon: "ğŸ¥—", desc: "ç›¤é¤ Li-Feel" }, { cat: 'food', title: "ä¸€äººä»½", k: "1ì¸ë¶„", icon: "â˜ï¸", desc: "ä¸€æ—å¥”" }, { cat: 'food', title: "å¤–å¸¶", k: "í¬ì¥", icon: "ğŸ", desc: "Po-Jang" },
        { cat: 'shop', title: "å¤šå°‘éŒ¢", k: "ì–¼ë§ˆì˜ˆìš”?", icon: "ğŸ’°", desc: "æ­åª½è€¶å‘¦" }, { cat: 'shop', title: "ä¾¿å®œé»", k: "ê¹ì•„ì£¼ì„¸ìš”", icon: "ğŸ’¸", desc: "å˜å˜æœ±ã„™ã„Ÿå‘¦" }, { cat: 'shop', title: "è¢‹å­", k: "ë´‰íˆ¬ ì£¼ì„¸ìš”", icon: "ğŸ›ï¸", desc: "å´©åœŸ æœ±ã„™ã„Ÿå‘¦" }, { cat: 'shop', title: "é€€ç¨…", k: "Tax Refund", icon: "ğŸ“„", desc: "Tax Refund" }, { cat: 'shop', title: "è©¦ç©¿", k: "ì…ì–´ë´ë„ ë¼ìš”?", icon: "ğŸ‘—", desc: "ä¸€æ³¢å§éƒ½ å°å‘¦?" }, { cat: 'shop', title: "æ–°å“", k: "ì‹ ìƒ", icon: "âœ¨", desc: "æ–°æ¡‘" }, { cat: 'shop', title: "ä¸€çµ„", k: "ì„¸íŠ¸", icon: "ğŸ“¦", desc: "Set-u" }, { cat: 'shop', title: "æœ‰æ–°çš„å—", k: "ìƒˆê±° ìˆì–´ìš”?", icon: "ğŸ†•", desc: "Say-Go ä¸€æœå‘¦?" },
        { cat: 'traffic', title: "åœ°éµç«™", k: "ì§€í•˜ì² ì—­", icon: "ğŸš‡", desc: "åŸºå“ˆç§‹å”·" }, { cat: 'traffic', title: "åˆ°é€™è£¡", k: "ì—¬ê¸°ë¡œ ê°€ì£¼ì„¸ìš”", icon: "ğŸ“", desc: "å„ªgi æ‘Ÿ å’–æœ±ã„™ã„Ÿå‘¦" }, { cat: 'traffic', title: "åœè»Š", k: "ì„¸ì›Œì£¼ì„¸ìš”", icon: "ğŸ›‘", desc: "Say-Whoa æœ±ã„™ã„Ÿå‘¦" }, { cat: 'traffic', title: "å¤šä¹…", k: "ì–¼ë§ˆë‚˜ ê±¸ë ¤ìš”?", icon: "â³", desc: "æ­åª½é‚£ æŸ¯æºœå‘¦?" }
    ];
    const defaultFormState = { mode: 'add', dIdx: 0, iIdx: 0, type: 'normal', time: '', title: '', desc: '', map: '', brandsStr: '', note: '', flightNo: '', dep: 'KHH', arr: 'ICN', duration: '', subItems: [] };

    createApp({
        setup() {
            const currentView = ref('plan');
            const itinerary = ref([]);
            const selectedDayIndex = ref(0);
            const dbStatus = ref('connecting');
            const loading = ref(true);
            const showEditModal = ref(false);
            const isSaving = ref(false);
            const editForm = reactive({ ...defaultFormState });
            const calcInput = ref('');
            const rate = ref(0.024);
            const infoModal = reactive({ show: false, title: '', desc: '', audio: '', mapUrl: '' }); // Added mapUrl
            const weather = reactive({ temp: '--', desc: 'è¼‰å…¥ä¸­', icon: 'fa-cloud', forecast: [] });
            const weatherModal = reactive({ show: false, loading: false, list: [], error: false });
            const koreanTab = ref('all');
            const globalLoading = ref(false);

            // --- GUIDE STATE (v33 restored) ---
            const guideState = {
                popup: { 
                    list: ref([
                        { title: "é¦–çˆ¾ç‡ˆç¯€", desc: "å…‰åŒ–é–€ | å†¬å­£é™å®š", tag: "é™å®š", tagClass: "bg-orange-100 text-orange-600", modalTitle: "é¦–çˆ¾ç‡ˆç¯€", modalDesc: "æ™‚é–“ï¼šè‡³ 1æœˆåº•\nåœ°é»ï¼šå…‰åŒ–é–€å»£å ´" },
                        { title: "ç¾ä»£ç™¾è²¨ è–èª•å¸‚é›†", desc: "The Hyundai 5F", tag: "ç†±é–€", tagClass: "bg-red-100 text-red-600", modalTitle: "The Hyundai Seoul", modalDesc: "åœ°é»ï¼šæ±çŸ£å³¶ (Day 5)" },
                        { title: "Shinsegae ç‡ˆå…‰ç§€", desc: "æ˜æ´æ–°ä¸–ç•Œç™¾è²¨", tag: "å¿…çœ‹", tagClass: "bg-yellow-100 text-yellow-800", modalTitle: "æ–°ä¸–ç•Œç™¾è²¨", modalDesc: "å¤–ç‰†ç‡ˆå…‰ç§€ï¼Œæ™šä¸Šè¶…ç¾" }
                    ]), 
                    updating: ref(false), updated: ref(false) 
                },
                brand: { 
                    list: ref([
                        { title: "Olive Young", desc: "æ˜æ´ | æ»¿é¡é€€ç¨…", tag: "SALE", tagClass: "bg-red-100 text-red-600", modalTitle: "Olive Young", modalDesc: "æ´»å‹•ï¼šå†¬å­£ä¿ƒéŠ·" }, 
                        { title: "Gentle Monster", desc: "Haus Dosan / æ±çŸ£å³¶", tag: "æ–°å“", tagClass: "bg-gray-100 text-gray-800", modalTitle: "GM 2026", modalDesc: "åœ°é»ï¼šç‹é·—äº­ Haus Dosan æˆ– æ±çŸ£å³¶" },
                        { title: "Matin Kim", desc: "è–æ°´æ´ / ç¾ä»£ç™¾è²¨", tag: "ç†±é–€", tagClass: "bg-black text-white", modalTitle: "Matin Kim", modalDesc: "éµç‰ŒéŒ¢åŒ…å¿…è²·" }
                    ]), 
                    updating: ref(false), updated: ref(false) 
                },
                shopping: {
                    list: ref([
                        { title: "è–æ°´æ´åœ°åœ–", desc: "Dior, Mardi, å’–å•¡å»³", tag: "Trend", tagClass: "bg-purple-100 text-purple-600", modalTitle: "è–æ°´æ´", modalDesc: "è·¯ç·šå»ºè­°ï¼šDior Seoul æ‰“å¡ -> é€› Mardi -> åƒç¥–å‚³é¦¬éˆ´è–¯æ¹¯ -> é€› LCDC" },
                        { title: "æ±çŸ£å³¶æ”»ç•¥", desc: "The Hyundai Seoul", tag: "Mall", tagClass: "bg-green-100 text-green-600", modalTitle: "The Hyundai", modalDesc: "B2 æ½®ç‰Œå€ (Thisisneverthat, Arket) -> 5F è–èª•å¸‚é›† -> B1 é£Ÿå“è¡—" },
                        { title: "å¼˜å¤§å¿…é€›", desc: "AK Plaza, åœè»Šå ´è¡—", tag: "Youth", tagClass: "bg-blue-100 text-blue-600", modalTitle: "å¼˜å¤§", modalDesc: "Object (æ–‡å‰µ), Gentle Monster, AA Place, NB æ——è‰¦åº—" }
                    ]),
                    updating: ref(false), updated: ref(false)
                }
            };
            const guideSections = [{id:'popup', title:"å¿«é–ƒ & å¸‚é›†", ...guideState.popup}, {id:'brand', title:"æ½®ç‰Œ & è³¼ç‰©", ...guideState.brand}, {id:'shopping', title:"é€›è¡—åœ°åœ–", ...guideState.shopping}];

            // AI Chat State
            const showAIChat = ref(false);
            const showApiKeyInput = ref(false);
            const userApiKey = ref(localStorage.getItem('gemini_api_key') || apiKey);
            const chatInput = ref('');
            const isChatLoading = ref(false);
            const chatMessages = ref([{ role: 'model', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„é¦–çˆ¾ AI å°éŠ ğŸ¤–<br>æˆ‘å¯ä»¥å¹«ä½ æ–°å¢æˆ–åˆªé™¤è¡Œç¨‹å–”ï¼' }]);
            const chatContainer = ref(null);
            
            // Draggable State
            const aiBtnRef = ref(null);
            const aiBtnPos = reactive({ x: window.innerWidth - 80, y: window.innerHeight - 150 });
            const isDragging = ref(false);
            let dragOffset = { x: 0, y: 0 };
            let startClickPos = { x: 0, y: 0 };

            // Computeds
            const currentDay = computed(() => itinerary.value[selectedDayIndex.value]);
            const statusText = computed(() => dbStatus.value === 'connected' ? 'é€£ç·šä¸­ v39' : (dbStatus.value === 'cached' ? 'é›¢ç·šæ¨¡å¼' : 'é€£ç·šä¸­...'));
            const calcTwd = computed(() => Math.round((parseFloat(calcInput.value) || 0) * rate.value).toLocaleString());
            const calcTax = computed(() => { const v = parseFloat(calcInput.value) || 0; return v < 30000 ? 0 : 'â‚© ' + (v >= 75000 ? 5000 : (v >= 50000 ? 3500 : 1500)).toLocaleString(); });
            const filteredKorean = computed(() => koreanTab.value === 'all' ? survivalCards : survivalCards.filter(c => c.cat === koreanTab.value));

            // Watcher
            watch(editForm, (newVal) => { if (showEditModal.value) localStorage.setItem('edit_draft', JSON.stringify(newVal)); }, { deep: true });

            // Lifecycle
            onMounted(() => {
                const cachedTrip = localStorage.getItem('seoul_trip_data_cache');
                if (cachedTrip) { try { itinerary.value = JSON.parse(cachedTrip); loading.value = false; dbStatus.value = 'cached'; } catch (e) {} }
                fetchWeather();
                if (!db) { dbStatus.value = 'error'; return; }
                onSnapshot(doc(db, "trips", DOC_ID), (snap) => {
                    if (snap.exists()) { const data = snap.data().itinerary; itinerary.value = data; localStorage.setItem('seoul_trip_data_cache', JSON.stringify(data)); dbStatus.value = 'connected'; } 
                    else { if(!cachedTrip) { dbStatus.value = 'empty'; itinerary.value = []; } }
                    loading.value = false;
                }, (err) => { dbStatus.value = 'error'; if(!cachedTrip) { itinerary.value = DEFAULT_ITINERARY; loading.value = false; } });
                window.addEventListener('mousemove', onAiBtnMouseMove); window.addEventListener('mouseup', onAiBtnMouseUp);
                
                if(!userApiKey.value && apiKey) {
                    userApiKey.value = apiKey;
                    localStorage.setItem('gemini_api_key', apiKey);
                }
            });

            // Draggable
            const onAiBtnTouchStart = (e) => { isDragging.value = true; const touch = e.touches[0]; dragOffset.x = touch.clientX - aiBtnPos.x; dragOffset.y = touch.clientY - aiBtnPos.y; startClickPos = { x: touch.clientX, y: touch.clientY }; };
            const onAiBtnTouchMove = (e) => { if (!isDragging.value) return; const touch = e.touches[0]; let newX = touch.clientX - dragOffset.x; let newY = touch.clientY - dragOffset.y; const maxX = window.innerWidth - 60; const maxY = window.innerHeight - 60; newX = Math.max(0, Math.min(newX, maxX)); newY = Math.max(0, Math.min(newY, maxY)); aiBtnPos.x = newX; aiBtnPos.y = newY; };
            const onAiBtnTouchEnd = (e) => { isDragging.value = false; const touch = e.changedTouches[0]; const dist = Math.sqrt(Math.pow(touch.clientX - startClickPos.x, 2) + Math.pow(touch.clientY - startClickPos.y, 2)); if (dist < 5) showAIChat.value = true; };
            const onAiBtnMouseDown = (e) => { isDragging.value = true; dragOffset.x = e.clientX - aiBtnPos.x; dragOffset.y = e.clientY - aiBtnPos.y; startClickPos = { x: e.clientX, y: e.clientY }; };
            const onAiBtnMouseMove = (e) => { if (!isDragging.value) return; e.preventDefault(); let newX = e.clientX - dragOffset.x; let newY = e.clientY - dragOffset.y; const maxX = window.innerWidth - 60; const maxY = window.innerHeight - 60; newX = Math.max(0, Math.min(newX, maxX)); newY = Math.max(0, Math.min(newY, maxY)); aiBtnPos.x = newX; aiBtnPos.y = newY; };
            const onAiBtnMouseUp = (e) => { if (!isDragging.value) return; isDragging.value = false; };
            const onAiBtnClick = (e) => { const dist = Math.sqrt(Math.pow(e.clientX - startClickPos.x, 2) + Math.pow(e.clientY - startClickPos.y, 2)); if (dist < 5) showAIChat.value = true; };

            // AI Logic
            const saveApiKey = () => {
                if(!userApiKey.value.trim()) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key");
                localStorage.setItem('gemini_api_key', userApiKey.value);
                showApiKeyInput.value = false;
                chatMessages.value.push({ role: 'model', text: 'é›»åŠ›å·²å……æ»¿ï¼âš¡ï¸ ç¾åœ¨å¯ä»¥ç›¡æƒ…å•æˆ‘å•é¡Œå›‰ï¼' });
            };

            const callGemini = async (prompt, systemPromptOverride = null) => {
                const currentKey = userApiKey.value || apiKey;
                if(!currentKey) {
                    showApiKeyInput.value = true;
                    return "è«‹å…ˆè¼¸å…¥ API Key è®“æˆ‘æ¢å¾©é›»åŠ› ğŸ”‹";
                }
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`;
                const systemPrompt = systemPromptOverride || `ä½ æ˜¯ä¸€å€‹é¦–çˆ¾æ—…éŠ AI ä»£ç†äººã€‚
                ã€æ¬Šé™ 1: æ–°å¢è¡Œç¨‹ã€‘å›ç­”æœ€å¾Œé™„ä¸Šï¼š<<<ACTION>>>{"type":"add","day":1,"time":"HH:mm","title":"åœ°é»åç¨±","desc":"ç°¡çŸ­æè¿°","detail":"ğŸ‘ å„ªé»ï¼š...\\nâš ï¸ ç¼ºé»ï¼š...\\nğŸ’¡ æ”»ç•¥ï¼š..."}<<<END>>>
                ã€æ¬Šé™ 2: åˆªé™¤è¡Œç¨‹ã€‘å›ç­”æœ€å¾Œé™„ä¸Šï¼š<<<ACTION>>>{"type":"delete","day":2,"title":"é—œéµå­—"}<<<END>>>
                æ³¨æ„ï¼š"day"æ˜¯æ•¸å­—(1-7)ã€‚å›ç­”è«‹ç°¡çŸ­å‹å–„ã€‚`;
                
                const history = chatMessages.value.slice(-6).map(m => ({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.rawText || m.text }] }));
                history.push({ role: 'user', parts: [{ text: prompt }] });

                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: history, systemInstruction: { parts: [{ text: systemPrompt }] } }) });
                    if(response.status !== 200) throw new Error("API Key å¯èƒ½ç„¡æ•ˆ");
                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content) return data.candidates[0].content.parts[0].text;
                    return "æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨æœ‰é»æšˆæ©Ÿ ğŸ˜µâ€ğŸ’«";
                } catch (error) { return `é€£ç·šå¤±æ•— (${error.message})ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯ã€‚`; }
            };

            const showToast = (msg, type='success') => { const toast = document.getElementById('toast'); const icon = document.getElementById('toast-icon'); document.getElementById('toast-msg').innerText = msg; if(type === 'error') { icon.className = "fa-solid fa-circle-exclamation text-red-400"; } else { icon.className = "fa-solid fa-check-circle text-green-400"; } toast.style.opacity = '1'; setTimeout(() => toast.style.opacity = '0', 3000); };
            const executeAIAction = async (actionJson) => { try { const action = JSON.parse(actionJson); const dayIdx = action.day - 1; if (dayIdx < 0 || dayIdx >= itinerary.value.length) { showToast("æ‰¾ä¸åˆ°è©²æ—¥æœŸçš„è¡Œç¨‹", 'error'); return; } if (action.type === 'add') { const newItem = { type: 'normal', time: action.time, title: action.title, desc: action.desc, detail: action.detail }; const newItinerary = JSON.parse(JSON.stringify(itinerary.value)); newItinerary[dayIdx].items.push(newItem); newItinerary[dayIdx].items.sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59')); if (db) await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary }); showToast(`å·²æ–°å¢ï¼š${action.title}`); selectedDayIndex.value = dayIdx; } else if (action.type === 'delete') { const newItinerary = JSON.parse(JSON.stringify(itinerary.value)); const items = newItinerary[dayIdx].items; const targetIdx = items.findIndex(item => (item.title || "").toLowerCase().includes((action.title || "").toLowerCase())); if (targetIdx !== -1) { const removedName = items[targetIdx].title; items.splice(targetIdx, 1); if (db) await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary }); showToast(`å·²ç§»é™¤ï¼š${removedName}`); selectedDayIndex.value = dayIdx; } else { showToast(`åœ¨ Day ${action.day} æ‰¾ä¸åˆ° "${action.title}"`, 'error'); } } } catch (e) { console.error("AI Action Failed:", e); showToast("AI æŒ‡ä»¤åŸ·è¡Œå¤±æ•—", 'error'); } };
            const sendMessage = async (text) => { if (!text.trim()) return; const userText = text; chatInput.value = ''; chatMessages.value.push({ role: 'user', text: userText }); isChatLoading.value = true; nextTick(() => { if(chatContainer.value) chatContainer.value.scrollTop = chatContainer.value.scrollHeight; }); const aiRawResponse = await callGemini(userText); const actionRegex = /<<<ACTION>>>(.*?)<<<END>>>/s; const match = aiRawResponse.match(actionRegex); let displayResponse = aiRawResponse; if (match) { displayResponse = aiRawResponse.replace(match[0], '').trim(); executeAIAction(match[1]); } const htmlResponse = marked.parse(displayResponse); chatMessages.value.push({ role: 'model', text: htmlResponse, rawText: aiRawResponse }); isChatLoading.value = false; nextTick(() => { if(chatContainer.value) chatContainer.value.scrollTop = chatContainer.value.scrollHeight; }); };
            
            // --- NEW: Real AI Search Logic (v39 Random/Infinite) ---
            const fetchAIUpdates = async (id) => {
                const s = guideState[id];
                if (s.updating.value) return; 
                s.updating.value = true;
                globalLoading.value = true; 
                
                // 1. Random Vibes for variety
                const vibes = ["newly opened", "local hidden gems", "highly instagrammable", "classic must-visit", "trending on social media", "under-the-radar", "luxury high-end"];
                const randomVibe = vibes[Math.floor(Math.random() * vibes.length)];
                
                // 2. Collect existing titles to avoid duplicates (deduplication)
                const existingTitles = s.list.value.map(i => i.title).slice(0, 10).join(", ");

                // 3. Customized Prompts for Each Section
                const prompts = {
                    popup: `Search for 2 UNIQUE and ${randomVibe} pop-up stores or market events in Seoul (2025/2026). 
                            Focus on character IPs, fashion, or food.
                            IMPORTANT: Do NOT recommend these again: ${existingTitles}. Find something different!`,
                            
                    brand: `Recommend 2 ${randomVibe} fashion/streetwear brands in Seoul. 
                            Can be major names or rising local designer brands.
                            IMPORTANT: Do NOT recommend these again: ${existingTitles}. Find something different!`,
                            
                    shopping: `Provide 2 ${randomVibe} shopping areas or specific mall floors/streets in Seoul.
                               IMPORTANT: Do NOT recommend these again: ${existingTitles}. Find something different!`
                };

                const specificPrompt = prompts[id] || "Recommend trending spots in Seoul.";

                const fullPrompt = `${specificPrompt}
                Return strictly a JSON array of objects with keys: 
                - title: Name (keep original English/Korean name).
                - desc: Short description in Traditional Chinese (ç¹é«”ä¸­æ–‡).
                - tag: Short tag (e.g. "HOT", "NEW", "POPUP").
                - tagClass: Tailwind CSS class string (e.g., 'bg-blue-100 text-blue-600').
                - modalTitle: Title in Traditional Chinese.
                - modalDesc: Detailed description in Traditional Chinese.
                - mapKeyword: The specific name in Korean for map search (e.g. "ë”í˜„ëŒ€ ì„œìš¸").

                Do not wrap in markdown code blocks. Just the raw JSON array.`;
                
                const extractionSystemPrompt = "You are a JSON data generator for a travel app. Output raw JSON arrays only.";

                try {
                    const currentKey = userApiKey.value || apiKey;
                    if(!currentKey) throw new Error("No API Key");
                    
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`;
                    const payload = {
                        contents: [{ role: 'user', parts: [{ text: fullPrompt }] }],
                        systemInstruction: { parts: [{ text: extractionSystemPrompt }] }
                    };
                    
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await response.json();
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "[]";
                    
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    const newItems = JSON.parse(text);
                    newItems.forEach(item => item.isNew = true);
                    
                    // Prepend new items to the top
                    s.list.value = [...newItems, ...s.list.value];
                    showToast(`âœ¨ å·²ç™¼ç¾ ${newItems.length} ç­†æ–°æƒ…å ±ï¼`);
                    
                } catch (e) {
                    console.error("AI Search Failed", e);
                    showToast("æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
                } finally {
                    s.updating.value = false;
                    globalLoading.value = false;
                }
            };

            // Other
            const uploadDefaultData = async () => { if(db) { loading.value = true; await setDoc(doc(db, "trips", DOC_ID), { itinerary: DEFAULT_ITINERARY }); }};
            const getWeatherIcon = (code) => { if (code === 0) return 'fa-sun text-orange-400'; if (code <= 3) return 'fa-cloud-sun text-yellow-400'; if (code <= 48) return 'fa-smog text-gray-400'; if (code <= 67) return 'fa-cloud-rain text-blue-400'; if (code <= 77) return 'fa-snowflake text-cyan-300'; if (code <= 82) return 'fa-cloud-showers-heavy text-blue-600'; return 'fa-cloud-bolt text-purple-500'; };
            const fetchWeather = async () => { const CACHE_KEY = 'seoul_weather_cache_v1'; const EXPIRY = 60 * 60 * 1000; const cached = localStorage.getItem(CACHE_KEY); if (cached) { try { const { timestamp, data } = JSON.parse(cached); if (Date.now() - timestamp < EXPIRY) { weather.temp = data.temp; weather.desc = data.desc; weather.icon = data.icon; weatherModal.list = data.list; return; } } catch(e) {} } try { const r = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FSeoul'); if (!r.ok) throw new Error("API Error"); const d = await r.json(); weather.temp = Math.round(d.current.temperature_2m); weather.desc = d.current.weather_code > 2 ? 'å¤šé›²' : 'æ™´æœ—'; weather.icon = getWeatherIcon(d.current.weather_code); weatherModal.list = d.daily.time.map((date, i) => ({ date: `${new Date(date).getMonth()+1}/${new Date(date).getDate()}`, week: ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(date).getDay()], min: Math.round(d.daily.temperature_2m_min[i]), max: Math.round(d.daily.temperature_2m_max[i]), icon: getWeatherIcon(d.daily.weather_code[i]) })); localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data: { temp: weather.temp, desc: weather.desc, icon: weather.icon, list: weatherModal.list } })); } catch(e){ weatherModal.error = true; } };
            const openWeatherModal = () => { weatherModal.show = true; if(weatherModal.list.length === 0 || weatherModal.error) { weatherModal.loading = true; fetchWeather().then(() => weatherModal.loading = false); } };
            const openModal = (mode, dIdx, iIdx = null, item = null) => { Object.assign(editForm, defaultFormState, { mode, dIdx, iIdx }); const draft = localStorage.getItem('edit_draft'); if (mode === 'add' && draft) { try { const parsedDraft = JSON.parse(draft); if (parsedDraft.mode === 'add') { Object.assign(editForm, parsedDraft); } } catch(e) {} } if (mode === 'edit' && item) { Object.assign(editForm, item); if (item.brands) editForm.brandsStr = item.brands.join(', '); editForm.subItems = (item.type === 'meal' && item.opts) ? JSON.parse(JSON.stringify(item.opts)) : ((item.type === 'choice' && item.choices) ? JSON.parse(JSON.stringify(item.choices)) : []); } showEditModal.value = true; };
            const addSubItem = () => editForm.subItems.push(editForm.type === 'meal' ? { n: '', t: 'walk', k: '', tip: '' } : { n: 'Plan', desc: '', target: '' });
            const removeSubItem = (idx) => editForm.subItems.splice(idx, 1);
            const closeEditModal = () => { showEditModal.value = false; localStorage.removeItem('edit_draft'); };
            const saveEdit = async () => { if (!db) { alert("è³‡æ–™åº«æœªé€£ç·šï¼Œç„¡æ³•å„²å­˜"); return; } isSaving.value = true; const { title, desc, time, note, type, map, brandsStr, flightNo, dep, arr, duration, subItems } = editForm; const newItem = { title, desc, time, note, type }; if (type === 'normal') { newItem.map = map; if (brandsStr) newItem.brands = brandsStr.split(/,|ï¼Œ/).map(s => s.trim()).filter(Boolean); } else if (type === 'meal') newItem.opts = subItems; else if (type === 'choice') newItem.choices = subItems; else if (type === 'flight') Object.assign(newItem, { flightNo, dep, arr, duration }); const newItinerary = JSON.parse(JSON.stringify(itinerary.value)); if (editForm.mode === 'add') newItinerary[editForm.dIdx].items.push(newItem); else newItinerary[editForm.dIdx].items[editForm.iIdx] = newItem; try { await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary }); showEditModal.value = false; localStorage.removeItem('edit_draft'); showToast("å„²å­˜æˆåŠŸ"); } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); } finally { isSaving.value = false; } };
            const deleteItem = async () => { if (!db) { alert("è³‡æ–™åº«æœªé€£ç·šï¼Œç„¡æ³•åˆªé™¤"); return; } if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ")) return; isSaving.value = true; const newItinerary = JSON.parse(JSON.stringify(itinerary.value)); newItinerary[editForm.dIdx].items.splice(editForm.iIdx, 1); try { await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary }); showEditModal.value = false; showToast("å·²åˆªé™¤è¡Œç¨‹"); } catch(e) { alert("åˆªé™¤å¤±æ•—: " + e.message); } finally { isSaving.value = false; } };
            
            const checkUpdates = (id) => fetchAIUpdates(id); 

            const getSearchLink = (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`;
            const getNaverLink = (k) => `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(k)}`;
            const getSmartMapLink = (item) => { if (!item.map) return getSearchLink(item.title); if (item.title.includes('å®¶') || item.title.includes('é«˜é›„') || item.title.includes('å°å—')) { return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.map)}`; } return getNaverLink(item.map); };
            
            // Updated openInfoModal to accept mapUrl
            const openInfoModal = (t, d, audio = null, mapKeyword = null) => { 
                infoModal.title = t; 
                infoModal.desc = d; 
                infoModal.audio = audio;
                // Generate map link if keyword exists
                infoModal.mapUrl = mapKeyword ? getNaverLink(mapKeyword) : null;
                infoModal.show = true; 
            };
            
            const playAudio = (text) => { if (!text) return; window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'ko-KR'; u.rate = 0.9; window.speechSynthesis.speak(u); };

            return { itinerary, selectedDayIndex, currentDay, dbStatus, loading, uploadDefaultData, statusText, showEditModal, editForm, openModal, closeEditModal, saveEdit, deleteItem, isSaving, addSubItem, removeSubItem, currentView, weather, fetchWeather, calcInput, calcTwd, calcTax, rate, survivalCards, infoModal, openInfoModal, guideSections, checkUpdates, getSearchLink, getNaverLink, getSmartMapLink, koreanTab, koreanTabs, filteredKorean, playAudio, weatherModal, openWeatherModal, showAIChat, showApiKeyInput, userApiKey, saveApiKey, chatMessages, chatInput, sendMessage, isChatLoading, chatContainer, aiBtnRef, aiBtnPos, onAiBtnTouchStart, onAiBtnTouchMove, onAiBtnTouchEnd, onAiBtnMouseDown, onAiBtnMouseMove, onAiBtnMouseUp, onAiBtnClick, fetchAIUpdates, globalLoading };
        }
    }).mount('#app');
</script>
</body>
</html>

