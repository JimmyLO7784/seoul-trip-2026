<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¦–çˆ¾ 2026 é›²ç«¯å…±ç·¨ç‰ˆ</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#F2F1F6',
                        primary: '#C8A47E',
                        'primary-dark': '#A68665',
                        'accent-green': '#34C759',
                    },
                    boxShadow: { 'ios': '0 2px 8px rgba(0,0,0,0.04)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #E5E5E5; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden select-none">

<div id="app" class="relative w-full h-full max-w-[480px] mx-auto bg-[#F2F1F6] shadow-2xl overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="flex-none px-5 py-3 pt-[calc(12px+env(safe-area-inset-top))] bg-bg/90 backdrop-blur-md border-b border-black/5 z-50 flex justify-between items-center sticky top-0">
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight text-gray-900 flex items-center gap-2">
                SEOUL 2026 
                <span v-if="dbStatus === 'connected'" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span v-else class="w-2 h-2 rounded-full bg-red-400"></span>
            </h1>
            <p class="text-xs font-semibold text-gray-400 -mt-1">
                {{ statusText }}
            </p>
        </div>
        <!-- Upload Init Data Button (Visible only if empty) -->
        <button v-if="dbStatus === 'empty'" @click="uploadDefaultData" class="text-xs bg-primary text-white px-3 py-1 rounded-full font-bold shadow-sm animate-bounce">
            åˆå§‹åŒ–è³‡æ–™åº«
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden pb-[100px] hide-scroll relative">
        
        <!-- Loading State -->
        <div v-show="currentView === 'plan'">
            <div v-if="loading" class="flex flex-col items-center justify-center h-[50vh] text-gray-400 gap-3">
                <i class="fa-solid fa-circle-notch animate-spin text-3xl"></i>
                <span class="text-sm font-bold">æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰è¡Œç¨‹...</span>
                <span v-if="dbStatus === 'error'" class="text-xs text-red-400 px-10 text-center">é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèª Firestore å·²é–‹å•Ÿæ¸¬è©¦æ¨¡å¼</span>
            </div>

            <div v-else class="p-4 space-y-5">
                 <!-- Weather Card -->
                 <div @click="fetchWeather" class="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-[#6DD5FA] to-[#2980B9] p-5 text-white shadow-lg shadow-blue-500/20 active:scale-95 transition-transform duration-200 cursor-pointer">
                    <div class="relative z-10 flex justify-between items-center">
                        <div>
                            <div class="text-4xl font-extrabold tracking-tighter">{{ weather.temp }}<span v-if="weather.temp !== '--'">Â°</span></div>
                            <div class="text-sm font-bold opacity-90 mt-1">{{ weather.desc }}</div>
                        </div>
                        <i :class="['fa-solid text-4xl opacity-90', weather.icon]"></i>
                    </div>
                </div>

                <!-- Date Slider -->
                <div class="sticky top-0 z-40 -mx-4 px-4 py-2 bg-[#F2F1F6]/95 backdrop-blur-sm">
                    <div class="flex gap-2 overflow-x-auto hide-scroll pb-2">
                        <div v-for="(day, index) in itinerary" :key="index" 
                             @click="selectedDayIndex = index"
                             :class="['flex-none w-[70px] p-2.5 rounded-2xl text-center transition-all duration-200 cursor-pointer border border-transparent shadow-sm', 
                                      selectedDayIndex === index ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-white text-gray-400']">
                            <div class="text-[10px] font-bold opacity-80">Day {{ day.d }}</div>
                            <div class="text-lg font-extrabold leading-tight">{{ day.date.split(' ')[0] }}</div>
                        </div>
                    </div>
                </div>

                <!-- Itinerary Items -->
                <div :key="selectedDayIndex" class="space-y-4">
                    <div class="bg-white rounded-2xl p-5 text-center shadow-ios border border-gray-100/50">
                        <h2 class="text-xl font-extrabold text-gray-800">{{ currentDay?.title }}</h2>
                    </div>

                    <div v-for="(item, idx) in currentDay?.items" :key="idx" class="relative group">
                        
                        <!-- Edit Trigger Button (Floating) -->
                        <button @click="openEditModal(selectedDayIndex, idx, item)" class="absolute -right-2 -top-2 z-10 w-8 h-8 bg-gray-900 rounded-full text-white text-xs flex items-center justify-center shadow-lg opacity-80 hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                        <!-- Type: Simple Item -->
                        <div v-if="!item.type || item.type === 'normal'" class="bg-white rounded-[20px] p-4 shadow-ios border border-gray-50 flex justify-between items-start">
                            <div class="flex-1 min-w-0 pr-3">
                                <a :href="getSearchLink(item.title)" target="_blank" class="font-bold text-base text-gray-800 block">
                                    {{ item.title }} <i class="fa-solid fa-magnifying-glass text-[10px] text-blue-300 opacity-50"></i>
                                </a>
                                <div class="text-xs text-gray-500 mt-1 whitespace-pre-line">{{ item.desc }}</div>
                                <!-- Brands -->
                                <div v-if="item.brands" class="flex flex-wrap gap-1.5 mt-2">
                                    <span v-for="brand in item.brands" class="px-2 py-0.5 rounded text-[10px] bg-gray-50 border border-gray-100 text-gray-600">{{ brand }}</span>
                                </div>
                                <!-- User Notes Display -->
                                <div v-if="item.note" class="mt-2 bg-yellow-50 text-yellow-800 text-xs p-2 rounded-lg border border-yellow-100 flex gap-2 items-start">
                                    <i class="fa-solid fa-sticky-note mt-0.5 opacity-50"></i>
                                    <span>{{ item.note }}</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2 shrink-0">
                                <span v-if="item.time" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md">{{ item.time }}</span>
                                <a v-if="item.map" :href="getNaverLink(item.map)" target="_blank" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-accent-green hover:bg-green-100">
                                    <i class="fa-solid fa-location-arrow text-sm"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Type: Meal -->
                        <div v-else-if="item.type === 'meal'" class="bg-white rounded-[20px] shadow-ios overflow-hidden border border-gray-50">
                            <div class="bg-gray-50/80 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                                <div class="font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fa-solid fa-utensils text-primary"></i> {{ item.title }}
                                </div>
                                <span v-if="item.time" class="text-xs font-bold text-gray-400 bg-gray-200/50 px-2 py-1 rounded-md">{{ item.time }}</span>
                            </div>
                            <div class="p-4 space-y-3">
                                <div v-for="opt in item.opts" class="flex justify-between items-center text-sm">
                                    <a :href="getSearchLink(opt.n)" target="_blank" class="flex-1">
                                        <div class="font-bold text-gray-700">{{ opt.n }}</div>
                                        <div v-if="opt.tip" class="text-[10px] text-gray-400">{{ opt.tip }}</div>
                                    </a>
                                    <div class="flex gap-2 items-center">
                                        <span :class="['text-[10px] px-2 py-1 rounded font-bold', opt.t==='res'?'bg-green-100 text-green-700':'bg-red-100 text-red-600']">{{ opt.t==='res'?'é ç´„':'æ’éšŠ' }}</span>
                                        <a v-if="opt.k" :href="getNaverLink(opt.k)" target="_blank" class="w-6 h-6 bg-gray-50 rounded-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-location-arrow text-[10px]"></i></a>
                                    </div>
                                </div>
                                <div v-if="item.note" class="pt-2 mt-2 border-t border-dashed border-gray-200 text-xs text-yellow-700">
                                    ğŸ“ {{ item.note }}
                                </div>
                            </div>
                        </div>

                        <!-- Type: Choice -->
                        <div v-else-if="item.type === 'choice'" class="bg-[#FAFAFA] rounded-[20px] p-4 border-2 border-dashed border-gray-200">
                            <div class="text-center font-bold text-primary-dark mb-1">{{ item.title }}</div>
                            <div class="text-center text-xs text-gray-400 mb-3">{{ item.desc }}</div>
                            <div class="grid grid-cols-2 gap-2">
                                <div v-for="c in item.choices" class="bg-white p-2 rounded-lg border text-center shadow-sm">
                                    <a :href="getSearchLink(c.n + ' ' + c.desc)" target="_blank">
                                        <div class="text-[10px] font-bold bg-gray-800 text-white inline-block px-1 rounded mb-1">{{ c.n.split(' ')[0] }}</div>
                                        <div class="text-xs font-bold text-gray-700">{{ c.desc }}</div>
                                    </a>
                                </div>
                            </div>
                            <div v-if="item.note" class="mt-3 bg-white p-2 rounded border text-xs text-gray-600 text-center shadow-sm">
                                <span class="text-primary font-bold">æ±ºå®šï¼š</span> {{ item.note }}
                            </div>
                        </div>

                    </div>
                    <div class="h-10"></div>
                </div>
            </div>
        </div>

        <!-- View: CALC -->
        <div v-show="currentView === 'calc'" class="p-5">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4 ml-1">åŒ¯ç‡è¨ˆç®—</h2>
            <div class="bg-white rounded-[24px] p-6 shadow-ios border border-gray-50 text-right mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-400">è¼¸å…¥éŸ“å¹£ (KRW)</span>
                    <button @click="resetCalc" class="text-xs font-bold text-primary hover:text-primary-dark">æ¸…é™¤</button>
                </div>
                <input type="text" inputmode="decimal" v-model="calcInput" 
                       class="w-full text-right text-5xl font-light text-gray-900 placeholder-gray-200 outline-none bg-transparent font-mono mb-4 tracking-tighter" 
                       placeholder="0">
                <div class="border-t border-gray-100 py-3 flex justify-between items-center">
                    <span class="text-sm text-gray-400">ç´„åˆå°å¹£</span>
                    <span class="text-xl font-bold font-mono text-gray-800">{{ calcTwd }}</span>
                </div>
                <div class="pt-2 flex justify-between items-center">
                    <span class="text-sm text-gray-400">é è¨ˆé€€ç¨…</span>
                    <span class="text-xl font-bold font-mono text-accent-green">{{ calcTax }}</span>
                </div>
            </div>
            <div class="text-center text-xs text-gray-400">åŒ¯ç‡: {{ rate }} | æ»¿ 30,000 å¯é€€ç¨…</div>
        </div>

        <!-- View: GUIDE -->
        <div v-show="currentView === 'guide'" class="p-4 space-y-4">
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-2">ç”Ÿå­˜éŸ“èª</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div v-for="c in survivalCards" class="border p-2 rounded text-center" @click="openInfoModal(c.k, c.desc)">
                        <div class="text-xl">{{ c.icon }}</div>
                        <div class="font-bold text-sm">{{ c.title }}</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-2">å¿«é–ƒæƒ…å ±</h3>
                <div v-for="p in guideData.popups" class="flex gap-3 py-2 border-b last:border-0" @click="openInfoModal(p.title, p.modalDesc || p.desc)">
                    <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded text-xs font-bold h-fit">{{ p.tag }}</span>
                    <div>
                        <div class="font-bold text-sm">{{ p.title }}</div>
                        <div class="text-xs text-gray-500">{{ p.desc }}</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="flex-none h-[calc(60px+env(safe-area-inset-bottom))] bg-white/95 backdrop-blur-xl border-t border-gray-200 pb-safe-bottom flex justify-around items-center z-50">
        <button v-for="tab in ['plan', 'calc', 'guide']" :key="tab"
                @click="currentView = tab"
                :class="['flex-1 h-full flex flex-col items-center justify-center gap-1 transition-colors', 
                         currentView === tab ? 'text-primary-dark' : 'text-gray-400']">
            <i :class="['fa-solid text-xl transition-transform duration-200', 
                        tab === 'plan' ? 'fa-calendar-days' : (tab === 'calc' ? 'fa-calculator' : 'fa-book-open'),
                        currentView === tab ? '-translate-y-0.5' : '']"></i>
            <span class="text-[10px] font-bold tracking-wide">
                {{ tab === 'plan' ? 'è¡Œç¨‹' : (tab === 'calc' ? 'è¨ˆç®—' : 'æ”»ç•¥') }}
            </span>
        </button>
    </nav>

    <!-- Edit Modal -->
    <transition name="slide-up">
        <div v-if="editingItem" class="absolute inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end justify-center" @click="editingItem = null">
            <div class="bg-white w-full rounded-t-[24px] p-6 shadow-2xl" @click.stop>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">ç·¨è¼¯è¡Œç¨‹</h3>
                    <button @click="editingItem = null" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">æ¨™é¡Œ</label>
                        <input v-model="editForm.title" class="w-full bg-gray-100 p-3 rounded-xl font-bold outline-none focus:ring-2 ring-primary/50">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">å‚™è¨» / ç­†è¨˜ (å¤§å®¶çœ‹å¾—åˆ°)</label>
                        <textarea v-model="editForm.note" rows="3" class="w-full bg-gray-100 p-3 rounded-xl text-sm outline-none focus:ring-2 ring-primary/50" placeholder="å¯«é»ä»€éº¼...ä¾‹å¦‚ï¼šé€™å®¶åº—å…¬ä¼‘æ”¹å»åˆ¥å®¶"></textarea>
                    </div>
                    <button @click="saveEdit" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-transform flex justify-center items-center gap-2">
                        <span v-if="isSaving" class="animate-spin"><i class="fa-solid fa-circle-notch"></i></span>
                        <span>{{ isSaving ? 'å„²å­˜ä¸­...' : 'å„²å­˜è®Šæ›´' }}</span>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Info Modal -->
    <transition name="fade">
        <div v-if="infoModal.show" class="absolute inset-0 z-[110] bg-black/60 flex items-center justify-center p-6" @click="infoModal.show = false">
            <div class="bg-white w-full max-w-sm rounded-[30px] p-6 shadow-2xl text-center" @click.stop>
                <h3 class="text-xl font-extrabold text-gray-900 mb-3 whitespace-pre-line">{{ infoModal.title }}</h3>
                <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap mb-6">{{ infoModal.desc }}</p>
                <button @click="infoModal.show = false" class="w-full bg-gray-100 text-gray-900 font-bold py-3 rounded-xl">é—œé–‰</button>
            </div>
        </div>
    </transition>

</div>

<script type="module">
    // --- 1. Firebase Imports (ä½¿ç”¨ 12.7.0 ç‰ˆæœ¬) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
    import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // --- 2. æ‚¨çš„è¨­å®šæª” (å·²å¡«å…¥) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBFDAs4hj4eJ2hCxsWWlRRCsJC_qEekBCc",
        authDomain: "trip-plan-app-c38a3.firebaseapp.com",
        projectId: "trip-plan-app-c38a3",
        storageBucket: "trip-plan-app-c38a3.firebasestorage.app",
        messagingSenderId: "79177072268",
        appId: "1:79177072268:web:e8efe92b05a528046d45a9",
        measurementId: "G-T39PWKG8GL"
    };

    // --- 3. åˆå§‹åŒ– Firebase ---
    let app, db, analytics;
    try {
        app = initializeApp(firebaseConfig);
        analytics = getAnalytics(app); 
        db = getFirestore(app); // å–å¾—è³‡æ–™åº«å¯¦é«”
    } catch(e) {
        console.error("Firebase åˆå§‹åŒ–éŒ¯èª¤", e);
    }
    
    // å®šç¾©æ–‡ä»¶ ID (è«‹å‹¿æ›´æ”¹ï¼Œç¢ºä¿å¤§å®¶éƒ½è®€åŒä¸€ä»½)
    const DOC_ID = "seoul_trip_data_v1";

    // --- Vue Application ---
    const { createApp, ref, computed, onMounted, reactive } = Vue;

    // å®Œæ•´ 7 å¤©é è¨­è¡Œç¨‹ (ç”¨æ–¼åˆå§‹åŒ–)
    const DEFAULT_ITINERARY = [
        { 
            d: 1, date: "1/25 (æ—¥)", title: "æŠµé” & æ˜æ´",
            items: [
                { time:"13:00", title:"L7 é£¯åº— Check-in", desc:"å¯„æ”¾è¡Œæ", map:"L7 ëª…ë™", note: "" },
                { title:"Money Planet æ›éŒ¢", desc:"å°±åœ¨æ˜æ´ï¼ŒåŒ¯ç‡å„ªï¼", map:"ë¨¸ë‹ˆí”Œë ˆë‹›", note: "" },
                { title:"é¦–çˆ¾è³¼ç‰©å­£ (Shopping Festa)", desc:"å»ã€Œæ˜æ´æ­¡è¿ä¸­å¿ƒã€é ˜å„ªæƒ åˆ¸ & æ­¡è¿ç¦®åŒ…ï¼\n*è¨˜å¾—å¸¶è­·ç…§/æ©Ÿç¥¨", map:"ëª…ë™ì˜ˆìˆ ê·¹ì¥", note: "" },
                { type:"meal", title:"æ˜æ´åˆé¤", opts:[{n:"æ˜æ´é¤ƒå­", t:"wait", tip:"å¿…æ¯”ç™»æ¨è–¦"}, {n:"ç¥ä»™é›ªæ¿ƒæ¹¯", t:"wait", tip:"æ¹¯é ­æ¿ƒéƒ"}, {n:"è’è¬¬çš„ç”Ÿè‚‰", t:"walk", tip:"é«˜CPå€¼çƒ¤è‚‰"}], note: "" },
                { time:"16:00", type:"choice", title:"ä¸‹åˆè‡ªç”±é¸", desc:"ç´¯äº†å—ï¼Ÿé¸ä¸€å€‹å–œæ­¡çš„", choices: [{n:"A é€›è¡—", desc:"Olive Young æ——è‰¦åº— / 8ç§’", target:"ì˜¬ë¦¬ë¸Œì˜ ëª…ë™"}, {n:"B è–å ‚", desc:"æ˜æ´è–å ‚ æ‹ç¾ç…§", target:"ëª…ë™ì„±ë‹¹"}, {n:"C å’–å•¡", desc:"Pink Pool Cafe", target:"ìŠ¤íƒ€ì¼ë‚œë‹¤ í•‘í¬í’€ì¹´í˜"}, {n:"D äº‚æ‰“ç§€", desc:"17:00 å ´æ¬¡ (é€±æ—¥æœ‰ä¸‹åˆå ´)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" },
                { title:"æ¨‚å¤©ç™¾è²¨ & å…ç¨…åº—", desc:"B1 é£Ÿå“è¡— / 9-12F å…ç¨…åº— (è­·ç…§)", map:"ë¡¯ë°ë°±í™”ì  ë³¸ì ", brands: ["Gentle Monster", "Tamburins", "Matin Kim"], note: "" },
                { time:"19:00", type:"meal", title:"æ™šé¤ï¼šéŸ“å¼çƒ¤è‚‰", opts:[{n:"ç‹å¦ƒå®¶", t:"res"}, {n:"é»ƒé‡‘ç‰§å ´", t:"res"}, {n:"è‚‰çµ±ç¸½", t:"wait"}], note: "" }
            ]
        },
        { 
            d: 2, date: "1/26 (ä¸€)", title: "å—å¤§é–€ & æ±å¤§é–€",
            items: [
                { time:"09:30", title:"æ™¯ç¦å®®", desc:"ç©¿éŸ“æœé€²å ´å…è²» (æ¨è–¦In KoreaéŸ“æœ)", map:"ê²½ë³µê¶", note: "" },
                { time:"12:00", type:"meal", title:"è¥¿æ‘åˆé¤", opts:[{n:"åœŸä¿—æ‘è”˜é›æ¹¯", t:"walk"}, {n:"é€šä»å¸‚å ´", t:"walk", tip:"éŠ…éŒ¢ä¾¿ç•¶"}, {n:"å¤§å¾æ›¸åº—", t:"walk", tip:"IUæ‹æ”åœ°"}], note: "" },
                { time:"14:00", title:"å—å¤§é–€å¸‚å ´ (ç«¥è£/æ£‰è¢«)", desc:"Dæ£Ÿæ£‰è¢«(äº¬ä¸€å±‹)ã€Eæ£Ÿ3FèŠ±å¸‚(æ°›åœç‡ˆ)", map:"ë‚¨ëŒ€ë¬¸ì‹œì¥", brands: ["Burdeng", "äº¬ä¸€å±‹"], note: "" },
                { time:"15:30", title:"ILKW Showroom (ç‡ˆå…·)", desc:"èµ°è·¯å»å°é¢(æœƒè³¢ç«™)çœ‹Snowmanç‡ˆ", map:"ì¼ê´‘ì „êµ¬ ë¼ì´íŒ…ë£¸ ì„œìš¸", note: "" },
                { time:"16:30", type:"choice", title:"ä¸‹åˆä¸‰é¸ä¸€", desc:"è²·å®Œæ±è¥¿å»å“ªï¼Ÿ", choices: [{n:"A ä¼‘æ¯", desc:"å›é£¯åº—æ”¾æˆ°åˆ©å“", target:"L7 ëª…ë™"}, {n:"B å’–å•¡", desc:"Molto Espresso Bar", target:"ëª°ë˜ ì´íƒˆë¦¬ì•ˆ ì—ìŠ¤í”„ë ˆì†Œë°”"}, {n:"C äº‚æ‰“ç§€", desc:"17:00 å ´æ¬¡ (è¿‘é£¯åº—)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" },
                { time:"19:30", type:"choice", title:"æ™šä¸Šä¸‰é¸ä¸€", desc:"é€›è¡— vs ä¼‘æ¯", choices: [{n:"A é€›è¡—", desc:"æ±å¤§é–€ DDP ç«ç‘°èŠ±æµ·/æ‰¹ç™¼", target:"DDP"}, {n:"B æ±—è’¸", desc:"Sparex æ±—è’¸å¹• æ“æ¾¡ä¼‘æ¯", target:"ìŠ¤íŒŒë ‰ìŠ¤ ë™ëŒ€ë¬¸"}, {n:"C äº‚æ‰“ç§€", desc:"20:00 å ´æ¬¡ (æ˜æ´)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" }
            ]
        },
        { 
            d: 3, date: "1/27 (äºŒ)", title: "å°å­©çš„é¸æ“‡æ—¥",
            items: [
                { type:"choice", title:"è¶…å¤šæ–¹æ¡ˆ (è¦–å¤©æ°£é«”åŠ›)", desc:"Plan A-H ä»»å›æŒ‘é¸", choices: [{n:"A æˆ¶å¤–", desc:"å—æ€¡å³¶/æ»‘é›ª (å¥½å¤©æ°£)", target:"ë‚¨ì´ì„¬"}, {n:"B å®¤å…§", desc:"æ¨‚å¤©ä¸–ç•Œ+æ°´æ—é¤¨ (è ¶å®¤)", target:"ë¡¯ë°ì›”ë“œ"}, {n:"C æ°´æ—", desc:"COEX æ°´æ—é¤¨+æ˜Ÿç©ºåœ–æ›¸é¤¨", target:"ì½”ì—‘ìŠ¤ ì•„ì¿ ì•„ë¦¬ì›€"}, {n:"D å‹•ç•«", desc:"é¦–çˆ¾å‹•ç•«ä¸­å¿ƒ (Pororo/Tayoæœ¬ç‡Ÿ)", target:"ì„œìš¸ì• ë‹ˆë©”ì´ì…˜ì„¼í„°"}, {n:"E HiKR", desc:"å¥½å®¢ç©ºé–“ (å…è²»åª’é«”è—è¡“)", target:"í•˜ì´ì»¤ê·¸ë¼ìš´ë“œ"}, {n:"F æ¨‚åœ’", desc:"Pororo Park (è ¶å®¤)", target:"ë½€ë¡œë¡œíŒŒí¬ ë¡¯ë°ì›”ë“œì "}, {n:"G å‚³çµ±", desc:"å»£è—å¸‚å ´+DDP", target:"DDP"}, {n:"H å‹•ç‰©", desc:"å…’ç«¥å¤§å…¬åœ’", target:"ì„œìš¸ì–´ë¦°ì´ëŒ€ê³µì›"}], note: "" },
                { title:"ç‰¹è‰²ç¾é£Ÿæ¨è–¦", desc:"æƒ³åƒæµ·é®®æ‹‰éºµï¼Ÿæ¨è–¦å»å¼˜å¤§/æ±Ÿå—", map:"", brands: ["æ¿Ÿå·é‡‘è¬ç¦", "æ–‡ä¾†æ´ Chae Yoon Hee"], note: "" },
                { time:"19:00", type:"choice", title:"å¤œæ™šå››é¸ä¸€", desc:"çœ‹é«”åŠ›æ±ºå®š", choices: [{n:"A æ™¯é»", desc:"å—å±±å¡”å¤œæ™¯ (æ­çºœè»Š)", target:"ë‚¨ì‚°ì¼€ì´ë¸”ì¹´"}, {n:"B æŒ‰æ‘©", desc:"æ˜æ´æŒ‰æ‘© + åƒç‚¸é›", target:"BHCì¹˜í‚¨ ëª…ë™ë³¸ì "}, {n:"C æ•£æ­¥", desc:"æ¸…æºªå· æ•£æ­¥çœ‹ç‡ˆå…‰", target:"ì²­ê³„ì²œ"}, {n:"D äº‚æ‰“ç§€", desc:"20:00 å ´æ¬¡ (èˆ’å£“)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" }
            ]
        },
        { 
            d: 4, date: "1/28 (ä¸‰)", title: "ç‹é·—äº­ & è–æ°´æ´",
            items: [
                { time:"11:00", title:"ç‹é·—äº­ æ½®ç‰Œå·¡ç¦®", desc:"å³¶å±±å…¬åœ’å‘¨é‚Šï¼Œé«˜ç´šæ„Ÿæ»¿æ»¿", map:"í•˜ìš°ìŠ¤ ë„ì‚°", brands: ["Haus Dosan", "StÃ¼ssy", "Supreme", "London Bagel"], note: "" },
                { time:"14:30", type:"choice", title:"è–æ°´æ´ä¸‰é¸ä¸€", desc:"é€›è¡— vs æºœå°å­©", choices: [{n:"A é€›è¡—", desc:"Dior/ADER/LCDC æ½®ç‰Œå·¡ç¦®", target:"ì„±ìˆ˜ë™ ì¹´í˜ê±°ë¦¬"}, {n:"B å…¬åœ’", desc:"é¦–çˆ¾æ—å…¬åœ’ æ•£æ­¥çœ‹é¹¿", target:"ì„œìš¸ìˆ²"}, {n:"C äº‚æ‰“ç§€", desc:"å›æ˜æ´çœ‹ 17:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" },
                { time:"17:00", type:"meal", title:"è–æ°´æ´æ™šé¤", opts:[{n:"ç¥–å‚³é¦¬éˆ´è–¯æ¹¯", t:"wait"}, {n:"Daelim Guksu", t:"walk", tip:"æº«éºµ"}, {n:"Onion Cafe", t:"walk"}], note: "" },
                { time:"20:00", type:"choice", title:"æ™šä¸ŠçºŒæ”¤", desc:"åƒé£½å¾Œæ´»å‹•", choices: [{n:"A äº‚æ‰“ç§€", desc:"20:00 å ´æ¬¡ (ç¶“å…¸å¿…çœ‹)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}, {n:"B é€›è¡—", desc:"Olive Young æ˜æ´æ——è‰¦åº—", target:"ì˜¬ë¦¬ë¸Œì˜ ëª…ë™"}], note: "" }
            ]
        },
        { 
            d: 5, date: "1/29 (å››)", title: "æ±çŸ£å³¶ ç¾ä»£ç™¾è²¨",
            items: [
                { time:"10:30", title:"Zoolung Zoolung", desc:"æ°¸ç™»æµ¦å®¤å…§å‹•ç‰©åœ’ (è¦ªå­)", map:"ì£¼ë ì£¼ë  ì˜ë“±í¬", note: "" },
                { time:"13:30", title:"The Hyundai Seoul", desc:"ç¾ä»£ç™¾è²¨ï¼Œç›®å‰é¦–çˆ¾æœ€å¤§æœ€æ½®", map:"ë”í˜„ëŒ€ ì„œìš¸", brands: ["Matin Kim", "Marithe", "Arket", "Blue Bottle"], note: "" },
                { type:"choice", title:"å‚æ™šä¸‰é¸ä¸€", desc:"å®¤å…§ vs æˆ¶å¤–", choices: [{n:"A é€›è¡—", desc:"ç™¾è²¨B1/B2 ç¹¼çºŒé€›/åƒæ™šé¤", target:"ë”í˜„ëŒ€ ì„œìš¸"}, {n:"B æ°´æ—", desc:"63å¤§æ¨“ Aqua Planet æ°´æ—é¤¨", target:"ì•„ì¿ ì•„í”Œë¼ë„· 63"}, {n:"C äº‚æ‰“ç§€", desc:"å›æ˜æ´çœ‹ 17:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" },
                { time:"19:00", type:"choice", title:"æ™šé¤ä¸‰é¸ä¸€", desc:"åœ¨åœ°é«”é©—", choices: [{n:"A æµ·é®®", desc:"é·ºæ¢æ´¥æ°´ç”¢å¸‚å ´ åƒå¸ç‹èŸ¹", target:"ë…¸ëŸ‰ì§„ìˆ˜ì‚°ì‹œì¥"}, {n:"B æ¼¢æ±Ÿ", desc:"æ¼¢æ±Ÿå…¬åœ’ åƒç…®æ³¡éºµ", target:"ì—¬ì˜ë„í•œê°•ê³µì›"}, {n:"C äº‚æ‰“ç§€", desc:"è¶•å›æ˜æ´çœ‹ 20:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" }
            ]
        },
        { 
            d: 6, date: "1/30 (äº”)", title: "å¼˜å¤§ & æœ›é ",
            items: [
                { time:"11:00", title:"å¼˜å¤§å•†åœˆ å¿…é€›", desc:"AK Plaza, Object, Shoopen", map:"í™ëŒ€ì…êµ¬ì—­", brands: ["Object", "Musinsa", "Shoopen"], note: "" },
                { time:"12:30", type:"meal", title:"å¼˜å¤§åˆé¤", opts:[{n:"ç”³ç¾äº¬è¾£ç‚’é›æ’", t:"walk"}, {n:"è±¬è…³å°å§", t:"walk"}], note: "" },
                { type:"choice", title:"ä¸‹åˆå››é¸ä¸€", desc:"æ–‡é’ vs å‚³çµ±", choices: [{n:"A å»¶å—", desc:"å»¶å—æ´ æ–‡é’å’–å•¡/å°åº—", target:"ì—°ë‚¨ë™"}, {n:"B ç›Šå–„", desc:"ç›Šå–„æ´ éŸ“å±‹å’–å•¡/é£¾å“", target:"ìµì„ ë™"}, {n:"C å¸‚å ´", desc:"æœ›é å¸‚å ´ åƒç‚¸é›/å¯æ¨‚é¤…", target:"ë§ì›ì‹œì¥"}, {n:"D äº‚æ‰“ç§€", desc:"17:00 å ´æ¬¡ (éœ€å›æ˜æ´)", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}], note: "" },
                { time:"18:30", title:"æ¨‚å¤©è¶…å¸‚", desc:"é¦–çˆ¾ç«™åšæœ€å¾Œé›¶é£Ÿæ¡è³¼", map:"ë¡¯ë°ë§ˆíŠ¸ ì„œìš¸ì—­ì ", note: "" }
            ]
        },
        { 
            d: 7, date: "1/31 (å…­)", title: "å›å®¶",
            items: [
                { time:"08:30", title:"Check-out", desc:"æ­æ©Ÿå ´å·´å£« 6001/6015 å‰å¾€ä»å·", note: "" },
                { time:"11:00", title:"æ©Ÿå ´é ˜å–å…ç¨…å“", desc:"éæµ·é—œå¾Œå»é ˜è²¨æ«ƒæª¯", note: "" },
                { time:"12:00", title:"èµ·é£›", desc:"å¹³å®‰å›å®¶", note: "" }
            ]
        }
    ];

    createApp({
        setup() {
            const currentView = ref('plan');
            const itinerary = ref([]);
            const selectedDayIndex = ref(0);
            const dbStatus = ref('connecting'); // connecting, connected, error, empty
            const loading = ref(true);
            
            // Edit Modal State
            const editingItem = ref(null);
            const editForm = reactive({ title: '', note: '' });
            const isSaving = ref(false);

            // Calc State
            const calcInput = ref('');
            const rate = ref(0.024);

            // Info Modal State
            const infoModal = reactive({ show: false, title: '', desc: '' });
            
            // Guide Data
            const guideData = {
                popups: [
                    { title: "é¦–çˆ¾ç‡ˆç¯€", desc: "å…‰åŒ–é–€å»£å ´ | å†¬å­£é™å®š", tag: "é™å®š", modalDesc:"æ™‚é–“ï¼šé è¨ˆè‡³ 1æœˆåº•\nåœ°é»ï¼šå…‰åŒ–é–€å»£å ´" },
                    { title: "Olive Young å¤§ä¿ƒ", desc: "æ»¿é¡é€€ç¨… + è´ˆå“", tag: "SALE", modalDesc:"è¨˜å¾—å¸¶è­·ç…§é€€ç¨…ï¼" }
                ]
            };
            const survivalCards = [
                { title: "ä½ å¥½", k: "ì•ˆë…•í•˜ì„¸ìš”", icon: "ğŸ‘‹", desc: "å®‰å¦å“ˆã„™ã„Ÿå‘¦" },
                { title: "è¬è¬", k: "ê°ì‚¬í•©ë‹ˆë‹¤", icon: "ğŸ™", desc: "åº·æ’’å“ˆå’ªæ­" },
                { title: "æˆ‘è¦é€™å€‹", k: "ì´ê±° ì£¼ì„¸ìš”", icon: "ğŸ‘‰", desc: "ä¼Šå‹¾ æœ±ã„™ã„Ÿå‘¦" },
                { title: "æ´—æ‰‹é–“", k: "í™”ì¥ì‹¤", icon: "ğŸš»", desc: "èŠ±æ±Ÿæ´—" },
                 { title: "ä¾¿å®œé»", k: "ê¹ì•„ì£¼ì„¸ìš”", icon: "ğŸ’¸", desc: "å˜å˜æœ±ã„™ã„Ÿå‘¦" },
                { title: "è¢‹å­", k: "ë´‰íˆ¬ ì£¼ì„¸ìš”", icon: "ğŸ›ï¸", desc: "å´©åœŸ æœ±ã„™ã„Ÿå‘¦" }
            ];

            const weather = reactive({ temp: '--', desc: 'è¼‰å…¥ä¸­', icon: 'fa-cloud' });

            // Computed
            const currentDay = computed(() => itinerary.value[selectedDayIndex.value]);
            const statusText = computed(() => {
                if (dbStatus.value === 'connected') return 'å¤šäººé€£ç·šä¸­';
                if (dbStatus.value === 'empty') return 'è³‡æ–™åº«ç‚ºç©º';
                if (dbStatus.value === 'error') return 'é€£ç·šéŒ¯èª¤';
                return 'é€£ç·šä¸­...';
            });
            const calcTwd = computed(() => Math.round((parseFloat(calcInput.value) || 0) * rate.value).toLocaleString());
            const calcTax = computed(() => {
                const v = parseFloat(calcInput.value) || 0;
                if(v < 30000) return 0;
                return 'â‚© ' + (v >= 75000 ? 5000 : (v >= 50000 ? 3500 : 1500)).toLocaleString();
            });

            // Database Sync Logic
            onMounted(async () => {
                fetchWeather();
                if (!db) {
                    dbStatus.value = 'error';
                    loading.value = false;
                    return;
                }

                try {
                    const docRef = doc(db, "trips", DOC_ID);
                    
                    onSnapshot(docRef, (docSnap) => {
                        loading.value = false;
                        if (docSnap.exists()) {
                            console.log("è³‡æ–™åŒæ­¥æˆåŠŸ");
                            itinerary.value = docSnap.data().itinerary;
                            dbStatus.value = 'connected';
                        } else {
                            console.log("è³‡æ–™åº«æ˜¯ç©ºçš„");
                            dbStatus.value = 'empty';
                            itinerary.value = [];
                        }
                    }, (error) => {
                        console.error("ç›£è½å¤±æ•—:", error);
                        dbStatus.value = 'error';
                        itinerary.value = DEFAULT_ITINERARY; // é™ç´šé¡¯ç¤º
                        loading.value = false;
                    });

                } catch (e) {
                    console.error("Firebase é€£ç·šéŒ¯èª¤", e);
                    dbStatus.value = 'error';
                    loading.value = false;
                }
            });

            // Actions
            const uploadDefaultData = async () => {
                if(!db) return;
                try {
                    loading.value = true;
                    await setDoc(doc(db, "trips", DOC_ID), {
                        itinerary: DEFAULT_ITINERARY,
                        lastUpdated: new Date()
                    });
                } catch(e) {
                    alert("åˆå§‹åŒ–å¤±æ•—: " + e.message);
                    loading.value = false;
                }
            };

            const openEditModal = (dIdx, iIdx, item) => {
                editingItem.value = { dIdx, iIdx };
                editForm.title = item.title;
                editForm.note = item.note || '';
            };

            const saveEdit = async () => {
                if (!editingItem.value || !db) return;
                isSaving.value = true;

                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                const { dIdx, iIdx } = editingItem.value;
                
                if (newItinerary[dIdx] && newItinerary[dIdx].items[iIdx]) {
                    newItinerary[dIdx].items[iIdx].title = editForm.title;
                    newItinerary[dIdx].items[iIdx].note = editForm.note;
                }

                try {
                    const docRef = doc(db, "trips", DOC_ID);
                    await updateDoc(docRef, {
                        itinerary: newItinerary,
                        lastUpdated: new Date()
                    });
                    editingItem.value = null;
                } catch (e) {
                    alert("å„²å­˜å¤±æ•—: " + e.message);
                } finally {
                    isSaving.value = false;
                }
            };
            
            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current=temperature_2m,weather_code&timezone=Asia%2FSeoul');
                    const d = await res.json();
                    weather.temp = Math.round(d.current.temperature_2m);
                    weather.desc = d.current.weather_code > 2 ? 'å¤šé›²' : 'æ™´æœ—';
                    weather.icon = d.current.weather_code > 2 ? 'fa-cloud' : 'fa-sun';
                } catch(e) {}
            };

            const resetCalc = () => calcInput.value = '';
            const getSearchLink = (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`;
            const getNaverLink = (k) => `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(k)}`;
            const openInfoModal = (title, desc) => { infoModal.title = title; infoModal.desc = desc; infoModal.show = true; };

            return {
                itinerary, selectedDayIndex, currentDay,
                dbStatus, loading, uploadDefaultData, statusText,
                editingItem, editForm, openEditModal, saveEdit, isSaving,
                currentView, weather, fetchWeather,
                calcInput, calcTwd, calcTax, resetCalc, rate,
                guideData, survivalCards, infoModal, openInfoModal,
                getSearchLink, getNaverLink
            };
        }
    }).mount('#app');
</script>
</body>
</html>


