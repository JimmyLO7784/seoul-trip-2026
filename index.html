<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¦–çˆ¾ 2026 (éŸ“èªæ“´å……ç‰ˆ)</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#F2F1F6',
                        primary: '#C8A47E',
                        'primary-dark': '#A68665',
                        'accent-green': '#34C759',
                    },
                    boxShadow: { 'ios': '0 2px 8px rgba(0,0,0,0.04)' },
                    animation: { 'spin-slow': 'spin 3s linear infinite' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #E5E5E5; -webkit-tap-highlight-color: transparent; font-family: "M PLUS Rounded 1c", sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(-20px); }
        .zoom-scroll { overflow: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden select-none">

<div id="app" class="relative w-full h-full max-w-full md:max-w-[480px] mx-auto bg-[#F2F1F6] shadow-2xl overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="flex-none px-5 py-3 pt-[calc(12px+env(safe-area-inset-top))] bg-bg/90 backdrop-blur-md border-b border-black/5 z-50 flex justify-between items-center sticky top-0">
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight text-gray-900 flex items-center gap-2">
                SEOUL <span class="text-primary">2026</span>
                <span v-if="dbStatus === 'connected'" class="w-2 h-2 rounded-full bg-green-500 animate-pulse" title="å·²é€£ç·š"></span>
                <span v-else-if="dbStatus === 'offline'" class="w-2 h-2 rounded-full bg-gray-400 border border-white" title="é›¢ç·šæ¨¡å¼"></span>
                <span v-else class="w-2 h-2 rounded-full bg-red-400" title="æ–·ç·š"></span>
            </h1>
            <p class="text-xs font-semibold text-gray-400 -mt-1 flex items-center gap-1">
                {{ statusText }}
                <span v-if="dbStatus === 'offline'" class="text-[9px] bg-gray-200 px-1.5 rounded text-gray-600">OFFLINE</span>
            </p>
        </div>
        <div class="flex items-center gap-2">
            <button @click="showSubwayModal = true" class="w-8 h-8 bg-white border border-gray-200 rounded-full flex items-center justify-center text-gray-600 active:scale-95 transition-transform shadow-sm">
                <i class="fa-solid fa-train-subway text-xs"></i>
            </button>
            <button v-if="dbStatus === 'empty'" @click="uploadDefaultData" class="text-xs bg-primary text-white px-3 py-1 rounded-full font-bold shadow-sm animate-bounce">
                åˆå§‹åŒ–
            </button>
            <div v-if="weather.temp !== '--'" class="flex flex-col items-end pl-2">
                <div class="text-lg font-bold leading-none">{{ weather.temp }}Â°</div>
                <div class="text-[10px] text-gray-400"><i :class="['fa-solid', weather.icon]"></i> {{ weather.desc }}</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden pb-[100px] hide-scroll relative">
        
        <!-- View: PLAN -->
        <div v-show="currentView === 'plan'">
            <div v-if="loading" class="flex flex-col items-center justify-center h-[50vh] text-gray-400 gap-3">
                <i class="fa-solid fa-circle-notch animate-spin text-3xl"></i>
                <span class="text-sm font-bold">æ­£åœ¨è¼‰å…¥è¡Œç¨‹...</span>
            </div>

            <div v-else class="p-4 space-y-5">
                 <!-- Weather Card -->
                 <div @click="fetchWeather" class="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-[#6DD5FA] to-[#2980B9] p-5 text-white shadow-lg shadow-blue-500/20 active:scale-95 transition-transform duration-200 cursor-pointer">
                    <div class="relative z-10 flex justify-between items-center">
                        <div>
                            <div class="text-4xl font-extrabold tracking-tighter">{{ weather.temp }}<span v-if="weather.temp !== '--'">Â°</span></div>
                            <div class="text-sm font-bold opacity-90 mt-1">{{ weather.desc }}</div>
                        </div>
                        <i :class="['fa-solid text-4xl opacity-90', weather.icon]"></i>
                    </div>
                </div>

                <!-- Date Slider -->
                <div class="sticky top-0 z-40 -mx-4 px-4 py-2 bg-[#F2F1F6]/95 backdrop-blur-sm">
                    <div class="flex gap-2 overflow-x-auto hide-scroll pb-2">
                        <div v-for="(day, index) in itinerary" :key="index" 
                             @click="selectedDayIndex = index"
                             :class="['flex-none w-[70px] p-2.5 rounded-2xl text-center transition-all duration-200 cursor-pointer border border-transparent shadow-sm', 
                                      selectedDayIndex === index ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-white text-gray-400']">
                            <div class="text-[10px] font-bold opacity-80">Day {{ day.d }}</div>
                            <div class="text-lg font-extrabold leading-tight">{{ day.date.split(' ')[0] }}</div>
                        </div>
                    </div>
                </div>

                <!-- Itinerary Items -->
                <div :key="selectedDayIndex" class="space-y-4">
                    <div v-if="currentDay" class="bg-white rounded-2xl p-5 text-center shadow-ios border border-gray-100/50">
                        <h2 class="text-xl font-extrabold text-gray-800">{{ currentDay.title }}</h2>
                        <div class="text-xs text-gray-400 mt-1">{{ currentDay.date }}</div>
                    </div>

                    <div v-for="(item, idx) in currentDay?.items" :key="idx" class="relative group">
                        <button @click="openModal('edit', selectedDayIndex, idx, item)" class="absolute -right-2 -top-2 z-10 w-8 h-8 bg-gray-900 rounded-full text-white text-xs flex items-center justify-center shadow-lg opacity-80 hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                        <div v-if="!item.type || item.type === 'normal'" class="bg-white rounded-[20px] p-4 shadow-ios border border-gray-50 flex justify-between items-start">
                            <div class="flex-1 min-w-0 pr-3">
                                <a :href="getSearchLink(item.title)" target="_blank" class="font-bold text-base text-gray-800 block flex items-center gap-1">{{ item.title }}</a>
                                <div class="text-xs text-gray-500 mt-1 whitespace-pre-line">{{ item.desc }}</div>
                                <div v-if="item.brands" class="flex flex-wrap gap-1.5 mt-2"><a v-for="brand in item.brands" :href="getSearchLink(brand + ' ' + item.title)" target="_blank" class="px-2 py-0.5 rounded text-[10px] bg-gray-50 border border-gray-100 text-gray-600 hover:bg-gray-100">{{ brand }}</a></div>
                                <div v-if="item.note" class="mt-2 bg-yellow-50 text-yellow-800 text-xs p-2 rounded-lg border border-yellow-100 flex gap-2 items-start"><i class="fa-solid fa-sticky-note mt-0.5 opacity-50"></i><span>{{ item.note }}</span></div>
                            </div>
                            <div class="flex flex-col items-end gap-2 shrink-0">
                                <span v-if="item.time" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md">{{ item.time }}</span>
                                <a v-if="item.map" :href="getNaverLink(item.map)" target="_blank" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-accent-green hover:bg-green-100"><i class="fa-solid fa-location-arrow text-sm"></i></a>
                            </div>
                        </div>

                        <div v-else-if="item.type === 'meal'" class="bg-white rounded-[20px] shadow-ios overflow-hidden border border-gray-50">
                            <div class="bg-gray-50/80 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                                <div class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-utensils text-primary"></i> {{ item.title }}</div>
                                <span v-if="item.time" class="text-xs font-bold text-gray-400 bg-gray-200/50 px-2 py-1 rounded-md">{{ item.time }}</span>
                            </div>
                            <div class="p-4 space-y-3">
                                <div v-for="opt in item.opts" class="flex justify-between items-center text-sm">
                                    <a :href="getSearchLink(opt.n)" target="_blank" class="flex-1 group"><div class="font-bold text-gray-700 flex items-center gap-1">{{ opt.n }}</div><div v-if="opt.tip" class="text-[10px] text-gray-400">{{ opt.tip }}</div></a>
                                    <div class="flex gap-2 items-center"><span :class="['text-[10px] px-2 py-1 rounded font-bold', opt.t==='res'?'bg-green-100 text-green-700':'bg-red-100 text-red-600']">{{ opt.t==='res'?'é ç´„':'æ’éšŠ' }}</span><a v-if="opt.k" :href="getNaverLink(opt.k)" target="_blank" class="w-6 h-6 bg-gray-50 rounded-full flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50"><i class="fa-solid fa-location-arrow text-[10px]"></i></a></div>
                                </div>
                            </div>
                        </div>

                        <div v-else-if="item.type === 'choice'" class="bg-[#FAFAFA] rounded-[20px] p-4 border-2 border-dashed border-gray-200">
                            <div class="flex justify-between items-center mb-1"><div class="text-xs font-bold text-gray-400">{{ item.time || 'æ™‚æ®µ' }}</div><div class="text-center font-bold text-primary-dark">{{ item.title }}</div><div class="w-4"></div></div>
                            <div class="text-center text-xs text-gray-400 mb-3">{{ item.desc }}</div>
                            <div class="flex flex-wrap gap-2">
                                <a v-for="c in item.choices" :href="getSearchLink(c.n + ' ' + c.desc)" target="_blank" class="flex-1 min-w-[45%] bg-white p-3 rounded-xl border border-gray-100 text-center shadow-sm flex items-center justify-between group hover:border-primary/30 transition-colors">
                                    <div class="text-left"><div class="text-[10px] font-bold bg-gray-800 text-white inline-block px-1.5 rounded mb-1">{{ c.n.split(' ')[0] }}</div><div class="text-xs font-bold text-gray-700 flex items-center gap-1">{{ c.desc }}</div></div>
                                    <div v-if="c.target" @click.prevent="window.open(getNaverLink(c.target))" class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50"><i class="fa-solid fa-location-arrow text-[10px]"></i></div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <button @click="openModal('add', selectedDayIndex)" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white hover:text-primary hover:border-primary transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹</button>
                    <div class="h-10"></div>
                </div>
            </div>
        </div>

        <!-- View: CALC -->
        <div v-show="currentView === 'calc'" class="p-5">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4 ml-1">åŒ¯ç‡è¨ˆç®—</h2>
            <div class="bg-gray-900 rounded-[20px] p-4 text-white mb-4 flex justify-between items-center shadow-lg">
                <div><div class="text-[10px] text-gray-400 font-bold mb-0.5">ç›®å‰å…±ç”¨åŒ¯ç‡ (KRW â†’ TWD)</div><div class="text-2xl font-mono font-bold tracking-wider">{{ rate }}</div></div>
                <button @click="openRateModal" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold px-3 py-2 rounded-lg transition-colors"><i class="fa-solid fa-gear"></i> è¨­å®š</button>
            </div>
            <div class="bg-white rounded-[24px] p-6 shadow-ios border border-gray-50 text-right mb-4">
                <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-400">è¼¸å…¥éŸ“å¹£ (KRW)</span><button @click="resetCalc" class="text-xs font-bold text-primary hover:text-primary-dark">æ¸…é™¤</button></div>
                <input type="text" inputmode="decimal" v-model="calcInput" class="w-full text-right text-5xl font-light text-gray-900 placeholder-gray-200 outline-none bg-transparent font-mono mb-4 tracking-tighter" placeholder="0">
                <div class="border-t border-gray-100 py-3 flex justify-between items-center"><span class="text-sm text-gray-400">ç´„åˆå°å¹£</span><span class="text-xl font-bold font-mono text-gray-800">{{ calcTwd }}</span></div>
                <div class="pt-2 flex justify-between items-center"><span class="text-sm text-gray-400">é è¨ˆé€€ç¨…</span><span class="text-xl font-bold font-mono text-accent-green">{{ calcTax }}</span></div>
            </div>
        </div>

        <!-- View: LIST -->
        <div v-show="currentView === 'list'" class="p-5">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4 ml-1">è³¼ç‰©æ¸…å–®</h2>
            <div class="bg-white rounded-[24px] p-5 shadow-ios border border-gray-50 min-h-[50vh]">
                <div class="flex gap-2 mb-6">
                    <input v-model="newItemText" @keyup.enter="addListItem" type="text" placeholder="è¼¸å…¥æƒ³è²·çš„æ±è¥¿..." class="flex-1 bg-gray-50 p-3 rounded-xl text-sm outline-none border border-transparent focus:border-primary/20 transition-all">
                    <button @click="addListItem" class="bg-gray-900 text-white w-12 rounded-xl flex items-center justify-center active:scale-95 transition-transform shadow-lg"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div v-if="shoppingList.length === 0" class="text-center py-12 text-gray-300 text-xs flex flex-col items-center gap-2"><i class="fa-solid fa-basket-shopping text-2xl opacity-20"></i><span>æ¸…å–®æ˜¯ç©ºçš„</span></div>
                <transition-group name="list" tag="div" class="space-y-2">
                    <div v-for="item in shoppingList" :key="item.id" class="flex items-center gap-3 p-3 rounded-xl transition-all" :class="item.checked ? 'bg-gray-50 opacity-60' : 'bg-white border border-gray-100 shadow-sm hover:border-primary/20'">
                        <button @click="toggleListItem(item.id)" :class="['w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors', item.checked ? 'bg-green-500 border-green-500 text-white' : 'border-gray-200 text-transparent']"><i class="fa-solid fa-check text-[10px]"></i></button>
                        <span :class="['flex-1 font-bold text-sm', item.checked ? 'line-through text-gray-400' : 'text-gray-800']">{{ item.text }}</span>
                        <button @click="deleteListItem(item.id)" class="w-8 h-8 rounded-full text-gray-300 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition-colors"><i class="fa-solid fa-trash-can text-xs"></i></button>
                    </div>
                </transition-group>
            </div>
        </div>

        <!-- View: GUIDE (Expanded) -->
        <div v-show="currentView === 'guide'" class="p-4 space-y-5">
            <!-- 4. ç”Ÿå­˜éŸ“èª (NEW: Categorized & Expanded) -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg flex items-center gap-2">ç”Ÿå­˜éŸ“èª <span class="text-[10px] text-gray-400 font-normal">(é»æ“Šç™¼éŸ³)</span></h3>
                </div>
                
                <!-- Category Pills -->
                <div class="flex gap-2 mb-3 overflow-x-auto hide-scroll pb-1">
                    <button v-for="cat in koreanCategories" :key="cat.id" 
                            @click="koreanCat = cat.id"
                            :class="['px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors', 
                                     koreanCat === cat.id ? 'bg-gray-900 text-white shadow-md' : 'bg-gray-100 text-gray-500 hover:bg-gray-200']">
                        {{ cat.name }}
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto hide-scroll">
                    <div v-for="c in filteredKorean" :key="c.k" class="border p-2 rounded-xl text-center hover:bg-gray-50 active:scale-95 transition-all cursor-pointer relative group" @click="playTTS(c.k)">
                        <div class="text-xl mb-1">{{ c.icon }}</div>
                        <div class="font-bold text-sm text-gray-800">{{ c.title }}</div>
                        <div class="text-[10px] text-gray-400 mt-0.5">{{ c.desc }}</div>
                        <div class="absolute top-1 right-1 text-gray-300 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-volume-high text-[10px]"></i></div>
                    </div>
                </div>
            </div>

            <!-- 1. å¿«é–ƒå¸‚é›† -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg">å¿«é–ƒ & å¸‚é›†</h3>
                    <button @click="checkUpdates('popup')" class="text-xs text-primary font-bold flex items-center gap-1 active:opacity-50 border border-primary/20 px-2 py-1 rounded-full"><i class="fa-solid fa-rotate-right transition-transform duration-700" :class="{'animate-spin': isUpdatingPopup}"></i> {{ hasUpdatedPopup ? 'å·²æ›´æ–°' : 'æ›´æ–°' }}</button>
                </div>
                <div class="space-y-2">
                    <transition-group name="list">
                        <div v-for="p in popupList" :key="p.title" class="flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" @click="openInfoModal(p.modalTitle || p.title, p.modalDesc || p.desc)">
                            <span :class="['px-2 py-1 rounded text-[10px] font-bold h-fit shrink-0 w-12 text-center', p.tagClass || 'bg-purple-100 text-purple-600']">{{ p.tag }}</span>
                            <div><div class="font-bold text-sm">{{ p.title }}</div><div class="text-xs text-gray-500 line-clamp-1">{{ p.desc }}</div></div>
                        </div>
                    </transition-group>
                </div>
            </div>

            <!-- 2. æ½®ç‰Œå¿«è¨Š -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg">æ½®ç‰Œ & è³¼ç‰©</h3>
                    <button @click="checkUpdates('brand')" class="text-xs text-primary font-bold flex items-center gap-1 active:opacity-50 border border-primary/20 px-2 py-1 rounded-full"><i class="fa-solid fa-rotate-right transition-transform duration-700" :class="{'animate-spin': isUpdatingBrand}"></i> {{ hasUpdatedBrand ? 'å·²æ›´æ–°' : 'æ›´æ–°' }}</button>
                </div>
                <div class="space-y-2">
                    <transition-group name="list">
                        <div v-for="b in brandList" :key="b.title" class="flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" @click="openInfoModal(b.modalTitle || b.title, b.modalDesc || b.desc)">
                            <span :class="['px-2 py-1 rounded text-[10px] font-bold h-fit shrink-0 w-12 text-center', b.tagClass || 'bg-blue-100 text-blue-600']">{{ b.tag }}</span>
                            <div><div class="font-bold text-sm">{{ b.title }}</div><div class="text-xs text-gray-500 line-clamp-1">{{ b.desc }}</div></div>
                        </div>
                    </transition-group>
                </div>
            </div>

            <!-- 5. å¸¸ç”¨åœ°åœ– -->
            <div class="bg-white rounded-2xl p-1 shadow-sm border border-gray-100">
                <a href="https://m.map.naver.com/" target="_blank" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl transition-colors">
                    <div class="flex items-center gap-3"><i class="fa-solid fa-map text-green-500 text-xl"></i><div><div class="font-bold text-sm">Naver Map</div><div class="text-xs text-gray-400">éŸ“åœ‹å¿…å‚™å°èˆª</div></div></div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </a>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="flex-none h-[calc(60px+env(safe-area-inset-bottom))] bg-white/95 backdrop-blur-xl border-t border-gray-200 pb-safe-bottom flex justify-around items-center z-50">
        <button v-for="tab in tabs" :key="tab.id" @click="currentView = tab.id" 
                :class="['flex-1 h-full flex flex-col items-center justify-center gap-1 transition-colors', currentView === tab.id ? 'text-primary-dark' : 'text-gray-400']">
            <i :class="['fa-solid text-xl transition-transform duration-200', tab.icon, currentView === tab.id ? '-translate-y-0.5' : '']"></i>
            <span class="text-[10px] font-bold tracking-wide">{{ tab.name }}</span>
        </button>
    </nav>

    <!-- Modal: SUBWAY -->
    <transition name="fade">
        <div v-if="showSubwayModal" class="absolute inset-0 z-[150] bg-black/95 flex flex-col backdrop-blur-md" @click="showSubwayModal = false">
            <div class="flex justify-between items-center px-5 py-4 text-white bg-black/50 z-20">
                <h3 class="font-bold text-lg">é¦–çˆ¾åœ°éµåœ–</h3>
                <button @click="showSubwayModal = false" class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-700 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 zoom-scroll flex items-start justify-center overflow-auto relative p-2" @click.stop>
                <img src="https://upload.wikimedia.org/wikipedia/commons/7/7b/Seoul_Metro_Subway_Map_English.png" 
                     class="max-w-none h-[120vh] object-contain pointer-events-auto bg-white rounded-lg" 
                     alt="Subway Map"
                     onerror="this.style.display='none'; document.getElementById('map-fallback').style.display='flex';">
                <div id="map-fallback" style="display:none;" class="absolute inset-0 flex flex-col items-center justify-center text-white gap-4">
                    <i class="fa-solid fa-map-location-dot text-4xl text-gray-500"></i>
                    <span class="text-sm text-gray-400">ç„¡æ³•è¼‰å…¥åœ–ç‰‡</span>
                    <a href="https://www.seoulmetro.co.kr/en/cyberStation.do" target="_blank" class="bg-primary text-white px-5 py-3 rounded-xl font-bold text-sm shadow-lg">å‰å¾€å®˜ç¶²</a>
                </div>
            </div>
            <div class="px-5 py-4 text-center text-gray-400 text-[10px] bg-black/50 z-20 pb-safe-bottom">
                <i class="fa-solid fa-hand-pointer animate-bounce mr-1"></i> å¯é›™æŒ‡æˆ–æ»‘å‹•ç¸®æ”¾æŸ¥çœ‹
            </div>
        </div>
    </transition>

    <!-- Modals: Edit, Rate, Info -->
    <transition name="slide-up">
        <div v-if="showEditModal" class="absolute inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end justify-center" @click="closeEditModal">
            <div class="bg-white w-full h-[85vh] rounded-t-[24px] p-6 shadow-2xl flex flex-col" @click.stop>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-extrabold text-gray-900">{{ editForm.mode === 'add' ? 'æ–°å¢è¡Œç¨‹' : 'ç·¨è¼¯è¡Œç¨‹' }}</h3>
                    <button @click="closeEditModal" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto hide-scroll space-y-5 pb-6">
                    <div><label class="text-xs font-bold text-gray-400 block mb-2">é¡å‹</label><div class="flex bg-gray-100 p-1 rounded-xl"><button v-for="t in ['normal', 'meal', 'choice']" @click="editForm.type = t" :class="['flex-1 py-2 text-xs font-bold rounded-lg transition-all', editForm.type === t ? 'bg-white shadow-sm text-gray-900' : 'text-gray-400']">{{ t === 'normal' ? 'ä¸€èˆ¬' : (t === 'meal' ? 'é¤å»³' : 'å¤šé¸') }}</button></div></div>
                    <div class="bg-white rounded-2xl p-4 space-y-3 shadow-sm border border-gray-100">
                        <div class="flex gap-3 border-b border-gray-100 pb-3"><div class="w-20"><label class="text-[10px] font-bold text-gray-400 block mb-1">æ™‚é–“</label><input v-model="editForm.time" class="w-full bg-gray-50 p-2 rounded-lg text-sm font-bold text-center outline-none" placeholder="10:00"></div><div class="flex-1"><label class="text-[10px] font-bold text-gray-400 block mb-1">æ¨™é¡Œ *</label><input v-model="editForm.title" class="w-full bg-gray-50 p-2 rounded-lg text-base font-bold outline-none" placeholder="è¡Œç¨‹åç¨±"></div></div>
                        <div><label class="text-[10px] font-bold text-gray-400 block mb-1">æè¿°</label><textarea v-model="editForm.desc" rows="2" class="w-full bg-gray-50 p-2 rounded-lg text-sm resize-none outline-none" placeholder="å‚™è¨»..."></textarea></div>
                    </div>
                    <div class="space-y-4">
                        <div v-if="editForm.type === 'normal'" class="space-y-4"><div><label class="text-xs font-bold text-gray-400 block mb-1">åœ°åœ–é—œéµå­—</label><input v-model="editForm.map" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="éŸ“æ–‡/è‹±æ–‡åº—å"></div><div><label class="text-xs font-bold text-gray-400 block mb-1">å“ç‰Œ/æ¨™ç±¤</label><input v-model="editForm.brandsStr" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="Nike, Adidas..."></div></div>
                        <div v-if="editForm.type === 'meal'" class="space-y-3"><label class="text-xs font-bold text-gray-400 flex justify-between">é¤å»³é¸é … <button @click="addMealOption" class="text-primary"><i class="fa-solid fa-plus"></i></button></label><div v-for="(opt, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative"><button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300"><i class="fa-solid fa-trash text-xs"></i></button><input v-model="opt.n" class="w-full bg-white p-2 rounded border border-gray-100 text-sm font-bold" placeholder="é¤å»³åç¨±"><div class="flex gap-2"><select v-model="opt.t" class="bg-white p-2 rounded border border-gray-100 text-xs flex-1"><option value="walk">ç¾å ´æ’</option><option value="res">å¯é ç´„</option><option value="wait">éœ€å€™ä½</option></select><input v-model="opt.k" class="flex-[2] bg-white p-2 rounded border border-gray-100 text-xs" placeholder="åœ°åœ–é—œéµå­—"></div></div></div>
                        <div v-if="editForm.type === 'choice'" class="space-y-3"><label class="text-xs font-bold text-gray-400 flex justify-between">å¤šé¸æ–¹æ¡ˆ <button @click="addChoiceOption" class="text-primary"><i class="fa-solid fa-plus"></i></button></label><div v-for="(c, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative"><button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300"><i class="fa-solid fa-trash text-xs"></i></button><div class="flex gap-2"><input v-model="c.n" class="w-1/3 bg-white p-2 rounded border border-gray-100 text-sm font-bold text-center" placeholder="Plan A"><input v-model="c.desc" class="w-2/3 bg-white p-2 rounded border border-gray-100 text-sm" placeholder="æè¿°"></div><input v-model="c.target" class="w-full bg-white p-2 rounded border border-gray-100 text-xs" placeholder="åœ°åœ–æœå°‹é—œéµå­—"></div></div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">ç­†è¨˜</label><textarea v-model="editForm.note" rows="2" class="w-full bg-yellow-50 border border-yellow-100 p-3 rounded-xl text-sm" placeholder="ç§äººç­†è¨˜..."></textarea></div>
                </div>
                <div class="pt-4 border-t border-gray-100 flex gap-3"><button v-if="editForm.mode === 'edit'" @click="deleteItem" class="flex-1 bg-red-50 text-red-500 font-bold py-3.5 rounded-xl">åˆªé™¤</button><button @click="saveEdit" class="flex-[3] bg-gray-900 text-white font-bold py-3.5 rounded-xl">{{ isSaving ? '...' : 'å„²å­˜è®Šæ›´' }}</button></div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="showRateModal" class="absolute inset-0 z-[120] bg-black/60 flex items-center justify-center p-6" @click="showRateModal = false">
            <div class="bg-white w-full max-w-sm rounded-[24px] p-6 shadow-2xl" @click.stop>
                <h3 class="text-lg font-extrabold text-gray-900 mb-4">è¨­å®šå…±ç”¨åŒ¯ç‡</h3>
                <div class="mb-4"><label class="text-xs font-bold text-gray-400 block mb-1">æ‰‹å‹•è¼¸å…¥ (1 KRW = ? TWD)</label><input type="number" step="0.0001" v-model="tempRate" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-xl text-center focus:border-primary outline-none"></div>
                <button @click="fetchLiveRate" class="w-full bg-blue-50 text-blue-600 font-bold py-3 rounded-xl text-sm mb-4 active:scale-95 transition-transform flex items-center justify-center gap-2"><i class="fa-solid fa-cloud-arrow-down"></i> å–å¾—ä»Šæ—¥å³æ™‚åŒ¯ç‡</button>
                <div class="flex gap-3"><button @click="showRateModal = false" class="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl">å–æ¶ˆ</button><button @click="saveRate" class="flex-[2] bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/30">å„²å­˜è¨­å®š</button></div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="infoModal.show" class="absolute inset-0 z-[110] bg-black/60 flex items-center justify-center p-6" @click="infoModal.show = false">
            <div class="bg-white w-full max-w-sm rounded-[30px] p-6 shadow-2xl text-center" @click.stop>
                <h3 class="text-xl font-extrabold text-gray-900 mb-3 whitespace-pre-line">{{ infoModal.title }}</h3>
                <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap mb-6">{{ infoModal.desc }}</p>
                <button @click="infoModal.show = false" class="w-full bg-gray-100 text-gray-900 font-bold py-3 rounded-xl">é—œé–‰</button>
            </div>
        </div>
    </transition>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

    const DEFAULT_ITINERARY = [
        { d: 1, date: "1/25 (æ—¥)", title: "æŠµé” & æ˜æ´", items: [ { time:"13:00", title:"L7 é£¯åº— Check-in", desc:"å¯„æ”¾è¡Œæ", map:"L7 ëª…ë™", type:"normal" }, { title:"Money Planet æ›éŒ¢", desc:"å°±åœ¨æ˜æ´ï¼ŒåŒ¯ç‡å„ªï¼", map:"ë¨¸ë‹ˆí”Œë ˆë‹›", type:"normal", brands: ["æ›éŒ¢æ‰€"] }, { title:"é¦–çˆ¾è³¼ç‰©å­£", desc:"å»ã€Œæ˜æ´æ­¡è¿ä¸­å¿ƒã€é ˜å„ªæƒ åˆ¸ & æ­¡è¿ç¦®åŒ…", map:"ëª…ë™ì˜ˆìˆ ê·¹ì¥", type:"normal", brands: ["Welcome Center"] }, { type:"meal", title:"æ˜æ´åˆé¤", opts:[{n:"æ˜æ´é¤ƒå­", t:"wait", tip:"å¿…æ¯”ç™»"}, {n:"ç¥ä»™é›ªæ¿ƒæ¹¯", t:"wait", tip:"æ¿ƒéƒ"}, {n:"è’è¬¬çš„ç”Ÿè‚‰", t:"walk", tip:"çƒ¤è‚‰"}] }, { time:"16:00", type:"choice", title:"ä¸‹åˆè‡ªç”±é¸", desc:"ç´¯äº†å—ï¼Ÿé¸ä¸€å€‹å–œæ­¡çš„", choices: [{n:"A é€›è¡—", desc:"Olive Young", target:"ì˜¬ë¦¬ë¸Œì˜ ëª…ë™"}, {n:"B è–å ‚", desc:"æ˜æ´è–å ‚", target:"ëª…ë™ì„±ë‹¹"}, {n:"C å’–å•¡", desc:"Pink Pool Cafe", target:"ìŠ¤íƒ€ì¼ë‚œë‹¤"}, {n:"D äº‚æ‰“ç§€", desc:"17:00 å ´æ¬¡", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] }, { title:"æ¨‚å¤©ç™¾è²¨ & å…ç¨…åº—", desc:"B1 é£Ÿå“è¡— / 9-12F å…ç¨…åº—", map:"ë¡¯ë°ë°±í™”ì  ë³¸ì ", type:"normal", brands: ["Gentle Monster", "Tamburins"] }, { time:"19:00", type:"meal", title:"æ™šé¤ï¼šéŸ“å¼çƒ¤è‚‰", opts:[{n:"ç‹å¦ƒå®¶", t:"res"}, {n:"é»ƒé‡‘ç‰§å ´", t:"res"}] } ] },
        { d: 2, date: "1/26 (ä¸€)", title: "å—å¤§é–€ & æ±å¤§é–€", items: [ { time:"09:30", title:"æ™¯ç¦å®®", desc:"ç©¿éŸ“æœé€²å ´å…è²»", map:"ê²½ë³µê¶", type:"normal" }, { time:"12:00", type:"meal", title:"è¥¿æ‘åˆé¤", opts:[{n:"åœŸä¿—æ‘è”˜é›æ¹¯", t:"walk"}, {n:"é€šä»å¸‚å ´", t:"walk", tip:"éŠ…éŒ¢ä¾¿ç•¶"}] }, { time:"14:00", title:"å—å¤§é–€å¸‚å ´", desc:"Dæ£Ÿæ£‰è¢«ã€Eæ£Ÿ3FèŠ±å¸‚(æ°›åœç‡ˆ)", map:"ë‚¨ëŒ€ë¬¸ì‹œì¥", type:"normal", brands: ["Burdeng", "äº¬ä¸€å±‹"] }, { time:"15:30", title:"ILKW Showroom", desc:"æœƒè³¢ç«™çœ‹Snowmanç‡ˆ", map:"ì¼ê´‘ì „êµ¬ ë¼ì´íŒ…ë£¸ ì„œìš¸", type:"normal" }, { time:"16:30", type:"choice", title:"ä¸‹åˆä¸‰é¸ä¸€", desc:"è²·å®Œæ±è¥¿å»å“ªï¼Ÿ", choices: [{n:"A ä¼‘æ¯", desc:"å›é£¯åº—", target:"L7 ëª…ë™"}, {n:"B å’–å•¡", desc:"Molto", target:"ëª°ë˜"}, {n:"C äº‚æ‰“ç§€", desc:"17:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] }, { time:"19:30", type:"choice", title:"æ™šä¸Šä¸‰é¸ä¸€", desc:"é€›è¡— vs ä¼‘æ¯", choices: [{n:"A é€›è¡—", desc:"DDP", target:"DDP"}, {n:"B æ±—è’¸", desc:"Sparex", target:"ìŠ¤íŒŒë ‰ìŠ¤"}, {n:"C äº‚æ‰“ç§€", desc:"20:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] } ] },
        { d: 3, date: "1/27 (äºŒ)", title: "å°å­©çš„é¸æ“‡æ—¥", items: [{ type:"choice", title:"è¶…å¤šæ–¹æ¡ˆ (è¦–å¤©æ°£é«”åŠ›)", desc:"Plan A-H ä»»å›æŒ‘é¸", choices: [{n:"A æˆ¶å¤–", desc:"å—æ€¡å³¶", target:"ë‚¨ì´ì„¬"}, {n:"B å®¤å…§", desc:"æ¨‚å¤©ä¸–ç•Œ", target:"ë¡¯ë°ì›”ë“œ"}, {n:"C æ°´æ—", desc:"COEX", target:"ì½”ì—‘ìŠ¤"}, {n:"D å‹•ç•«", desc:"é¦–çˆ¾å‹•ç•«ä¸­å¿ƒ", target:"ì„œìš¸ì• ë‹ˆë©”ì´ì…˜ì„¼í„°"}, {n:"E HiKR", desc:"å¥½å®¢ç©ºé–“", target:"í•˜ì´ì»¤ê·¸ë¼ìš´ë“œ"}, {n:"F æ¨‚åœ’", desc:"Pororo Park", target:"ë½€ë¡œë¡œíŒŒí¬"}] }, { time:"19:00", type:"choice", title:"å¤œæ™šå››é¸ä¸€", desc:"çœ‹é«”åŠ›æ±ºå®š", choices: [{n:"A æ™¯é»", desc:"å—å±±å¡”", target:"Nì„œìš¸íƒ€ì›Œ"}, {n:"B æŒ‰æ‘©", desc:"æ˜æ´æŒ‰æ‘©", target:"ëª…ë™"}] }] },
        { d: 4, date: "1/28 (ä¸‰)", title: "ç‹é·—äº­ & è–æ°´æ´", items: [{ time:"11:00", title:"ç‹é·—äº­æ½®ç‰Œ", desc:"å³¶å±±å…¬åœ’", map:"í•˜ìš°ìŠ¤ ë„ì‚°", type:"normal", brands:["Stussy", "Supreme"] }, { time:"14:30", type:"choice", title:"è–æ°´æ´", desc:"é€›è¡— vs æºœå°å­©", choices: [{n:"A é€›è¡—", desc:"Dior/ADER", target:"ì„±ìˆ˜ë™"}, {n:"B å…¬åœ’", desc:"é¦–çˆ¾æ—", target:"ì„œìš¸ìˆ²"}, {n:"C äº‚æ‰“ç§€", desc:"å›æ˜æ´", target:"ëª…ë™"}] }, { time:"17:00", type:"meal", title:"æ™šé¤", opts:[{n:"ç¥–å‚³é¦¬éˆ´è–¯æ¹¯", t:"wait"}, {n:"Onion Cafe", t:"walk"}] }, { time:"20:00", type:"choice", title:"æ™šä¸ŠçºŒæ”¤", desc:"", choices: [{n:"A äº‚æ‰“ç§€", desc:"20:00 å ´", target:"ëª…ë™"}, {n:"B é€›è¡—", desc:"Olive Young", target:"ì˜¬ë¦¬ë¸Œì˜"}] }] },
        { d: 5, date: "1/29 (å››)", title: "æ±çŸ£å³¶", items: [{ time:"10:30", title:"Zoolung Zoolung", desc:"å®¤å…§å‹•ç‰©åœ’", map:"ì£¼ë ì£¼ë  ì˜ë“±í¬", type:"normal" }, { time:"13:30", title:"ç¾ä»£ç™¾è²¨", desc:"The Hyundai Seoul", map:"ë”í˜„ëŒ€ ì„œìš¸", type:"normal", brands:["Matin Kim"] }, { type:"choice", title:"å‚æ™šäºŒé¸ä¸€", desc:"", choices: [{n:"A é€›è¡—", desc:"ç¹¼çºŒé€›", target:"ë”í˜„ëŒ€"}, {n:"B æ°´æ—", desc:"63å¤§æ¨“", target:"63ë¹Œë”©"}] }, { time:"19:00", type:"choice", title:"æ™šé¤", desc:"", choices: [{n:"A æµ·é®®", desc:"é·ºæ¢æ´¥", target:"ë…¸ëŸ‰ì§„"}, {n:"B æ¼¢æ±Ÿ", desc:"åƒæ³¡éºµ", target:"í•œê°•ê³µì›"}] }] },
        { d: 6, date: "1/30 (äº”)", title: "å¼˜å¤§", items: [{ time:"11:00", title:"å¼˜å¤§å•†åœˆ", desc:"AK Plaza", map:"í™ëŒ€ì…êµ¬ì—­", type:"normal", brands:["Object", "Musinsa"] }, { time:"12:30", type:"meal", title:"åˆé¤", opts:[{n:"ç”³ç¾äº¬è¾£ç‚’é›æ’", t:"walk"}, {n:"è±¬è…³å°å§", t:"walk"}] }, { type:"choice", title:"ä¸‹åˆ", desc:"", choices: [{n:"A å»¶å—", desc:"æ–‡é’", target:"ì—°ë‚¨ë™"}, {n:"B ç›Šå–„", desc:"éŸ“å±‹", target:"ìµì„ ë™"}, {n:"C å¸‚å ´", desc:"æœ›é å¸‚å ´", target:"ë§ì›ì‹œì¥"}] }, { time:"18:30", title:"æ¨‚å¤©è¶…å¸‚", desc:"æ¡è³¼", map:"ë¡¯ë°ë§ˆíŠ¸ ì„œìš¸ì—­ì ", type:"normal" }] },
        { d: 7, date: "1/31 (å…­)", title: "å›å®¶", items: [{ time:"08:30", title:"Check-out", desc:"å»æ©Ÿå ´", type:"normal" }, { time:"12:00", title:"èµ·é£›", desc:"å¹³å®‰å›å®¶", type:"normal" }] }
    ];

    const initialPopups = [
        { title: "é¦–çˆ¾ç‡ˆç¯€", desc: "å…‰åŒ–é–€ | 2026 å†¬å­£", tag: "é™å®š", tagClass: "bg-orange-100 text-orange-600", modalTitle: "é¦–çˆ¾ç‡ˆç¯€", modalDesc: "æ™‚é–“ï¼šè‡³ 1æœˆåº•\nåœ°é»ï¼šå…‰åŒ–é–€å»£å ´" },
        { title: "The Hyundai Seoul", desc: "B2 å‰µæ„å¿«é–ƒå±¤", tag: "ç†±é–€", tagClass: "bg-purple-100 text-purple-600", modalTitle: "The Hyundai Seoul B2", modalDesc: "åœ°é»ï¼šæ±çŸ£å³¶ (Day 5)" },
        { title: "å»£è—å¸‚å ´", desc: "å¾©å¤å¸‚é›† & æ£‰è¢«", tag: "å¸‚é›†", tagClass: "bg-green-100 text-green-600", modalTitle: "å»£è—å¸‚å ´", modalDesc: "åœ°é»ï¼šé¾è·¯5è¡—ç«™\nå¿…åƒï¼šç¶ è±†ç…é¤…ã€ç”Ÿç‰›è‚‰ã€éº»è—¥é£¯æ²ã€‚" },
    ];
    const newPopupsMock = [{ title: "Burberry ç«ç‘°", desc: "è–æ°´æ´ | å’–å•¡å»³", tag: "NEW", tagClass: "bg-pink-100 text-pink-600", modalTitle: "Burberry Rose", modalDesc: "ä½ç½®ï¼šè–æ°´æ´" }];
    const initialBrands = [
        { title: "Olive Young", desc: "æ˜æ´ | æ»¿é¡é€€ç¨…", tag: "SALE", tagClass: "bg-red-100 text-red-600", modalTitle: "Olive Young", modalDesc: "æ´»å‹•ï¼šå†¬å­£ä¿ƒéŠ·" },
        { title: "Gentle Monster", desc: "Haus Dosan", tag: "æ–°å“", tagClass: "bg-gray-100 text-gray-800", modalTitle: "GM 2026", modalDesc: "åœ°é»ï¼šç‹é·—äº­" }
    ];
    const newBrandsMock = [{ title: "StÃ¼ssy é™å®š", desc: "ç‹é·—äº­ | Hoodie", tag: "DROP", tagClass: "bg-yellow-100 text-yellow-800", modalTitle: "StÃ¼ssy Seoul", modalDesc: "æœ¬é€±äº”ç™¼å”®" }];

    // --- EXPANDED SURVIVAL KOREAN DATA ---
    const survivalCards = [
        { cat: 'basic', title: "ä½ å¥½", k: "ì•ˆë…•í•˜ì„¸ìš”", icon: "ğŸ‘‹", desc: "å®‰å¦å“ˆã„™ã„Ÿå‘¦" },
        { cat: 'basic', title: "è¬è¬", k: "ê°ì‚¬í•©ë‹ˆë‹¤", icon: "ğŸ™", desc: "åº·æ’’å“ˆå’ªæ­" },
        { cat: 'basic', title: "å°ä¸èµ·", k: "ì£„ì†¡í•©ë‹ˆë‹¤", icon: "ğŸ™‡", desc: "å´”é€å“ˆå’ªæ­" },
        { cat: 'basic', title: "æ˜¯/å¥½", k: "ë„¤", icon: "â­•", desc: "å…§" },
        { cat: 'basic', title: "ä¸æ˜¯", k: "ì•„ë‹ˆìš”", icon: "âŒ", desc: "é˜¿å°¼å‘¦" },
        
        { cat: 'shop', title: "å¤šå°‘éŒ¢", k: "ì–¼ë§ˆì˜ˆìš”?", icon: "ğŸ’°", desc: "æ­é¦¬è€¶å‘¦" },
        { cat: 'shop', title: "å¤ªè²´äº†", k: "ë¹„ì‹¸ìš”", icon: "ğŸ’¸", desc: "ç•¢æ’’å‘¦" },
        { cat: 'shop', title: "æœ‰é€™å€‹å—", k: "ì´ê±° ìˆì–´ìš”?", icon: "â“", desc: "ä¼Šå‹¾ ä»¥æœå‘¦" },
        { cat: 'shop', title: "æˆ‘è¦é€™å€‹", k: "ì´ê±° ì£¼ì„¸ìš”", icon: "ğŸ‘‰", desc: "ä¼Šå‹¾ æœ±ã„™ã„Ÿå‘¦" },
        { cat: 'shop', title: "å¯ä»¥è©¦ç©¿å—", k: "ì…ì–´ë´ë„ ë¼ìš”?", icon: "ğŸ‘•", desc: "ä¼Šæ³¢å·´å¤š æ¨å‘¦" },

        { cat: 'food', title: "è«‹çµ¦èœå–®", k: "ë©”ë‰´íŒ ì£¼ì„¸ìš”", icon: "ğŸ“–", desc: "Menuåˆ¤ æœ±ã„™ã„Ÿå‘¦" },
        { cat: 'food', title: "è«‹çµ¦æˆ‘æ°´", k: "ë¬¼ ì¢€ ì£¼ì„¸ìš”", icon: "ğŸ’§", desc: "ç©† å®— æœ±ã„™ã„Ÿå‘¦" },
        { cat: 'food', title: "å¥½ç©/å¥½åƒ", k: "ë§›ìˆì–´ìš”", icon: "ğŸ˜‹", desc: "é¦¬å¸æœå‘¦" },
        { cat: 'food', title: "è«‹çµå¸³", k: "ê³„ì‚°í•´ ì£¼ì„¸ìš”", icon: "ğŸ’³", desc: "Kyeå±±é»‘ æœ±ã„™ã„Ÿå‘¦" },

        { cat: 'traffic', title: "æ´—æ‰‹é–“", k: "í™”ì¥ì‹¤", icon: "ğŸš»", desc: "èŠ±æ±Ÿæ´—" },
        { cat: 'traffic', title: "...åœ¨å“ªè£¡", k: "...ì–´ë””ì˜ˆìš”?", icon: "ğŸ—ºï¸", desc: "å–”åº•è€¶å‘¦" },
        { cat: 'traffic', title: "è«‹å»é€™è£¡", k: "ì—¬ê¸°ë¡œ ê°€ì£¼ì„¸ìš”", icon: "ğŸš•", desc: "ç”±åŸºç¾… å¡æœ±ã„™ã„Ÿå‘¦" },
        { cat: 'traffic', title: "å¯ä»¥åˆ·å¡å—", k: "ì¹´ë“œ ë¼ìš”?", icon: "ğŸ’³", desc: "å¡å¾· æ¨å‘¦" }
    ];

    const koreanCategories = [
        { id: 'all', name: 'å…¨éƒ¨' }, { id: 'basic', name: 'åŸºæœ¬' }, { id: 'shop', name: 'è³¼ç‰©' }, { id: 'food', name: 'é£²é£Ÿ' }, { id: 'traffic', name: 'äº¤é€š' }
    ];

    createApp({
        setup() {
            const currentView = ref('plan');
            const itinerary = ref([]);
            const selectedDayIndex = ref(0);
            const dbStatus = ref('connecting');
            const loading = ref(true);
            const weather = reactive({ temp: '--', desc: 'è¼‰å…¥ä¸­', icon: 'fa-cloud' });
            
            const showSubwayModal = ref(false);
            const shoppingList = ref([]);
            const newItemText = ref('');
            
            const showEditModal = ref(false);
            const isSaving = ref(false);
            const editForm = reactive({ mode: 'add', dIdx: 0, iIdx: 0, type: 'normal', time: '', title: '', desc: '', map: '', brandsStr: '', note: '', subItems: [] });

            const calcInput = ref('');
            const rate = ref(0.024);
            const showRateModal = ref(false);
            const tempRate = ref(0.024);
            const infoModal = reactive({ show: false, title: '', desc: '' });
            
            const popupList = ref([...initialPopups]);
            const brandList = ref([...initialBrands]);
            const isUpdatingPopup = ref(false);
            const isUpdatingBrand = ref(false);
            const hasUpdatedPopup = ref(false);
            const hasUpdatedBrand = ref(false);

            // Korean Filter
            const koreanCat = ref('all');
            const filteredKorean = computed(() => {
                return koreanCat.value === 'all' ? survivalCards : survivalCards.filter(c => c.cat === koreanCat.value);
            });

            let db, appId, docRef;
            const tabs = [
                { id: 'plan', name: 'è¡Œç¨‹', icon: 'fa-calendar-days' },
                { id: 'calc', name: 'è¨ˆç®—', icon: 'fa-calculator' },
                { id: 'list', name: 'æ¸…å–®', icon: 'fa-clipboard-check' },
                { id: 'guide', name: 'æ”»ç•¥', icon: 'fa-book-open' }
            ];

            const currentDay = computed(() => itinerary.value[selectedDayIndex.value]);
            const statusText = computed(() => {
                if (dbStatus.value === 'connected') return 'å¤šäººé€£ç·šä¸­';
                if (dbStatus.value === 'offline') return 'é›¢ç·šå‚™ä»½';
                if (dbStatus.value === 'empty') return 'è³‡æ–™åº«ç‚ºç©º';
                return 'é€£ç·šä¸­...';
            });
            const calcTwd = computed(() => Math.round((parseFloat(calcInput.value) || 0) * rate.value).toLocaleString());
            const calcTax = computed(() => { const v = parseFloat(calcInput.value) || 0; return v < 30000 ? 0 : 'â‚© ' + (v >= 75000 ? 5000 : (v >= 50000 ? 3500 : 1500)).toLocaleString(); });

            const playTTS = (text) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ko-KR'; utterance.rate = 0.8;
                    window.speechSynthesis.speak(utterance);
                } else alert("ç€è¦½å™¨ä¸æ”¯æ´ç™¼éŸ³");
            };

            const addListItem = async () => {
                if(!newItemText.value.trim()) return;
                shoppingList.value.push({ id: Date.now(), text: newItemText.value, checked: false });
                newItemText.value = '';
                saveChecklist();
            };
            const toggleListItem = async (id) => { const i = shoppingList.value.find(x => x.id === id); if(i) { i.checked = !i.checked; saveChecklist(); } };
            const deleteListItem = async (id) => { shoppingList.value = shoppingList.value.filter(x => x.id !== id); saveChecklist(); };
            const saveChecklist = async () => {
                if(dbStatus.value === 'connected' && docRef) updateDoc(docRef, { shoppingList: shoppingList.value });
                localStorage.setItem('seoul_list_backup', JSON.stringify(shoppingList.value));
            };

            onMounted(async () => {
                fetchWeather();
                
                const localItinerary = localStorage.getItem('seoul_itinerary_backup');
                const localList = localStorage.getItem('seoul_list_backup');
                if (localItinerary) itinerary.value = JSON.parse(localItinerary);
                if (localList) shoppingList.value = JSON.parse(localList);

                try {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    db = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);

                    docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', 'seoul_pro_v5_merged');

                    onSnapshot(docRef, (snap) => {
                        loading.value = false;
                        if (snap.exists()) {
                            const d = snap.data();
                            itinerary.value = d.itinerary || [];
                            shoppingList.value = d.shoppingList || [];
                            if (d.settings?.exchangeRate) rate.value = d.settings.exchangeRate;
                            localStorage.setItem('seoul_itinerary_backup', JSON.stringify(itinerary.value));
                            localStorage.setItem('seoul_list_backup', JSON.stringify(shoppingList.value));
                            dbStatus.value = 'connected';
                        } else {
                            dbStatus.value = 'empty';
                            if(!localItinerary) itinerary.value = [];
                        }
                    }, (err) => { dbStatus.value = 'offline'; loading.value = false; });

                } catch (e) { dbStatus.value = 'offline'; loading.value = false; }
            });

            const uploadDefaultData = async () => {
                if(!db || !docRef) return;
                loading.value = true;
                await setDoc(docRef, { itinerary: DEFAULT_ITINERARY, shoppingList: [], settings: { exchangeRate: 0.024 } });
            };

            const openModal = (mode, dIdx, iIdx = null, item = null) => {
                editForm.mode = mode; editForm.dIdx = dIdx; editForm.iIdx = iIdx;
                if (mode === 'edit' && item) {
                    Object.assign(editForm, { ...item, brandsStr: (item.brands||[]).join(', '), subItems: JSON.parse(JSON.stringify(item.opts || item.choices || [])) });
                } else {
                    Object.assign(editForm, { type: 'normal', time: '', title: '', desc: '', map: '', brandsStr: '', note: '', subItems: [] });
                }
                showEditModal.value = true;
            };
            const closeEditModal = () => showEditModal.value = false;
            const addMealOption = () => editForm.subItems.push({ n: '', t: 'walk', k: '' });
            const addChoiceOption = () => editForm.subItems.push({ n: 'Plan', desc: '', target: '' });
            const removeSubItem = (idx) => editForm.subItems.splice(idx, 1);
            
            const saveEdit = async () => {
                if (!db || !docRef && dbStatus.value !== 'offline') return;
                isSaving.value = true;
                const newItem = { title: editForm.title, desc: editForm.desc, time: editForm.time, note: editForm.note, type: editForm.type };
                if (editForm.type === 'normal') { newItem.map = editForm.map; if(editForm.brandsStr) newItem.brands = editForm.brandsStr.split(/,|ï¼Œ/).map(s=>s.trim()).filter(s=>s); }
                else if (editForm.type === 'meal') newItem.opts = editForm.subItems;
                else if (editForm.type === 'choice') newItem.choices = editForm.subItems;

                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                if (editForm.mode === 'add') newItinerary[editForm.dIdx].items.push(newItem);
                else newItinerary[editForm.dIdx].items[editForm.iIdx] = newItem;

                try {
                    if(dbStatus.value === 'connected') await updateDoc(docRef, { itinerary: newItinerary });
                    itinerary.value = newItinerary;
                    localStorage.setItem('seoul_itinerary_backup', JSON.stringify(newItinerary));
                    showEditModal.value = false;
                } catch(e) { alert("å„²å­˜å¤±æ•—"); } finally { isSaving.value = false; }
            };
            const deleteItem = async () => {
                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                newItinerary[editForm.dIdx].items.splice(editForm.iIdx, 1);
                if(dbStatus.value === 'connected') await updateDoc(docRef, { itinerary: newItinerary });
                itinerary.value = newItinerary;
                localStorage.setItem('seoul_itinerary_backup', JSON.stringify(newItinerary));
                showEditModal.value = false;
            };

            const openRateModal = () => { tempRate.value = rate.value; showRateModal.value = true; };
            const fetchLiveRate = async () => {
                try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/KRW'); const d = await res.json(); if(d.rates?.TWD) tempRate.value = d.rates.TWD; } 
                catch(e) { alert("ç„¡æ³•å–å¾—åŒ¯ç‡"); }
            };
            const saveRate = async () => {
                if(dbStatus.value === 'connected' && docRef) await setDoc(docRef, { settings: { exchangeRate: parseFloat(tempRate.value) } }, { merge: true });
                rate.value = parseFloat(tempRate.value);
                showRateModal.value = false;
            };

            const fetchWeather = async () => {
                try { const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current=temperature_2m,weather_code&timezone=Asia%2FSeoul'); const d = await res.json(); weather.temp = Math.round(d.current.temperature_2m); weather.desc = d.current.weather_code > 2 ? 'å¤šé›²' : 'æ™´æœ—'; weather.icon = d.current.weather_code > 2 ? 'fa-cloud' : 'fa-sun'; } catch(e){}
            };
            const checkUpdates = (type) => {
                if (type === 'popup') { isUpdatingPopup.value = true; setTimeout(() => { popupList.value = [...newPopupsMock, ...initialPopups]; hasUpdatedPopup.value = true; isUpdatingPopup.value = false; }, 1000); }
                else { isUpdatingBrand.value = true; setTimeout(() => { brandList.value = [...newBrandsMock, ...initialBrands]; hasUpdatedBrand.value = true; isUpdatingBrand.value = false; }, 1000); }
            };
            const resetCalc = () => calcInput.value = '';
            const getSearchLink = (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`;
            const getNaverLink = (k) => `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(k)}`;
            const openInfoModal = (t, d) => { infoModal.title = t; infoModal.desc = d; infoModal.show = true; };
            const copyToClipboard = (t) => { navigator.clipboard.writeText(t).then(()=>alert('å·²è¤‡è£½')).catch(()=>{}); };

            return {
                itinerary, selectedDayIndex, currentDay, dbStatus, loading, uploadDefaultData, statusText, tabs,
                showEditModal, editForm, openModal, closeEditModal, saveEdit, deleteItem, isSaving, addMealOption, addChoiceOption, removeSubItem,
                currentView, weather, fetchWeather,
                calcInput, calcTwd, calcTax, resetCalc, rate, showRateModal, tempRate, openRateModal, fetchLiveRate, saveRate,
                survivalCards, infoModal, openInfoModal, popupList, brandList, checkUpdates, isUpdatingPopup, isUpdatingBrand, hasUpdatedPopup, hasUpdatedBrand,
                getSearchLink, getNaverLink, copyToClipboard,
                showSubwayModal, shoppingList, newItemText, addListItem, toggleListItem, deleteListItem, playTTS,
                koreanCategories, koreanCat, filteredKorean
            };
        }
    }).mount('#app');
</script>
</body>
</html>

