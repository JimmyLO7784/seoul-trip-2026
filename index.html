<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¦–çˆ¾ 2026 é›²ç«¯å…±ç·¨ç‰ˆ (ç·¨è¼¯åŠ å¼·ç‰ˆ)</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#F2F1F6',
                        primary: '#C8A47E',
                        'primary-dark': '#A68665',
                        'accent-green': '#34C759',
                    },
                    boxShadow: { 'ios': '0 2px 8px rgba(0,0,0,0.04)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #E5E5E5; -webkit-tap-highlight-color: transparent; font-family: "M PLUS Rounded 1c", sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* åˆ—è¡¨å‹•ç•« */
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(-20px); }
        
        a { -webkit-touch-callout: none; }
    </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden select-none">

<div id="app" class="relative w-full h-full max-w-[480px] mx-auto bg-[#F2F1F6] shadow-2xl overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="flex-none px-5 py-3 pt-[calc(12px+env(safe-area-inset-top))] bg-bg/90 backdrop-blur-md border-b border-black/5 z-50 flex justify-between items-center sticky top-0">
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight text-gray-900 flex items-center gap-2">
                SEOUL 2026 
                <span v-if="dbStatus === 'connected'" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span v-else class="w-2 h-2 rounded-full bg-red-400"></span>
            </h1>
            <p class="text-xs font-semibold text-gray-400 -mt-1">
                {{ statusText }}
            </p>
        </div>
        <!-- Upload Init Data Button (Visible only if empty) -->
        <button v-if="dbStatus === 'empty'" @click="uploadDefaultData" class="text-xs bg-primary text-white px-3 py-1 rounded-full font-bold shadow-sm animate-bounce">
            åˆå§‹åŒ–è³‡æ–™åº«
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden pb-[100px] hide-scroll relative">
        
        <!-- Loading State -->
        <div v-show="currentView === 'plan'">
            <div v-if="loading" class="flex flex-col items-center justify-center h-[50vh] text-gray-400 gap-3">
                <i class="fa-solid fa-circle-notch animate-spin text-3xl"></i>
                <span class="text-sm font-bold">æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰è¡Œç¨‹...</span>
                <span v-if="dbStatus === 'error'" class="text-xs text-red-400 px-10 text-center">é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèª Firestore å·²é–‹å•Ÿæ¸¬è©¦æ¨¡å¼</span>
            </div>

            <div v-else class="p-4 space-y-5">
                 <!-- Weather Card -->
                 <div @click="fetchWeather" class="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-[#6DD5FA] to-[#2980B9] p-5 text-white shadow-lg shadow-blue-500/20 active:scale-95 transition-transform duration-200 cursor-pointer">
                    <div class="relative z-10 flex justify-between items-center">
                        <div>
                            <div class="text-4xl font-extrabold tracking-tighter">{{ weather.temp }}<span v-if="weather.temp !== '--'">Â°</span></div>
                            <div class="text-sm font-bold opacity-90 mt-1">{{ weather.desc }}</div>
                        </div>
                        <i :class="['fa-solid text-4xl opacity-90', weather.icon]"></i>
                    </div>
                </div>

                <!-- Date Slider -->
                <div class="sticky top-0 z-40 -mx-4 px-4 py-2 bg-[#F2F1F6]/95 backdrop-blur-sm">
                    <div class="flex gap-2 overflow-x-auto hide-scroll pb-2">
                        <div v-for="(day, index) in itinerary" :key="index" 
                             @click="selectedDayIndex = index"
                             :class="['flex-none w-[70px] p-2.5 rounded-2xl text-center transition-all duration-200 cursor-pointer border border-transparent shadow-sm', 
                                      selectedDayIndex === index ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-white text-gray-400']">
                            <div class="text-[10px] font-bold opacity-80">Day {{ day.d }}</div>
                            <div class="text-lg font-extrabold leading-tight">{{ day.date.split(' ')[0] }}</div>
                        </div>
                    </div>
                </div>

                <!-- Itinerary Items -->
                <div :key="selectedDayIndex" class="space-y-4">
                    <div class="bg-white rounded-2xl p-5 text-center shadow-ios border border-gray-100/50">
                        <h2 class="text-xl font-extrabold text-gray-800">{{ currentDay?.title }}</h2>
                        <div class="text-xs text-gray-400 mt-1">{{ currentDay?.date }}</div>
                    </div>

                    <div v-for="(item, idx) in currentDay?.items" :key="idx" class="relative group">
                        
                        <!-- Edit Trigger Button (Floating) -->
                        <button @click="openModal('edit', selectedDayIndex, idx, item)" class="absolute -right-2 -top-2 z-10 w-8 h-8 bg-gray-900 rounded-full text-white text-xs flex items-center justify-center shadow-lg opacity-80 hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                        <!-- Type: Simple Item -->
                        <div v-if="!item.type || item.type === 'normal'" class="bg-white rounded-[20px] p-4 shadow-ios border border-gray-50 flex justify-between items-start">
                            <div class="flex-1 min-w-0 pr-3">
                                <a :href="getSearchLink(item.title)" target="_blank" class="font-bold text-base text-gray-800 block flex items-center gap-1">
                                    {{ item.title }} <i class="fa-solid fa-magnifying-glass text-[10px] text-blue-300 opacity-50"></i>
                                </a>
                                <div class="text-xs text-gray-500 mt-1 whitespace-pre-line">{{ item.desc }}</div>
                                <!-- Brands -->
                                <div v-if="item.brands" class="flex flex-wrap gap-1.5 mt-2">
                                    <a v-for="brand in item.brands" :href="getSearchLink(brand + ' ' + item.title)" target="_blank" class="px-2 py-0.5 rounded text-[10px] bg-gray-50 border border-gray-100 text-gray-600 hover:bg-gray-100">{{ brand }}</a>
                                </div>
                                <!-- User Notes Display -->
                                <div v-if="item.note" class="mt-2 bg-yellow-50 text-yellow-800 text-xs p-2 rounded-lg border border-yellow-100 flex gap-2 items-start">
                                    <i class="fa-solid fa-sticky-note mt-0.5 opacity-50"></i>
                                    <span>{{ item.note }}</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2 shrink-0">
                                <span v-if="item.time" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md">{{ item.time }}</span>
                                <a v-if="item.map" :href="getNaverLink(item.map)" target="_blank" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-accent-green hover:bg-green-100">
                                    <i class="fa-solid fa-location-arrow text-sm"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Type: Meal -->
                        <div v-else-if="item.type === 'meal'" class="bg-white rounded-[20px] shadow-ios overflow-hidden border border-gray-50">
                            <div class="bg-gray-50/80 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                                <div class="font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fa-solid fa-utensils text-primary"></i> {{ item.title }}
                                </div>
                                <span v-if="item.time" class="text-xs font-bold text-gray-400 bg-gray-200/50 px-2 py-1 rounded-md">{{ item.time }}</span>
                            </div>
                            <div class="p-4 space-y-3">
                                <div v-for="opt in item.opts" class="flex justify-between items-center text-sm">
                                    <a :href="getSearchLink(opt.n)" target="_blank" class="flex-1 group">
                                        <div class="font-bold text-gray-700 flex items-center gap-1">{{ opt.n }} <i class="fa-solid fa-magnifying-glass text-[10px] text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity"></i></div>
                                        <div v-if="opt.tip" class="text-[10px] text-gray-400">{{ opt.tip }}</div>
                                    </a>
                                    <div class="flex gap-2 items-center">
                                        <span :class="['text-[10px] px-2 py-1 rounded font-bold', opt.t==='res'?'bg-green-100 text-green-700':'bg-red-100 text-red-600']">{{ opt.t==='res'?'é ç´„':'æ’éšŠ' }}</span>
                                        <a v-if="opt.k" :href="getNaverLink(opt.k)" target="_blank" class="w-6 h-6 bg-gray-50 rounded-full flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50"><i class="fa-solid fa-location-arrow text-[10px]"></i></a>
                                    </div>
                                </div>
                                <div v-if="item.note" class="pt-2 mt-2 border-t border-dashed border-gray-200 text-xs text-yellow-700">
                                    ğŸ“ {{ item.note }}
                                </div>
                            </div>
                        </div>

                        <!-- Type: Choice -->
                        <div v-else-if="item.type === 'choice'" class="bg-[#FAFAFA] rounded-[20px] p-4 border-2 border-dashed border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <div class="text-xs font-bold text-gray-400">{{ item.time || 'æ™‚æ®µ' }}</div>
                                <div class="text-center font-bold text-primary-dark">{{ item.title }}</div>
                                <div class="w-4"></div>
                            </div>
                            <div class="text-center text-xs text-gray-400 mb-3">{{ item.desc }}</div>
                            <div class="flex flex-wrap gap-2">
                                <a v-for="c in item.choices" :href="getSearchLink(c.n + ' ' + c.desc)" target="_blank" class="flex-1 min-w-[45%] bg-white p-3 rounded-xl border border-gray-100 text-center shadow-sm flex items-center justify-between group hover:border-primary/30 transition-colors">
                                    <div class="text-left">
                                        <div class="text-[10px] font-bold bg-gray-800 text-white inline-block px-1.5 rounded mb-1">{{ c.n.split(' ')[0] }}</div>
                                        <div class="text-xs font-bold text-gray-700 flex items-center gap-1">{{ c.desc }} <i class="fa-solid fa-magnifying-glass text-[8px] text-gray-300"></i></div>
                                    </div>
                                    <div v-if="c.target" @click.prevent="window.open(getNaverLink(c.target))" class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50">
                                        <i class="fa-solid fa-location-arrow text-[10px]"></i>
                                    </div>
                                </a>
                            </div>
                            <div v-if="item.note" class="mt-3 bg-white p-2 rounded border text-xs text-gray-600 text-center shadow-sm">
                                <span class="text-primary font-bold">ç­†è¨˜ï¼š</span> {{ item.note }}
                            </div>
                        </div>

                    </div>

                    <!-- ADD BUTTON -->
                    <button @click="openModal('add', selectedDayIndex)" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white hover:text-primary hover:border-primary transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹
                    </button>

                    <div class="h-10"></div>
                </div>
            </div>
        </div>

        <!-- View: CALC -->
        <div v-show="currentView === 'calc'" class="p-5">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4 ml-1">åŒ¯ç‡è¨ˆç®—</h2>
            <div class="bg-white rounded-[24px] p-6 shadow-ios border border-gray-50 text-right mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-400">è¼¸å…¥éŸ“å¹£ (KRW)</span>
                    <button @click="resetCalc" class="text-xs font-bold text-primary hover:text-primary-dark">æ¸…é™¤</button>
                </div>
                <input type="text" inputmode="decimal" v-model="calcInput" 
                       class="w-full text-right text-5xl font-light text-gray-900 placeholder-gray-200 outline-none bg-transparent font-mono mb-4 tracking-tighter" 
                       placeholder="0">
                <div class="border-t border-gray-100 py-3 flex justify-between items-center">
                    <span class="text-sm text-gray-400">ç´„åˆå°å¹£</span>
                    <span class="text-xl font-bold font-mono text-gray-800">{{ calcTwd }}</span>
                </div>
                <div class="pt-2 flex justify-between items-center">
                    <span class="text-sm text-gray-400">é è¨ˆé€€ç¨…</span>
                    <span class="text-xl font-bold font-mono text-accent-green">{{ calcTax }}</span>
                </div>
            </div>
            <div class="text-center text-xs text-gray-400">åŒ¯ç‡: {{ rate }} | æ»¿ 30,000 å¯é€€ç¨…</div>
        </div>

        <!-- View: GUIDE -->
        <div v-show="currentView === 'guide'" class="p-4 space-y-5">
            
            <!-- 1. å¿«é–ƒå¸‚é›† -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg">1æœˆå¿«é–ƒ & å¸‚é›†</h3>
                    <button @click="checkUpdates('popup')" class="text-xs text-primary font-bold flex items-center gap-1 active:opacity-50">
                        <i class="fa-solid fa-rotate-right transition-transform duration-700" :class="{'animate-spin': isUpdatingPopup}"></i> æ›´æ–°æƒ…å ±
                    </button>
                </div>
                <div class="space-y-2">
                    <transition-group name="list">
                        <div v-for="p in popupList" :key="p.title" class="flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" @click="openInfoModal(p.modalTitle || p.title, p.modalDesc || p.desc)">
                            <span :class="['px-2 py-1 rounded text-xs font-bold h-fit shrink-0', p.tagClass || 'bg-purple-100 text-purple-600']">{{ p.tag }}</span>
                            <div>
                                <div class="font-bold text-sm">{{ p.title }}</div>
                                <div class="text-xs text-gray-500 line-clamp-1">{{ p.desc }}</div>
                            </div>
                        </div>
                    </transition-group>
                </div>
            </div>

            <!-- 2. æ½®ç‰Œå¿«è¨Š -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg">æ½®ç‰Œ & è³¼ç‰©å¿«è¨Š</h3>
                    <button @click="checkUpdates('brand')" class="text-xs text-primary font-bold flex items-center gap-1 active:opacity-50">
                        <i class="fa-solid fa-rotate-right transition-transform duration-700" :class="{'animate-spin': isUpdatingBrand}"></i> æ›´æ–°å¿«è¨Š
                    </button>
                </div>
                <div class="space-y-2">
                    <transition-group name="list">
                        <div v-for="b in brandList" :key="b.title" class="flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" @click="openInfoModal(b.modalTitle || b.title, b.modalDesc || b.desc)">
                            <span :class="['px-2 py-1 rounded text-xs font-bold h-fit shrink-0', b.tagClass || 'bg-blue-100 text-blue-600']">{{ b.tag }}</span>
                            <div>
                                <div class="font-bold text-sm">{{ b.title }}</div>
                                <div class="text-xs text-gray-500 line-clamp-1">{{ b.desc }}</div>
                            </div>
                        </div>
                    </transition-group>
                </div>
            </div>

            <!-- 3. äº‚æ‰“ç§€ -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50" @click="openInfoModal('NANTA äº‚æ‰“ç§€', 'æ¼”å‡ºæ™‚é–“ï¼š\n- é€±ä¸€è‡³é€±äº”ï¼š17:00, 20:00\n- é€±æœ«/å‡æ—¥ï¼š14:00, 17:00, 20:00\n\nè¦ªå­å‹å–„å—ï¼Ÿ\n- æ»¿ 12 å€‹æœˆå³å¯å…¥å ´\n- 12~35å€‹æœˆå¹¼å…’æ†‘è­·ç…§å…è²» (ä¸ä½”ä½)\n\næ³¨æ„äº‹é …ï¼š\n- æ¼”å‡º90åˆ†é˜ï¼ŒéŸ³é‡å¤§ (æ‰“é¼“è²)ã€‚\n- å»ºè­°2æ­²åŠå°å­©è‹¥æ€•åµï¼Œå¯åèµ°é“æ—ã€‚')">
                <div class="flex gap-3 items-center">
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-500"><i class="fa-solid fa-drum"></i></div>
                    <div>
                        <div class="font-bold text-sm">æ˜æ´äº‚æ‰“ç§€</div>
                        <div class="text-xs text-gray-500">æ¼”å‡ºè³‡è¨Šèˆ‡å ´æ¬¡</div>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
            </div>

            <!-- 4. ç”Ÿå­˜éŸ“èª -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-2">ç”Ÿå­˜éŸ“èª</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div v-for="c in survivalCards" class="border p-2 rounded-xl text-center hover:bg-gray-50 active:scale-95 transition-all cursor-pointer" @click="openInfoModal(c.title + ' ' + c.k, c.desc)">
                        <div class="text-xl mb-1">{{ c.icon }}</div>
                        <div class="font-bold text-sm text-gray-700">{{ c.title }}</div>
                    </div>
                </div>
            </div>

            <!-- 5. å¸¸ç”¨åœ°åœ– -->
            <div class="bg-white rounded-2xl p-1 shadow-sm border border-gray-100">
                <a href="https://m.map.naver.com/" target="_blank" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl transition-colors">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-map text-green-500 text-xl"></i>
                        <div>
                            <div class="font-bold text-sm">Naver Map</div>
                            <div class="text-xs text-gray-400">éŸ“åœ‹å¿…å‚™å°èˆª</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </a>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="flex-none h-[calc(60px+env(safe-area-inset-bottom))] bg-white/95 backdrop-blur-xl border-t border-gray-200 pb-safe-bottom flex justify-around items-center z-50">
        <button v-for="tab in ['plan', 'calc', 'guide']" :key="tab"
                @click="currentView = tab"
                :class="['flex-1 h-full flex flex-col items-center justify-center gap-1 transition-colors', 
                         currentView === tab ? 'text-primary-dark' : 'text-gray-400']">
            <i :class="['fa-solid text-xl transition-transform duration-200', 
                        tab === 'plan' ? 'fa-calendar-days' : (tab === 'calc' ? 'fa-calculator' : 'fa-book-open'),
                        currentView === tab ? '-translate-y-0.5' : '']"></i>
            <span class="text-[10px] font-bold tracking-wide">
                {{ tab === 'plan' ? 'è¡Œç¨‹' : (tab === 'calc' ? 'è¨ˆç®—' : 'æ”»ç•¥') }}
            </span>
        </button>
    </nav>

    <!-- ADD/EDIT Modal (Advanced) -->
    <transition name="slide-up">
        <div v-if="showEditModal" class="absolute inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end justify-center" @click="closeEditModal">
            <div class="bg-white w-full h-[85vh] rounded-t-[24px] p-6 shadow-2xl flex flex-col" @click.stop>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-extrabold text-gray-900">{{ editForm.mode === 'add' ? 'æ–°å¢è¡Œç¨‹' : 'ç·¨è¼¯è¡Œç¨‹' }}</h3>
                    <button @click="closeEditModal" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto hide-scroll space-y-5 pb-6">
                    
                    <!-- Type Selector -->
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-2">é¡å‹</label>
                        <div class="flex bg-gray-100 p-1 rounded-xl">
                            <button v-for="t in ['normal', 'meal', 'choice']" 
                                    @click="editForm.type = t"
                                    :class="['flex-1 py-2 text-xs font-bold rounded-lg transition-all', editForm.type === t ? 'bg-white shadow-sm text-gray-900' : 'text-gray-400']">
                                {{ t === 'normal' ? 'ä¸€èˆ¬' : (t === 'meal' ? 'é¤å»³' : 'å¤šé¸æ–¹æ¡ˆ') }}
                            </button>
                        </div>
                    </div>

                    <!-- Common Fields -->
                    <div class="grid grid-cols-4 gap-3">
                        <div class="col-span-1">
                            <label class="text-xs font-bold text-gray-400 block mb-1">æ™‚é–“</label>
                            <input v-model="editForm.time" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-sm text-center" placeholder="12:00">
                        </div>
                        <div class="col-span-3">
                            <label class="text-xs font-bold text-gray-400 block mb-1">æ¨™é¡Œ</label>
                            <input v-model="editForm.title" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-base" placeholder="è¡Œç¨‹åç¨±">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">æè¿° / è³‡è¨Š</label>
                        <textarea v-model="editForm.desc" rows="2" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="ç°¡çŸ­æè¿°"></textarea>
                    </div>

                    <!-- Normal Type Specific -->
                    <div v-if="editForm.type === 'normal'" class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 block mb-1">åœ°åœ–é—œéµå­— (Naver Map)</label>
                            <div class="relative">
                                <i class="fa-solid fa-map-pin absolute left-3 top-3.5 text-gray-400 text-xs"></i>
                                <input v-model="editForm.map" class="w-full bg-gray-50 border border-gray-200 p-3 pl-8 rounded-xl text-sm" placeholder="è¼¸å…¥éŸ“æ–‡/è‹±æ–‡åº—å">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 block mb-1">å“ç‰Œ/æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label>
                            <input v-model="editForm.brandsStr" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="Nike, Adidas, å¿…è²·">
                        </div>
                    </div>

                    <!-- Meal Type Specific -->
                    <div v-if="editForm.type === 'meal'" class="space-y-3">
                        <label class="text-xs font-bold text-gray-400 flex justify-between items-center">
                            é¤å»³é¸é … <button @click="addMealOption" class="text-primary text-[10px]"><i class="fa-solid fa-plus"></i> å¢åŠ </button>
                        </label>
                        <div v-for="(opt, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative">
                            <button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                            <input v-model="opt.n" class="w-full bg-white p-2 rounded border border-gray-100 text-sm font-bold" placeholder="é¤å»³åç¨±">
                            <div class="flex gap-2">
                                <select v-model="opt.t" class="bg-white p-2 rounded border border-gray-100 text-xs flex-1">
                                    <option value="walk">ç¾å ´æ’</option>
                                    <option value="res">å¯é ç´„</option>
                                    <option value="wait">éœ€å€™ä½</option>
                                </select>
                                <input v-model="opt.k" class="flex-[2] bg-white p-2 rounded border border-gray-100 text-xs" placeholder="Naveråœ°åœ–é—œéµå­—">
                            </div>
                            <input v-model="opt.tip" class="w-full bg-white p-2 rounded border border-gray-100 text-xs" placeholder="å‚™è¨» (å¦‚: å¿…é»æ’éª¨)">
                        </div>
                    </div>

                    <!-- Choice Type Specific -->
                    <div v-if="editForm.type === 'choice'" class="space-y-3">
                        <label class="text-xs font-bold text-gray-400 flex justify-between items-center">
                            å¤šé¸æ–¹æ¡ˆ <button @click="addChoiceOption" class="text-primary text-[10px]"><i class="fa-solid fa-plus"></i> å¢åŠ </button>
                        </label>
                        <div v-for="(c, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative">
                            <button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                            <div class="flex gap-2">
                                <input v-model="c.n" class="w-1/3 bg-white p-2 rounded border border-gray-100 text-sm font-bold text-center" placeholder="Plan A">
                                <input v-model="c.desc" class="w-2/3 bg-white p-2 rounded border border-gray-100 text-sm" placeholder="æè¿° (å¦‚: å»æ¨‚åœ’)">
                            </div>
                            <input v-model="c.target" class="w-full bg-white p-2 rounded border border-gray-100 text-xs" placeholder="åœ°åœ–æœå°‹é—œéµå­—">
                        </div>
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">ç­†è¨˜ / å‚™è¨»</label>
                        <textarea v-model="editForm.note" rows="2" class="w-full bg-yellow-50 border border-yellow-100 p-3 rounded-xl text-sm text-gray-700" placeholder="ç§äººç­†è¨˜..."></textarea>
                    </div>

                </div>

                <div class="pt-4 border-t border-gray-100 flex gap-3">
                    <button v-if="editForm.mode === 'edit'" @click="deleteItem" class="flex-1 bg-red-50 text-red-500 font-bold py-3.5 rounded-xl active:scale-95 transition-transform">
                        åˆªé™¤
                    </button>
                    <button @click="saveEdit" class="flex-[3] bg-gray-900 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-transform flex justify-center items-center gap-2 shadow-lg shadow-gray-500/30">
                        <span v-if="isSaving" class="animate-spin"><i class="fa-solid fa-circle-notch"></i></span>
                        <span>{{ isSaving ? 'è™•ç†ä¸­...' : 'å„²å­˜è®Šæ›´' }}</span>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Info Modal -->
    <transition name="fade">
        <div v-if="infoModal.show" class="absolute inset-0 z-[110] bg-black/60 flex items-center justify-center p-6" @click="infoModal.show = false">
            <div class="bg-white w-full max-w-sm rounded-[30px] p-6 shadow-2xl text-center" @click.stop>
                <h3 class="text-xl font-extrabold text-gray-900 mb-3 whitespace-pre-line">{{ infoModal.title }}</h3>
                <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap mb-6">{{ infoModal.desc }}</p>
                <button @click="infoModal.show = false" class="w-full bg-gray-100 text-gray-900 font-bold py-3 rounded-xl">é—œé–‰</button>
            </div>
        </div>
    </transition>

</div>

<script type="module">
    // --- 1. Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
    import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // --- 2. Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyBFDAs4hj4eJ2hCxsWWlRRCsJC_qEekBCc",
        authDomain: "trip-plan-app-c38a3.firebaseapp.com",
        projectId: "trip-plan-app-c38a3",
        storageBucket: "trip-plan-app-c38a3.firebasestorage.app",
        messagingSenderId: "79177072268",
        appId: "1:79177072268:web:e8efe92b05a528046d45a9",
        measurementId: "G-T39PWKG8GL"
    };

    let app, db, analytics;
    try {
        app = initializeApp(firebaseConfig);
        analytics = getAnalytics(app); 
        db = getFirestore(app); 
    } catch(e) { console.error("Init Error", e); }
    
    const DOC_ID = "seoul_trip_data_v2";

    const { createApp, ref, computed, onMounted, reactive } = Vue;

    // --- DEFAULT ITINERARY (Initial Data) ---
    const DEFAULT_ITINERARY = [
        { 
            d: 1, date: "1/25 (æ—¥)", title: "æŠµé” & æ˜æ´",
            items: [
                { time:"13:00", title:"L7 é£¯åº— Check-in", desc:"å¯„æ”¾è¡Œæ", map:"L7 ëª…ë™", type:"normal" },
                { title:"Money Planet æ›éŒ¢", desc:"å°±åœ¨æ˜æ´ï¼ŒåŒ¯ç‡å„ªï¼", map:"ë¨¸ë‹ˆí”Œë ˆë‹›", type:"normal", brands: ["æ›éŒ¢æ‰€"] },
                { title:"é¦–çˆ¾è³¼ç‰©å­£", desc:"å»ã€Œæ˜æ´æ­¡è¿ä¸­å¿ƒã€é ˜å„ªæƒ åˆ¸ & æ­¡è¿ç¦®åŒ…", map:"ëª…ë™ì˜ˆìˆ ê·¹ì¥", type:"normal", brands: ["Welcome Center"] },
                { type:"meal", title:"æ˜æ´åˆé¤", opts:[{n:"æ˜æ´é¤ƒå­", t:"wait", tip:"å¿…æ¯”ç™»"}, {n:"ç¥ä»™é›ªæ¿ƒæ¹¯", t:"wait", tip:"æ¿ƒéƒ"}, {n:"è’è¬¬çš„ç”Ÿè‚‰", t:"walk", tip:"çƒ¤è‚‰"}] },
                { time:"16:00", type:"choice", title:"ä¸‹åˆè‡ªç”±é¸", desc:"ç´¯äº†å—ï¼Ÿé¸ä¸€å€‹å–œæ­¡çš„", choices: [{n:"A é€›è¡—", desc:"Olive Young", target:"ì˜¬ë¦¬ë¸Œì˜ ëª…ë™"}, {n:"B è–å ‚", desc:"æ˜æ´è–å ‚", target:"ëª…ë™ì„±ë‹¹"}, {n:"C å’–å•¡", desc:"Pink Pool Cafe", target:"ìŠ¤íƒ€ì¼ë‚œë‹¤"}, {n:"D äº‚æ‰“ç§€", desc:"17:00 å ´æ¬¡", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] },
                { title:"æ¨‚å¤©ç™¾è²¨ & å…ç¨…åº—", desc:"B1 é£Ÿå“è¡— / 9-12F å…ç¨…åº—", map:"ë¡¯ë°ë°±í™”ì  ë³¸ì ", type:"normal", brands: ["Gentle Monster", "Tamburins"] },
                { time:"19:00", type:"meal", title:"æ™šé¤ï¼šéŸ“å¼çƒ¤è‚‰", opts:[{n:"ç‹å¦ƒå®¶", t:"res"}, {n:"é»ƒé‡‘ç‰§å ´", t:"res"}] }
            ]
        },
        { 
            d: 2, date: "1/26 (ä¸€)", title: "å—å¤§é–€ & æ±å¤§é–€",
            items: [
                { time:"09:30", title:"æ™¯ç¦å®®", desc:"ç©¿éŸ“æœé€²å ´å…è²»", map:"ê²½ë³µê¶", type:"normal" },
                { time:"12:00", type:"meal", title:"è¥¿æ‘åˆé¤", opts:[{n:"åœŸä¿—æ‘è”˜é›æ¹¯", t:"walk"}, {n:"é€šä»å¸‚å ´", t:"walk", tip:"éŠ…éŒ¢ä¾¿ç•¶"}] },
                { time:"14:00", title:"å—å¤§é–€å¸‚å ´", desc:"Dæ£Ÿæ£‰è¢«ã€Eæ£Ÿ3FèŠ±å¸‚(æ°›åœç‡ˆ)", map:"ë‚¨ëŒ€ë¬¸ì‹œì¥", type:"normal", brands: ["Burdeng", "äº¬ä¸€å±‹"] },
                { time:"15:30", title:"ILKW Showroom", desc:"æœƒè³¢ç«™çœ‹Snowmanç‡ˆ", map:"ì¼ê´‘ì „êµ¬ ë¼ì´íŒ…ë£¸ ì„œìš¸", type:"normal" },
                { time:"16:30", type:"choice", title:"ä¸‹åˆä¸‰é¸ä¸€", desc:"è²·å®Œæ±è¥¿å»å“ªï¼Ÿ", choices: [{n:"A ä¼‘æ¯", desc:"å›é£¯åº—", target:"L7 ëª…ë™"}, {n:"B å’–å•¡", desc:"Molto", target:"ëª°ë˜"}, {n:"C äº‚æ‰“ç§€", desc:"17:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] },
                { time:"19:30", type:"choice", title:"æ™šä¸Šä¸‰é¸ä¸€", desc:"é€›è¡— vs ä¼‘æ¯", choices: [{n:"A é€›è¡—", desc:"DDP", target:"DDP"}, {n:"B æ±—è’¸", desc:"Sparex", target:"ìŠ¤íŒŒë ‰ìŠ¤"}, {n:"C äº‚æ‰“ç§€", desc:"20:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] }
            ]
        },
        { d: 3, date: "1/27 (äºŒ)", title: "å°å­©çš„é¸æ“‡æ—¥", items: [{ type:"choice", title:"è¶…å¤šæ–¹æ¡ˆ (è¦–å¤©æ°£é«”åŠ›)", desc:"Plan A-H ä»»å›æŒ‘é¸", choices: [{n:"A æˆ¶å¤–", desc:"å—æ€¡å³¶", target:"ë‚¨ì´ì„¬"}, {n:"B å®¤å…§", desc:"æ¨‚å¤©ä¸–ç•Œ", target:"ë¡¯ë°ì›”ë“œ"}, {n:"C æ°´æ—", desc:"COEX", target:"ì½”ì—‘ìŠ¤"}, {n:"D å‹•ç•«", desc:"é¦–çˆ¾å‹•ç•«ä¸­å¿ƒ", target:"ì„œìš¸ì• ë‹ˆë©”ì´ì…˜ì„¼í„°"}, {n:"E HiKR", desc:"å¥½å®¢ç©ºé–“", target:"í•˜ì´ì»¤ê·¸ë¼ìš´ë“œ"}, {n:"F æ¨‚åœ’", desc:"Pororo Park", target:"ë½€ë¡œë¡œíŒŒí¬"}] }, { time:"19:00", type:"choice", title:"å¤œæ™šå››é¸ä¸€", desc:"çœ‹é«”åŠ›æ±ºå®š", choices: [{n:"A æ™¯é»", desc:"å—å±±å¡”", target:"Nì„œìš¸íƒ€ì›Œ"}, {n:"B æŒ‰æ‘©", desc:"æ˜æ´æŒ‰æ‘©", target:"ëª…ë™"}] }] },
        { d: 4, date: "1/28 (ä¸‰)", title: "ç‹é·—äº­ & è–æ°´æ´", items: [{ time:"11:00", title:"ç‹é·—äº­æ½®ç‰Œ", desc:"å³¶å±±å…¬åœ’", map:"í•˜ìš°ìŠ¤ ë„ì‚°", type:"normal", brands:["Stussy", "Supreme"] }, { time:"14:30", type:"choice", title:"è–æ°´æ´", desc:"é€›è¡— vs æºœå°å­©", choices: [{n:"A é€›è¡—", desc:"Dior/ADER", target:"ì„±ìˆ˜ë™"}, {n:"B å…¬åœ’", desc:"é¦–çˆ¾æ—", target:"ì„œìš¸ìˆ²"}, {n:"C äº‚æ‰“ç§€", desc:"å›æ˜æ´", target:"ëª…ë™"}] }, { time:"17:00", type:"meal", title:"æ™šé¤", opts:[{n:"ç¥–å‚³é¦¬éˆ´è–¯æ¹¯", t:"wait"}, {n:"Onion Cafe", t:"walk"}] }, { time:"20:00", type:"choice", title:"æ™šä¸ŠçºŒæ”¤", desc:"", choices: [{n:"A äº‚æ‰“ç§€", desc:"20:00 å ´", target:"ëª…ë™"}, {n:"B é€›è¡—", desc:"Olive Young", target:"ì˜¬ë¦¬ë¸Œì˜"}] }] },
        { d: 5, date: "1/29 (å››)", title: "æ±çŸ£å³¶", items: [{ time:"10:30", title:"Zoolung Zoolung", desc:"å®¤å…§å‹•ç‰©åœ’", map:"ì£¼ë ì£¼ë  ì˜ë“±í¬", type:"normal" }, { time:"13:30", title:"ç¾ä»£ç™¾è²¨", desc:"The Hyundai Seoul", map:"ë”í˜„ëŒ€ ì„œìš¸", type:"normal", brands:["Matin Kim"] }, { type:"choice", title:"å‚æ™šäºŒé¸ä¸€", desc:"", choices: [{n:"A é€›è¡—", desc:"ç¹¼çºŒé€›", target:"ë”í˜„ëŒ€"}, {n:"B æ°´æ—", desc:"63å¤§æ¨“", target:"63ë¹Œë”©"}] }, { time:"19:00", type:"choice", title:"æ™šé¤", desc:"", choices: [{n:"A æµ·é®®", desc:"é·ºæ¢æ´¥", target:"ë…¸ëŸ‰ì§„"}, {n:"B æ¼¢æ±Ÿ", desc:"åƒæ³¡éºµ", target:"í•œê°•ê³µì›"}] }] },
        { d: 6, date: "1/30 (äº”)", title: "å¼˜å¤§", items: [{ time:"11:00", title:"å¼˜å¤§å•†åœˆ", desc:"AK Plaza", map:"í™ëŒ€ì…êµ¬ì—­", type:"normal", brands:["Object", "Musinsa"] }, { time:"12:30", type:"meal", title:"åˆé¤", opts:[{n:"ç”³ç¾äº¬è¾£ç‚’é›æ’", t:"walk"}, {n:"è±¬è…³å°å§", t:"walk"}] }, { type:"choice", title:"ä¸‹åˆ", desc:"", choices: [{n:"A å»¶å—", desc:"æ–‡é’", target:"ì—°ë‚¨ë™"}, {n:"B ç›Šå–„", desc:"éŸ“å±‹", target:"ìµì„ ë™"}, {n:"C å¸‚å ´", desc:"æœ›é å¸‚å ´", target:"ë§ì›ì‹œì¥"}] }, { time:"18:30", title:"æ¨‚å¤©è¶…å¸‚", desc:"æ¡è³¼", map:"ë¡¯ë°ë§ˆíŠ¸ ì„œìš¸ì—­ì ", type:"normal" }] },
        { d: 7, date: "1/31 (å…­)", title: "å›å®¶", items: [{ time:"08:30", title:"Check-out", desc:"å»æ©Ÿå ´", type:"normal" }, { time:"12:00", title:"èµ·é£›", desc:"å¹³å®‰å›å®¶", type:"normal" }] }
    ];

    // --- GUIDE DATA ---
    const initialPopups = [
        { title: "é¦–çˆ¾ç‡ˆç¯€", desc: "å…‰åŒ–é–€ | å†¬å­£é™å®š", tag: "é™å®š", tagClass: "bg-orange-100 text-orange-600", modalTitle: "é¦–çˆ¾ç‡ˆç¯€", modalDesc: "æ™‚é–“ï¼šè‡³ 1æœˆåº•\nåœ°é»ï¼šå…‰åŒ–é–€å»£å ´" },
        { title: "ç¾ä»£ç™¾è²¨ å¿«é–ƒ", desc: "B2 / 5F å¤§å‹IP", tag: "ç†±é–€", tagClass: "bg-purple-100 text-purple-600", modalTitle: "The Hyundai Seoul", modalDesc: "åœ°é»ï¼šæ±çŸ£å³¶ (Day 5)" }
    ];
    const newPopupsMock = [{ title: "Burberry ç«ç‘°", desc: "è–æ°´æ´ | å’–å•¡å»³", tag: "NEW", tagClass: "bg-teal-100 text-teal-600", modalTitle: "Burberry Rose", modalDesc: "ä½ç½®ï¼šè–æ°´æ´" }];
    const initialBrands = [
        { title: "Olive Young", desc: "æ˜æ´ | æ»¿é¡é€€ç¨…", tag: "SALE", tagClass: "bg-red-100 text-red-600", modalTitle: "Olive Young", modalDesc: "æ´»å‹•ï¼šå†¬å­£ä¿ƒéŠ·" },
        { title: "Gentle Monster", desc: "Haus Dosan", tag: "æ–°å“", tagClass: "bg-gray-100 text-gray-800", modalTitle: "GM 2026", modalDesc: "åœ°é»ï¼šç‹é·—äº­" }
    ];
    const newBrandsMock = [{ title: "StÃ¼ssy é™å®š", desc: "ç‹é·—äº­ | Hoodie", tag: "DROP", tagClass: "bg-yellow-100 text-yellow-800", modalTitle: "StÃ¼ssy Seoul", modalDesc: "æœ¬é€±äº”ç™¼å”®" }];
    const survivalCards = [
        { title: "ä½ å¥½", k: "ì•ˆë…•í•˜ì„¸ìš”", icon: "ğŸ‘‹", desc: "å®‰å¦å“ˆã„™ã„Ÿå‘¦" }, { title: "è¬è¬", k: "ê°ì‚¬í•©ë‹ˆë‹¤", icon: "ğŸ™", desc: "åº·æ’’å“ˆå’ªæ­" },
        { title: "æˆ‘è¦é€™å€‹", k: "ì´ê±° ì£¼ì„¸ìš”", icon: "ğŸ‘‰", desc: "ä¼Šå‹¾ æœ±ã„™ã„Ÿå‘¦" }, { title: "æ´—æ‰‹é–“", k: "í™”ì¥ì‹¤", icon: "ğŸš»", desc: "èŠ±æ±Ÿæ´—" },
        { title: "ä¾¿å®œé»", k: "ê¹ì•„ì£¼ì„¸ìš”", icon: "ğŸ’¸", desc: "å˜å˜æœ±ã„™ã„Ÿå‘¦" }, { title: "è¢‹å­", k: "ë´‰íˆ¬ ì£¼ì„¸ìš”", icon: "ğŸ›ï¸", desc: "å´©åœŸ æœ±ã„™ã„Ÿå‘¦" }
    ];

    createApp({
        setup() {
            const currentView = ref('plan');
            const itinerary = ref([]);
            const selectedDayIndex = ref(0);
            const dbStatus = ref('connecting');
            const loading = ref(true);
            
            // Edit Modal State
            const showEditModal = ref(false);
            const editingItem = ref(null); // Contains {dIdx, iIdx} or null
            const isSaving = ref(false);
            
            // The Form Data (Single Source of Truth for Editing)
            const editForm = reactive({
                mode: 'add', // 'add' or 'edit'
                dIdx: 0,
                iIdx: 0, // Only for edit
                type: 'normal',
                time: '',
                title: '',
                desc: '',
                map: '',
                brandsStr: '',
                note: '',
                subItems: [] // For Meal (opts) or Choice (choices)
            });

            // Calc & Guide State
            const calcInput = ref('');
            const rate = ref(0.024);
            const infoModal = reactive({ show: false, title: '', desc: '' });
            const popupList = ref([...initialPopups]);
            const brandList = ref([...initialBrands]);
            const isUpdatingPopup = ref(false);
            const isUpdatingBrand = ref(false);
            const hasUpdatedPopup = ref(false);
            const hasUpdatedBrand = ref(false);
            const weather = reactive({ temp: '--', desc: 'è¼‰å…¥ä¸­', icon: 'fa-cloud' });

            const currentDay = computed(() => itinerary.value[selectedDayIndex.value]);
            const statusText = computed(() => {
                if (dbStatus.value === 'connected') return 'å¤šäººé€£ç·šä¸­';
                if (dbStatus.value === 'empty') return 'è³‡æ–™åº«ç‚ºç©º';
                if (dbStatus.value === 'error') return 'é€£ç·šéŒ¯èª¤';
                return 'é€£ç·šä¸­...';
            });
            const calcTwd = computed(() => Math.round((parseFloat(calcInput.value) || 0) * rate.value).toLocaleString());
            const calcTax = computed(() => {
                const v = parseFloat(calcInput.value) || 0;
                if(v < 30000) return 0;
                return 'â‚© ' + (v >= 75000 ? 5000 : (v >= 50000 ? 3500 : 1500)).toLocaleString();
            });

            onMounted(async () => {
                fetchWeather();
                if (!db) { dbStatus.value = 'error'; loading.value = false; return; }
                try {
                    onSnapshot(doc(db, "trips", DOC_ID), (docSnap) => {
                        loading.value = false;
                        if (docSnap.exists()) {
                            itinerary.value = docSnap.data().itinerary;
                            dbStatus.value = 'connected';
                        } else {
                            dbStatus.value = 'empty';
                            itinerary.value = [];
                        }
                    }, (err) => { console.error(err); dbStatus.value = 'error'; itinerary.value = DEFAULT_ITINERARY; loading.value = false; });
                } catch (e) { dbStatus.value = 'error'; loading.value = false; }
            });

            const uploadDefaultData = async () => {
                if(!db) return;
                loading.value = true;
                await setDoc(doc(db, "trips", DOC_ID), { itinerary: DEFAULT_ITINERARY });
            };

            // --- Modal Logic ---
            const openModal = (mode, dIdx, iIdx = null, item = null) => {
                editForm.mode = mode;
                editForm.dIdx = dIdx;
                editForm.iIdx = iIdx;
                
                if (mode === 'edit' && item) {
                    // Populate Form
                    editForm.type = item.type || 'normal';
                    editForm.time = item.time || '';
                    editForm.title = item.title || '';
                    editForm.desc = item.desc || '';
                    editForm.map = item.map || '';
                    editForm.brandsStr = item.brands ? item.brands.join(', ') : '';
                    editForm.note = item.note || '';
                    
                    // Handle Complex Sub-Items
                    editForm.subItems = [];
                    if (editForm.type === 'meal' && item.opts) {
                        editForm.subItems = JSON.parse(JSON.stringify(item.opts)); // Deep copy
                    } else if (editForm.type === 'choice' && item.choices) {
                        editForm.subItems = JSON.parse(JSON.stringify(item.choices));
                    }
                } else {
                    // Reset Form for Add
                    editForm.type = 'normal';
                    editForm.time = '';
                    editForm.title = '';
                    editForm.desc = '';
                    editForm.map = '';
                    editForm.brandsStr = '';
                    editForm.note = '';
                    editForm.subItems = [];
                }
                showEditModal.value = true;
            };

            const closeEditModal = () => { showEditModal.value = false; };

            const addMealOption = () => { editForm.subItems.push({ n: '', t: 'walk', k: '', tip: '' }); };
            const addChoiceOption = () => { editForm.subItems.push({ n: `Plan`, desc: '', target: '' }); };
            const removeSubItem = (idx) => { editForm.subItems.splice(idx, 1); };

            const saveEdit = async () => {
                if (!db) return;
                isSaving.value = true;
                
                // Construct Item Object
                const newItem = {
                    title: editForm.title,
                    desc: editForm.desc,
                    time: editForm.time,
                    note: editForm.note,
                    type: editForm.type
                };

                if (editForm.type === 'normal') {
                    newItem.map = editForm.map;
                    if (editForm.brandsStr) newItem.brands = editForm.brandsStr.split(/,|ï¼Œ/).map(s => s.trim()).filter(s => s);
                } else if (editForm.type === 'meal') {
                    newItem.opts = editForm.subItems;
                } else if (editForm.type === 'choice') {
                    newItem.choices = editForm.subItems;
                }

                // Update Local Data Copy
                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                if (editForm.mode === 'add') {
                    newItinerary[editForm.dIdx].items.push(newItem);
                } else {
                    newItinerary[editForm.dIdx].items[editForm.iIdx] = newItem;
                }

                // Sync to Firebase
                try {
                    await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary });
                    showEditModal.value = false;
                } catch (e) { alert("å„²å­˜å¤±æ•—"); } 
                finally { isSaving.value = false; }
            };

            const deleteItem = async () => {
                if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ")) return;
                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                newItinerary[editForm.dIdx].items.splice(editForm.iIdx, 1);
                try {
                    await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary });
                    showEditModal.value = false;
                } catch (e) { alert("åˆªé™¤å¤±æ•—"); }
            };

            // --- Other Logic ---
            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current=temperature_2m,weather_code&timezone=Asia%2FSeoul');
                    const d = await res.json();
                    weather.temp = Math.round(d.current.temperature_2m);
                    weather.desc = d.current.weather_code > 2 ? 'å¤šé›²' : 'æ™´æœ—';
                    weather.icon = d.current.weather_code > 2 ? 'fa-cloud' : 'fa-sun';
                } catch(e) {}
            };

            const checkUpdates = (type) => {
                if ((type === 'popup' && hasUpdatedPopup.value) || (type === 'brand' && hasUpdatedBrand.value)) { alert("ç›®å‰å·²æ˜¯æœ€æ–°è³‡è¨Š"); return; }
                if (type === 'popup') isUpdatingPopup.value = true; else isUpdatingBrand.value = true;
                setTimeout(() => {
                    if (type === 'popup') { popupList.value = [...newPopupsMock, ...initialPopups]; hasUpdatedPopup.value = true; isUpdatingPopup.value = false; }
                    else { brandList.value = [...newBrandsMock, ...initialBrands]; hasUpdatedBrand.value = true; isUpdatingBrand.value = false; }
                }, 1500);
            };

            const resetCalc = () => calcInput.value = '';
            const getSearchLink = (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`;
            const getNaverLink = (k) => `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(k)}`;
            const openInfoModal = (title, desc) => { infoModal.title = title; infoModal.desc = desc; infoModal.show = true; };

            return {
                itinerary, selectedDayIndex, currentDay, dbStatus, loading, uploadDefaultData, statusText,
                showEditModal, editForm, openModal, closeEditModal, saveEdit, deleteItem, isSaving, addMealOption, addChoiceOption, removeSubItem,
                currentView, weather, fetchWeather,
                calcInput, calcTwd, calcTax, resetCalc, rate,
                survivalCards, infoModal, openInfoModal,
                popupList, brandList, checkUpdates, isUpdatingPopup, isUpdatingBrand,
                getSearchLink, getNaverLink
            };
        }
    }).mount('#app');
</script>
</body>
</html>

