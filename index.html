<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>È¶ñÁàæ 2026 Èõ≤Á´ØÂÖ±Á∑®Áâà (v4 Áè≠Ê©üÂº∑ÂåñÁâà)</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#F2F1F6',
                        primary: '#C8A47E',
                        'primary-dark': '#A68665',
                        'accent-green': '#34C759',
                        'flight-blue': '#003087', // Airline Blue
                    },
                    boxShadow: { 'ios': '0 2px 8px rgba(0,0,0,0.04)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #E5E5E5; -webkit-tap-highlight-color: transparent; font-family: "M PLUS Rounded 1c", sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* ÂàóË°®ÂãïÁï´ */
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(-20px); }
        
        a { -webkit-touch-callout: none; }
    </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden select-none">

<div id="app" class="relative w-full h-full max-w-[480px] mx-auto bg-[#F2F1F6] shadow-2xl overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="flex-none px-5 py-3 pt-[calc(12px+env(safe-area-inset-top))] bg-bg/90 backdrop-blur-md border-b border-black/5 z-50 flex justify-between items-center sticky top-0">
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight text-gray-900 flex items-center gap-2">
                SEOUL 2026 
                <span v-if="dbStatus === 'connected'" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span v-else class="w-2 h-2 rounded-full bg-red-400"></span>
            </h1>
            <p class="text-xs font-semibold text-gray-400 -mt-1">
                {{ statusText }}
            </p>
        </div>
        <!-- Upload Init Data Button (Visible only if empty) -->
        <button v-if="dbStatus === 'empty'" @click="uploadDefaultData" class="text-xs bg-primary text-white px-3 py-1 rounded-full font-bold shadow-sm animate-bounce">
            ÂàùÂßãÂåñ v4 Ë≥áÊñô
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden pb-[100px] hide-scroll relative">
        
        <!-- Loading State -->
        <div v-show="currentView === 'plan'">
            <div v-if="loading" class="flex flex-col items-center justify-center h-[50vh] text-gray-400 gap-3">
                <i class="fa-solid fa-plane-departure animate-bounce text-3xl"></i>
                <span class="text-sm font-bold">Ê≠£Âú®ËºâÂÖ• v4 Áè≠Ê©üË°åÁ®ã...</span>
                <span v-if="dbStatus === 'error'" class="text-xs text-red-400 px-10 text-center">ÈÄ£Á∑öÂ§±ÊïóÔºåË´ãÁ¢∫Ë™ç Firestore Â∑≤ÈñãÂïüÊ∏¨Ë©¶Ê®°Âºè</span>
            </div>

            <div v-else class="p-4 space-y-5">
                 <!-- Weather Card -->
                 <div @click="fetchWeather" class="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-[#6DD5FA] to-[#2980B9] p-5 text-white shadow-lg shadow-blue-500/20 active:scale-95 transition-transform duration-200 cursor-pointer">
                    <div class="relative z-10 flex justify-between items-center">
                        <div>
                            <div class="text-4xl font-extrabold tracking-tighter">{{ weather.temp }}<span v-if="weather.temp !== '--'">¬∞</span></div>
                            <div class="text-sm font-bold opacity-90 mt-1">{{ weather.desc }}</div>
                        </div>
                        <i :class="['fa-solid text-4xl opacity-90', weather.icon]"></i>
                    </div>
                </div>

                <!-- Date Slider -->
                <div class="sticky top-0 z-40 -mx-4 px-4 py-2 bg-[#F2F1F6]/95 backdrop-blur-sm">
                    <div class="flex gap-2 overflow-x-auto hide-scroll pb-2">
                        <div v-for="(day, index) in itinerary" :key="index" 
                             @click="selectedDayIndex = index"
                             :class="['flex-none w-[70px] p-2.5 rounded-2xl text-center transition-all duration-200 cursor-pointer border border-transparent shadow-sm', 
                                      selectedDayIndex === index ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-white text-gray-400']">
                            <div class="text-[10px] font-bold opacity-80">Day {{ day.d }}</div>
                            <div class="text-lg font-extrabold leading-tight">{{ day.date.split(' ')[0] }}</div>
                        </div>
                    </div>
                </div>

                <!-- Itinerary Items -->
                <div :key="selectedDayIndex" class="space-y-4">
                    <div class="bg-white rounded-2xl p-5 text-center shadow-ios border border-gray-100/50">
                        <h2 class="text-xl font-extrabold text-gray-800">{{ currentDay?.title }}</h2>
                        <div class="text-xs text-gray-400 mt-1">{{ currentDay?.date }}</div>
                    </div>

                    <div v-for="(item, idx) in currentDay?.items" :key="idx" class="relative group">
                        
                        <!-- Edit Trigger Button (Floating) -->
                        <button @click="openModal('edit', selectedDayIndex, idx, item)" class="absolute -right-2 -top-2 z-10 w-8 h-8 bg-gray-900 rounded-full text-white text-xs flex items-center justify-center shadow-lg opacity-80 hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                        <!-- Type: FLIGHT (NEW!) -->
                        <div v-if="item.type === 'flight'" class="bg-gradient-to-r from-flight-blue to-blue-600 rounded-[20px] text-white shadow-lg shadow-blue-500/30 overflow-hidden relative">
                            <!-- Decor -->
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
                            
                            <div class="p-5 relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="text-xs font-bold bg-white/20 px-2 py-1 rounded backdrop-blur-sm border border-white/10">
                                        <i class="fa-solid fa-plane-up mr-1"></i> {{ item.flightNo || 'FLIGHT' }}
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs opacity-70">BOARDING</div>
                                        <div class="font-mono font-bold text-lg leading-none">{{ item.time }}</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center px-2">
                                    <div class="text-center">
                                        <div class="text-3xl font-black tracking-tighter">{{ item.dep || 'DEP' }}</div>
                                        <div class="text-[10px] opacity-70 font-bold mt-1">È´òÈõÑ KHH</div>
                                    </div>
                                    <div class="flex-1 flex flex-col items-center px-4">
                                        <i class="fa-solid fa-plane text-white/50 rotate-90 text-xl"></i>
                                        <div class="h-0.5 w-full bg-white/20 mt-[-10px]"></div>
                                        <div class="text-[10px] mt-2 opacity-60">{{ item.duration || '2h 35m' }}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-3xl font-black tracking-tighter">{{ item.arr || 'ARR' }}</div>
                                        <div class="text-[10px] opacity-70 font-bold mt-1">È¶ñÁàæ ICN</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Perforated Bottom -->
                            <div class="bg-white/10 p-3 flex justify-between items-center text-[10px] font-bold tracking-wide relative">
                                <div class="absolute top-0 left-0 w-full border-t border-dashed border-white/30"></div>
                                <span>{{ item.desc }}</span>
                                <i class="fa-solid fa-chevron-right opacity-50"></i>
                            </div>
                        </div>

                        <!-- Type: Simple Item -->
                        <div v-else-if="!item.type || item.type === 'normal'" class="bg-white rounded-[20px] p-4 shadow-ios border border-gray-50 flex justify-between items-start">
                            <div class="flex-1 min-w-0 pr-3">
                                <a :href="item.map ? (item.title.includes('ÂÆ∂') ? 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(item.map) : getNaverLink(item.map)) : getSearchLink(item.title)" target="_blank" class="font-bold text-base text-gray-800 block flex items-center gap-1">
                                    {{ item.title }} 
                                    <i v-if="item.map" class="fa-solid fa-location-dot text-[10px] text-primary opacity-50"></i>
                                    <i v-else class="fa-solid fa-magnifying-glass text-[10px] text-blue-300 opacity-50"></i>
                                </a>
                                <div class="text-xs text-gray-500 mt-1 whitespace-pre-line">{{ item.desc }}</div>
                                <!-- Brands -->
                                <div v-if="item.brands" class="flex flex-wrap gap-1.5 mt-2">
                                    <a v-for="brand in item.brands" :href="getSearchLink(brand + ' ' + item.title)" target="_blank" class="px-2 py-0.5 rounded text-[10px] bg-gray-50 border border-gray-100 text-gray-600 hover:bg-gray-100">{{ brand }}</a>
                                </div>
                                <!-- User Notes Display -->
                                <div v-if="item.note" class="mt-2 bg-yellow-50 text-yellow-800 text-xs p-2 rounded-lg border border-yellow-100 flex gap-2 items-start">
                                    <i class="fa-solid fa-sticky-note mt-0.5 opacity-50"></i>
                                    <span>{{ item.note }}</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2 shrink-0">
                                <span v-if="item.time" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md">{{ item.time }}</span>
                                <a v-if="item.map" :href="item.title.includes('ÂÆ∂') ? 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(item.map) : getNaverLink(item.map)" target="_blank" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-accent-green hover:bg-green-100">
                                    <i class="fa-solid fa-location-arrow text-sm"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Type: Meal -->
                        <div v-else-if="item.type === 'meal'" class="bg-white rounded-[20px] shadow-ios overflow-hidden border border-gray-50">
                            <div class="bg-gray-50/80 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                                <div class="font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fa-solid fa-utensils text-primary"></i> {{ item.title }}
                                </div>
                                <span v-if="item.time" class="text-xs font-bold text-gray-400 bg-gray-200/50 px-2 py-1 rounded-md">{{ item.time }}</span>
                            </div>
                            <div class="p-4 space-y-3">
                                <div v-for="opt in item.opts" class="flex justify-between items-center text-sm">
                                    <a :href="getSearchLink(opt.n)" target="_blank" class="flex-1 group">
                                        <div class="font-bold text-gray-700 flex items-center gap-1">{{ opt.n }} <i class="fa-solid fa-magnifying-glass text-[10px] text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity"></i></div>
                                        <div v-if="opt.tip" class="text-[10px] text-gray-400">{{ opt.tip }}</div>
                                    </a>
                                    <div class="flex gap-2 items-center">
                                        <span :class="['text-[10px] px-2 py-1 rounded font-bold', opt.t==='res'?'bg-green-100 text-green-700':'bg-red-100 text-red-600']">{{ opt.t==='res'?'È†êÁ¥Ñ':'ÊéíÈöä' }}</span>
                                        <a v-if="opt.k" :href="getNaverLink(opt.k)" target="_blank" class="w-6 h-6 bg-gray-50 rounded-full flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50"><i class="fa-solid fa-location-arrow text-[10px]"></i></a>
                                    </div>
                                </div>
                                <div v-if="item.note" class="pt-2 mt-2 border-t border-dashed border-gray-200 text-xs text-yellow-700">
                                    üìù {{ item.note }}
                                </div>
                            </div>
                        </div>

                        <!-- Type: Choice -->
                        <div v-else-if="item.type === 'choice'" class="bg-[#FAFAFA] rounded-[20px] p-4 border-2 border-dashed border-gray-200">
                            <div class="flex justify-between items-center mb-1">
                                <div class="text-xs font-bold text-gray-400">{{ item.time || 'ÊôÇÊÆµ' }}</div>
                                <div class="text-center font-bold text-primary-dark">{{ item.title }}</div>
                                <div class="w-4"></div>
                            </div>
                            <div class="text-center text-xs text-gray-400 mb-3">{{ item.desc }}</div>
                            <div class="flex flex-wrap gap-2">
                                <a v-for="c in item.choices" :href="getSearchLink(c.n + ' ' + c.desc)" target="_blank" class="flex-1 min-w-[45%] bg-white p-3 rounded-xl border border-gray-100 text-center shadow-sm flex items-center justify-between group hover:border-primary/30 transition-colors">
                                    <div class="text-left">
                                        <div class="text-[10px] font-bold bg-gray-800 text-white inline-block px-1.5 rounded mb-1">{{ c.n.split(' ')[0] }}</div>
                                        <div class="text-xs font-bold text-gray-700 flex items-center gap-1">{{ c.desc }} <i class="fa-solid fa-magnifying-glass text-[8px] text-gray-300"></i></div>
                                    </div>
                                    <div v-if="c.target" @click.prevent="window.open(getNaverLink(c.target))" class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50">
                                        <i class="fa-solid fa-location-arrow text-[10px]"></i>
                                    </div>
                                </a>
                            </div>
                            <div v-if="item.note" class="mt-3 bg-white p-2 rounded border text-xs text-gray-600 text-center shadow-sm">
                                <span class="text-primary font-bold">Á≠ÜË®òÔºö</span> {{ item.note }}
                            </div>
                        </div>

                    </div>

                    <!-- ADD BUTTON -->
                    <button @click="openModal('add', selectedDayIndex)" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white hover:text-primary hover:border-primary transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> Êñ∞Â¢ûË°åÁ®ã
                    </button>

                    <div class="h-10"></div>
                </div>
            </div>
        </div>

        <!-- View: CALC -->
        <div v-show="currentView === 'calc'" class="p-5">
            <h2 class="text-xl font-extrabold text-gray-900 mb-4 ml-1">ÂåØÁéáË®àÁÆó</h2>
            <div class="bg-white rounded-[24px] p-6 shadow-ios border border-gray-50 text-right mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-400">Ëº∏ÂÖ•ÈüìÂπ£ (KRW)</span>
                    <button @click="resetCalc" class="text-xs font-bold text-primary hover:text-primary-dark">Ê∏ÖÈô§</button>
                </div>
                <input type="text" inputmode="decimal" v-model="calcInput" 
                       class="w-full text-right text-5xl font-light text-gray-900 placeholder-gray-200 outline-none bg-transparent font-mono mb-4 tracking-tighter" 
                       placeholder="0">
                <div class="border-t border-gray-100 py-3 flex justify-between items-center">
                    <span class="text-sm text-gray-400">Á¥ÑÂêàÂè∞Âπ£</span>
                    <span class="text-xl font-bold font-mono text-gray-800">{{ calcTwd }}</span>
                </div>
                <div class="pt-2 flex justify-between items-center">
                    <span class="text-sm text-gray-400">È†êË®àÈÄÄÁ®Ö</span>
                    <span class="text-xl font-bold font-mono text-accent-green">{{ calcTax }}</span>
                </div>
            </div>
            <div class="text-center text-xs text-gray-400">ÂåØÁéá: {{ rate }} | Êªø 30,000 ÂèØÈÄÄÁ®Ö</div>
        </div>

        <!-- View: GUIDE -->
        <div v-show="currentView === 'guide'" class="p-4 space-y-5">
            
            <!-- 1. Âø´ÈñÉÂ∏ÇÈõÜ -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg">1ÊúàÂø´ÈñÉ & Â∏ÇÈõÜ</h3>
                    <button @click="checkUpdates('popup')" class="text-xs text-primary font-bold flex items-center gap-1 active:opacity-50">
                        <i class="fa-solid fa-rotate-right transition-transform duration-700" :class="{'animate-spin': isUpdatingPopup}"></i> Êõ¥Êñ∞ÊÉÖÂ†±
                    </button>
                </div>
                <div class="space-y-2">
                    <transition-group name="list">
                        <div v-for="p in popupList" :key="p.title" class="flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" @click="openInfoModal(p.modalTitle || p.title, p.modalDesc || p.desc)">
                            <span :class="['px-2 py-1 rounded text-xs font-bold h-fit shrink-0', p.tagClass || 'bg-purple-100 text-purple-600']">{{ p.tag }}</span>
                            <div>
                                <div class="font-bold text-sm">{{ p.title }}</div>
                                <div class="text-xs text-gray-500 line-clamp-1">{{ p.desc }}</div>
                            </div>
                        </div>
                    </transition-group>
                </div>
            </div>

            <!-- 2. ÊΩÆÁâåÂø´Ë®ä -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg">ÊΩÆÁâå & Ë≥ºÁâ©Âø´Ë®ä</h3>
                    <button @click="checkUpdates('brand')" class="text-xs text-primary font-bold flex items-center gap-1 active:opacity-50">
                        <i class="fa-solid fa-rotate-right transition-transform duration-700" :class="{'animate-spin': isUpdatingBrand}"></i> Êõ¥Êñ∞Âø´Ë®ä
                    </button>
                </div>
                <div class="space-y-2">
                    <transition-group name="list">
                        <div v-for="b in brandList" :key="b.title" class="flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" @click="openInfoModal(b.modalTitle || b.title, b.modalDesc || b.desc)">
                            <span :class="['px-2 py-1 rounded text-xs font-bold h-fit shrink-0', b.tagClass || 'bg-blue-100 text-blue-600']">{{ b.tag }}</span>
                            <div>
                                <div class="font-bold text-sm">{{ b.title }}</div>
                                <div class="text-xs text-gray-500 line-clamp-1">{{ b.desc }}</div>
                            </div>
                        </div>
                    </transition-group>
                </div>
            </div>

            <!-- 3. ‰∫ÇÊâìÁßÄ -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50" @click="openInfoModal('NANTA ‰∫ÇÊâìÁßÄ', 'ÊºîÂá∫ÊôÇÈñìÔºö\n- ÈÄ±‰∏ÄËá≥ÈÄ±‰∫îÔºö17:00, 20:00\n- ÈÄ±Êú´/ÂÅáÊó•Ôºö14:00, 17:00, 20:00\n\nË¶™Â≠êÂèãÂñÑÂóéÔºü\n- Êªø 12 ÂÄãÊúàÂç≥ÂèØÂÖ•Â†¥\n- 12~35ÂÄãÊúàÂπºÂÖíÊÜëË≠∑ÁÖßÂÖçË≤ª (‰∏ç‰Ωî‰Ωç)\n\nÊ≥®ÊÑè‰∫ãÈ†ÖÔºö\n- ÊºîÂá∫90ÂàÜÈêòÔºåÈü≥ÈáèÂ§ß (ÊâìÈºìËÅ≤)„ÄÇ\n- Âª∫Ë≠∞2Ê≠≤ÂçäÂ∞èÂ≠©Ëã•ÊÄïÂêµÔºåÂèØÂùêËµ∞ÈÅìÊóÅ„ÄÇ')">
                <div class="flex gap-3 items-center">
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-500"><i class="fa-solid fa-drum"></i></div>
                    <div>
                        <div class="font-bold text-sm">ÊòéÊ¥û‰∫ÇÊâìÁßÄ</div>
                        <div class="text-xs text-gray-500">ÊºîÂá∫Ë≥áË®äËàáÂ†¥Ê¨°</div>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
            </div>

            <!-- 4. ÁîüÂ≠òÈüìË™û -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-2">ÁîüÂ≠òÈüìË™û</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div v-for="c in survivalCards" class="border p-2 rounded-xl text-center hover:bg-gray-50 active:scale-95 transition-all cursor-pointer" @click="openInfoModal(c.title + ' ' + c.k, c.desc)">
                        <div class="text-xl mb-1">{{ c.icon }}</div>
                        <div class="font-bold text-sm text-gray-700">{{ c.title }}</div>
                    </div>
                </div>
            </div>

            <!-- 5. Â∏∏Áî®Âú∞Âúñ -->
            <div class="bg-white rounded-2xl p-1 shadow-sm border border-gray-100">
                <a href="https://m.map.naver.com/" target="_blank" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl transition-colors">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-map text-green-500 text-xl"></i>
                        <div>
                            <div class="font-bold text-sm">Naver Map</div>
                            <div class="text-xs text-gray-400">ÈüìÂúãÂøÖÂÇôÂ∞éËà™</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </a>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="flex-none h-[calc(60px+env(safe-area-inset-bottom))] bg-white/95 backdrop-blur-xl border-t border-gray-200 pb-safe-bottom flex justify-around items-center z-50">
        <button v-for="tab in ['plan', 'calc', 'guide']" :key="tab"
                @click="currentView = tab"
                :class="['flex-1 h-full flex flex-col items-center justify-center gap-1 transition-colors', 
                         currentView === tab ? 'text-primary-dark' : 'text-gray-400']">
            <i :class="['fa-solid text-xl transition-transform duration-200', 
                        tab === 'plan' ? 'fa-calendar-days' : (tab === 'calc' ? 'fa-calculator' : 'fa-book-open'),
                        currentView === tab ? '-translate-y-0.5' : '']"></i>
            <span class="text-[10px] font-bold tracking-wide">
                {{ tab === 'plan' ? 'Ë°åÁ®ã' : (tab === 'calc' ? 'Ë®àÁÆó' : 'ÊîªÁï•') }}
            </span>
        </button>
    </nav>

    <!-- ADD/EDIT Modal (Advanced) -->
    <transition name="slide-up">
        <div v-if="showEditModal" class="absolute inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end justify-center" @click="closeEditModal">
            <div class="bg-white w-full h-[85vh] rounded-t-[24px] p-6 shadow-2xl flex flex-col" @click.stop>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-extrabold text-gray-900">{{ editForm.mode === 'add' ? 'Êñ∞Â¢ûË°åÁ®ã' : 'Á∑®ËºØË°åÁ®ã' }}</h3>
                    <button @click="closeEditModal" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto hide-scroll space-y-5 pb-6">
                    
                    <!-- Type Selector -->
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-2">È°ûÂûã</label>
                        <div class="flex bg-gray-100 p-1 rounded-xl">
                            <button v-for="t in ['normal', 'meal', 'choice', 'flight']" 
                                    @click="editForm.type = t"
                                    :class="['flex-1 py-2 text-xs font-bold rounded-lg transition-all', editForm.type === t ? 'bg-white shadow-sm text-gray-900' : 'text-gray-400']">
                                {{ t === 'normal' ? '‰∏ÄËà¨' : (t === 'meal' ? 'È§êÂª≥' : (t === 'flight' ? 'Áè≠Ê©ü' : 'Â§öÈÅ∏')) }}
                            </button>
                        </div>
                    </div>

                    <!-- Common Fields -->
                    <div class="grid grid-cols-4 gap-3">
                        <div class="col-span-1">
                            <label class="text-xs font-bold text-gray-400 block mb-1">ÊôÇÈñì</label>
                            <input v-model="editForm.time" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-sm text-center" placeholder="12:00">
                        </div>
                        <div class="col-span-3">
                            <label class="text-xs font-bold text-gray-400 block mb-1">Ê®ôÈ°å</label>
                            <input v-model="editForm.title" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-base" placeholder="Ë°åÁ®ãÂêçÁ®±">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">ÊèèËø∞ / Ë≥áË®ä</label>
                        <textarea v-model="editForm.desc" rows="2" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="Á∞°Áü≠ÊèèËø∞"></textarea>
                    </div>

                    <!-- FLIGHT Type Specific -->
                    <div v-if="editForm.type === 'flight'" class="space-y-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <div>
                            <label class="text-xs font-bold text-blue-400 block mb-1">Ëà™Áè≠‰ª£Ëôü (Flight No.)</label>
                            <input v-model="editForm.flightNo" class="w-full bg-white border border-blue-100 p-3 rounded-xl text-sm font-mono" placeholder="CI164">
                        </div>
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="text-xs font-bold text-blue-400 block mb-1">Âá∫ÁôºÂú∞ (Dep)</label>
                                <input v-model="editForm.dep" class="w-full bg-white border border-blue-100 p-3 rounded-xl text-center font-black text-xl" placeholder="KHH">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs font-bold text-blue-400 block mb-1">ÁõÆÁöÑÂú∞ (Arr)</label>
                                <input v-model="editForm.arr" class="w-full bg-white border border-blue-100 p-3 rounded-xl text-center font-black text-xl" placeholder="ICN">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-blue-400 block mb-1">È£õË°åÊôÇÈñì</label>
                            <input v-model="editForm.duration" class="w-full bg-white border border-blue-100 p-3 rounded-xl text-sm" placeholder="2h 35m">
                        </div>
                    </div>

                    <!-- Normal Type Specific -->
                    <div v-if="editForm.type === 'normal'" class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 block mb-1">Âú∞ÂúñÈóúÈçµÂ≠ó (Naver Map / Google Map)</label>
                            <div class="relative">
                                <i class="fa-solid fa-map-pin absolute left-3 top-3.5 text-gray-400 text-xs"></i>
                                <input v-model="editForm.map" class="w-full bg-gray-50 border border-gray-200 p-3 pl-8 rounded-xl text-sm" placeholder="Ëº∏ÂÖ•ÈüìÊñáÂ∫óÂêçÊàñ‰ΩèÂÆ∂Âú∞ÂùÄ">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 block mb-1">ÂìÅÁâå/Ê®ôÁ±§ (ÈÄóËôüÂàÜÈöî)</label>
                            <input v-model="editForm.brandsStr" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="Nike, Adidas, ÂøÖË≤∑">
                        </div>
                    </div>

                    <!-- Meal Type Specific -->
                    <div v-if="editForm.type === 'meal'" class="space-y-3">
                        <label class="text-xs font-bold text-gray-400 flex justify-between items-center">
                            È§êÂª≥ÈÅ∏È†Ö <button @click="addMealOption" class="text-primary text-[10px]"><i class="fa-solid fa-plus"></i> Â¢ûÂä†</button>
                        </label>
                        <div v-for="(opt, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative">
                            <button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                            <input v-model="opt.n" class="w-full bg-white p-2 rounded border border-gray-100 text-sm font-bold" placeholder="È§êÂª≥ÂêçÁ®±">
                            <div class="flex gap-2">
                                <select v-model="opt.t" class="bg-white p-2 rounded border border-gray-100 text-xs flex-1">
                                    <option value="walk">ÁèæÂ†¥Êéí</option>
                                    <option value="res">ÂèØÈ†êÁ¥Ñ</option>
                                    <option value="wait">ÈúÄÂÄô‰Ωç</option>
                                </select>
                                <input v-model="opt.k" class="flex-[2] bg-white p-2 rounded border border-gray-100 text-xs" placeholder="NaverÂú∞ÂúñÈóúÈçµÂ≠ó">
                            </div>
                            <input v-model="opt.tip" class="w-full bg-white p-2 rounded border border-gray-100 text-xs" placeholder="ÂÇôË®ª (Â¶Ç: ÂøÖÈªûÊéíÈ™®)">
                        </div>
                    </div>

                    <!-- Choice Type Specific -->
                    <div v-if="editForm.type === 'choice'" class="space-y-3">
                        <label class="text-xs font-bold text-gray-400 flex justify-between items-center">
                            Â§öÈÅ∏ÊñπÊ°à <button @click="addChoiceOption" class="text-primary text-[10px]"><i class="fa-solid fa-plus"></i> Â¢ûÂä†</button>
                        </label>
                        <div v-for="(c, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative">
                            <button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                            <div class="flex gap-2">
                                <input v-model="c.n" class="w-1/3 bg-white p-2 rounded border border-gray-100 text-sm font-bold text-center" placeholder="Plan A">
                                <input v-model="c.desc" class="w-2/3 bg-white p-2 rounded border border-gray-100 text-sm" placeholder="ÊèèËø∞ (Â¶Ç: ÂéªÊ®ÇÂúí)">
                            </div>
                            <input v-model="c.target" class="w-full bg-white p-2 rounded border border-gray-100 text-xs" placeholder="Âú∞ÂúñÊêúÂ∞ãÈóúÈçµÂ≠ó">
                        </div>
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="text-xs font-bold text-gray-400 block mb-1">Á≠ÜË®ò / ÂÇôË®ª</label>
                        <textarea v-model="editForm.note" rows="2" class="w-full bg-yellow-50 border border-yellow-100 p-3 rounded-xl text-sm text-gray-700" placeholder="ÁßÅ‰∫∫Á≠ÜË®ò..."></textarea>
                    </div>

                </div>

                <div class="pt-4 border-t border-gray-100 flex gap-3">
                    <button v-if="editForm.mode === 'edit'" @click="deleteItem" class="flex-1 bg-red-50 text-red-500 font-bold py-3.5 rounded-xl active:scale-95 transition-transform">
                        Âà™Èô§
                    </button>
                    <button @click="saveEdit" class="flex-[3] bg-gray-900 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-transform flex justify-center items-center gap-2 shadow-lg shadow-gray-500/30">
                        <span v-if="isSaving" class="animate-spin"><i class="fa-solid fa-circle-notch"></i></span>
                        <span>{{ isSaving ? 'ËôïÁêÜ‰∏≠...' : 'ÂÑ≤Â≠òËÆäÊõ¥' }}</span>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Info Modal -->
    <transition name="fade">
        <div v-if="infoModal.show" class="absolute inset-0 z-[110] bg-black/60 flex items-center justify-center p-6" @click="infoModal.show = false">
            <div class="bg-white w-full max-w-sm rounded-[30px] p-6 shadow-2xl text-center" @click.stop>
                <h3 class="text-xl font-extrabold text-gray-900 mb-3 whitespace-pre-line">{{ infoModal.title }}</h3>
                <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap mb-6">{{ infoModal.desc }}</p>
                <button @click="infoModal.show = false" class="w-full bg-gray-100 text-gray-900 font-bold py-3 rounded-xl">ÈóúÈñâ</button>
            </div>
        </div>
    </transition>

</div>

<script type="module">
    // --- 1. Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
    import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // --- 2. Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyBFDAs4hj4eJ2hCxsWWlRRCsJC_qEekBCc",
        authDomain: "trip-plan-app-c38a3.firebaseapp.com",
        projectId: "trip-plan-app-c38a3",
        storageBucket: "trip-plan-app-c38a3.firebasestorage.app",
        messagingSenderId: "79177072268",
        appId: "1:79177072268:web:e8efe92b05a528046d45a9",
        measurementId: "G-T39PWKG8GL"
    };

    let app, db, analytics;
    try {
        app = initializeApp(firebaseConfig);
        analytics = getAnalytics(app); 
        db = getFirestore(app); 
    } catch(e) { console.error("Init Error", e); }
    
    // --- UPDATE: Changed ID to v4 to force FLIGHT data load ---
    const DOC_ID = "seoul_trip_data_v4";

    const { createApp, ref, computed, onMounted, reactive } = Vue;

    // --- DEFAULT ITINERARY (Initial Data v4) ---
    const DEFAULT_ITINERARY = [
        { 
            d: 1, date: "1/25 (Êó•)", title: "Âá∫Áôº & ÊòéÊ¥û",
            items: [
                { time:"03:30", title:"üè† Âá∫ÁôºÔºöÂè∞ÂçóÊ∫´ÊöñÁöÑÂÆ∂", desc:"Ê™¢Êü•Ë≠∑ÁÖßÔºÅÈ†êÁïôÁ∑©Ë°ùÂâçÂæÄÂ∞èÊ∏ØÊ©üÂ†¥", map:"Âè∞ÂçóÂ∏ÇÊù±ÂçÄË£ïÂπ≥Ë∑Ø100Ëôü", type:"normal" },
                { time:"05:00", title:"üõ´ ÊäµÈÅîÈ´òÈõÑÂ∞èÊ∏ØÊ©üÂ†¥ (KHH)", desc:"Ëæ¶ÁêÜÁôªÊ©ü & Ë®óÈÅã (Ëµ∑È£õÂâç2Â∞èÊôÇ)", map:"È´òÈõÑÂúãÈöõÊ©üÂ†¥", type:"normal" },
                { 
                    type: "flight", time: "07:00", flightNo: "CI 164", dep: "KHH", arr: "ICN", duration: "2h 35m",
                    title: "È£õÂæÄÈ¶ñÁàæ", desc: "ËèØËà™ / È†êË®à 10:35 ÊäµÈÅî (ÊôÇÂ∑Æ+1)" 
                },
                { time:"11:30", title:"üõ¨ ÂÖ•Â¢É & È†òË°åÊùé", desc:"Ê©üÂ†¥Âø´Á∑ö / Â∑¥Â£´ÂâçÂæÄÂ∏ÇÂçÄ", type:"normal" },
                { time:"13:00", title:"L7 È£ØÂ∫ó Check-in", desc:"ÂØÑÊîæË°åÊùé", map:"L7 Î™ÖÎèô", type:"normal" },
                { title:"Money Planet ÊèõÈå¢", desc:"Â∞±Âú®ÊòéÊ¥ûÔºåÂåØÁéáÂÑ™ÔºÅ", map:"Î®∏ÎãàÌîåÎ†àÎãõ", type:"normal", brands: ["ÊèõÈå¢ÊâÄ"] },
                { title:"È¶ñÁàæË≥ºÁâ©Â≠£", desc:"Âéª„ÄåÊòéÊ¥ûÊ≠°Ëøé‰∏≠ÂøÉ„ÄçÈ†òÂÑ™ÊÉ†Âà∏ & Ê≠°ËøéÁ¶ÆÂåÖ", map:"Î™ÖÎèôÏòàÏà†Í∑πÏû•", type:"normal", brands: ["Welcome Center"] },
                { type:"meal", title:"ÊòéÊ¥ûÂçàÈ§ê", opts:[{n:"ÊòéÊ¥ûÈ§ÉÂ≠ê", t:"wait", tip:"ÂøÖÊØîÁôª"}, {n:"Á•û‰ªôÈõ™ÊøÉÊπØ", t:"wait", tip:"ÊøÉÈÉÅ"}, {n:"ËçíË¨¨ÁöÑÁîüËÇâ", t:"walk", tip:"ÁÉ§ËÇâ"}] },
                { time:"16:00", type:"choice", title:"‰∏ãÂçàËá™Áî±ÈÅ∏", desc:"Á¥Ø‰∫ÜÂóéÔºüÈÅ∏‰∏ÄÂÄãÂñúÊ≠°ÁöÑ", choices: [{n:"A ÈÄõË°ó", desc:"Olive Young", target:"Ïò¨Î¶¨Î∏åÏòÅ Î™ÖÎèô"}, {n:"B ËÅñÂ†Ç", desc:"ÊòéÊ¥ûËÅñÂ†Ç", target:"Î™ÖÎèôÏÑ±Îãπ"}, {n:"C ÂíñÂï°", desc:"Pink Pool Cafe", target:"Ïä§ÌÉÄÏùºÎÇúÎã§"}, {n:"D ‰∫ÇÊâìÁßÄ", desc:"17:00 Â†¥Ê¨°", target:"Î™ÖÎèôÎÇúÌÉÄÍ∑πÏû•"}] },
                { title:"Ê®ÇÂ§©ÁôæË≤® & ÂÖçÁ®ÖÂ∫ó", desc:"B1 È£üÂìÅË°ó / 9-12F ÂÖçÁ®ÖÂ∫ó", map:"Î°ØÎç∞Î∞±ÌôîÏ†ê Î≥∏Ï†ê", type:"normal", brands: ["Gentle Monster", "Tamburins"] },
                { time:"19:00", type:"meal", title:"ÊôöÈ§êÔºöÈüìÂºèÁÉ§ËÇâ", opts:[{n:"ÁéãÂ¶ÉÂÆ∂", t:"res"}, {n:"ÈªÉÈáëÁâßÂ†¥", t:"res"}] }
            ]
        },
        { 
            d: 2, date: "1/26 (‰∏Ä)", title: "ÂçóÂ§ßÈñÄ & Êù±Â§ßÈñÄ",
            items: [
                { time:"09:30", title:"ÊôØÁ¶èÂÆÆ", desc:"Á©øÈüìÊúçÈÄ≤Â†¥ÂÖçË≤ª", map:"Í≤ΩÎ≥µÍ∂Å", type:"normal" },
                { time:"12:00", type:"meal", title:"Ë•øÊùëÂçàÈ§ê", opts:[{n:"Âúü‰øóÊùëËîòÈõûÊπØ", t:"walk"}, {n:"ÈÄö‰ªÅÂ∏ÇÂ†¥", t:"walk", tip:"ÈäÖÈå¢‰æøÁï∂"}] },
                { time:"14:00", title:"ÂçóÂ§ßÈñÄÂ∏ÇÂ†¥", desc:"DÊ£üÊ£âË¢´„ÄÅEÊ£ü3FËä±Â∏Ç(Ê∞õÂúçÁáà)", map:"ÎÇ®ÎåÄÎ¨∏ÏãúÏû•", type:"normal", brands: ["Burdeng", "‰∫¨‰∏ÄÂ±ã"] },
                { time:"15:30", title:"ILKW Showroom", desc:"ÊúÉË≥¢Á´ôÁúãSnowmanÁáà", map:"ÏùºÍ¥ëÏ†ÑÍµ¨ ÎùºÏù¥ÌåÖÎ£∏ ÏÑúÏö∏", type:"normal" },
                { time:"16:30", type:"choice", title:"‰∏ãÂçà‰∏âÈÅ∏‰∏Ä", desc:"Ë≤∑ÂÆåÊù±Ë•øÂéªÂì™Ôºü", choices: [{n:"A ‰ºëÊÅØ", desc:"ÂõûÈ£ØÂ∫ó", target:"L7 Î™ÖÎèô"}, {n:"B ÂíñÂï°", desc:"Molto", target:"Î™∞Îòê"}, {n:"C ‰∫ÇÊâìÁßÄ", desc:"17:00 Â†¥", target:"Î™ÖÎèôÎÇúÌÉÄÍ∑πÏû•"}] },
                { time:"19:30", type:"choice", title:"Êôö‰∏ä‰∏âÈÅ∏‰∏Ä", desc:"ÈÄõË°ó vs ‰ºëÊÅØ", choices: [{n:"A ÈÄõË°ó", desc:"DDP", target:"DDP"}, {n:"B Ê±óËí∏", desc:"Sparex", target:"Ïä§ÌååÎ†âÏä§"}, {n:"C ‰∫ÇÊâìÁßÄ", desc:"20:00 Â†¥", target:"Î™ÖÎèôÎÇúÌÉÄÍ∑πÏû•"}] }
            ]
        },
        { d: 3, date: "1/27 (‰∫å)", title: "Â∞èÂ≠©ÁöÑÈÅ∏ÊìáÊó•", items: [{ type:"choice", title:"Ë∂ÖÂ§öÊñπÊ°à (Ë¶ñÂ§©Ê∞£È´îÂäõ)", desc:"Plan A-H ‰ªªÂêõÊåëÈÅ∏", choices: [{n:"A Êà∂Â§ñ", desc:"ÂçóÊÄ°Â≥∂", target:"ÎÇ®Ïù¥ÏÑ¨"}, {n:"B ÂÆ§ÂÖß", desc:"Ê®ÇÂ§©‰∏ñÁïå", target:"Î°ØÎç∞ÏõîÎìú"}, {n:"C Ê∞¥Êóè", desc:"COEX", target:"ÏΩîÏóëÏä§"}, {n:"D ÂãïÁï´", desc:"È¶ñÁàæÂãïÁï´‰∏≠ÂøÉ", target:"ÏÑúÏö∏Ïï†ÎãàÎ©îÏù¥ÏÖòÏÑºÌÑ∞"}, {n:"E HiKR", desc:"Â•ΩÂÆ¢Á©∫Èñì", target:"ÌïòÏù¥Ïª§Í∑∏ÎùºÏö¥Îìú"}, {n:"F Ê®ÇÂúí", desc:"Pororo Park", target:"ÎΩÄÎ°úÎ°úÌååÌÅ¨"}] }, { time:"19:00", type:"choice", title:"Â§úÊôöÂõõÈÅ∏‰∏Ä", desc:"ÁúãÈ´îÂäõÊ±∫ÂÆö", choices: [{n:"A ÊôØÈªû", desc:"ÂçóÂ±±Â°î", target:"NÏÑúÏö∏ÌÉÄÏõå"}, {n:"B ÊåâÊë©", desc:"ÊòéÊ¥ûÊåâÊë©", target:"Î™ÖÎèô"}] }] },
        { d: 4, date: "1/28 (‰∏â)", title: "ÁãéÈ∑ó‰∫≠ & ËÅñÊ∞¥Ê¥û", items: [{ time:"11:00", title:"ÁãéÈ∑ó‰∫≠ÊΩÆÁâå", desc:"Â≥∂Â±±ÂÖ¨Âúí", map:"ÌïòÏö∞Ïä§ ÎèÑÏÇ∞", type:"normal", brands:["Stussy", "Supreme"] }, { time:"14:30", type:"choice", title:"ËÅñÊ∞¥Ê¥û", desc:"ÈÄõË°ó vs Ê∫úÂ∞èÂ≠©", choices: [{n:"A ÈÄõË°ó", desc:"Dior/ADER", target:"ÏÑ±ÏàòÎèô"}, {n:"B ÂÖ¨Âúí", desc:"È¶ñÁàæÊûó", target:"ÏÑúÏö∏Ïà≤"}, {n:"C ‰∫ÇÊâìÁßÄ", desc:"ÂõûÊòéÊ¥û", target:"Î™ÖÎèô"}] }, { time:"17:00", type:"meal", title:"ÊôöÈ§ê", opts:[{n:"Á•ñÂÇ≥È¶¨Èà¥ËñØÊπØ", t:"wait"}, {n:"Onion Cafe", t:"walk"}] }, { time:"20:00", type:"choice", title:"Êôö‰∏äÁ∫åÊî§", desc:"", choices: [{n:"A ‰∫ÇÊâìÁßÄ", desc:"20:00 Â†¥", target:"Î™ÖÎèô"}, {n:"B ÈÄõË°ó", desc:"Olive Young", target:"Ïò¨Î¶¨Î∏åÏòÅ"}] }] },
        { d: 5, date: "1/29 (Âõõ)", title: "Ê±ùÁü£Â≥∂", items: [{ time:"10:30", title:"Zoolung Zoolung", desc:"ÂÆ§ÂÖßÂãïÁâ©Âúí", map:"Ï£ºÎ†ÅÏ£ºÎ†Å ÏòÅÎì±Ìè¨", type:"normal" }, { time:"13:30", title:"Áèæ‰ª£ÁôæË≤®", desc:"The Hyundai Seoul", map:"ÎçîÌòÑÎåÄ ÏÑúÏö∏", type:"normal", brands:["Matin Kim"] }, { type:"choice", title:"ÂÇçÊôö‰∫åÈÅ∏‰∏Ä", desc:"", choices: [{n:"A ÈÄõË°ó", desc:"ÁπºÁ∫åÈÄõ", target:"ÎçîÌòÑÎåÄ"}, {n:"B Ê∞¥Êóè", desc:"63Â§ßÊ®ì", target:"63ÎπåÎî©"}] }, { time:"19:00", type:"choice", title:"ÊôöÈ§ê", desc:"", choices: [{n:"A Êµ∑ÈÆÆ", desc:"È∑∫Ê¢ÅÊ¥•", target:"ÎÖ∏ÎüâÏßÑ"}, {n:"B Êº¢Ê±ü", desc:"ÂêÉÊ≥°È∫µ", target:"ÌïúÍ∞ïÍ≥µÏõê"}] }] },
        { d: 6, date: "1/30 (‰∫î)", title: "ÂºòÂ§ß", items: [{ time:"11:00", title:"ÂºòÂ§ßÂïÜÂúà", desc:"AK Plaza", map:"ÌôçÎåÄÏûÖÍµ¨Ïó≠", type:"normal", brands:["Object", "Musinsa"] }, { time:"12:30", type:"meal", title:"ÂçàÈ§ê", opts:[{n:"Áî≥Áæé‰∫¨Ëæ£ÁÇíÈõûÊéí", t:"walk"}, {n:"Ë±¨ËÖ≥Â∞èÂßê", t:"walk"}] }, { type:"choice", title:"‰∏ãÂçà", desc:"", choices: [{n:"A Âª∂Âçó", desc:"ÊñáÈùí", target:"Ïó∞ÎÇ®Îèô"}, {n:"B ÁõäÂñÑ", desc:"ÈüìÂ±ã", target:"ÏùµÏÑ†Îèô"}, {n:"C Â∏ÇÂ†¥", desc:"ÊúõÈÅ†Â∏ÇÂ†¥", target:"ÎßùÏõêÏãúÏû•"}] }, { time:"18:30", title:"Ê®ÇÂ§©Ë∂ÖÂ∏Ç", desc:"Êé°Ë≥º", map:"Î°ØÎç∞ÎßàÌä∏ ÏÑúÏö∏Ïó≠Ï†ê", type:"normal" }] },
        { 
            d: 7, date: "1/31 (ÂÖ≠)", title: "ÂõûÂÆ∂", 
            items: [
                { time:"08:30", title:"üè® Check-out", desc:"Êê≠‰πòÊ©üÂ†¥Â∑¥Â£´ÊàñAREXÂâçÂæÄÊ©üÂ†¥", type:"normal" }, 
                { time:"10:00", title:"üõ´ ÊäµÈÅîÊ©üÂ†¥ & ÈÄÄÁ®Ö", desc:"Ëæ¶ÁêÜÁôªÊ©ü & ÊúÄÂæåÊé°Ë≤∑", type:"normal" },
                { 
                    type: "flight", time: "12:00", flightNo: "CI 165", dep: "ICN", arr: "KHH", duration: "3h 05m",
                    title: "ËøîÂõûÂè∞ÁÅ£", desc: "ËèØËà™ / È†êË®à 14:05 ÊäµÈÅî" 
                },
                { time:"14:30", title:"üõ¨ ÊäµÈÅîÈ´òÈõÑÂ∞èÊ∏ØÊ©üÂ†¥", desc:"È†òÂèñË°åÊùé & ÂÖ•Â¢É", type:"normal" },
                { time:"16:00", title:"üè† ÊäµÈÅîÂè∞Âçó", desc:"ÁîúËúúÁöÑÂÆ∂ÔºåÊï¥ÁêÜÊà∞Âà©ÂìÅÔºÅ", map:"Âè∞ÂçóÂ∏ÇÊù±ÂçÄË£ïÂπ≥Ë∑Ø100Ëôü", type:"normal" }
            ] 
        }
    ];

    // --- GUIDE DATA ---
    const initialPopups = [
        { title: "È¶ñÁàæÁáàÁØÄ", desc: "ÂÖâÂåñÈñÄ | ÂÜ¨Â≠£ÈôêÂÆö", tag: "ÈôêÂÆö", tagClass: "bg-orange-100 text-orange-600", modalTitle: "È¶ñÁàæÁáàÁØÄ", modalDesc: "ÊôÇÈñìÔºöËá≥ 1ÊúàÂ∫ï\nÂú∞ÈªûÔºöÂÖâÂåñÈñÄÂª£Â†¥" },
        { title: "Áèæ‰ª£ÁôæË≤® Âø´ÈñÉ", desc: "B2 / 5F Â§ßÂûãIP", tag: "ÁÜ±ÈñÄ", tagClass: "bg-purple-100 text-purple-600", modalTitle: "The Hyundai Seoul", modalDesc: "Âú∞ÈªûÔºöÊ±ùÁü£Â≥∂ (Day 5)" }
    ];
    const newPopupsMock = [{ title: "Burberry Áé´Áë∞", desc: "ËÅñÊ∞¥Ê¥û | ÂíñÂï°Âª≥", tag: "NEW", tagClass: "bg-teal-100 text-teal-600", modalTitle: "Burberry Rose", modalDesc: "‰ΩçÁΩÆÔºöËÅñÊ∞¥Ê¥û" }];
    const initialBrands = [
        { title: "Olive Young", desc: "ÊòéÊ¥û | ÊªøÈ°çÈÄÄÁ®Ö", tag: "SALE", tagClass: "bg-red-100 text-red-600", modalTitle: "Olive Young", modalDesc: "Ê¥ªÂãïÔºöÂÜ¨Â≠£‰øÉÈä∑" },
        { title: "Gentle Monster", desc: "Haus Dosan", tag: "Êñ∞ÂìÅ", tagClass: "bg-gray-100 text-gray-800", modalTitle: "GM 2026", modalDesc: "Âú∞ÈªûÔºöÁãéÈ∑ó‰∫≠" }
    ];
    const newBrandsMock = [{ title: "St√ºssy ÈôêÂÆö", desc: "ÁãéÈ∑ó‰∫≠ | Hoodie", tag: "DROP", tagClass: "bg-yellow-100 text-yellow-800", modalTitle: "St√ºssy Seoul", modalDesc: "Êú¨ÈÄ±‰∫îÁôºÂîÆ" }];
    const survivalCards = [
        { title: "‰Ω†Â•Ω", k: "ÏïàÎÖïÌïòÏÑ∏Ïöî", icon: "üëã", desc: "ÂÆâÂ¶ûÂìà„Ñô„ÑüÂë¶" }, { title: "Ë¨ùË¨ù", k: "Í∞êÏÇ¨Ìï©ÎãàÎã§", icon: "üôè", desc: "Â∫∑ÊííÂìàÂí™Êê≠" },
        { title: "ÊàëË¶ÅÈÄôÂÄã", k: "Ïù¥Í±∞ Ï£ºÏÑ∏Ïöî", icon: "üëâ", desc: "‰ºäÂãæ Êú±„Ñô„ÑüÂë¶" }, { title: "Ê¥óÊâãÈñì", k: "ÌôîÏû•Ïã§", icon: "üöª", desc: "Ëä±Ê±üÊ¥ó" },
        { title: "‰æøÂÆúÈªû", k: "ÍπéÏïÑÏ£ºÏÑ∏Ïöî", icon: "üí∏", desc: "ÂòéÂòéÊú±„Ñô„ÑüÂë¶" }, { title: "Ë¢ãÂ≠ê", k: "Î¥âÌà¨ Ï£ºÏÑ∏Ïöî", icon: "üõçÔ∏è", desc: "Â¥©Âúü Êú±„Ñô„ÑüÂë¶" }
    ];

    createApp({
        setup() {
            const currentView = ref('plan');
            const itinerary = ref([]);
            const selectedDayIndex = ref(0);
            const dbStatus = ref('connecting');
            const loading = ref(true);
            
            // Edit Modal State
            const showEditModal = ref(false);
            const editingItem = ref(null); // Contains {dIdx, iIdx} or null
            const isSaving = ref(false);
            
            // The Form Data
            const editForm = reactive({
                mode: 'add', // 'add' or 'edit'
                dIdx: 0,
                iIdx: 0, // Only for edit
                type: 'normal',
                time: '',
                title: '',
                desc: '',
                map: '',
                brandsStr: '',
                note: '',
                flightNo: '', // For flight
                dep: 'KHH',   // For flight
                arr: 'ICN',   // For flight
                duration: '', // For flight
                subItems: [] // For Meal (opts) or Choice (choices)
            });

            // Calc & Guide State
            const calcInput = ref('');
            const rate = ref(0.024);
            const infoModal = reactive({ show: false, title: '', desc: '' });
            const popupList = ref([...initialPopups]);
            const brandList = ref([...initialBrands]);
            const isUpdatingPopup = ref(false);
            const isUpdatingBrand = ref(false);
            const hasUpdatedPopup = ref(false);
            const hasUpdatedBrand = ref(false);
            const weather = reactive({ temp: '--', desc: 'ËºâÂÖ•‰∏≠', icon: 'fa-cloud' });

            const currentDay = computed(() => itinerary.value[selectedDayIndex.value]);
            const statusText = computed(() => {
                if (dbStatus.value === 'connected') return 'Â§ö‰∫∫ÈÄ£Á∑ö‰∏≠ (v4)';
                if (dbStatus.value === 'empty') return 'Ë≥áÊñôÂ∫´ÁÇ∫Á©∫';
                if (dbStatus.value === 'error') return 'ÈÄ£Á∑öÈåØË™§';
                return 'ÈÄ£Á∑ö‰∏≠...';
            });
            const calcTwd = computed(() => Math.round((parseFloat(calcInput.value) || 0) * rate.value).toLocaleString());
            const calcTax = computed(() => {
                const v = parseFloat(calcInput.value) || 0;
                if(v < 30000) return 0;
                return '‚Ç© ' + (v >= 75000 ? 5000 : (v >= 50000 ? 3500 : 1500)).toLocaleString();
            });

            onMounted(async () => {
                fetchWeather();
                if (!db) { dbStatus.value = 'error'; loading.value = false; return; }
                try {
                    onSnapshot(doc(db, "trips", DOC_ID), (docSnap) => {
                        loading.value = false;
                        if (docSnap.exists()) {
                            itinerary.value = docSnap.data().itinerary;
                            dbStatus.value = 'connected';
                        } else {
                            dbStatus.value = 'empty';
                            itinerary.value = [];
                        }
                    }, (err) => { console.error(err); dbStatus.value = 'error'; itinerary.value = DEFAULT_ITINERARY; loading.value = false; });
                } catch (e) { dbStatus.value = 'error'; loading.value = false; }
            });

            const uploadDefaultData = async () => {
                if(!db) return;
                loading.value = true;
                await setDoc(doc(db, "trips", DOC_ID), { itinerary: DEFAULT_ITINERARY });
            };

            // --- Modal Logic ---
            const openModal = (mode, dIdx, iIdx = null, item = null) => {
                editForm.mode = mode;
                editForm.dIdx = dIdx;
                editForm.iIdx = iIdx;
                
                if (mode === 'edit' && item) {
                    // Populate Form
                    editForm.type = item.type || 'normal';
                    editForm.time = item.time || '';
                    editForm.title = item.title || '';
                    editForm.desc = item.desc || '';
                    editForm.map = item.map || '';
                    editForm.brandsStr = item.brands ? item.brands.join(', ') : '';
                    editForm.note = item.note || '';
                    
                    // Flight specifics
                    editForm.flightNo = item.flightNo || '';
                    editForm.dep = item.dep || '';
                    editForm.arr = item.arr || '';
                    editForm.duration = item.duration || '';

                    // Handle Complex Sub-Items
                    editForm.subItems = [];
                    if (editForm.type === 'meal' && item.opts) {
                        editForm.subItems = JSON.parse(JSON.stringify(item.opts)); // Deep copy
                    } else if (editForm.type === 'choice' && item.choices) {
                        editForm.subItems = JSON.parse(JSON.stringify(item.choices));
                    }
                } else {
                    // Reset Form for Add
                    editForm.type = 'normal';
                    editForm.time = '';
                    editForm.title = '';
                    editForm.desc = '';
                    editForm.map = '';
                    editForm.brandsStr = '';
                    editForm.note = '';
                    editForm.flightNo = '';
                    editForm.dep = 'KHH';
                    editForm.arr = 'ICN';
                    editForm.duration = '';
                    editForm.subItems = [];
                }
                showEditModal.value = true;
            };

            const closeEditModal = () => { showEditModal.value = false; };

            const addMealOption = () => { editForm.subItems.push({ n: '', t: 'walk', k: '', tip: '' }); };
            const addChoiceOption = () => { editForm.subItems.push({ n: `Plan`, desc: '', target: '' }); };
            const removeSubItem = (idx) => { editForm.subItems.splice(idx, 1); };

            const saveEdit = async () => {
                if (!db) return;
                isSaving.value = true;
                
                // Construct Item Object
                const newItem = {
                    title: editForm.title,
                    desc: editForm.desc,
                    time: editForm.time,
                    note: editForm.note,
                    type: editForm.type
                };

                if (editForm.type === 'normal') {
                    newItem.map = editForm.map;
                    if (editForm.brandsStr) newItem.brands = editForm.brandsStr.split(/,|Ôºå/).map(s => s.trim()).filter(s => s);
                } else if (editForm.type === 'meal') {
                    newItem.opts = editForm.subItems;
                } else if (editForm.type === 'choice') {
                    newItem.choices = editForm.subItems;
                } else if (editForm.type === 'flight') {
                    newItem.flightNo = editForm.flightNo;
                    newItem.dep = editForm.dep;
                    newItem.arr = editForm.arr;
                    newItem.duration = editForm.duration;
                }

                // Update Local Data Copy
                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                if (editForm.mode === 'add') {
                    newItinerary[editForm.dIdx].items.push(newItem);
                } else {
                    newItinerary[editForm.dIdx].items[editForm.iIdx] = newItem;
                }

                // Sync to Firebase
                try {
                    await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary });
                    showEditModal.value = false;
                } catch (e) { alert("ÂÑ≤Â≠òÂ§±Êïó"); } 
                finally { isSaving.value = false; }
            };

            const deleteItem = async () => {
                if (!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË°åÁ®ãÂóéÔºü")) return;
                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                newItinerary[editForm.dIdx].items.splice(editForm.iIdx, 1);
                try {
                    await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary });
                    showEditModal.value = false;
                } catch (e) { alert("Âà™Èô§Â§±Êïó"); }
            };

            // --- Other Logic ---
            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current=temperature_2m,weather_code&timezone=Asia%2FSeoul');
                    const d = await res.json();
                    weather.temp = Math.round(d.current.temperature_2m);
                    weather.desc = d.current.weather_code > 2 ? 'Â§öÈõ≤' : 'Êô¥Êúó';
                    weather.icon = d.current.weather_code > 2 ? 'fa-cloud' : 'fa-sun';
                } catch(e) {}
            };

            const checkUpdates = (type) => {
                if ((type === 'popup' && hasUpdatedPopup.value) || (type === 'brand' && hasUpdatedBrand.value)) { alert("ÁõÆÂâçÂ∑≤ÊòØÊúÄÊñ∞Ë≥áË®ä"); return; }
                if (type === 'popup') isUpdatingPopup.value = true; else isUpdatingBrand.value = true;
                setTimeout(() => {
                    if (type === 'popup') { popupList.value = [...newPopupsMock, ...initialPopups]; hasUpdatedPopup.value = true; isUpdatingPopup.value = false; }
                    else { brandList.value = [...newBrandsMock, ...initialBrands]; hasUpdatedBrand.value = true; isUpdatingBrand.value = false; }
                }, 1500);
            };

            const resetCalc = () => calcInput.value = '';
            const getSearchLink = (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`;
            const getNaverLink = (k) => `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(k)}`;
            const openInfoModal = (title, desc) => { infoModal.title = title; infoModal.desc = desc; infoModal.show = true; };

            return {
                itinerary, selectedDayIndex, currentDay, dbStatus, loading, uploadDefaultData, statusText,
                showEditModal, editForm, openModal, closeEditModal, saveEdit, deleteItem, isSaving, addMealOption, addChoiceOption, removeSubItem,
                currentView, weather, fetchWeather,
                calcInput, calcTwd, calcTax, resetCalc, rate,
                survivalCards, infoModal, openInfoModal,
                popupList, brandList, checkUpdates, isUpdatingPopup, isUpdatingBrand,
                getSearchLink, getNaverLink
            };
        }
    }).mount('#app');
</script>
</body>
</html>

