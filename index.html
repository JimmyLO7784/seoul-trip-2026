<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¦–çˆ¾ 2026 è¡Œç¨‹ (v14 COEX æ ¸å¿ƒç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { bg: '#F2F1F6', primary: '#C8A47E', 'primary-dark': '#A68665', 'accent-green': '#34C759', 'flight-blue': '#003087' }, boxShadow: { 'ios': '0 2px 8px rgba(0,0,0,0.04)' } } } }
    </script>
    <style>
        body { background-color: #333; font-family: "M PLUS Rounded 1c", sans-serif; overflow: hidden; position: fixed; inset: 0; width: 100%; height: 100dvh; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; } .hide-scroll::-webkit-scrollbar { display: none; }
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); } .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; } .fade-enter-from, .fade-leave-to { opacity: 0; }
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; } .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(-20px); }
        a { -webkit-touch-callout: none; }
        .ripple { position: relative; overflow: hidden; }
        .ripple:after { content: ""; display: block; position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; background-image: radial-gradient(circle, #000 10%, transparent 10.01%); background-repeat: no-repeat; background-position: 50%; transform: scale(10, 10); opacity: 0; transition: transform .5s, opacity 1s; }
        .ripple:active:after { transform: scale(0, 0); opacity: .2; transition: 0s; }
    </style>
</head>
<body class="text-gray-900 select-none flex justify-center items-center bg-gray-800/50 backdrop-blur-sm">

<div id="app" class="relative w-full h-full max-w-[480px] bg-[#F2F1F6] shadow-2xl flex flex-col md:h-[95dvh] md:rounded-[40px] md:overflow-hidden md:border-[8px] md:border-gray-900">
    <!-- Header -->
    <header class="flex-none px-5 py-3 pt-[calc(12px+env(safe-area-inset-top))] bg-bg/90 backdrop-blur-md border-b border-black/5 z-50 flex justify-between items-center sticky top-0">
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight text-gray-900 flex items-center gap-2">
                SEOUL 2026 <span :class="['w-2 h-2 rounded-full', dbStatus === 'connected' ? 'bg-green-500 animate-pulse' : 'bg-red-400']"></span>
            </h1>
            <p class="text-xs font-semibold text-gray-400 -mt-1">{{ statusText }}</p>
        </div>
        <button v-if="dbStatus === 'empty'" @click="uploadDefaultData" class="text-xs bg-primary text-white px-3 py-1 rounded-full font-bold shadow-sm animate-bounce">åˆå§‹åŒ– v14</button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden hide-scroll relative w-full">
        <div class="pb-[20px]"> 
            <!-- PLAN VIEW -->
            <div v-show="currentView === 'plan'">
                <div v-if="loading" class="flex flex-col items-center justify-center h-[50vh] text-gray-400 gap-3">
                    <i class="fa-solid fa-map-location-dot animate-bounce text-3xl text-blue-500"></i><span class="text-sm font-bold">è¼‰å…¥ COEX è¡Œç¨‹...</span>
                </div>
                <div v-else class="p-4 space-y-5">
                    
                    <!-- Weather Card -->
                    <div @click="openWeatherModal" class="relative overflow-hidden rounded-[24px] bg-gradient-to-br from-[#6DD5FA] to-[#2980B9] p-5 text-white shadow-lg active:scale-95 transition-transform cursor-pointer group">
                        <div class="absolute right-0 top-0 p-3 opacity-0 group-hover:opacity-100 transition-opacity text-xs font-bold bg-white/20 rounded-bl-xl backdrop-blur-sm">æŸ¥çœ‹é å ± <i class="fa-solid fa-arrow-right ml-1"></i></div>
                        <div class="relative z-10 flex justify-between items-center">
                            <div><div class="text-4xl font-extrabold tracking-tighter">{{ weather.temp }}<span v-if="weather.temp !== '--'">Â°</span></div><div class="text-sm font-bold opacity-90 mt-1">{{ weather.desc }}</div></div>
                            <i :class="['fa-solid text-4xl opacity-90', weather.icon]"></i>
                        </div>
                    </div>

                    <!-- Date Slider -->
                    <div class="sticky top-0 z-40 -mx-4 px-4 py-2 bg-[#F2F1F6]/95 backdrop-blur-sm">
                        <div class="flex gap-2 overflow-x-auto hide-scroll pb-2">
                            <div v-for="(day, index) in itinerary" :key="index" @click="selectedDayIndex = index"
                                 :class="['flex-none w-[70px] p-2.5 rounded-2xl text-center transition-all cursor-pointer border border-transparent shadow-sm', selectedDayIndex === index ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-white text-gray-400']">
                                <div class="text-[10px] font-bold opacity-80">Day {{ day.d }}</div><div class="text-lg font-extrabold leading-tight">{{ day.date.split(' ')[0] }}</div>
                            </div>
                        </div>
                    </div>
                    <!-- Items -->
                    <div :key="selectedDayIndex" class="space-y-4">
                        <div class="bg-white rounded-2xl p-5 text-center shadow-ios border border-gray-100/50">
                            <h2 class="text-xl font-extrabold text-gray-800">{{ currentDay?.title }}</h2><div class="text-xs text-gray-400 mt-1">{{ currentDay?.date }}</div>
                        </div>
                        <div v-for="(item, idx) in currentDay?.items" :key="idx" class="relative group">
                            <button @click="openModal('edit', selectedDayIndex, idx, item)" class="absolute -right-2 -top-2 z-10 w-8 h-8 bg-gray-900 rounded-full text-white text-xs flex items-center justify-center shadow-lg opacity-80 hover:opacity-100 transition-opacity"><i class="fa-solid fa-pen"></i></button>
                            
                            <!-- FLIGHT CARD -->
                            <div v-if="item.type === 'flight'" class="bg-gradient-to-r from-flight-blue to-blue-600 rounded-[20px] text-white shadow-lg overflow-hidden relative">
                                <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
                                <div class="p-5 relative z-10">
                                    <div class="flex justify-between items-start mb-4"><div class="text-xs font-bold bg-white/20 px-2 py-1 rounded backdrop-blur-sm border border-white/10"><i class="fa-solid fa-plane-up mr-1"></i> {{ item.flightNo || 'FLIGHT' }}</div><div class="text-right"><div class="text-xs opacity-70">BOARDING</div><div class="font-mono font-bold text-lg leading-none">{{ item.time }}</div></div></div>
                                    <div class="flex justify-between items-center px-2"><div class="text-center"><div class="text-3xl font-black tracking-tighter">{{ item.dep }}</div><div class="text-[10px] opacity-70 font-bold mt-1">é«˜é›„ KHH</div></div><div class="flex-1 flex flex-col items-center px-4"><i class="fa-solid fa-plane text-white/50 rotate-90 text-xl"></i><div class="h-0.5 w-full bg-white/20 mt-[-10px]"></div><div class="text-[10px] mt-2 opacity-60">{{ item.duration }}</div></div><div class="text-center"><div class="text-3xl font-black tracking-tighter">{{ item.arr }}</div><div class="text-[10px] opacity-70 font-bold mt-1">é¦–çˆ¾ ICN</div></div></div>
                                </div>
                                <div class="bg-white/10 p-3 flex justify-between items-center text-[10px] font-bold tracking-wide relative"><div class="absolute top-0 left-0 w-full border-t border-dashed border-white/30"></div><span>{{ item.desc }}</span><i class="fa-solid fa-chevron-right opacity-50"></i></div>
                            </div>

                            <!-- NORMAL CARD -->
                            <div v-else-if="!item.type || item.type === 'normal'" class="bg-white rounded-[20px] p-4 shadow-ios border border-gray-50 flex justify-between items-start">
                                <div class="flex-1 min-w-0 pr-3">
                                    <a :href="getSearchLink(item.title)" target="_blank" class="font-bold text-base text-gray-800 block flex items-center gap-1">{{ item.title }} <i class="fa-solid fa-magnifying-glass text-[10px] text-blue-300 opacity-50"></i></a>
                                    <div class="text-xs text-gray-500 mt-1 whitespace-pre-line">{{ item.desc }}</div>
                                    <div v-if="item.brands" class="flex flex-wrap gap-1.5 mt-2"><a v-for="b in item.brands" :href="getSearchLink(b + ' ' + item.title)" target="_blank" class="px-2 py-0.5 rounded text-[10px] bg-gray-50 border border-gray-100 text-gray-600 hover:bg-gray-100">{{ b }}</a></div>
                                    <div v-if="item.note" class="mt-2 bg-yellow-50 text-yellow-800 text-xs p-2 rounded-lg border border-yellow-100 flex gap-2 items-start"><i class="fa-solid fa-sticky-note mt-0.5 opacity-50"></i><span>{{ item.note }}</span></div>
                                </div>
                                <div class="flex flex-col items-end gap-2 shrink-0">
                                    <span v-if="item.time" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md">{{ item.time }}</span>
                                    <a v-if="item.map" :href="getNaverLink(item.map)" target="_blank" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-accent-green hover:bg-green-100"><i class="fa-solid fa-location-arrow text-sm"></i></a>
                                </div>
                            </div>

                            <!-- MEAL CARD (Clickable) -->
                            <div v-else-if="item.type === 'meal'" class="bg-white rounded-[20px] shadow-ios overflow-hidden border border-gray-50">
                                <div class="bg-gray-50/80 px-4 py-3 border-b border-gray-100 flex justify-between items-center"><div class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-utensils text-primary"></i> {{ item.title }} <span class="text-[10px] text-gray-400 font-normal ml-1">(é»é¤å»³çœ‹è©•åƒ¹)</span></div><span v-if="item.time" class="text-xs font-bold text-gray-400 bg-gray-200/50 px-2 py-1 rounded-md">{{ item.time }}</span></div>
                                <div class="p-4 space-y-3">
                                    <div v-for="opt in item.opts" :key="opt.n" @click="openInfoModal(opt.n, opt.detail || 'æš«ç„¡è©•åƒ¹')" class="flex justify-between items-center text-sm cursor-pointer active:scale-[0.98] transition-transform hover:bg-gray-50 p-2 rounded-lg -mx-2">
                                        <div class="flex-1 group"><div class="font-bold text-gray-700 flex items-center gap-1">{{ opt.n }} <i class="fa-solid fa-circle-info text-[10px] text-gray-300 opacity-0 group-hover:opacity-100"></i></div><div v-if="opt.tip" class="text-[10px] text-gray-400">{{ opt.tip }}</div></div>
                                        <div class="flex gap-2 items-center"><span :class="['text-[10px] px-2 py-1 rounded font-bold', opt.t==='res'?'bg-green-100 text-green-700':'bg-red-100 text-red-600']">{{ opt.t==='res'?'é ç´„':'æ’éšŠ' }}</span><a v-if="opt.k" @click.stop :href="getNaverLink(opt.k)" target="_blank" class="w-6 h-6 bg-gray-50 rounded-full flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50"><i class="fa-solid fa-location-arrow text-[10px]"></i></a></div>
                                    </div>
                                    <div v-if="item.note" class="pt-2 mt-2 border-t border-dashed border-gray-200 text-xs text-yellow-700">ğŸ“ {{ item.note }}</div>
                                </div>
                            </div>

                            <!-- CHOICE CARD (Clickable) -->
                            <div v-else-if="item.type === 'choice'" class="bg-[#FAFAFA] rounded-[20px] p-4 border-2 border-dashed border-gray-200">
                                <div class="flex justify-between items-center mb-1"><div class="text-xs font-bold text-gray-400">{{ item.time || 'æ™‚æ®µ' }}</div><div class="text-center font-bold text-primary-dark">{{ item.title }}</div><div class="w-4"></div></div>
                                <div class="text-center text-xs text-gray-400 mb-3">{{ item.desc }} <span class="text-[9px] opacity-70">(é»é¸é …çœ‹å„ªç¼ºé»)</span></div>
                                <div class="flex flex-wrap gap-2">
                                    <div v-for="c in item.choices" :key="c.n" @click="openInfoModal(c.n, c.detail || 'æš«ç„¡è©³ç´°è³‡è¨Š')" class="flex-1 min-w-[45%] bg-white p-3 rounded-xl border border-gray-100 text-center shadow-sm flex items-center justify-between group hover:border-primary/30 transition-colors cursor-pointer active:scale-95">
                                        <div class="text-left"><div class="text-[10px] font-bold bg-gray-800 text-white inline-block px-1.5 rounded mb-1">{{ c.n.split(' ')[0] }}</div><div class="text-xs font-bold text-gray-700 flex items-center gap-1">{{ c.desc }} <i class="fa-solid fa-circle-info text-[8px] text-blue-300"></i></div></div>
                                        <div v-if="c.target" @click.stop="window.open(getNaverLink(c.target))" class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 hover:text-accent-green hover:bg-green-50"><i class="fa-solid fa-location-arrow text-[10px]"></i></div>
                                    </div>
                                </div>
                                <div v-if="item.note" class="mt-3 bg-white p-2 rounded border text-xs text-gray-600 text-center shadow-sm"><span class="text-primary font-bold">ç­†è¨˜ï¼š</span> {{ item.note }}</div>
                            </div>
                        </div>
                        <button @click="openModal('add', selectedDayIndex)" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-white hover:text-primary hover:border-primary transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹</button>
                        <div class="h-10"></div>
                    </div>
                </div>
            </div>

            <!-- CALC VIEW -->
            <div v-show="currentView === 'calc'" class="p-5">
                <h2 class="text-xl font-extrabold text-gray-900 mb-4 ml-1">åŒ¯ç‡è¨ˆç®—</h2>
                <div class="bg-white rounded-[24px] p-6 shadow-ios border border-gray-50 text-right mb-4">
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-400">è¼¸å…¥éŸ“å¹£ (KRW)</span><button @click="calcInput=''" class="text-xs font-bold text-primary">æ¸…é™¤</button></div>
                    <input type="text" inputmode="decimal" v-model="calcInput" class="w-full text-right text-5xl font-light text-gray-900 placeholder-gray-200 outline-none bg-transparent font-mono mb-4 tracking-tighter" placeholder="0">
                    <div class="border-t border-gray-100 py-3 flex justify-between items-center"><span class="text-sm text-gray-400">ç´„åˆå°å¹£</span><span class="text-xl font-bold font-mono text-gray-800">{{ calcTwd }}</span></div>
                    <div class="pt-2 flex justify-between items-center"><span class="text-sm text-gray-400">é è¨ˆé€€ç¨…</span><span class="text-xl font-bold font-mono text-accent-green">{{ calcTax }}</span></div>
                </div>
                <div class="text-center text-xs text-gray-400">åŒ¯ç‡: {{ rate }} | æ»¿ 30,000 å¯é€€ç¨…</div>
            </div>

            <!-- GUIDE VIEW -->
            <div v-show="currentView === 'guide'" class="p-4 space-y-5">
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-lg mb-3 flex justify-between items-center">ç”Ÿå­˜éŸ“èª<span class="text-[10px] font-bold text-white bg-red-400 px-2 py-0.5 rounded-full">æ•‘æ€¥ç”¨</span></h3>
                    <div class="flex gap-2 mb-4 overflow-x-auto hide-scroll pb-1"><button v-for="t in koreanTabs" :key="t.id" @click="koreanTab = t.id" :class="['px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors', koreanTab === t.id ? 'bg-gray-800 text-white shadow-md' : 'bg-gray-100 text-gray-400']">{{ t.name }}</button></div>
                    <div class="grid grid-cols-2 gap-2"><transition-group name="list"><div v-for="c in filteredKorean" :key="c.title" class="ripple relative border p-2.5 rounded-xl hover:bg-gray-50 active:scale-95 transition-all cursor-pointer bg-white" @click="openInfoModal(c.title + ' ' + c.k, c.desc, c.k)"><div class="flex justify-between items-start mb-1"><div class="text-2xl">{{ c.icon }}</div><button @click.stop="playAudio(c.k)" class="w-7 h-7 bg-primary/10 rounded-full flex items-center justify-center text-primary active:bg-primary active:text-white transition-colors"><i class="fa-solid fa-volume-high text-xs"></i></button></div><div class="font-bold text-sm text-gray-700 text-center">{{ c.title }}</div><div class="text-[10px] text-gray-400 mt-0.5 text-center">{{ c.k }}</div></div></transition-group></div>
                </div>
                <div v-for="sec in guideSections" :key="sec.id" class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100"><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-lg">{{ sec.title }}</h3><button @click="checkUpdates(sec.id)" class="text-xs text-primary font-bold flex items-center gap-1 active:opacity-50"><i class="fa-solid fa-rotate-right transition-transform duration-700" :class="{'animate-spin': sec.updating.value}"></i> æ›´æ–°æƒ…å ±</button></div><div class="space-y-2"><transition-group name="list"><div v-for="item in sec.list.value" :key="item.title" class="flex gap-3 py-2 border-b border-gray-50 last:border-0 cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" @click="openInfoModal(item.modalTitle || item.title, item.modalDesc || item.desc)"><span :class="['px-2 py-1 rounded text-xs font-bold h-fit shrink-0', item.tagClass]">{{ item.tag }}</span><div><div class="font-bold text-sm">{{ item.title }}</div><div class="text-xs text-gray-500 line-clamp-1">{{ item.desc }}</div></div></div></transition-group></div></div>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="flex-none h-[calc(60px+env(safe-area-inset-bottom))] bg-white/95 backdrop-blur-xl border-t border-gray-200 pb-safe-bottom flex justify-around items-center z-50 w-full">
        <button v-for="tab in ['plan', 'calc', 'guide']" :key="tab" @click="currentView = tab" :class="['flex-1 h-full flex flex-col items-center justify-center gap-1 transition-colors', currentView === tab ? 'text-primary-dark' : 'text-gray-400']">
            <i :class="['fa-solid text-xl transition-transform duration-200', tab === 'plan' ? 'fa-calendar-days' : (tab === 'calc' ? 'fa-calculator' : 'fa-book-open'), currentView === tab ? '-translate-y-0.5' : '']"></i><span class="text-[10px] font-bold tracking-wide">{{ tab === 'plan' ? 'è¡Œç¨‹' : (tab === 'calc' ? 'è¨ˆç®—' : 'æ”»ç•¥') }}</span>
        </button>
    </nav>

    <!-- MODALS -->
    <!-- EDIT MODAL -->
    <transition name="slide-up">
        <div v-if="showEditModal" class="absolute inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end justify-center rounded-[40px] overflow-hidden" @click="closeEditModal">
            <div class="bg-white w-full h-[85%] rounded-t-[24px] p-6 shadow-2xl flex flex-col" @click.stop>
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-extrabold text-gray-900">{{ editForm.mode === 'add' ? 'æ–°å¢è¡Œç¨‹' : 'ç·¨è¼¯è¡Œç¨‹' }}</h3><button @click="closeEditModal" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
                <div class="flex-1 overflow-y-auto hide-scroll space-y-5 pb-6">
                    <div><label class="text-xs font-bold text-gray-400 block mb-2">é¡å‹</label><div class="flex bg-gray-100 p-1 rounded-xl"><button v-for="t in ['normal', 'meal', 'choice', 'flight']" @click="editForm.type = t" :class="['flex-1 py-2 text-xs font-bold rounded-lg transition-all', editForm.type === t ? 'bg-white shadow-sm text-gray-900' : 'text-gray-400']">{{ t === 'normal' ? 'ä¸€èˆ¬' : (t === 'meal' ? 'é¤å»³' : (t === 'flight' ? 'ç­æ©Ÿ' : 'å¤šé¸')) }}</button></div></div>
                    <div class="grid grid-cols-4 gap-3"><div class="col-span-1"><label class="text-xs font-bold text-gray-400 block mb-1">æ™‚é–“</label><input v-model="editForm.time" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-sm text-center" placeholder="12:00"></div><div class="col-span-3"><label class="text-xs font-bold text-gray-400 block mb-1">æ¨™é¡Œ</label><input v-model="editForm.title" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-base" placeholder="è¡Œç¨‹åç¨±"></div></div>
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">æè¿° / è³‡è¨Š</label><textarea v-model="editForm.desc" rows="2" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="ç°¡çŸ­æè¿°"></textarea></div>
                    <div v-if="editForm.type === 'flight'" class="space-y-4 bg-blue-50 p-4 rounded-xl border border-blue-100"><div><label class="text-xs font-bold text-blue-400 block mb-1">èˆªç­ä»£è™Ÿ</label><input v-model="editForm.flightNo" class="w-full bg-white border border-blue-100 p-3 rounded-xl text-sm font-mono" placeholder="CI164"></div><div class="flex gap-3"><div class="flex-1"><label class="text-xs font-bold text-blue-400 block mb-1">å‡ºç™¼åœ°</label><input v-model="editForm.dep" class="w-full bg-white border border-blue-100 p-3 rounded-xl text-center font-black text-xl" placeholder="KHH"></div><div class="flex-1"><label class="text-xs font-bold text-blue-400 block mb-1">ç›®çš„åœ°</label><input v-model="editForm.arr" class="w-full bg-white border border-blue-100 p-3 rounded-xl text-center font-black text-xl" placeholder="ICN"></div></div><div><label class="text-xs font-bold text-blue-400 block mb-1">é£›è¡Œæ™‚é–“</label><input v-model="editForm.duration" class="w-full bg-white border border-blue-100 p-3 rounded-xl text-sm" placeholder="2h 35m"></div></div>
                    <div v-if="editForm.type === 'normal'" class="space-y-4"><div><label class="text-xs font-bold text-gray-400 block mb-1">åœ°åœ–é—œéµå­—</label><div class="relative"><i class="fa-solid fa-map-pin absolute left-3 top-3.5 text-gray-400 text-xs"></i><input v-model="editForm.map" class="w-full bg-gray-50 border border-gray-200 p-3 pl-8 rounded-xl text-sm" placeholder="è¼¸å…¥éŸ“æ–‡åº—åæˆ–åœ°å€"></div></div><div><label class="text-xs font-bold text-gray-400 block mb-1">å“ç‰Œ/æ¨™ç±¤</label><input v-model="editForm.brandsStr" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm" placeholder="Nike, Adidas, å¿…è²·"></div></div>
                    <div v-if="editForm.type === 'meal'" class="space-y-3"><label class="text-xs font-bold text-gray-400 flex justify-between items-center">é¤å»³é¸é … <button @click="addSubItem" class="text-primary text-[10px]"><i class="fa-solid fa-plus"></i> å¢åŠ </button></label><div v-for="(opt, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative"><button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button><input v-model="opt.n" class="w-full bg-white p-2 rounded border border-gray-100 text-sm font-bold" placeholder="é¤å»³åç¨±"><div class="flex gap-2"><select v-model="opt.t" class="bg-white p-2 rounded border border-gray-100 text-xs flex-1"><option value="walk">ç¾å ´æ’</option><option value="res">å¯é ç´„</option><option value="wait">éœ€å€™ä½</option></select><input v-model="opt.k" class="flex-[2] bg-white p-2 rounded border border-gray-100 text-xs" placeholder="Naveråœ°åœ–é—œéµå­—"></div><input v-model="opt.tip" class="w-full bg-white p-2 rounded border border-gray-100 text-xs" placeholder="å‚™è¨»"></div></div>
                    <div v-if="editForm.type === 'choice'" class="space-y-3"><label class="text-xs font-bold text-gray-400 flex justify-between items-center">å¤šé¸æ–¹æ¡ˆ <button @click="addSubItem" class="text-primary text-[10px]"><i class="fa-solid fa-plus"></i> å¢åŠ </button></label><div v-for="(c, idx) in editForm.subItems" :key="idx" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 relative"><button @click="removeSubItem(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button><div class="flex gap-2"><input v-model="c.n" class="w-1/3 bg-white p-2 rounded border border-gray-100 text-sm font-bold text-center" placeholder="Plan A"><input v-model="c.desc" class="w-2/3 bg-white p-2 rounded border border-gray-100 text-sm" placeholder="æè¿°"></div><input v-model="c.target" class="w-full bg-white p-2 rounded border border-gray-100 text-xs" placeholder="åœ°åœ–æœå°‹é—œéµå­—"></div></div>
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">ç­†è¨˜ / å‚™è¨»</label><textarea v-model="editForm.note" rows="2" class="w-full bg-yellow-50 border border-yellow-100 p-3 rounded-xl text-sm text-gray-700" placeholder="ç§äººç­†è¨˜..."></textarea></div>
                </div>
                <div class="pt-4 border-t border-gray-100 flex gap-3"><button v-if="editForm.mode === 'edit'" @click="deleteItem" class="flex-1 bg-red-50 text-red-500 font-bold py-3.5 rounded-xl active:scale-95 transition-transform">åˆªé™¤</button><button @click="saveEdit" class="flex-[3] bg-gray-900 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-transform flex justify-center items-center gap-2 shadow-lg shadow-gray-500/30"><span v-if="isSaving" class="animate-spin"><i class="fa-solid fa-circle-notch"></i></span><span>{{ isSaving ? 'è™•ç†ä¸­...' : 'å„²å­˜è®Šæ›´' }}</span></button></div>
            </div>
        </div>
    </transition>

    <!-- Info Modal -->
    <transition name="fade">
        <div v-if="infoModal.show" class="absolute inset-0 z-[110] bg-black/60 flex items-center justify-center p-6 rounded-[40px] overflow-hidden" @click="infoModal.show = false">
            <div class="bg-white w-full max-w-sm rounded-[30px] p-6 shadow-2xl text-center" @click.stop>
                <h3 class="text-2xl font-extrabold text-gray-900 mb-1 whitespace-pre-line">{{ infoModal.title.split(' ')[0] }}</h3>
                <p class="text-lg text-primary font-bold mb-4 font-mono">{{ infoModal.title.split(' ').slice(1).join(' ') }}</p>
                <button v-if="infoModal.audio" @click="playAudio(infoModal.audio)" class="mb-5 bg-primary text-white w-14 h-14 rounded-full flex items-center justify-center text-xl shadow-lg shadow-primary/30 mx-auto active:scale-90 transition-transform"><i class="fa-solid fa-volume-high"></i></button>
                <div v-else class="w-16 h-1 bg-gray-100 mx-auto mb-4 rounded-full"></div>
                <p class="text-base text-gray-600 leading-relaxed whitespace-pre-wrap mb-8 font-medium">{{ infoModal.desc }}</p>
                <button @click="infoModal.show = false" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-transform">é—œé–‰</button>
            </div>
        </div>
    </transition>

    <!-- WEATHER MODAL -->
    <transition name="slide-up">
        <div v-if="weatherModal.show" class="absolute inset-0 z-[120] bg-black/60 backdrop-blur-sm flex items-end justify-center rounded-[40px] overflow-hidden" @click="weatherModal.show = false">
            <div class="bg-white w-full max-h-[85%] rounded-t-[30px] p-6 shadow-2xl flex flex-col" @click.stop>
                <div class="flex justify-between items-center mb-6"><div><h3 class="text-2xl font-extrabold text-gray-900">é¦–çˆ¾å¤©æ°£é å ±</h3><p class="text-xs text-gray-400 font-bold">æœªä¾† 7 å¤©</p></div><button @click="weatherModal.show = false" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div>
                <div class="flex-1 overflow-y-auto hide-scroll space-y-3">
                    <div v-if="weatherModal.loading" class="text-center py-10 text-gray-400"><i class="fa-solid fa-circle-notch animate-spin text-2xl mb-2"></i><p class="text-xs">è¼‰å…¥æ°£è±¡è³‡æ–™ä¸­...</p></div>
                    <div v-else v-for="(day, idx) in weatherModal.list" :key="idx" class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                        <div class="flex items-center gap-4"><div class="w-12 text-center"><div class="text-xs font-bold text-gray-400">{{ day.week }}</div><div class="text-lg font-black text-gray-800">{{ day.date }}</div></div><div class="text-2xl text-gray-600 w-8 text-center"><i :class="['fa-solid', day.icon]"></i></div></div>
                        <div class="flex gap-4 text-right"><div><span class="text-xs text-blue-400 font-bold block">ä½</span><span class="text-lg font-bold text-gray-800">{{ day.min }}Â°</span></div><div><span class="text-xs text-red-400 font-bold block">é«˜</span><span class="text-lg font-bold text-gray-800">{{ day.max }}Â°</span></div></div>
                    </div>
                </div>
            </div>
        </div>
    </transition>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    const firebaseConfig = { apiKey: "AIzaSyBFDAs4hj4eJ2hCxsWWlRRCsJC_qEekBCc", authDomain: "trip-plan-app-c38a3.firebaseapp.com", projectId: "trip-plan-app-c38a3", storageBucket: "trip-plan-app-c38a3.firebasestorage.app", messagingSenderId: "79177072268", appId: "1:79177072268:web:e8efe92b05a528046d45a9", measurementId: "G-T39PWKG8GL" };
    
    let db; try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e) {}
    const DOC_ID = "seoul_trip_data_v14"; // NEW ID V14 COEX
    const { createApp, ref, computed, onMounted, reactive } = Vue;

    // --- DATA MOCK (v14 COEX FOCUS + 3 Meals) ---
    const DEFAULT_ITINERARY = [
        { 
            d: 1, date: "1/25 (æ—¥)", title: "å‡ºç™¼ & æ˜æ´", items: [
                { time:"03:30", title:"ğŸ  å‡ºç™¼ï¼šå°å—æº«æš–çš„å®¶", desc:"æª¢æŸ¥è­·ç…§ï¼é ç•™ç·©è¡å‰å¾€å°æ¸¯æ©Ÿå ´", map:"å°å—å¸‚æ±å€è£•å¹³è·¯100è™Ÿ", type:"normal" },
                { time:"05:00", title:"ğŸ›« æŠµé”é«˜é›„å°æ¸¯æ©Ÿå ´ (KHH)", desc:"è¾¦ç†ç™»æ©Ÿ & è¨—é‹ (èµ·é£›å‰2å°æ™‚)", map:"é«˜é›„åœ‹éš›æ©Ÿå ´", type:"normal" },
                { type: "flight", time: "07:00", flightNo: "CI 164", dep: "KHH", arr: "ICN", duration: "2h 35m", title: "é£›å¾€é¦–çˆ¾", desc: "è¯èˆª / é è¨ˆ 10:35 æŠµé” (æ™‚å·®+1)" },
                { time:"11:30", title:"ğŸ›¬ å…¥å¢ƒ & é ˜è¡Œæ", desc:"æ©Ÿå ´å¿«ç·š / å·´å£«å‰å¾€å¸‚å€", type:"normal" },
                { time:"13:00", title:"L7 é£¯åº— Check-in", desc:"å¯„æ”¾è¡Œæ", map:"L7 ëª…ë™", type:"normal" },
                { title:"Money Planet æ›éŒ¢", desc:"å°±åœ¨æ˜æ´ï¼ŒåŒ¯ç‡å„ªï¼", map:"ë¨¸ë‹ˆí”Œë ˆë‹›", type:"normal", brands: ["æ›éŒ¢æ‰€"] },
                { 
                    type:"meal", title:"æ—©é¤/æ—©åˆé¤ (å‚™é¸)", 
                    opts:[
                        {n:"Isaac Toast", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šæ–¹ä¾¿å¿«é€Ÿã€å£å‘³ç¶“å…¸ã€‚\nâš ï¸ ç¼ºé»ï¼šç«™è‘—åƒã€‚"},
                        {n:"Hobong Toast", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šç‰¹è£½æœé†¬ç‰¹åˆ¥ã€‚\nâš ï¸ ç¼ºé»ï¼šåº—å°ã€‚"},
                        {n:"æœ¬ç²¥", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šæš–èƒƒé¦–é¸ã€‚\nâš ï¸ ç¼ºé»ï¼šç¾ç…®éœ€ç­‰ã€‚"}
                    ]
                },
                { 
                    type:"meal", title:"æ˜æ´åˆé¤", 
                    opts:[
                        {n:"æ±Ÿå—é¢å±‹", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šç‡‰æ’éª¨è»Ÿå«©å…¥å‘³ã€‚\nâš ï¸ ç¼ºé»ï¼šæ’éª¨ä»½é‡å¤§ã€‚"},
                        {n:"æ˜æ´é¤ƒå­", t:"wait", detail:"ğŸ‘ å„ªé»ï¼šå¿…æ¯”ç™»æ¨è–¦ã€åˆ€å‰Šéºµå¿…åƒã€‚\nâš ï¸ ç¼ºé»ï¼šäººå¤šæ“æ“ ã€‚"}, 
                        {n:"ç¥ä»™é›ªæ¿ƒæ¹¯", t:"wait", detail:"ğŸ‘ å„ªé»ï¼šæ¹¯é ­æ¿ƒéƒæº«å’Œã€‚\nâš ï¸ ç¼ºé»ï¼šéœ€æ’éšŠã€‚"}
                    ] 
                },
                { 
                    time:"16:00", type:"choice", title:"ä¸‹åˆè‡ªç”±é¸", desc:"ç´¯äº†å—ï¼Ÿé¸ä¸€å€‹å–œæ­¡çš„", 
                    choices: [
                        {n:"A é€›è¡—", desc:"Olive Young", target:"ì˜¬ë¦¬ë¸Œì˜ ëª…ë™", detail:"ğŸ‘ å„ªé»ï¼šæ——è‰¦åº—å“é …å…¨ã€‚\nâš ï¸ ç¼ºé»ï¼šçµå¸³æ’éšŠä¹…ã€‚"}, 
                        {n:"B å°åƒ", desc:"å··å­é˜¿å§¨", target:"ëª…ë™ì—­ 6ë²ˆì¶œêµ¬", detail:"ğŸ‘ å„ªé»ï¼šé­šæ¿æ¹¯å¥½å–ã€‚\nâš ï¸ ç¼ºé»ï¼šè·¯é‚Šæ”¤ã€‚"},
                        {n:"C å’–å•¡", desc:"COMPOSE", target:"ì»´í¬ì¦ˆì»¤í”¼ ëª…ë™", detail:"ğŸ‘ å„ªé»ï¼šCPå€¼é«˜ã€‚\nâš ï¸ ç¼ºé»ï¼šå¤–å¸¶ç‚ºä¸»ã€‚"},
                        {n:"D äº‚æ‰“ç§€", desc:"17:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥", detail:"ğŸ‘ å„ªé»ï¼šç„¡èªè¨€éšœç¤™ã€‚\nâš ï¸ ç¼ºé»ï¼šéœ€é…åˆå ´æ¬¡ã€‚"}
                    ] 
                },
                { title:"æ¨‚å¤©ç™¾è²¨ & å…ç¨…åº—", desc:"B1 é£Ÿå“è¡— / 9-12F å…ç¨…åº—", map:"ë¡¯ë°ë°±í™”ì  ë³¸ì ", type:"normal", brands: ["Gentle Monster", "Tamburins", "Nike Seoul", "MLB", "Mardi"] },
                { 
                    time:"19:00", type:"meal", title:"æ™šé¤ï¼šéŸ“å¼æ–™ç†", 
                    opts:[
                        {n:"Myth è±¬è¹„", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šè’œå‘³è±¬è…³é¦™ã€‚\nâš ï¸ ç¼ºé»ï¼šäººå¤šã€‚"},
                        {n:"ç‹å¦ƒå®¶", t:"res", detail:"ğŸ‘ å„ªé»ï¼šå°ˆäººä»£çƒ¤ã€‚\nâš ï¸ ç¼ºé»ï¼šåƒ¹æ ¼é«˜ã€‚"}, 
                        {n:"BHC ç‚¸é›", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šèŠå£«çƒå¿…é»ã€‚\nâš ï¸ ç¼ºé»ï¼šç¾ç‚¸éœ€ç­‰ã€‚"}
                    ] 
                }
            ] 
        },
        { 
            d: 2, date: "1/26 (ä¸€)", title: "å—å¤§é–€ & æ±å¤§é–€", items: [
                { type:"meal", title:"æ—©é¤", opts:[{n:"Isaac Toast", t:"walk", detail:"æ–¹ä¾¿"}, {n:"Egg Drop", t:"walk", detail:"æ»‘è›‹"}, {n:"Paris Baguette", t:"walk", detail:"éºµåŒ…"}] },
                { time:"09:30", title:"æ™¯ç¦å®®", desc:"ç©¿éŸ“æœé€²å ´å…è²»", map:"ê²½ë³µê¶", type:"normal" },
                { 
                    time:"12:00", type:"meal", title:"è¥¿æ‘/åŒ—æ‘åˆé¤", 
                    opts:[
                        {n:"åœŸä¿—æ‘è”˜é›æ¹¯", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šç¸½çµ±ç´šç¾é£Ÿã€‚\nâš ï¸ ç¼ºé»ï¼šäººå¤šéœ€è„«é‹ã€‚"}, 
                        {n:"é€šä»å¸‚å ´", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šéŠ…éŒ¢ä¾¿ç•¶æœ‰è¶£ã€‚\nâš ï¸ ç¼ºé»ï¼šæˆ¶å¤–å†·ã€‚"},
                        {n:"é»ƒç”Ÿå®¶åˆ€å‰Šéºµ", t:"wait", detail:"ğŸ‘ å„ªé»ï¼šç±³å…¶æ—æ¨è–¦ã€‚\nâš ï¸ ç¼ºé»ï¼šæ’éšŠã€‚"}
                    ] 
                },
                { time:"14:00", title:"å—å¤§é–€å¸‚å ´", desc:"Dæ£Ÿæ£‰è¢«ã€Eæ£Ÿ3FèŠ±å¸‚ã€ç«¥è£è¡—", map:"ë‚¨ëŒ€ë¬¸ì‹œì¥", type:"normal", brands: ["Burdeng", "äº¬ä¸€å±‹"] },
                { 
                    time:"19:00", type:"meal", title:"å¸‚å»³/å—å¤§é–€æ™šé¤", 
                    opts:[
                        {n:"JoJo Kalguksu (å¸‚å»³)", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šè›¤èœŠè¶…å¤šæ¹¯é®®ç¾ã€æµ·é®®ç…é¤…å¿…é»ï¼\nâš ï¸ ç¼ºé»ï¼šäººæ°£åº—éœ€æ’éšŠã€‚"}, 
                        {n:"æ™‰å·æœƒé¤¨", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šè±†æ¼¿éºµå§‹ç¥–ã€‚\nâš ï¸ ç¼ºé»ï¼šåªè³£éºµã€‚"}, 
                        {n:"æ»¿è¶³äº”é¦™è±¬è…³", t:"res", detail:"ğŸ‘ å„ªé»ï¼šç±³å…¶æ—æ¨è–¦ã€‚\nâš ï¸ ç¼ºé»ï¼šä»½é‡å¤§ã€‚"}
                    ] 
                },
                { time:"20:30", type:"choice", title:"æ™šä¸Š", desc:"", choices: [{n:"A é€›è¡—", desc:"DDP", target:"DDP"}, {n:"B æ±—è’¸", desc:"Sparex", target:"ìŠ¤íŒŒë ‰ìŠ¤"}, {n:"C äº‚æ‰“ç§€", desc:"20:00 å ´", target:"ëª…ë™ë‚œíƒ€ê·¹ì¥"}] }
            ]
        },
        { 
            d: 3, date: "1/27 (äºŒ)", title: "COEX & æ±Ÿå—", items: [
                { 
                    type:"meal", title:"æ—©é¤", 
                    opts:[
                        {n:"Paris Croissant (COEX)", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šå°±åœ¨COEXå…§ã€éºµåŒ…ç¾åšã€‚\nâš ï¸ ç¼ºé»ï¼šåƒ¹æ ¼ç¨é«˜ã€‚"},
                        {n:"Eggslut (COEX)", t:"wait", detail:"ğŸ‘ å„ªé»ï¼šç¾åœ‹ååº—ã€æ»‘è›‹è¶…å«©ã€‚\nâš ï¸ ç¼ºé»ï¼šéœ€æ’éšŠã€‚"},
                        {n:"æ˜Ÿå·´å…‹ (æ˜Ÿç©ºåœ–æ›¸é¤¨æ—)", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šä½ç½®å¥½ã€ä¼‘æ¯æ–¹ä¾¿ã€‚\nâš ï¸ ç¼ºé»ï¼šä¸€ä½é›£æ±‚ã€‚"}
                    ]
                },
                { time:"10:00", title:"COEX æ°´æ—é¤¨", desc:"é¯Šé­šæ•¸é‡éŸ“åœ‹ç¬¬ä¸€ï¼Œè¶…å¥½æ‹ï¼", map:"ì½”ì—‘ìŠ¤ ì•„ì¿ ì•„ë¦¬ì›€", type:"normal" },
                { 
                    type:"meal", title:"COEX åˆé¤", 
                    opts:[
                        {n:"æ²³æ±é¤¨ (COEXåº—)", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šæ¸…æ·¡ç‰›è‚‰æ¹¯ã€é©åˆå°å­©ã€‚\nâš ï¸ ç¼ºé»ï¼šèœå–®é¸æ“‡å°‘ã€‚"},
                        {n:"Dim Dim Sum", t:"wait", detail:"ğŸ‘ å„ªé»ï¼šæ¸¯å¼é»å¿ƒã€è±¬è±¬åŒ…å¯æ„›ã€‚\nâš ï¸ ç¼ºé»ï¼šç”¨é¤æ™‚é–“éœ€å€™ä½ã€‚"},
                        {n:"Outback Steakhouse", t:"res", detail:"ğŸ‘ å„ªé»ï¼šç¾å¼å®¶åº­é¤å»³ã€ç©ºé–“å¤§ã€‚\nâš ï¸ ç¼ºé»ï¼šéœ€é ç´„ã€‚"}
                    ] 
                },
                { time:"14:00", title:"æ˜Ÿç©ºåœ–æ›¸é¤¨", desc:"å·¨å‹æ›¸ç‰†æ‰“å¡", map:"ë³„ë§ˆë‹¹ ë„ì„œê´€", type:"normal" },
                { 
                    time:"15:30", type:"choice", title:"ä¸‹åˆå‚™æ¡ˆ (é›¨å¤©/æ™´å¤©)", desc:"å¦‚æœCOEXé€›å®Œé‚„æœ‰é«”åŠ›...", 
                    choices: [
                        {n:"A æ¨‚åœ’", desc:"æ¨‚å¤©ä¸–ç•Œ (è ¶å®¤)", target:"ë¡¯ë°ì›”ë“œ", detail:"ğŸ‘ å„ªé»ï¼šå®¤å…§éŠæ¨‚åœ’ä¸æ€•å†·ã€è·é›¢è¿‘(åœ°éµ3ç«™)ã€‚\nâš ï¸ ç¼ºé»ï¼šäººæ½®å¤šã€é–€ç¥¨è²´ã€‚"}, 
                        {n:"B æ™¯è§€", desc:"Seoul Sky (æ¨‚å¤©å¡”)", target:"ì„œìš¸ìŠ¤ì¹´ì´", detail:"ğŸ‘ å„ªé»ï¼šéŸ“åœ‹æœ€é«˜æ¨“ã€å¤•é™½å¤œæ™¯ç¾ã€‚\nâš ï¸ ç¼ºé»ï¼šé–€ç¥¨è²´ã€å¤©æ°£ä¸å¥½çœ‹ä¸åˆ°ã€‚"}, 
                        {n:"C æˆ¶å¤–", desc:"å…’ç«¥å¤§å…¬åœ’", target:"ì„œìš¸ì–´ë¦°ì´ëŒ€ê³µì›", detail:"ğŸ‘ å„ªé»ï¼šæœ‰å‹•ç‰©åœ’æ¤ç‰©åœ’ã€é©åˆæ”¾é›»ã€‚\nâš ï¸ ç¼ºé»ï¼šæˆ¶å¤–è¼ƒå†·ã€è·é›¢ç¨é ã€‚"}
                    ] 
                },
                { 
                    type:"meal", title:"æ™šé¤ (æ±Ÿå—/è ¶å®¤)", 
                    opts:[
                        {n:"Kkanbu Chicken", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šç‚¸é›é…¥è„†ã€ç’°å¢ƒä¹¾æ·¨ã€‚\nâš ï¸ ç¼ºé»ï¼šé€£é–åº—å£å‘³æ¨™æº–ã€‚"}, 
                        {n:"é»‘è±šå®¶", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šæ¿Ÿå·å³¶é»‘è±¬è‚‰ã€ç‚­ç«é¦™ã€‚\nâš ï¸ ç¼ºé»ï¼šåƒ¹æ ¼è¼ƒé«˜ã€‚"},
                        {n:"MIES Container", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šå·¥æ¥­é¢¨ç¾©å¤§åˆ©éºµã€åº—å“¡ç†±æƒ…ã€‚\nâš ï¸ ç¼ºé»ï¼šéŸ³æ¨‚å¤§è²ã€‚"}
                    ] 
                }
            ] 
        },
        { 
            d: 4, date: "1/28 (ä¸‰)", title: "ç‹é·—äº­ & è–æ°´æ´", items: [
                { 
                    type:"meal", title:"æ—©é¤/æ—©åˆé¤", 
                    opts:[
                        {n:"London Bagel", t:"wait", detail:"ğŸ‘ å„ªé»ï¼šè¶…äººæ°£è²æœã€‚\nâš ï¸ ç¼ºé»ï¼šéœ€æ¥µæ—©èµ·æ’éšŠã€‚"},
                        {n:"Milestone Coffee", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šç¶­ä¹Ÿç´å’–å•¡å¿…å–ã€‚\nâš ï¸ ç¼ºé»ï¼šåº—é¢ä¸å¤§ã€‚"},
                        {n:"Nudake Sinsa", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šæŠ¹èŒ¶å¯é Œè›‹ç³•ç‰¹åˆ¥ã€‚\nâš ï¸ ç¼ºé»ï¼šå–®åƒ¹é«˜ã€‚"}
                    ]
                },
                { time:"11:00", title:"ç‹é·—äº­æ½®ç‰Œ", desc:"å³¶å±±å…¬åœ’å‘¨é‚Š", map:"í•˜ìš°ìŠ¤ ë„ì‚°", type:"normal", brands:["Stussy", "Supreme", "Gentle Monster"] }, 
                { time:"14:30", type:"choice", title:"è–æ°´æ´", desc:"é€›è¡— vs æºœå°å­©", choices: [{n:"A é€›è¡—", desc:"Dior/Mardi", target:"ì„±ìˆ˜ë™"}, {n:"B å…¬åœ’", desc:"é¦–çˆ¾æ—", target:"ì„œìš¸ìˆ²"}, {n:"C äº‚æ‰“ç§€", desc:"å›æ˜æ´", target:"ëª…ë™"}] }, 
                { 
                    type:"meal", title:"è–æ°´æ™šé¤", 
                    opts:[
                        {n:"ç¥–å‚³é¦¬éˆ´è–¯æ¹¯", t:"wait", detail:"ğŸ‘ å„ªé»ï¼šè–æ°´ååº—ã€è‚‰å¤šã€‚\nâš ï¸ ç¼ºé»ï¼šæ’éšŠæ¥µé•·ã€‚"}, 
                        {n:"Grandma's Recipe", t:"res", detail:"ğŸ‘ å„ªé»ï¼šç²¾ç·»éŸ“å®šé£Ÿã€‚\nâš ï¸ ç¼ºé»ï¼šä»½é‡ç²¾ç·»ã€‚"},
                        {n:"Daelim Changgo", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šå¤§æ—å€‰åº«æ°£æ°›å¥½ã€‚\nâš ï¸ ç¼ºé»ï¼šæ­£é¤å°‘ã€‚"}
                    ] 
                },
                { time:"20:00", type:"choice", title:"æ™šä¸Š", desc:"", choices: [{n:"A äº‚æ‰“ç§€", desc:"20:00 å ´", target:"ëª…ë™"}, {n:"B é€›è¡—", desc:"Olive Young", target:"ì˜¬ë¦¬ë¸Œì˜"}] }
            ] 
        },
        { 
            d: 5, date: "1/29 (å››)", title: "æ±çŸ£å³¶", items: [
                { type:"meal", title:"æ—©é¤", opts:[{n:"é£¯åº—", t:"res"}, {n:"å’–å•¡å»³", t:"walk"}, {n:"è¶…å•†", t:"walk"}] },
                { time:"10:30", title:"Zoolung Zoolung", desc:"å®¤å…§å‹•ç‰©åœ’", map:"ì£¼ë ì£¼ë  ì˜ë“±í¬", type:"normal" }, 
                { time:"13:30", title:"ç¾ä»£ç™¾è²¨ The Hyundai", desc:"B1/B2 æ½®ç‰Œ & 5F è–èª•å¸‚é›†", map:"ë”í˜„ëŒ€ ì„œìš¸", type:"normal", brands:["Matin Kim", "Marithe", "Arket"] }, 
                { 
                    type:"meal", title:"ç™¾è²¨åˆé¤", 
                    opts:[
                        {n:"Eataly", t:"res", detail:"ğŸ‘ å„ªé»ï¼šæ™¯è§€å¥½ã€ç¾©å¼æ­£å®—ã€‚\nâš ï¸ ç¼ºé»ï¼šåƒ¹é«˜ã€‚"},
                        {n:"Soo Ti", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šç¾å¼çƒ¤ç‰›è‚‰ã€‚\nâš ï¸ ç¼ºé»ï¼šæ²¹è†©ã€‚"},
                        {n:"Matsuno", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šæ—¥å¼è•éº¥éºµæ¸…çˆ½ã€‚\nâš ï¸ ç¼ºé»ï¼šé‡å°‘ã€‚"}
                    ]
                },
                { 
                    type:"choice", title:"å‚æ™šäºŒé¸ä¸€", desc:"", 
                    choices: [
                        {n:"A é€›è¡—", desc:"ç¹¼çºŒé€›ç™¾è²¨", target:"ë”í˜„ëŒ€", detail:"ğŸ‘ å„ªé»ï¼šå¥½é€›ã€‚\nâš ï¸ ç¼ºé»ï¼šäººå¤šã€‚"}, 
                        {n:"B æ°´æ—", desc:"63å¤§æ¨“", target:"63ë¹Œë”©", detail:"ğŸ‘ å„ªé»ï¼šç¶“å…¸ã€‚\nâš ï¸ ç¼ºé»ï¼šèˆŠã€‚"}
                    ] 
                }, 
                { 
                    time:"19:00", type:"choice", title:"æ™šé¤", desc:"", 
                    choices: [
                        {n:"A æµ·é®®", desc:"é·ºæ¢æ´¥", target:"ë…¸ëŸ‰ì§„", detail:"ğŸ‘ å„ªé»ï¼šæ–°é®®ã€‚\nâš ï¸ ç¼ºé»ï¼šéœ€æ®ºåƒ¹ã€‚"}, 
                        {n:"B æ¼¢æ±Ÿ", desc:"åƒæ³¡éºµ", target:"í•œê°•ê³µì›", detail:"ğŸ‘ å„ªé»ï¼šæ°›åœã€‚\nâš ï¸ ç¼ºé»ï¼šå†·ã€‚"}
                    ] 
                }
            ] 
        },
        { 
            d: 6, date: "1/30 (äº”)", title: "å¼˜å¤§", items: [
                { 
                    type:"meal", title:"æ—©é¤/åˆé¤", 
                    opts:[
                        {n:"Oats Office", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šå„ªæ ¼å¥åº·ã€‚\nâš ï¸ ç¼ºé»ï¼šé‡å°‘ã€‚"},
                        {n:"ç”³ç¾äº¬è¾£ç‚’é›æ’", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šèµ·å¸å¤šã€‚\nâš ï¸ ç¼ºé»ï¼šé‡é¹¹ã€‚"},
                        {n:"COLLI", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šç¾©å¤§åˆ©éºµã€‚\nâš ï¸ ç¼ºé»ï¼šéœ€ç´„ã€‚"}
                    ]
                },
                { time:"11:00", title:"å¼˜å¤§å•†åœˆ", desc:"AK Plaza", map:"í™ëŒ€ì…êµ¬ì—­", type:"normal", brands:["Object", "Musinsa"] }, 
                { 
                    time:"14:30", type:"choice", title:"ä¸‹åˆèŒ¶", desc:"", 
                    choices: [
                        {n:"A ç”œé»", desc:"Parole & Langue", target:"ì—°ë‚¨ë™", detail:"ğŸ‘ å„ªé»ï¼šæ —å­æ´¾ç´…ã€‚\nâš ï¸ ç¼ºé»ï¼šé›£è²·ã€‚"}, 
                        {n:"B ç”œé»", desc:"Mintchoco World", target:"ì—°ë‚¨ë™", detail:"ğŸ‘ å„ªé»ï¼šè–„è·æ§æ„›ã€‚\nâš ï¸ ç¼ºé»ï¼šå£å‘³ç‰¹æ®Šã€‚"}, 
                        {n:"C éºµåŒ…", desc:"Ugly Bakery", target:"ë§ì›ì‹œì¥", detail:"ğŸ‘ å„ªé»ï¼šçˆ†æ¼¿éºµåŒ…ã€‚\nâš ï¸ ç¼ºé»ï¼šæ’éšŠã€‚"}
                    ] 
                }, 
                { time:"16:00", title:"FOLNUA æ——è‰¦åº—", desc:"å¿…é€›åŒ…åŒ…ï¼åˆäº•ç«™é™„è¿‘", map:"í´ë‰´ì•„ ì‡¼ë£¸", type:"normal", brands:["FOLNUA"] },
                { time:"18:30", title:"æ¨‚å¤©è¶…å¸‚", desc:"é¦–çˆ¾ç«™æ¡è³¼é›¶é£Ÿ", map:"ë¡¯ë°ë§ˆíŠ¸ ì„œìš¸ì—­ì ", type:"normal" },
                { 
                    type:"meal", title:"å¼˜å¤§æ™šé¤", 
                    opts:[
                        {n:"Hongs ç« é­šç‡’", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šç‚’é£¯å¿…åƒã€‚\nâš ï¸ ç¼ºé»ï¼šè¾£ã€‚"},
                        {n:"å…ƒå ‚è„Šéª¨åœŸè±†æ¹¯", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šæ¹¯æ¿ƒè‚‰å¤§ã€‚\nâš ï¸ ç¼ºé»ï¼šåƒç›¸ç‹¼ç‹½ã€‚"},
                        {n:"BHC ç‚¸é›", t:"walk", detail:"ğŸ‘ å„ªé»ï¼šèŠå£«çƒè®šã€‚\nâš ï¸ ç¼ºé»ï¼šç¾ç‚¸ä¹…ã€‚"}
                    ]
                }
            ] 
        },
        { 
            d: 7, date: "1/31 (å…­)", title: "å›å®¶", items: [
                { time:"08:30", title:"ğŸ¨ Check-out", desc:"å»æ©Ÿå ´", type:"normal" }, 
                { time:"10:00", title:"ğŸ›« é€€ç¨…", desc:"è¾¦ç†ç™»æ©Ÿ", type:"normal" }, 
                { type: "flight", time: "12:00", flightNo: "CI 165", dep: "ICN", arr: "KHH", duration: "3h 05m", title: "è¿”å›å°ç£", desc: "è¯èˆª" }, 
                { time:"14:30", title:"ğŸ›¬ æŠµé”é«˜é›„", desc:"é ˜è¡Œæ", type:"normal" }, 
                { time:"16:00", title:"ğŸ  æŠµé”å°å—", desc:"ç”œèœœçš„å®¶", map:"å°å—å¸‚æ±å€è£•å¹³è·¯100è™Ÿ", type:"normal" }
            ] 
        }
    ];
    
    // --- STATIC DATA ---
    const koreanTabs = [{ id: 'all', name: 'å…¨éƒ¨' }, { id: 'basic', name: 'åŸºç¤' }, { id: 'food', name: 'åƒå–' }, { id: 'shop', name: 'è³¼ç‰©' }, { id: 'traffic', name: 'äº¤é€š' }];
    const survivalCards = [
        { cat: 'basic', title: "ä½ å¥½", k: "ì•ˆë…•í•˜ì„¸ìš”", icon: "ğŸ‘‹", desc: "å®‰å¦å“ˆã„™ã„Ÿå‘¦" }, { cat: 'basic', title: "è¬è¬", k: "ê°ì‚¬í•©ë‹ˆë‹¤", icon: "ğŸ™", desc: "åº·æ’’å“ˆå’ªæ­" }, { cat: 'basic', title: "å°ä¸èµ·", k: "ì£„ì†¡í•©ë‹ˆë‹¤", icon: "ğŸ™‡", desc: "å´”é€å“ˆå’ªæ­" }, { cat: 'basic', title: "æ´—æ‰‹é–“", k: "í™”ì¥ì‹¤", icon: "ğŸš»", desc: "èŠ±æ±Ÿæ´—" }, { cat: 'basic', title: "æ˜¯/å¥½çš„", k: "ë„¤", icon: "â­•", desc: "å…§" }, { cat: 'basic', title: "ä¸æ˜¯", k: "ì•„ë‹ˆìš”", icon: "âŒ", desc: "é˜¿å°¼å‘¦" },
        { cat: 'food', title: "è«‹çµ¦æ°´", k: "ë¬¼ ì£¼ì„¸ìš”", icon: "ğŸ’§", desc: "ç©† æœ±ã„™ã„Ÿå‘¦" }, { cat: 'food', title: "å¥½åƒ", k: "ë§›ìˆì–´ìš”", icon: "ğŸ˜‹", desc: "ç‘ªå¸Œæœå‘¦" }, { cat: 'food', title: "çµå¸³", k: "ê³„ì‚°í•´ì£¼ì„¸ìš”", icon: "ğŸ’³", desc: "åˆ‡æ¡‘é»‘æœ±ã„™ã„Ÿå‘¦" }, { cat: 'food', title: "ä¸è¦è¾£", k: "ì•ˆ ë§µê²Œ", icon: "ğŸŒ¶ï¸", desc: "å®‰å¦¹çµ¦ (æµ·é®®éºµå¿…ç”¨)" }, { cat: 'food', title: "å¹¾ä½?", k: "ëª‡ ë¶„ì´ì„¸ìš”?", icon: "âœŒï¸", desc: "è‹—å¸ƒä½ ã„™ã„Ÿå‘¦" },
        { cat: 'shop', title: "å¤šå°‘éŒ¢", k: "ì–¼ë§ˆì˜ˆìš”?", icon: "ğŸ’°", desc: "æ­åª½è€¶å‘¦" }, { cat: 'shop', title: "ä¾¿å®œé»", k: "ê¹ì•„ì£¼ì„¸ìš”", icon: "ğŸ’¸", desc: "å˜å˜æœ±ã„™ã„Ÿå‘¦" }, { cat: 'shop', title: "è¢‹å­", k: "ë´‰íˆ¬ ì£¼ì„¸ìš”", icon: "ğŸ›ï¸", desc: "å´©åœŸ æœ±ã„™ã„Ÿå‘¦" }, { cat: 'shop', title: "é€€ç¨…", k: "Tax Refund", icon: "ğŸ“„", desc: "Tax Refund" },
        { cat: 'traffic', title: "åœ°éµç«™", k: "ì§€í•˜ì² ì—­", icon: "ğŸš‡", desc: "åŸºå“ˆç§‹å”·" }, { cat: 'traffic', title: "åˆ°é€™è£¡", k: "ì—¬ê¸°ë¡œ ê°€ì£¼ì„¸ìš”", icon: "ğŸ“", desc: "å„ªgi æ‘Ÿ å’–æœ±ã„™ã„Ÿå‘¦" }
    ];

    const defaultFormState = { mode: 'add', dIdx: 0, iIdx: 0, type: 'normal', time: '', title: '', desc: '', map: '', brandsStr: '', note: '', flightNo: '', dep: 'KHH', arr: 'ICN', duration: '', subItems: [] };

    createApp({
        setup() {
            // State
            const currentView = ref('plan');
            const itinerary = ref([]);
            const selectedDayIndex = ref(0);
            const dbStatus = ref('connecting');
            const loading = ref(true);
            const showEditModal = ref(false);
            const isSaving = ref(false);
            const editForm = reactive({ ...defaultFormState });
            const calcInput = ref('');
            const rate = ref(0.024);
            const infoModal = reactive({ show: false, title: '', desc: '', audio: '' });
            const weather = reactive({ temp: '--', desc: 'è¼‰å…¥ä¸­', icon: 'fa-cloud', forecast: [] });
            const weatherModal = reactive({ show: false, loading: false, list: [] });
            const koreanTab = ref('all');

            const guideState = {
                popup: { 
                    title: "1æœˆå¿«é–ƒ & å¸‚é›†",
                    list: ref([
                        { title: "é¦–çˆ¾ç‡ˆç¯€", desc: "å…‰åŒ–é–€ | å†¬å­£é™å®š", tag: "é™å®š", tagClass: "bg-orange-100 text-orange-600", modalTitle: "é¦–çˆ¾ç‡ˆç¯€", modalDesc: "æ™‚é–“ï¼šè‡³ 1æœˆåº•\nåœ°é»ï¼šå…‰åŒ–é–€å»£å ´" },
                        { title: "ç¾ä»£ç™¾è²¨ è–èª•å¸‚é›†", desc: "The Hyundai 5F", tag: "ç†±é–€", tagClass: "bg-red-100 text-red-600", modalTitle: "The Hyundai Seoul", modalDesc: "åœ°é»ï¼šæ±çŸ£å³¶ (Day 5)" },
                        { title: "Shinsegae ç‡ˆå…‰ç§€", desc: "æ˜æ´æ–°ä¸–ç•Œç™¾è²¨", tag: "å¿…çœ‹", tagClass: "bg-yellow-100 text-yellow-800", modalTitle: "æ–°ä¸–ç•Œç™¾è²¨", modalDesc: "å¤–ç‰†ç‡ˆå…‰ç§€ï¼Œæ™šä¸Šè¶…ç¾" }
                    ]), 
                    new: [{ title: "Burberry ç«ç‘°", desc: "è–æ°´æ´ | å’–å•¡å»³", tag: "NEW", tagClass: "bg-teal-100 text-teal-600", modalTitle: "Burberry Rose", modalDesc: "ä½ç½®ï¼šè–æ°´æ´" }], updating: ref(false), updated: ref(false) 
                },
                brand: { 
                    title: "æ½®ç‰Œ & è³¼ç‰©å¿«è¨Š",
                    list: ref([
                        { title: "Olive Young", desc: "æ˜æ´ | æ»¿é¡é€€ç¨…", tag: "SALE", tagClass: "bg-red-100 text-red-600", modalTitle: "Olive Young", modalDesc: "æ´»å‹•ï¼šå†¬å­£ä¿ƒéŠ·" }, 
                        { title: "Gentle Monster", desc: "Haus Dosan / æ±çŸ£å³¶", tag: "æ–°å“", tagClass: "bg-gray-100 text-gray-800", modalTitle: "GM 2026", modalDesc: "åœ°é»ï¼šç‹é·—äº­ Haus Dosan æˆ– æ±çŸ£å³¶" },
                        { title: "Matin Kim", desc: "è–æ°´æ´ / ç¾ä»£ç™¾è²¨", tag: "ç†±é–€", tagClass: "bg-black text-white", modalTitle: "Matin Kim", modalDesc: "éµç‰ŒéŒ¢åŒ…å¿…è²·" }
                    ]), 
                    new: [{ title: "StÃ¼ssy é™å®š", desc: "ç‹é·—äº­ | Hoodie", tag: "DROP", tagClass: "bg-yellow-100 text-yellow-800", modalTitle: "StÃ¼ssy Seoul", modalDesc: "æœ¬é€±äº”ç™¼å”®" }], updating: ref(false), updated: ref(false) 
                },
                shopping: {
                    title: "é€›è¡—åœ°åœ–æ”»ç•¥",
                    list: ref([
                        { title: "è–æ°´æ´åœ°åœ–", desc: "Dior, Mardi, å’–å•¡å»³", tag: "Trend", tagClass: "bg-purple-100 text-purple-600", modalTitle: "è–æ°´æ´", modalDesc: "è·¯ç·šå»ºè­°ï¼šDior Seoul æ‰“å¡ -> é€› Mardi -> åƒç¥–å‚³é¦¬éˆ´è–¯æ¹¯ -> é€› LCDC" },
                        { title: "æ±çŸ£å³¶æ”»ç•¥", desc: "The Hyundai Seoul", tag: "Mall", tagClass: "bg-green-100 text-green-600", modalTitle: "The Hyundai", modalDesc: "B2 æ½®ç‰Œå€ (Thisisneverthat, Arket) -> 5F è–èª•å¸‚é›† -> B1 é£Ÿå“è¡—" },
                        { title: "å¼˜å¤§å¿…é€›", desc: "AK Plaza, åœè»Šå ´è¡—", tag: "Youth", tagClass: "bg-blue-100 text-blue-600", modalTitle: "å¼˜å¤§", modalDesc: "Object (æ–‡å‰µ), Gentle Monster, AA Place, NB æ——è‰¦åº—" }
                    ]),
                    new: [{ title: "æ¼¢å—æ´", desc: "Mardi, Depound", tag: "Vibe", tagClass: "bg-gray-100 text-gray-600", modalTitle: "æ¼¢å—æ´", modalDesc: "é©åˆå–œæ­¡å®‰éœé€›è¡—çš„äºº" }], updating: ref(false), updated: ref(false)
                }
            };
            const guideSections = [{id:'popup', ...guideState.popup}, {id:'brand', ...guideState.brand}, {id:'shopping', ...guideState.shopping}];

            // Computeds
            const currentDay = computed(() => itinerary.value[selectedDayIndex.value]);
            const statusText = computed(() => dbStatus.value === 'connected' ? 'é€£ç·šä¸­ v14' : (dbStatus.value === 'empty' ? 'è³‡æ–™åº«ç‚ºç©º' : (dbStatus.value === 'error' ? 'é€£ç·šéŒ¯èª¤' : 'é€£ç·šä¸­...')));
            const calcTwd = computed(() => Math.round((parseFloat(calcInput.value) || 0) * rate.value).toLocaleString());
            const calcTax = computed(() => { const v = parseFloat(calcInput.value) || 0; return v < 30000 ? 0 : 'â‚© ' + (v >= 75000 ? 5000 : (v >= 50000 ? 3500 : 1500)).toLocaleString(); });
            const filteredKorean = computed(() => koreanTab.value === 'all' ? survivalCards : survivalCards.filter(c => c.cat === koreanTab.value));

            // Lifecycle
            onMounted(() => {
                fetchWeather(); // Fetch current
                if (!db) { dbStatus.value = 'error'; loading.value = false; return; }
                onSnapshot(doc(db, "trips", DOC_ID), (snap) => {
                    if (snap.exists()) { itinerary.value = snap.data().itinerary; dbStatus.value = 'connected'; } 
                    else { dbStatus.value = 'empty'; itinerary.value = []; }
                    loading.value = false;
                }, () => { dbStatus.value = 'error'; itinerary.value = DEFAULT_ITINERARY; loading.value = false; });
            });

            // Methods
            const uploadDefaultData = async () => { if(db) { loading.value = true; await setDoc(doc(db, "trips", DOC_ID), { itinerary: DEFAULT_ITINERARY }); }};
            
            const getWeatherIcon = (code) => {
                if (code === 0) return 'fa-sun text-orange-400';
                if (code <= 3) return 'fa-cloud-sun text-yellow-400';
                if (code <= 48) return 'fa-smog text-gray-400';
                if (code <= 67) return 'fa-cloud-rain text-blue-400';
                if (code <= 77) return 'fa-snowflake text-cyan-300';
                if (code <= 82) return 'fa-cloud-showers-heavy text-blue-600';
                return 'fa-cloud-bolt text-purple-500';
            };

            const fetchWeather = async () => { 
                try { 
                    const r = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FSeoul'); 
                    const d = await r.json(); 
                    weather.temp = Math.round(d.current.temperature_2m); 
                    weather.desc = d.current.weather_code > 2 ? (d.current.weather_code > 50 ? 'æœ‰é›¨' : 'å¤šé›²') : 'æ™´æœ—'; 
                    weather.icon = getWeatherIcon(d.current.weather_code);
                    weatherModal.list = d.daily.time.map((date, i) => {
                        const dayDate = new Date(date);
                        return {
                            date: `${dayDate.getMonth()+1}/${dayDate.getDate()}`,
                            week: ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dayDate.getDay()],
                            min: Math.round(d.daily.temperature_2m_min[i]),
                            max: Math.round(d.daily.temperature_2m_max[i]),
                            icon: getWeatherIcon(d.daily.weather_code[i])
                        };
                    });
                } catch(e){} 
            };

            const openWeatherModal = () => { weatherModal.show = true; if(weatherModal.list.length === 0) { weatherModal.loading = true; fetchWeather().then(() => weatherModal.loading = false); } };

            const openModal = (mode, dIdx, iIdx = null, item = null) => {
                Object.assign(editForm, defaultFormState, { mode, dIdx, iIdx }); 
                if (mode === 'edit' && item) {
                    Object.assign(editForm, item);
                    if (item.brands) editForm.brandsStr = item.brands.join(', ');
                    editForm.subItems = (item.type === 'meal' && item.opts) ? JSON.parse(JSON.stringify(item.opts)) : ((item.type === 'choice' && item.choices) ? JSON.parse(JSON.stringify(item.choices)) : []);
                }
                showEditModal.value = true;
            };

            const addSubItem = () => editForm.subItems.push(editForm.type === 'meal' ? { n: '', t: 'walk', k: '', tip: '' } : { n: 'Plan', desc: '', target: '' });
            const removeSubItem = (idx) => editForm.subItems.splice(idx, 1);
            const closeEditModal = () => showEditModal.value = false;

            const saveEdit = async () => {
                if (!db) return; isSaving.value = true;
                const { title, desc, time, note, type, map, brandsStr, flightNo, dep, arr, duration, subItems } = editForm;
                const newItem = { title, desc, time, note, type };
                if (type === 'normal') { newItem.map = map; if (brandsStr) newItem.brands = brandsStr.split(/,|ï¼Œ/).map(s => s.trim()).filter(Boolean); }
                else if (type === 'meal') newItem.opts = subItems;
                else if (type === 'choice') newItem.choices = subItems;
                else if (type === 'flight') Object.assign(newItem, { flightNo, dep, arr, duration });
                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                if (editForm.mode === 'add') newItinerary[editForm.dIdx].items.push(newItem); else newItinerary[editForm.dIdx].items[editForm.iIdx] = newItem;
                try { await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary }); showEditModal.value = false; } catch (e) { alert("Error"); } finally { isSaving.value = false; }
            };

            const deleteItem = async () => {
                if (!confirm("Delete?")) return;
                const newItinerary = JSON.parse(JSON.stringify(itinerary.value));
                newItinerary[editForm.dIdx].items.splice(editForm.iIdx, 1);
                await updateDoc(doc(db, "trips", DOC_ID), { itinerary: newItinerary }); showEditModal.value = false;
            };

            const checkUpdates = (id) => {
                const s = guideState[id];
                if (s.updated.value) return alert("å·²æ˜¯æœ€æ–°");
                s.updating.value = true;
                setTimeout(() => { s.list.value = [...s.new, ...s.list.value]; s.updated.value = true; s.updating.value = false; }, 1500);
            };

            const getSearchLink = (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`;
            const getNaverLink = (k) => `https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(k)}`;
            const openInfoModal = (t, d, audio = null) => { infoModal.title = t; infoModal.desc = d; infoModal.audio = audio; infoModal.show = true; };
            const playAudio = (text) => { if (!text) return; window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'ko-KR'; u.rate = 0.9; window.speechSynthesis.speak(u); };

            return { itinerary, selectedDayIndex, currentDay, dbStatus, loading, uploadDefaultData, statusText, showEditModal, editForm, openModal, closeEditModal, saveEdit, deleteItem, isSaving, addSubItem, removeSubItem, currentView, weather, fetchWeather, calcInput, calcTwd, calcTax, rate, survivalCards, infoModal, openInfoModal, guideSections, checkUpdates, getSearchLink, getNaverLink, koreanTab, koreanTabs, filteredKorean, playAudio, weatherModal, openWeatherModal };
        }
    }).mount('#app');
</script>
</body>
</html>

