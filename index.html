<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>首爾之旅 2026</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#f7f7f2',       // 溫暖米白
                            card: '#ffffff',     // 純白卡片
                            text: '#4a4a4a',     // 深灰文字
                            accent: '#8c8c82',   // 質感灰
                            highlight: '#d4a373', // 木質調點綴
                            naver: '#03C75A'     // Naver Green
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f7f7f2; color: #4a4a4a; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .meal-choice { border-left: 3px solid #d4a373; padding-left: 0.75rem; }
        .map-btn { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* Loading animation for weather/rate */
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="font-sans text-sm pb-24">

    <!-- Top Navigation / Header -->
    <header class="fixed top-0 w-full bg-muji-bg/95 backdrop-blur-sm z-50 border-b border-stone-200 px-4 py-3 shadow-sm">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold tracking-widest text-stone-700">SEOUL <span class="text-xs font-normal">2026</span></h1>
                <p class="text-[10px] text-stone-500">Jan 25 - Jan 31</p>
            </div>
            <!-- Live Weather Display -->
            <div id="weather-display" class="text-right">
                <div id="weather-content" class="text-stone-500 transition-opacity duration-500">
                    <i class="fa-solid fa-spinner fa-spin text-xs"></i> <span class="text-xs">首爾</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="mt-16 px-4">

        <!-- PLAN TAB (行程) -->
        <div id="tab-plan" class="tab-content active">
            <!-- Flight Info Card -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-4 border border-stone-100">
                <div class="flex justify-between items-center mb-2">
                    <span class="bg-stone-100 text-stone-600 px-2 py-0.5 rounded text-xs">去程 CI 0164</span>
                    <span class="text-xs text-stone-400">1/25 (日)</span>
                </div>
                <div class="flex justify-between items-center font-bold text-lg text-stone-700">
                    <span>KHH 07:00</span>
                    <i class="fa-solid fa-plane text-xs text-stone-300"></i>
                    <span>ICN 10:35</span>
                </div>
                <hr class="my-3 border-stone-100">
                <div class="flex justify-between items-center mb-2">
                    <span class="bg-stone-100 text-stone-600 px-2 py-0.5 rounded text-xs">回程 CI 0165</span>
                    <span class="text-xs text-stone-400">1/31 (六)</span>
                </div>
                <div class="flex justify-between items-center font-bold text-lg text-stone-700">
                    <span>ICN 12:00</span>
                    <i class="fa-solid fa-plane text-xs text-stone-300"></i>
                    <span>KHH 14:15</span>
                </div>
            </div>

            <!-- Hotel Info -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6 border border-stone-100 flex items-start gap-3">
                <div class="bg-stone-100 p-2 rounded-lg text-stone-500"><i class="fa-solid fa-hotel"></i></div>
                <div>
                    <h3 class="font-bold text-stone-700">L7 明洞飯店</h3>
                    <p class="text-xs text-stone-500 mt-1">L7 Myeongdong</p>
                    <a href="https://m.map.naver.com/search2/search.naver?query=L7+명동" target="_blank" class="text-xs text-muji-naver font-bold mt-2 inline-block"><i class="fa-solid fa-location-dot mr-1"></i>Naver Map</a>
                </div>
            </div>

            <!-- Itinerary Timeline -->
            <div id="itinerary-container">
                <!-- Javascript will render days here -->
            </div>
        </div>

        <!-- GUIDE TAB (導覽) -->
        <div id="tab-guide" class="tab-content">
            <h2 class="text-xl font-bold mb-4 text-stone-700">深度導覽</h2>
            
            <div class="space-y-6">
                <!-- Guide Item 1 -->
                <article class="bg-white rounded-xl overflow-hidden shadow-sm border border-stone-100">
                    <img src="https://images.unsplash.com/photo-1596409605553-61e47941cb94?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Bukchon" class="w-full h-40 object-cover opacity-90">
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-2">北村與西村的差異</h3>
                        <p class="text-stone-600 leading-relaxed text-justify mb-2">
                            <strong class="text-stone-800">北村 (Bukchon)：</strong>位於景福宮與昌德宮之間，是朝鮮時代高官貴族的居住地。這裡的韓屋保存最完整，坡道多，景色壯觀，但也因為遊客眾多較為喧鬧。
                        </p>
                        <p class="text-stone-600 leading-relaxed text-justify">
                            <strong class="text-stone-800">西村 (Seochon)：</strong>位於景福宮西側，曾是藝術家與文人的居所。這裡氛圍更生活化，充滿了可愛的小店、獨立書店與傳統市場（如通仁市場），是體驗首爾「日常感」的最佳去處。
                        </p>
                    </div>
                </article>

                <!-- Guide Item 2 -->
                <article class="bg-white rounded-xl overflow-hidden shadow-sm border border-stone-100">
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-2"><i class="fa-solid fa-paw text-muji-highlight mr-2"></i>Zoolung Zoolung 攻略</h3>
                        <p class="text-stone-600 leading-relaxed mb-3">
                            位於永登浦 Times Square 的室內動物園。最大的特色是「無柵欄」體驗。進入後請領取蓋章護照，完成任務可換小禮物。
                        </p>
                        <ul class="list-disc list-inside text-stone-600 text-xs space-y-1 mb-4">
                            <li>不可以隨意觸摸動物，除非飼養員允許。</li>
                            <li>鳥園區建議戴帽子，以免「幸運」降臨。</li>
                            <li>每小時有燈光秀，記得留意廣播。</li>
                        </ul>
                        <div class="w-full h-48 rounded-lg overflow-hidden border border-stone-200 relative">
                             <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=126.9010%2C37.5160%2C126.9050%2C37.5180&amp;layer=mapnik&amp;marker=37.5170%2C126.9030" style="border: 0px;"></iframe>
                             <a href="https://m.map.naver.com/search2/search.naver?query=주렁주렁 영등포" target="_blank" class="absolute bottom-2 right-2 bg-muji-naver text-white text-xs px-3 py-1 rounded shadow-md font-bold">開啟導航</a>
                        </div>
                        <p class="text-[10px] text-center text-stone-400 mt-1">永登浦 Times Square 4F 售票 / 5F 入口</p>
                    </div>
                </article>

                <!-- Guide Item 3 -->
                <article class="bg-white rounded-xl p-4 shadow-sm border border-stone-100">
                    <h3 class="font-bold text-lg mb-2">購物退稅懶人包</h3>
                    <div class="flex items-start gap-3 mb-3">
                        <div class="bg-stone-100 p-2 rounded text-stone-500 text-xs font-bold">即時</div>
                        <p class="text-stone-600 text-xs pt-1">單筆滿 3萬韓元，在貼有 Tax Free 標誌的店家（如 Olive Young, Lotte Mart），出示護照可直接扣除稅金結帳。</p>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="bg-stone-100 p-2 rounded text-stone-500 text-xs font-bold">機場</div>
                        <p class="text-stone-600 text-xs pt-1">若市區無法即時退稅，請保留單據。到機場KIOSK機器掃描護照與單據，入關後去領錢。</p>
                    </div>
                </article>
            </div>
        </div>

        <!-- WALLET TAB (記帳) -->
        <div id="tab-wallet" class="tab-content">
            <!-- Rate Settings -->
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-xl font-bold text-stone-700">記帳 & 匯率</h2>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-stone-400">1 KRW ≈ </span>
                    <input type="number" id="exchange-rate" step="0.001" class="w-16 bg-white border border-stone-300 rounded px-2 py-1 text-center text-xs text-stone-700" onchange="updateRate()">
                    <span class="text-xs text-stone-400">TWD</span>
                    <!-- Rate Update Indicator -->
                    <div id="rate-indicator" class="text-[10px] text-muji-highlight ml-1 hidden"><i class="fa-solid fa-check"></i> 更新</div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6 border border-stone-100 sticky top-16 z-30">
                <div class="mb-3">
                    <input type="text" id="expense-desc" placeholder="品項 (例如: 晚餐, 伴手禮)" class="w-full bg-stone-50 border-none rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-muji-highlight mb-2">
                    <div class="flex gap-2">
                        <input type="text" id="expense-calc" placeholder="金額 (可算式: 500+200)" class="flex-1 bg-stone-50 border-none rounded-lg px-3 py-2 text-lg font-mono tracking-wider focus:ring-1 focus:ring-muji-highlight">
                        <button onclick="calculateAndAdd()" class="bg-stone-700 text-white px-4 rounded-lg shadow-sm active:scale-95 transition-transform"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <p class="text-right text-xs text-stone-400 mt-1 h-4" id="preview-twd">約 TWD 0</p>
                </div>
                
                <!-- Photo Upload -->
                <div class="flex items-center justify-between border-t border-stone-100 pt-3">
                    <label for="expense-photo" class="flex items-center gap-2 text-stone-500 text-xs cursor-pointer bg-stone-50 px-3 py-1.5 rounded-full border border-stone-200">
                        <i class="fa-solid fa-camera"></i> <span>附加照片</span>
                    </label>
                    <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoSelect(this)">
                    <span id="photo-name" class="text-[10px] text-stone-400 truncate max-w-[100px]"></span>
                </div>
            </div>

            <!-- Expense List -->
            <div id="expense-list" class="space-y-3 pb-20">
                <!-- Items rendered here -->
            </div>
            
            <!-- Total -->
            <div class="fixed bottom-20 left-4 right-4 bg-stone-800 text-white p-3 rounded-lg shadow-lg flex justify-between items-center z-40">
                <span class="text-xs">總支出</span>
                <div class="text-right">
                    <div class="text-sm font-bold">₩ <span id="total-krw">0</span></div>
                    <div class="text-[10px] text-stone-300">≈ NT$ <span id="total-twd">0</span></div>
                </div>
            </div>
        </div>

        <!-- LISTS TAB (清單) -->
        <div id="tab-lists" class="tab-content">
            <h2 class="text-xl font-bold mb-4 text-stone-700">行前檢查 & 備忘</h2>
            
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6 border border-stone-100">
                <h3 class="font-bold text-stone-600 mb-3 border-b border-stone-100 pb-2">必帶清單</h3>
                <ul id="checklist-container" class="space-y-2">
                    <!-- JS renders items -->
                </ul>
            </div>

            <div class="bg-white rounded-xl p-4 shadow-sm border border-stone-100">
                <h3 class="font-bold text-stone-600 mb-3 border-b border-stone-100 pb-2">個人筆記</h3>
                <textarea id="personal-memo" class="w-full h-40 bg-stone-50 rounded-lg p-3 text-sm text-stone-600 focus:outline-none resize-none" placeholder="輸入筆記、網址連結... (會自動儲存)"></textarea>
            </div>
        </div>

        <!-- INFO TAB (資訊) -->
        <div id="tab-info" class="tab-content">
            <h2 class="text-xl font-bold mb-4 text-stone-700">實用資訊</h2>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <a href="https://n.weather.naver.com/" target="_blank" class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 flex flex-col items-center justify-center gap-2 active:bg-stone-50">
                    <i class="fa-solid fa-cloud text-2xl text-blue-300"></i>
                    <span class="text-xs font-bold text-stone-600">Naver 天氣</span>
                </a>
                <a href="https://m.map.naver.com/" target="_blank" class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 flex flex-col items-center justify-center gap-2 active:bg-stone-50">
                    <i class="fa-solid fa-map text-2xl text-muji-naver"></i>
                    <span class="text-xs font-bold text-stone-600">Naver 地圖</span>
                </a>
            </div>

            <div class="bg-white rounded-xl p-4 shadow-sm mb-6 border border-stone-100">
                <h3 class="font-bold text-stone-600 mb-3">緊急聯絡</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center border-b border-stone-50 pb-2">
                        <span class="text-sm">韓國報警</span>
                        <a href="tel:112" class="bg-red-50 text-red-500 px-3 py-1 rounded-full text-xs font-bold">112</a>
                    </div>
                    <div class="flex justify-between items-center border-b border-stone-50 pb-2">
                        <span class="text-sm">火警/救護車</span>
                        <a href="tel:119" class="bg-red-50 text-red-500 px-3 py-1 rounded-full text-xs font-bold">119</a>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">外交部旅外救助</span>
                        <a href="tel:+82-10-9093-5912" class="bg-blue-50 text-blue-500 px-3 py-1 rounded-full text-xs font-bold">直撥</a>
                    </div>
                </div>
            </div>

            <div class="bg-amber-50 rounded-xl p-4 border border-amber-100">
                <h3 class="font-bold text-amber-800 mb-2 text-sm"><i class="fa-solid fa-triangle-exclamation mr-1"></i> 注意事項</h3>
                <ul class="list-disc list-inside text-xs text-amber-900/80 space-y-1">
                    <li>電壓 220V，插座為兩孔圓形（豬鼻子）。</li>
                    <li>冬天極冷 (-10°C)，務必洋蔥式穿搭。</li>
                    <li>南大門/路邊攤多收現金，記得備足韓幣。</li>
                    <li>搭地鐵上下班時間極擠，請避開 8-9am 及 6-7pm。</li>
                </ul>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-stone-200 pb-safe pt-2 px-6 z-50">
        <div class="flex justify-between items-center text-[10px] font-medium text-stone-400 pb-2">
            <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center gap-1 w-12" data-target="plan">
                <i class="fa-solid fa-calendar-check text-lg"></i>
                <span>行程</span>
            </button>
            <button onclick="switchTab('guide')" class="nav-btn flex flex-col items-center gap-1 w-12" data-target="guide">
                <i class="fa-solid fa-book-open text-lg"></i>
                <span>導覽</span>
            </button>
            <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center gap-1 w-12" data-target="wallet">
                <div class="bg-muji-highlight text-white rounded-full w-10 h-10 flex items-center justify-center -mt-4 shadow-md border-2 border-white">
                    <i class="fa-solid fa-wallet text-lg"></i>
                </div>
                <span class="mt-1">記帳</span>
            </button>
            <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center gap-1 w-12" data-target="lists">
                <i class="fa-solid fa-list-check text-lg"></i>
                <span>清單</span>
            </button>
            <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center gap-1 w-12" data-target="info">
                <i class="fa-solid fa-circle-info text-lg"></i>
                <span>資訊</span>
            </button>
        </div>
    </nav>

    <script>
        // --- DATA & CONFIG ---
        const itineraryData = [
            {
                day: 1, date: "1/25 (日)", title: "抵達 & 明洞掃貨",
                events: [
                    { time: "10:35", title: "抵達仁川機場", desc: "搭巴士 6015/6001 至明洞" },
                    { time: "13:00", title: "L7 飯店放行李", desc: "明洞換錢", map: "L7 명동" },
                    { time: "13:30", type: "meal", title: "午餐 (明洞)", choices: ["明洞餃子 (명동교자)", "神仙雪濃湯 (신선설농탕)", "河東館 (하동관)"] },
                    { time: "14:30", title: "免稅店雙殺", desc: "新世界+樂天 (帶護照)", map: "신세계면세점 명동점" },
                    { time: "18:00", title: "明洞品牌大掃蕩", desc: "TNF, NB, emis, WHO.A.U, Kodak, Musinsa", highlight: true, map: "무신사 스탠다드 명동" },
                    { time: "19:00", type: "meal", title: "晚餐 (烤肉)", choices: ["王妃家 (왕비집)", "黃金牧場 (황금목장)", "荒謬的生肉 (엉터리생고기)"] }
                ]
            },
            {
                day: 2, date: "1/26 (一)", title: "古宮、西村、批發",
                events: [
                    { time: "09:30", title: "景福宮 (韓服)", desc: "光化門廣場", map: "경복궁" },
                    { time: "12:00", type: "meal", title: "午餐 (西村)", choices: ["土俗村蔘雞湯 (토속촌)", "罐頭餃子 (깡통만두)", "通仁市場 (통인시장)"] },
                    { time: "13:30", title: "Folnua 買包包", desc: "合井站 (Hapjeong)", map: "폴뉴아" },
                    { time: "17:00", type: "meal", title: "晚餐 (合井/東大門)", choices: ["屋同食 (옥동식)", "給豚的男人 (돈주는남자)", "橋村炸雞 (교촌치킨)"] },
                    { time: "19:00", title: "東大門批發", desc: "apM PLACE, nuZZon", highlight: true, map: "apM PLACE" }
                ]
            },
            {
                day: 3, date: "1/27 (二)", title: "近郊一日遊",
                events: [
                    { time: "08:00", title: "集合出發", desc: "南怡島 / 滑雪一日遊", highlight: true },
                    { time: "12:00", type: "meal", title: "午餐", choices: ["春川辣炒雞排 (춘천닭갈비)", "懷舊手搖便當", "滑雪場餐廳"] },
                    { time: "19:30", type: "meal", title: "晚餐 (炸雞)", choices: ["BHC (明洞)", "Puradak (푸라닭)", "Oppadak (오빠닭)"] }
                ]
            },
            {
                day: 4, date: "1/28 (三)", title: "江南潮流聖地",
                events: [
                    { time: "11:00", title: "狎鷗亭潮牌", desc: "Supreme, Stussy, Human Made", map: "슈프림 도산" },
                    { time: "13:00", type: "meal", title: "午餐 (島山)", choices: ["London Bagel Museum (런던베이글뮤지엄)", "Gino's NY Pizza (지노스피자)", "Dosan Bunsik (도산분식)"] },
                    { time: "15:00", title: "下午茶", desc: "Nudake (抹茶可頌)", map: "누데이크 하우스 도산" },
                    { time: "18:00", type: "meal", title: "晚餐 (明洞)", choices: ["元堂馬鈴薯排骨湯 (원당감자탕)", "The Sic-Ddang (더식당)", "摩西年糕鍋 (먹쉬돈나)"] }
                ]
            },
            {
                day: 5, date: "1/29 (四)", title: "親子動物園 & 現代",
                events: [
                    { time: "10:30", title: "Zoolung Zoolung", desc: "永登浦 Times Square (室內動物園)", map: "주렁주렁 영등포" },
                    { time: "12:30", type: "meal", title: "午餐 (商場內)", choices: ["鼎泰豐", "On The Border", "Shake Shack"] },
                    { time: "15:00", title: "現代百貨", desc: "The Hyundai Seoul (On Running, B2潮牌)", map: "더현대 서울" },
                    { time: "19:00", type: "meal", title: "晚餐 (現代百貨)", choices: ["Eataly (義式)", "SMT Lounge", "B1 美食街"] }
                ]
            },
            {
                day: 6, date: "1/30 (五)", title: "終極採購日",
                events: [
                    { time: "09:30", title: "南大門童裝", desc: "Burdeng, Mama (備現金)", highlight: true, map: "남대문시장 아동복거리" },
                    { time: "12:00", type: "meal", title: "午餐 (必吃)", choices: ["JoJo Kalguksu (조조칼국수 시청점)", "韓順子奶奶", "富村生拌牛肉"] },
                    { time: "13:30", title: "廣藏市場 (棉被)", desc: "請店家真空壓縮", map: "광장시장" },
                    { time: "14:30", title: "樂天超市", desc: "首爾站 (買零食)", map: "롯데마트 서울역점" },
                    { time: "16:30", title: "搭計程車回飯店", desc: "行李多，請勿搭地鐵", highlight: true },
                    { time: "19:00", type: "meal", title: "晚餐 (一隻雞)", choices: ["陳玉華奶奶 (진옥화할매)", "孔陵一隻雞 (공릉)", "元祖元奶奶"] }
                ]
            },
            {
                day: 7, date: "1/31 (六)", title: "快樂賦歸",
                events: [
                    { time: "08:30", title: "Check-out", desc: "搭機場巴士" },
                    { time: "11:00", title: "領取免稅品", desc: "仁川機場管制區內", highlight: true },
                    { time: "12:00", title: "起飛返台", desc: "CI 0165" }
                ]
            }
        ];

        const defaultChecklist = [
            { text: "護照 (有效期限6個月以上)", checked: false },
            { text: "電子機票存檔", checked: false },
            { text: "WOWPASS / T-Money 卡", checked: false },
            { text: "網卡 / Roaming 開通", checked: false },
            { text: "轉接頭 (豬鼻子 220V)", checked: false },
            { text: "韓幣現金 (南大門用)", checked: false },
            { text: "牙刷牙膏 (韓國飯店通常不附)", checked: false },
            { text: "保暖衣物 (圍巾/手套/毛帽)", checked: false }
        ];

        // --- RENDER FUNCTIONS ---

        function renderItinerary() {
            const container = document.getElementById('itinerary-container');
            container.innerHTML = itineraryData.map((day, index) => `
                <div class="mb-8 relative pl-4 border-l-2 border-stone-200">
                    <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-stone-300 border-2 border-white"></div>
                    <h3 class="font-bold text-lg text-stone-800 mb-1 leading-none">Day ${day.day} <span class="text-sm font-normal text-stone-500 ml-2">${day.date}</span></h3>
                    <p class="text-xs text-muji-highlight font-bold mb-3 uppercase tracking-wider">${day.title}</p>
                    
                    <div class="space-y-3">
                        ${day.events.map(ev => {
                            if (ev.type === 'meal') {
                                return `
                                <div class="bg-white p-3 rounded-lg shadow-sm border border-stone-100">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="font-bold text-stone-700 text-sm"><i class="fa-solid fa-utensils text-xs mr-1 text-stone-400"></i> ${ev.title}</div>
                                        <div class="text-xs font-mono text-stone-400 bg-stone-50 px-1 rounded">${ev.time}</div>
                                    </div>
                                    <div class="space-y-1">
                                        ${ev.choices.map(c => `<div class="meal-choice text-xs text-stone-600">${c}</div>`).join('')}
                                    </div>
                                </div>`;
                            } else {
                                const highlightClass = ev.highlight ? 'border-l-4 border-l-red-400 bg-red-50/30' : 'border border-stone-100 bg-white';
                                const mapLink = ev.map ? 
                                    `<a href="https://m.map.naver.com/search2/search.naver?query=${encodeURIComponent(ev.map)}" target="_blank" class="map-btn absolute bottom-3 right-3 text-white bg-muji-naver hover:bg-green-600 text-[10px] px-2 py-1 rounded shadow-sm flex items-center gap-1"><i class="fa-solid fa-location-dot"></i> <span>NAVER</span></a>` 
                                    : '';
                                return `
                                <div class="relative p-3 rounded-lg shadow-sm ${highlightClass}">
                                    <div class="flex gap-3">
                                        <div class="text-xs font-mono text-stone-400 pt-0.5 w-10 shrink-0">${ev.time}</div>
                                        <div>
                                            <div class="font-bold text-stone-700 text-sm">${ev.title}</div>
                                            <div class="text-xs text-stone-500 mt-1 pr-16">${ev.desc}</div>
                                        </div>
                                    </div>
                                    ${mapLink}
                                </div>`;
                            }
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        // --- WALLET LOGIC ---
        let expenses = JSON.parse(localStorage.getItem('seoul2026_expenses')) || [];
        let currentRate = parseFloat(localStorage.getItem('seoul2026_rate')) || 0.024;
        let tempPhotoData = null;

        function initWallet() {
            document.getElementById('exchange-rate').value = currentRate;
            renderExpenses();
            updatePreview();
            document.getElementById('expense-calc').addEventListener('input', updatePreview);
        }

        function updateRate() {
            currentRate = parseFloat(document.getElementById('exchange-rate').value);
            localStorage.setItem('seoul2026_rate', currentRate);
            renderExpenses();
            updatePreview();
        }

        function updatePreview() {
            const val = document.getElementById('expense-calc').value;
            try {
                if(!val) throw new Error();
                const safeVal = val.replace(/[^0-9+\-*/().]/g, '');
                const result = Function('"use strict";return (' + safeVal + ')')();
                if(isFinite(result)) {
                    document.getElementById('preview-twd').innerText = `≈ TWD ${Math.round(result * currentRate)}`;
                } else {
                     document.getElementById('preview-twd').innerText = '';
                }
            } catch (e) {
                document.getElementById('preview-twd').innerText = '';
            }
        }

        function handlePhotoSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                document.getElementById('photo-name').innerText = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 400; 
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        tempPhotoData = canvas.toDataURL('image/jpeg', 0.6); 
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        function calculateAndAdd() {
            const desc = document.getElementById('expense-desc').value;
            const calcStr = document.getElementById('expense-calc').value;
            
            if (!desc || !calcStr) return alert("請輸入說明和金額");

            try {
                const safeVal = calcStr.replace(/[^0-9+\-*/().]/g, '');
                const amount = Function('"use strict";return (' + safeVal + ')')();
                
                if (!isFinite(amount)) throw new Error("Invalid");

                const newExp = {
                    id: Date.now(),
                    desc: desc,
                    krw: amount,
                    date: new Date().toLocaleDateString(),
                    img: tempPhotoData
                };

                expenses.unshift(newExp);
                localStorage.setItem('seoul2026_expenses', JSON.stringify(expenses));
                
                document.getElementById('expense-desc').value = '';
                document.getElementById('expense-calc').value = '';
                document.getElementById('expense-photo').value = '';
                document.getElementById('photo-name').innerText = '';
                tempPhotoData = null;
                updatePreview();
                renderExpenses();

            } catch (e) {
                alert("金額算式有誤");
            }
        }

        function deleteExpense(id) {
            if(confirm("確定刪除此筆記帳？")) {
                expenses = expenses.filter(e => e.id !== id);
                localStorage.setItem('seoul2026_expenses', JSON.stringify(expenses));
                renderExpenses();
            }
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            let totalKrw = 0;
            
            list.innerHTML = expenses.map(e => {
                totalKrw += e.krw;
                const twd = Math.round(e.krw * currentRate);
                return `
                <div class="bg-white p-3 rounded-lg shadow-sm border border-stone-100 flex gap-3 items-center">
                    ${e.img ? `<img src="${e.img}" class="w-12 h-12 object-cover rounded bg-stone-100 cursor-pointer" onclick="showImage('${e.img}')">` : '<div class="w-12 h-12 rounded bg-stone-50 flex items-center justify-center text-stone-300"><i class="fa-solid fa-won-sign"></i></div>'}
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-stone-700 truncate">${e.desc}</h4>
                            <button onclick="deleteExpense(${e.id})" class="text-stone-300 px-2"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="flex justify-between items-baseline mt-1">
                            <span class="text-xs text-stone-400">${e.date}</span>
                            <div class="text-right">
                                <div class="font-mono font-bold text-stone-800">₩${e.krw.toLocaleString()}</div>
                                <div class="text-[10px] text-stone-500">NT$ ${twd.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('total-krw').innerText = totalKrw.toLocaleString();
            document.getElementById('total-twd').innerText = Math.round(totalKrw * currentRate).toLocaleString();
        }

        function showImage(src) {
            const win = window.open("");
            win.document.write(`<img src="${src}" style="max-width:100%">`);
        }


        // --- LISTS LOGIC ---
        let checklist = JSON.parse(localStorage.getItem('seoul2026_checklist'));
        if (!checklist || checklist.length === 0) {
            checklist = defaultChecklist;
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = checklist.map((item, index) => `
                <li class="flex items-center gap-3 p-2 rounded hover:bg-stone-50 cursor-pointer" onclick="toggleCheck(${index})">
                    <div class="w-5 h-5 rounded border ${item.checked ? 'bg-muji-highlight border-muji-highlight' : 'border-stone-300'} flex items-center justify-center text-white text-xs transition-colors">
                        ${item.checked ? '<i class="fa-solid fa-check"></i>' : ''}
                    </div>
                    <span class="${item.checked ? 'text-stone-400 line-through' : 'text-stone-700'} text-sm select-none">${item.text}</span>
                </li>
            `).join('');
        }

        function toggleCheck(index) {
            checklist[index].checked = !checklist[index].checked;
            localStorage.setItem('seoul2026_checklist', JSON.stringify(checklist));
            renderChecklist();
        }

        function initMemo() {
            const memoArea = document.getElementById('personal-memo');
            memoArea.value = localStorage.getItem('seoul2026_memo') || '';
            memoArea.addEventListener('input', () => {
                localStorage.setItem('seoul2026_memo', memoArea.value);
            });
        }


        // --- TAB SWITCHING ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === tabId) {
                    btn.classList.add('text-muji-highlight');
                    btn.classList.remove('text-stone-400');
                } else {
                    btn.classList.remove('text-muji-highlight');
                    btn.classList.add('text-stone-400');
                }
            });
            window.scrollTo(0, 0);
        }

        // --- LIVE DATA FETCHING (Weather & Rate) ---
        
        // 1. Weather API (Open-Meteo, No Key required)
        const WMO_CODES = {
            0: { desc: '晴朗', icon: 'fa-sun' },
            1: { desc: '多雲', icon: 'fa-cloud-sun' },
            2: { desc: '多雲', icon: 'fa-cloud' },
            3: { desc: '陰天', icon: 'fa-cloud' },
            45: { desc: '有霧', icon: 'fa-smog' },
            48: { desc: '有霧', icon: 'fa-smog' },
            51: { desc: '毛毛雨', icon: 'fa-cloud-rain' },
            53: { desc: '毛毛雨', icon: 'fa-cloud-rain' },
            55: { desc: '毛毛雨', icon: 'fa-cloud-rain' },
            61: { desc: '下雨', icon: 'fa-umbrella' },
            63: { desc: '下雨', icon: 'fa-umbrella' },
            65: { desc: '大雨', icon: 'fa-umbrella' },
            71: { desc: '下雪', icon: 'fa-snowflake' },
            73: { desc: '下雪', icon: 'fa-snowflake' },
            75: { desc: '大雪', icon: 'fa-snowflake' },
            95: { desc: '雷雨', icon: 'fa-bolt' }
        };

        async function fetchWeather() {
            const weatherDiv = document.getElementById('weather-content');
            
            try {
                // Seoul Coordinates
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current=temperature_2m,weather_code&timezone=Asia%2FSeoul');
                if (!res.ok) throw new Error();
                const data = await res.json();
                
                const temp = Math.round(data.current.temperature_2m);
                const code = data.current.weather_code;
                const weatherInfo = WMO_CODES[code] || { desc: '多雲', icon: 'fa-cloud' };

                weatherDiv.innerHTML = `<i class="fa-solid ${weatherInfo.icon} text-muji-highlight"></i> ${temp}°C ${weatherInfo.desc}`;
            } catch (e) {
                // Fallback / Keep default
                weatherDiv.innerHTML = `<i class="fa-solid fa-cloud-sun"></i> -5°C (離線)`;
            }
        }

        // 2. Exchange Rate API (Exchangerate-API, Free endpoint)
        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/KRW');
                if (!res.ok) throw new Error();
                const data = await res.json();
                const newRate = data.rates.TWD;
                
                if (newRate) {
                    // Update State
                    currentRate = newRate;
                    localStorage.setItem('seoul2026_rate', currentRate);
                    
                    // Update UI
                    document.getElementById('exchange-rate').value = currentRate;
                    document.getElementById('rate-indicator').classList.remove('hidden');
                    renderExpenses(); // Recalculate totals
                }
            } catch (e) {
                console.log("Using cached or default rate");
            }
        }

        // --- INIT ---
        window.onload = function() {
            renderItinerary();
            initWallet();
            renderChecklist();
            initMemo();
            
            // Try fetching live data
            fetchWeather();
            fetchExchangeRate();
        };

    </script>
</body>
</html>

